<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" sizes="57x57" href="/bootstrap/images/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="/bootstrap/images/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/images/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/bootstrap/images/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/images/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/bootstrap/images/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="/bootstrap/images/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/bootstrap/images/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="/bootstrap/images/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="/bootstrap/images/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/bootstrap/images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="/bootstrap/images/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/bootstrap/images/favicon-16x16.png">
        <link rel="manifest" href="/bootstrap/images/manifest.json">
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/bootstrap/images/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <title>New Power Company - Rep Portal</title>
        <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
        <script src="./bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/bootstrap-dialog.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/hashids.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/bootstrap-datepicker.js" type="text/javascript"></script>
        <script src="./bootstrap/js/changepass_v12.js" type="text/javascript"></script>
        <script src="./bootstrap/js/bootstrap-clockpicker.js" type="text/javascript"></script>
        <script src="./bootstrap/js/jquery-clockpicker.js" type="text/javasccript"></script>
        <script src="./bootstrap/js/moment.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/jquery.waypoints.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/jquery.counterup.js" type="text/javascript"></script>
        <script src="./bootstrap/js/fullcalendar.min.js" type="text/javascript"></script>
        <script src="./bootstrap/js/jquery.cookie.js" type="text/javascript"></script>
        <script src="./bootstrap/js/compressorjs.js" type="text/javascript"></script>
        <!-- script src="./bootstrap/js/errortracker_v1.js" type="text/javascript"></script -->
        <script>
            window.FileAPI = {
                  debug: false // debug mode
                , staticPath: './bootstrap/js/jquery.fileapi/FileAPI/' // path to *.swf
            };
        </script>
        <script src="./bootstrap/js/jquery.fileapi/FileAPI/FileAPI.min.js"></script>
        <script src="./bootstrap/js/jquery.fileapi/FileAPI/FileAPI.exif.js"></script>
        <script src="./bootstrap/js/jquery.fileapi/jquery.fileapi.min.js"></script>
        <script src="./bootstrap/js/jquery.fileapi/jcrop/jquery.Jcrop.min.js"></script>
        <script src="./bootstrap/js/chart.js" type="text/javascript"></script>
        <script src="./bootstrap/js/randomColor.js" type="text/javascript"></script>
        <script charset="utf-8"type="text/javascript" src="/bootstrap/js/hacks.js"></script>
        <script type="text/javascript" src='//maps.google.com/maps/api/js?sensor=false&libraries=places&key=AIzaSyC1JStq4qg-S61Y1bAXLzAWlq3ToUIscZk'></script>
        <script type="text/javascript" src="/bootstrap/js/mobile-detect.js"></script>
        <script type="text/javascript" src="/bootstrap/js/maplabel.js"></script>
        <script type="text/javascript" src="/bootstrap/js/infobox.js"></script>
        <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css" />
        <link href="//fonts.googleapis.com/css?family=Qwigley" rel="stylesheet" type="text/css">
        <link href="//fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet" type="text/css">
        <link href="//fonts.googleapis.com/css?family=Permanent+Marker" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" href="./bootstrap/css/bootstrap-theme.min.css" />
        <link rel="stylesheet" href="./bootstrap/css/bootstrap-dialog.min.css" />
        <link rel="stylesheet" href="./bootstrap/css/datepicker.css" />
        <link rel="stylesheet" href="./bootstrap/css/changepass_v12.css" />
        <link rel="stylesheet" href="./bootstrap/css/bootstrap-clockpicker.css" />
        <link rel="stylesheet" href="./bootstrap/css/jquery-clockpicker.css" />
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="./bootstrap/css/fullcalendar.min.css" />
        <link rel="stylesheet" href="./bootstrap/css/symbola.css" />
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
        <link href="/bootstrap/js/jquery.fileapi/jcrop/jquery.Jcrop.min.css" rel="stylesheet" type="text/css"/>
        <style type="text/css">
            body
            {
                font-family: "Ubuntu", Arial, Helvetica, sans-serif;
                color: #ffffff;
                background: #353030;
            }
            .upcoming_appointment_day
            {
                background: #867F7F;
                text-shadow: 0px 0px 0.1em #000;
                text-align: center;
            }
            @media(max-width:767px)
            {
                body > .container > .row > .col-xs-12 > h2
                {
                    margin-top: 0em;
                    text-align: center;
                }
                .upcoming_inner
                {
                    text-align: center;
                }
                .col-xs-0
                {
                    display: none;
                }
                .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12, .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12, .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12
                {
                    display: block;
                }
            }
            @media(min-width:768px)
            {
                body > .container > .row > .col-xs-12 > h2
                {
                    margin-top: 0em;
                    text-align: center;
                }
                .upcoming_inner
                {
                    text-align: center;
                }
                .col-sm-0
                {
                    display: none;
                }
                .col-xs-1, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9, .col-xs-10, .col-xs-11, .col-xs-12, .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12, .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12
                {
                    display: block;
                }
            }
            @media(min-width:992px)
            {
                body > .container > .row > .col-xs-12 > h2
                {
                    margin-top: 1.75em;
                    text-align: right;
                }
                .upcoming_inner
                {
                    text-align: left;
                }
                .col-md-0
                {
                    display: none;
                }
                .col-xs-1, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9, .col-xs-10, .col-xs-11, .col-xs-12, .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12, .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12
                {
                    display: block;
                }
            }
            @media(min-width:1200px)
            {
                body > .container > .row > .col-xs-12 > h2
                {
                    margin-top: 1.75em;
                    text-align: right;
                }
                .upcoming_inner
                {
                    text-align: left;
                }
                #dropdownMenuAdditionalActions
                {
                    width: 24em;
                }
                #mainbtns .open>.dropdown-menu
                {
                    width: 24em;
                }
                .col-lg-0
                {
                    display: none;
                }
                .col-xs-1, .col-xs-2, .col-xs-3, .col-xs-4, .col-xs-5, .col-xs-6, .col-xs-7, .col-xs-8, .col-xs-9, .col-xs-10, .col-xs-11, .col-xs-12, .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12, .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12
                {
                    display: block;
                }
            }
            .modal-header
            {
                background-color: #D19F28 !important;
                text-align: center;
                text-shadow: 0px 0px 0.05em #000000;
            }
            .open li a
            {
                text-shadow: 0px 0px 0px #000;
            }
            .modal-body
            {
                background: #353030;
            }
            .bootstrap-dialog-message
            {
                color: #C6C2C2;
                text-shadow: 0px 0px 0.05em #000000;
            }
            input[type=text], input[type='text'], input[type="text"], input[type=email], input[type='email'], input[type="email"], #email_list, #cpf_email, #cpf_pass
            {
                background-color: #575757;
                border: 0;
                color: #D8D1D1;
            }
            #cpf_pass, #cpf_email
            {
                width: 100%;
                display: block;
                text-indent: 0.5em;
            }
            .dropdown > button, .open > button
            {
                background: #1F6FBD !important;
                color: #ffffff !important;
                text-shadow: 0px 0px 0.05em #000 !important;
            }
            .dropdown > button:hover, .open > button:hover
            {
                /*background: #1F6FBD !important;*/
                background-color: #1F6FBD !important;
                color: #ffffff !important;
                text-shadow: 0px 0px 0.05em #000 !important;
            }
            .dropdown > button:focus, .open > button:focus
            {
                /*background: #1F6FBD !important;*/
                background-color: #1F6FBD !important;
                color: #ffffff !important;
                text-shadow: 0px 0px 0.05em #000 !important;
            }
            .glyphicon-camera
            {
                color: #FB8A0B;
                font-size: 5em;
                cursor: pointer;
            }
            ::-webkit-input-placeholder
            {
                color: #000000;
            }
            :-moz-placeholder
            {
                color: #000000;
                opacity:  1;
            }
            ::-moz-placeholder
            {
                color: #000000;
                opacity:  1;
            }
            :-ms-input-placeholder
            {
                color: #909;
            }
            #apps_script_settings .img-responsive
            {
                  width: 1em;
                  display: inline-block;
                  margin-right: 0.8em;
            }
            #signout
            {
                text-align: right;
                line-height: 2em;
            }
            input[disabled]
            {
                background: #AAAAAA !important;
                color: #000000 !important;
                border: 1px solid #ff0000;
            }
            #lead_id
            {
                font-family: monospace, "MonoSpace";
            }
            .datepicker
            {
                color: #000000;
            }
            #cust_dob, #cust_signature_date, #cust_appointment_date
            {
                text-indent: 1em;
            }
            #app_area
            {
                opacity: 1.0;
                padding-bottom: 1em;
                min-height: 1000px;
                padding-top: 1em;
            }
            .new_office_txt
            {
                width: 70%;
                margin-right: 1em;
                text-indent: 0.5em;
            }
            .textaligncenter
            {
                text-align: center;
            }
            #mainbtns .btn
            {
                margin-right: 0.25em;
            }
            .modal-footer
            {
                background: #353030;
                border-top: 1px solid #353030;
            }
            .exception_selection_cb
            {
                position: relative;
                left: 0.5em;
            }
            .inner_card_cancel
            {
                float: right;
                position: relative;
                top: -2em;
                font-weight: normal;
                color: #fff;
                font-size: 0.8em;
                background: rgb(211, 82, 82);
                padding-left: 0.5em;
                padding-right: 0.5em;
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                border-radius: 0.4em;
                text-shadow: 0px 0px 0.05em #000;
                -webkit-user-select: none;
                cursor: pointer;
            }
            #ex_next_btn2
            {
                margin-top: 3em;
            }
            .qual_search_results
            {
                margin-top: 3em;
            }
            .testing_span
            {
                float: right;
                color: #E8FF3D;
                line-height: 2em;
                cursor: pointer;
            }
            #appt_date, #cancellation_date
            {
                text-indent: 1em;
            }
            #exception_date, #exception_date_testing
            {
                text-indent: 1em;
            }
            .upcoming_anchor
            {
                color: #33B7B7;
                font-size: 2em;
            }
            .upcoming_anchor:hover
            {
                color: #33B7B7 !important;
                text-decoration: none !important;
            }
            .no_appointments
            {
                color: #FF5454;
                font-size: 0.8em;
                text-align: center;
            }
            .upcoming_appointment_item
            {
                color: #F0BC1A;
                cursor: pointer;
                text-align: center;
            }
            .upcoming_card_label
            {
                color: #000000;
                font-family: Arial, Helvetica, sans-serif;
                font-weight: bold;
            }
            .upcoming_card_value
            {
                color: #000000;
                position: relative;
                display: block;
                top: -0.75em;
                margin-bottom: 0px;
            }
            .upcoming_appt_card
            {
                display: block;
                position: relative;
                z-index: 25;
                padding: 4%;
                background-color: #867F7F;
                box-shadow: inset 0 0 0.5em #000000;
                -moz-box-shadow:    inset 0 0 0.5em #000000;
                -webkit-box-shadow: inset 0 0 0.5em #000000;
                opacity: 0.0;

            }
            #mainbtns .dropdown
            {
                float: left;
            }
            #mainbtns .glyphicon-search
            {

            }
            #qual_search_note
            {
                  font-style: italic;
                  color: #54C5FF;
            }
            #dropdownMenuAdditionalActions
            {
                  border-radius: 4px;
                  border-top-left-radius: 0px;
                  border-bottom-left-radius: 0px;
                  background-image: -webkit-linear-gradient(top,#f0ad4e 0,#eb9316 100%) !important;
                  background-image: -o-linear-gradient(top,#f0ad4e 0,#eb9316 100%) !important;
                  background-image: -webkit-gradient(linear,left top,left bottom,from(#f0ad4e),to(#eb9316)) !important;
                  background-image: linear-gradient(to bottom,#f0ad4e 0,#eb9316 100%) !important;
                  background: -webkit-linear-gradient(top,#f0ad4e 0,#eb9316 100%) !important;
                  background: -o-linear-gradient(top,#f0ad4e 0,#eb9316 100%) !important;
                  background: -webkit-gradient(linear,left top,left bottom,from(#f0ad4e),to(#eb9316)) !important;
                  background: linear-gradient(to bottom,#f0ad4e 0,#eb9316 100%) !important;
                  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#fff0ad4e', endColorstr='#ffeb9316', GradientType=0) !important;
                  filter: progid:DXImageTransform.Microsoft.gradient(enabled=false) !important;
                  background-repeat: repeat-x;
                  border-color: #e38d13;
                  text-shadow: 0px 0px 0px #000000  !important;
                  float: left;
                  left: -0.1em;
            }
            #qual_first, #qual_last, #qual_postal
            {
                text-indent: 0.5em;
            }
            .script_label .img-responsive
            {
                  display: inline-block;
                  height: 1.5em;
                  margin-right: 0.5em;
            }
            .script_label
            {
                font-size: 1.5em;
            }
            .script_description
            {
                  width: 92.5%;
                  left: 7.5%;
                  position: relative;
                  font-style: italic;
                  color: #D5CDCD;
            }
            .script_url
            {
                  width: 92.5%;
                  left: 7.5%;
                  position: relative;
                  font-family: monospace;
                  color: #229B7F;
            }
            .script_changer
            {
                text-align: right;
                color: #DB7777;
                cursor: pointer;
            }
            .clist_title
            {
                font-size: 2em;
                text-align: left !important;
            }
            .no_surveys, .no_questions
            {
                margin-left: auto;
                margin-right: auto;
                position: relative;
                display: block;
                width: 25%;
                min-width: 200px;
                text-shadow: 0px 0px 0.1em #000;
                -webkit-user-select: none;
            }
            #checklist_button_menu_main, #checklist_button_menu_add
            {
                background: rgba(69, 68, 68, 0.5);
                padding-top: 0.5em;
                padding-bottom: 0.5em;
                padding-left: 1em;
                padding-right: 1em;
                box-shadow: inset 0px 0px 0.5px 0.5px rgba(0, 0, 0, 1);
            }
            #checklist_button_menu_add
            {
                display: none;
                opacity: 0.0;
            }
            .checklist_inner_view_main
            {
                min-height: 150px;
            }
            .optional_time_span
            {
                  padding: 0.2em;
                  padding-left: 0.5em;
                  padding-right: 0.5em;
                  text-shadow: 0px 0px 0.1em #000;
                  cursor: pointer;
                  -webkit-user-select: none;
                  float: right;
                  margin-left: 0.5em;
                  position: relative;
                  top: -43.5em;
            }
            #show_add_st_dt, #show_add_et_dt
            {
                opacity: 0.0;
                float: right;
            }
            .picker_for_show_add_st
            {
                margin-top: -9.75em;
                margin-left: 30em;
            }
            .picker_for_show_add_et
            {
                margin-top: -9.75em;
                margin-left: 23em;
            }
            .picker_for_show_add_st:before, .picker_for_show_add_et:before, .picker_for_show_add_st:after, .picker_for_show_add_et:after
            {
                display: none;
            }
            .checklist_inner_view_add .glyphicon-time
            {
                float: right;
                top: -28.5em;
                left: 14.5em;
            }
            .start-clock
            {
                right: 6.5em;
                display: block;
                width: 7.2em;
                text-align: right;
                position: relative;
                z-index: 5;
                left: 8.1em !important;
            }
            .end-clock, .start-clock
            {
                cursor: pointer;
            }
            .end-clock, .start-clock, .optional_time_span, #cancel_time_config
            {
                display: none;
            }
            #enable_time_config
            {
                float: right;
                z-index: 100;
                position: relative;
            }
            #enable_time_config_cb, #cancel_time_config_cb
            {
                position: relative;
                top: 0.2em;
            }
            #cancel_time_config
            {
                clear: both;
                float: right;
                color: #F35D5D;
                top: -28em;
                position: relative;
            }
            .create_clist_triggers
            {
                width: 50%;
                float: left;
                min-height: 400px;
                max-height: 450px;
                overflow: hidden;
            }
            .create_clist_triggers_list
            {
                margin-top: 1.5em;
                margin-left: -3em;
                text-indent: 0.3em;
            }
            .filter_li_item
            {
                list-style-type: none;
            }
            .filter_li_item input
            {
                position: relative;
                margin-left: 0.5em;
                top: 0.25em;
            }
            .end-time, .start-time
            {
                float: right;
                clear: both;
                opacity: 0.0;
                top: -27em;
                position: relative;
            }
            .popover_for_end-time
            {
                margin-left: -1.8em;
                margin-top: -1.5em !important;
            }
            .popover_for_start-time
            {
                margin-top: -3em !important;
                margin-left: -9em;
            }
            .popover_for_start-time > .arrow, .popover_for_end-time > .arrow
            {
                display: none;
            }
            .inner_buttons_add
            {
                position: relative;
                top: -4em;
                clear: both;
            }
            .inner_buttons_add button
            {
                width: 90%;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            #button66, #button666
            {
                width: 80%;
                display: block;
                position: relative;
                margin-top: 3em;
                margin-bottom: 2em;
            }
            .edit_checklist_name
            {
                font-size: 2.0em;
                background: #5A5A5A;
                text-indent: 0.4em;
                padding-bottom: 0.1em;
                padding-top: 0.1em;
                border-radius: 0.15em;
            }
            .edit_checklist_actions_btns
            {
                top: -4em;
                border-radius: 0.15em;
                position: relative;
                float: right;
                background: #389BA4;
                padding-left: 0.75em;
                padding-right: 0.75em;
                min-height: 1.5em;
                min-width: 7.5em;

            }
            .manageclistrow > hr
            {
                clear: both;
            }
            .edit_checklist_actions_btns .glyphicon
            {
                cursor: pointer;
                text-shadow: 0px 0px 0.1em #000;
                padding-right: 0.5em;
            }
            .edit_checklist_actions_btns .glyphicon:hover
            {
                text-shadow: 0px 0px 0.4em #000;
                -webkit-transition: all 0.5s ease-out;  /* Android 2.1+, Chrome 1-25, iOS 3.2-6.1, Safari 3.2-6  */
                transition: all 0.5s ease-out;  /* Chrome 26, Firefox 16+, iOS 7+, IE 10+, Opera, Safari 6.1+  */
            }
            .edit_active_filters_ul
            {
                list-style-type: none;
                width: 40%;
            }
            .edit_potential_filters  ul
            {
                list-style-type: none;
                width: 40%;
            }
            .edit_filters_potential ul
            {
                list-style-type: none;
            }
            .edit_active_filters_ul li
            {
            }
            #plus_new_q
            {
                width: 97%;
                margin-left: auto;
                margin-right: auto;
                display: block;
            }
            .questioneditor_inner_view_main
            {
                  margin-top: 3em;
            }
            .question_row
            {
                left: 1em;
                position: relative;
                width: 98%;
                background: #645D5D;
                border-radius: 0.5em;
                padding-top: 0.5em;
                margin-bottom: 1.25em;
                box-shadow: 0px 0px 0.25em #000;
                -webkit-transition: all 0.5s ease-out;  /* Android 2.1+, Chrome 1-25, iOS 3.2-6.1, Safari 3.2-6  */
                transition: all 0.5s ease-out;  /* Chrome 26, Firefox 16+, iOS 7+, IE 10+, Opera, Safari 6.1+  */
            }
            .question_row:hover
            {
                box-shadow: 0px 0px 0.5em #000;
            }
            .question_type_dropdown
            {
                top: -0.25em;
            }
            .grid_icon
            {
                font-size: 5em;
                color: #0BFBBC;
            }
            #icon_grid
            {
                text-align: center;
                margin-top: 50px;
                margin-left: -1em;
            }
            #checklist_builder
            {
                display: none;
            }
            .grid_icon_wrapper
            {
                cursor: pointer;
                width: 8em;
                margin-left: auto;
                margin-right: auto;
                padding-top: 1.25em;
                padding-bottom: 1em;
                padding-right: 0.5em;
                border-radius: 1.5em;
                background-color: #171617;
                background-image: -webkit-linear-gradient(top, #171617, #2e2e2e);
                background-image: linear-gradient(to bottom, #171617, #2e2e2e);
                box-shadow: 0px 0px 0.1em #000;
                text-shadow: 0px 0px 0.05em #000;
                position: relative;
            }
            .grid_icon_wrapper:hover
            {
                box-shadow: 0px 0px 0.5em #000;
                text-shadow: 0px 0px 0.2em #000;
                color: #F6F5EF;
                -webkit-transition: all 0.3s ease-out;
                transition: all 0.3s ease-out;
            }
            .grid_icon_wrapper .glyphicon-paste
            {
                top: -0.05em;
                left: 0.075em;
            }
            .action_name
            {
                cursor: default;
                -webkit-user-select: none;
                margin-left: auto;
                margin-right: auto;
                /*background: #216980;*/
                width: auto;
                display: inline-block;
                padding-left: 1em;
                padding-right: 1em;
                text-shadow: 0px 0px 0.1em #000;
                margin-top: 1em;
                box-shadow: 0px 0px 1px #000;
                margin-bottom: 3em;
            }
            .badge
            {
                    left: 5.5em;
                    position: relative;
                    top: -0.5em;
                    width: 2em;
                    height: 2em;
                    border-radius: 1em;
                    line-height: 1.5em;
                    text-indent: 0.1em;
                    background: #DA8C15;
                    text-shadow: 0px 0px 0.1em #000;
                    box-shadow: 0px 0px 0.1em #000000;
                    cursor: pointer;
                    -webkit-transition: all 0.3s ease-out;
                    transition: all 0.3s ease-out;
                    margin-top: -2em;
                    z-index: 1;
            }
            .badge:hover
            {
                text-shadow: 0px 0px 0.15em #000;
                box-shadow: 0px 0px 0.2em #000;
            }
            .badgered
            {
                background: #DB2F38;
                left: 6em;
            }
            .special_treatment_badge
            {
                text-indent: 0em;
                text-indent: -0.1em;
            }
            .pp_parent_div
            {
                margin-top: -2em;
            }
            .packet_list_item_container
            {
                border: 1px solid rgba(34, 233, 185, 0.17);
                padding: 1em;
            }
            .cust_name_pp_list
            {
                cursor: pointer;
                left: 2.2em;
                position: relative;
                line-height: 1em;
                float: left;
            }
            .pp_list_item_icons
            {
                float: left;
            }
            .pp_list_item_icons .glyphicon-warning-sign
            {
                color: yellow;
                left: 0.5em;
            }
            .pp_list_item_icons .glyphicon-trash
            {
                cursor: pointer;
            }
            #preview_form .control-label
            {
                text-align: left;
            }
            #preview_form .dropdown
            {
                top: 0.6em;
            }
            .outstanding_submit_div
            {
                margin-top: 5em;
            }
            .outstanding_submit_div .btn
            {
                margin-left: 1em;
            }
            .packet_list_item
            {
                clear: both;
                min-height: 3em;
            }
            .items_attetion_reqd_h2
            {
                margin-bottom: 2em;
            }
            .form-horizontal .checkbox
            {
                margin-bottom: 1em;
            }
            .pp_submit_btns
            {
                margin-left: 0.1em;
            }
            .pp_submit_btns .btn-danger
            {
                margin-left: 1em;
            }
            #pp_list_back_btn
            {
                margin-top: 5em;
                width: 100%;
            }
            .lbl_div_rep_pp
            {
                top: 2.5em;
                position: relative;
            }
            .lbl_div_rep_pp .label
            {
                text-shadow: 0px 0px 0.075em #000000;
                -webkit-user-select: none;
                cursor: default;
            }
            .lbl_div_rep_pp .label-success
            {
                background-color: #555356;
                background: #555356;
            }
            .lbl_div_rep_pp .lblthree
            {
                position: relative;
            }
            .lbl_div_rep_pp .lblone
            {
                position: relative;
            }
            @media(max-width:767px)
            {
                .pp_line_pp_dollar, #pp_line_pp_dollar
                {
                    margin-top: 0.5em;
                }
                .pp_check
                {
                    background-image: -webkit-linear-gradient(top, #ffffff, #E8E5E5);
                    background-image:        -linear-gradient(top, #ffffff, #E8E5E5);
                    padding-top: 1em;
                    color: #222222;
                    position: relative;
                    box-shadow: inset 0px 0px 1em #000;
                    padding-bottom: 0.5em;
                }
                .pp_dollar_hdr_cont
                {
                    display: inline-block;
                    text-align: right;
                    width: 30%;
                }
                .pp_hdr
                {
                    font-size: 1em;
                }
                .pp_dt
                {
                    margin-left: 70%;
                }
                .pp_dt_line
                {
                    width: 25%;
                }
                .pp_input_spacer
                {
                    margin-left: 4%;
                }
                .pp_line,
                .pp_line3
                {
                    margin-top: -0.3em;
                    border-top: 2px solid #222;
                    padding-bottom: 1.2em;
                }
                .pp_line2
                {
                    margin-top: -0.1em;
                    border-top: 2px solid #222;
                }
                .pp_line3
                {
                    padding-bottom: 0.8em;
                }
                .pp_input
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                }
                .pp_input2
                {
                    font-family: 'Permanent Marker', serif;
                    font-size: 1em;j
                }
                .pp_input3
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    opacity: 0.92;
                    padding-left: 0.25em;
                }
                .pp_fixed
                {
                    height: 4em;
                    display: inline-block;
                }
                .dollar_word
                {
                      font-size: 0.8em;
                }
                .pp_pay_order
                {
                    margin-left: 5%;
                    width: 78%;
                    display: inline-block;
                }
                .pp_dollar_word
                {
                    width: 65%;
                    display:inline-block;
                }
                .pp_dollar
                {
                    margin-left: 5%;
                    width: 90%;
                }
                .pp_dollar_amnt
                {
                    display: inline;
                }
                .pp_dollar_box
                {
                    padding-left: 0.5em;
                    padding-right: 0.5em;
                    box-shadow: 0 0 1px #000;
                    font-size: 1em;
                }
                .pp_dollar_hdr
                {
                    margin-left: 40%;
                }
                .pp_for_sig_div
                {
                    margin-left: 5%;
                }
                .pp_check_logo
                {
                    position: absolute;
                    top: 0;
                    left: 2em;
                    width: 22%;
                }
                .pp_for
                {
                    width: 60%;
                    display: inline-block;
                }
                .pp_sig
                {
                    width: 30%;
                    display: inline-block;
                    margin-left: 5%;
                }
                .pp_fourth_spacer
                {
                    width: 5%;
                }
                .routing_div,
                .acc_div
                {
                    display: inline-block;
                    width: 20%;
                }
                .routing_div
                {
                    margin-left: 5%;
                }
                .acc_div
                {
                    margin-left: 16.5%;
                }
                .check_div
                {
                    display: inline-block;
                    margin-left: 5%;
                    width: 15%;
                }
                .pp_nums
                {
                    font-size: 2em;
                    font-weight: bold;
                    letter-spacing: 4px;
                    margin-top: -1em;
                }

                .and_qualifier
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                }
                .cents_written_out
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                    top: -0.75em;
                    position: relative;
                }
                .cent_divisor
                {
                    font-weight: bold;
                    font-size: 1.5em;
                    position: relative;
                    top: -0.25em;
                }
                .out_of_one_hundred
                {
                    font-weight: bold;
                    font-size: 1em;
                    position: relative;
                    font-family: "Permanent Marker", cursive;
                    top: -0.1em;
                }
                .cust_name_pp_list
                {
                    font-size: 1em;
                }
                .lbl_div_rep_pp .lblone
                {
                    position: relative;
                    left: 7em;
                }
                .lbl_div_rep_pp .lbltwo
                {
                    position: relative;
                    float: right;
                    top: 2em;
                    right: 1em;
                }
                .lbl_div_rep_pp .lblthree
                {
                    float: right;
                    margin-right: 1em;
                    margin-top: 0em;
                    clear: both;
                    position: relative;
                    top: -1.75em;
                }
                .cust_date
                {
                    float: right;
                    position: relative;
                    font-size: 0.85em;
                    line-height: 1.6em;
                    color: #6ABCA5;
                    left: 0em;
                    cursor: default;
                    -webkit-user-select: none;
                }
                .mr
                {
                    margin-right: 0em;
                    float: right;
                    left: 5.1em;
                    top: 1.5em;
                }
                .packet_list_item_container
                {
                    margin-top: 4em;
                }
                .items_attetion_reqd_h2
                {
                    width: 95%;
                    position: relative;
                    left: 2.5%;
                }
                #preview_form
                {
                      width: 95%;
                      position: relative;
                      left: 2.5%;
                }
                .thx
                {
                    font-size: 0.85em;
                }
                .routing_div, .acc_div, .check_div
                {
                    font-size: 0.5em;
                }
                .lbl_div_rep_pp_rejected .lblone
                {
                    left: 4em;
                }
                .lbl_div_rep_pp_rejected .lbltwo
                {
                    left: -0.5em;
                }
                .lbl_div_rep_pp_rejected .lblthree
                {
                    margin-right: 2.75em;
                    left: 3em;
                }
                .rejected_packet_list_item_container .mr
                {
                    margin-right: 1em;
                }
                .rejected_packet_list_item_container .cust_name_pp_list
                {
                    left: 0em;
                }
                .rejected_packet_list_item_container .cust_date
                {
                    left: -1em;
                }
                .rejected_packet_list_item_container .cust_date_rejection
                {
                    left: 5.1em;
                    margin-top: 0.5em;
                }
                .packet_list_item
                {
                    margin-bottom: 2em;
                    border-bottom: 1px solid rgba(106, 188, 165, 0.3);
                    padding-bottom: 4em;
                }
            }
            @media(min-width:768px)
            {
                .pp_line_pp_dollar, #pp_line_pp_dollar
                {
                    margin-top: 0.5em;
                }
                .pp_check
                {
                    background-image: -webkit-linear-gradient(top, #ffffff, #E8E5E5);
                    background-image:        -linear-gradient(top, #ffffff, #E8E5E5);
                    padding-top: 1em;
                    color: #222222;
                    position: relative;
                    box-shadow: inset 0px 0px 1em #000;
                    padding-bottom: 0.5em;
                }
                .pp_dollar_hdr_cont
                {
                    display: inline-block;
                    text-align: right;
                    width: 30%;
                }
                .pp_hdr
                {
                    font-size: 1em;
                }
                .pp_dt
                {
                    margin-left: 70%;
                }
                .pp_dt_line
                {
                    width: 25%;
                }
                .pp_input_spacer
                {
                    margin-left: 4%;
                }
                .pp_line,
                .pp_line3
                {
                    margin-top: -0.6em;
                    border-top: 2px solid #222;
                    padding-bottom: 1.2em;
                }
                .pp_line2
                {
                    margin-top: -0.1em;
                    border-top: 2px solid #222;
                }
                .pp_line3
                {
                    padding-bottom: 0.8em;
                }
                .pp_input
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                }
                .pp_input2
                {
                    font-family: 'Permanent Marker', serif;
                    font-size: 1.5em;j
                }
                .pp_input3
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    opacity: 0.92;
                    padding-left: 0.25em;
                }
                .pp_fixed
                {
                    height: 4em;
                    display: inline-block;
                }
                .dollar_word
                {
                      font-size: 0.8em;
                }
                .pp_pay_order
                {
                    margin-left: 5%;
                    width: 78%;
                    display: inline-block;
                }
                .pp_dollar_word
                {
                    width: 65%;
                    display:inline-block;
                }
                .pp_dollar
                {
                    margin-left: 5%;
                    width: 90%;
                }
                .pp_dollar_amnt
                {
                    display: inline;
                }
                .pp_dollar_box
                {
                    padding-left: 1em;
                    padding-right: 1em;
                    box-shadow: 0 0 1px #000;
                    font-size: 1em;
                }
                .pp_dollar_hdr
                {
                    margin-left: 40%;
                }
                .pp_for_sig_div
                {
                    margin-left: 5%;
                }
                .pp_check_logo
                {
                    position: absolute;
                    top: 0;
                    left: 2em;
                    width: 22%;
                }
                .pp_for
                {
                    width: 60%;
                    display: inline-block;
                }
                .pp_sig
                {
                    width: 30%;
                    display: inline-block;
                    margin-left: 5%;
                }
                .pp_fourth_spacer
                {
                    width: 5%;
                }
                .routing_div,
                .acc_div
                {
                    display: inline-block;
                    width: 20%;
                }
                .routing_div
                {
                    margin-left: 5%;
                }
                .acc_div
                {
                    margin-left: 16.5%;
                }
                .check_div
                {
                    display: inline-block;
                    margin-left: 5%;
                    width: 15%;
                }
                .pp_nums
                {
                    font-size: 2em;
                    font-weight: bold;
                    letter-spacing: 4px;
                    margin-top: -1em;
                }

                .and_qualifier
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                }
                .cents_written_out
                {
                    font-size: 1em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                    top: -0.75em;
                    position: relative;
                }
                .cent_divisor
                {
                    font-weight: bold;
                    font-size: 1.5em;
                    position: relative;
                    top: -0.25em;
                }
                .out_of_one_hundred
                {
                    font-weight: bold;
                    font-size: 1em;
                    position: relative;
                    font-family: "Permanent Marker", cursive;
                    top: -0.1em;
                }
                .cust_name_pp_list
                {
                    font-size: 1.25em;
                }
                .lbl_div_rep_pp .lblone
                {
                    position: relative;
                    left: 7.75em;
                }
                .lbl_div_rep_pp .lbltwo
                {
                    position: relative;
                    left: 27em;
                }
                .lbl_div_rep_pp .lblthree
                {
                    float: right;
                    margin-top: 0.3em;
                    left: 2.25em;
                }
                .cust_date
                {
                    float: right;
                    position: relative;
                    font-size: 0.85em;
                    line-height: 1.6em;
                    color: #6ABCA5;
                    left: 0em;
                    cursor: default;
                    -webkit-user-select: none;
                }
                .mr
                {
                    margin-right: 1em;
                }
                .packet_list_item_container
                {
                    margin-top: 2em;
                }

                .items_attetion_reqd_h2
                {
                    width: 95%;
                    position: relative;
                    left: 2.5%;
                }
                #preview_form
                {
                      width: 95%;
                      position: relative;
                      left: 2.5%;
                }
                .thx
                {
                    font-size: 0.85em;
                }
                .routing_div, .acc_div, .check_div
                {
                    font-size: 0.5em;
                }
                .lbl_div_rep_pp_rejected .lblone
                {
                    left: 4em;
                }
                .lbl_div_rep_pp_rejected .lbltwo
                {
                    left: 30.75em;
                }
                .lbl_div_rep_pp_rejected .lblthree
                {
                    margin-right: 2.75em;
                    left: 3em;
                }
                .rejected_packet_list_item_container .mr
                {
                    margin-right: 1em;
                }
                .rejected_packet_list_item_container .cust_name_pp_list
                {
                    left: 0em;
                }
                .rejected_packet_list_item_container .cust_date
                {
                    left: -1em;
                }

            }
            @media(min-width:992px)
            {
                .pp_line_pp_dollar, #pp_line_pp_dollar
                {
                    margin-top: -0.6em;
                }
                .pp_check
                {
                    background-image: -webkit-linear-gradient(top, #ffffff, #E8E5E5);
                    background-image:        -linear-gradient(top, #ffffff, #E8E5E5);
                    padding-top: 1em;
                    color: #222222;
                    position: relative;
                    box-shadow: inset 0px 0px 1em #000;
                    padding-bottom: 0.5em;
                }
                .pp_dollar_hdr_cont
                {
                    display: inline-block;
                    text-align: right;
                    width: 30%;
                }
                .pp_hdr
                {
                    font-size: 1em;
                }
                .pp_dt
                {
                    margin-left: 70%;
                }
                .pp_dt_line
                {
                    width: 25%;
                }
                .pp_input_spacer
                {
                    margin-left: 5%;
                }
                .pp_line,
                .pp_line3
                {
                    margin-top: -0.6em;
                    border-top: 2px solid #222;
                    padding-bottom: 1.2em;
                }
                .pp_line2
                {
                    margin-top: -0.1em;
                    border-top: 2px solid #222;
                }
                .pp_line3
                {
                    padding-bottom: 0.8em;
                }
                .pp_input
                {
                    font-size: 2em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                }
                .pp_input2
                {
                    font-family: 'Permanent Marker', serif;
                    font-size: 1.8em;j
                }
                .pp_input3
                {
                    font-size: 2em;
                    font-family: 'Permanent Marker', cursive;
                    opacity: 0.92;
                    padding-left: 0.25em;
                }
                .pp_fixed
                {
                    height: 4em;
                    display: inline-block;
                }
                .dollar_word
                {
                      font-size: 0.8em;
                }
                .pp_pay_order
                {
                    margin-left: 5%;
                    width: 78%;
                    display: inline-block;
                }
                .pp_dollar_word
                {
                    width: 65%;
                    display:inline-block;
                }
                .pp_dollar
                {
                    margin-left: 5%;
                    width: 90%;
                }
                .pp_dollar_amnt
                {
                    display: inline;
                }
                .pp_dollar_box
                {
                    padding-left: 1em;
                    padding-right: 1em;
                    box-shadow: 0 0 1px #000;
                    font-size: 1.5em;
                }
                .pp_dollar_hdr
                {
                    margin-left: 40%;
                }
                .pp_for_sig_div
                {
                    margin-left: 5%;
                }
                .pp_check_logo
                {
                    position: absolute;
                    top: 0;
                    left: 2em;
                    width: 22%;
                }
                .pp_for
                {
                    width: 60%;
                    display: inline-block;
                }
                .pp_sig
                {
                    width: 30%;
                    display: inline-block;
                    margin-left: 5%;
                }
                .pp_fourth_spacer
                {
                    width: 5%;
                }
                .routing_div,
                .acc_div
                {
                    display: inline-block;
                    width: 20%;
                }
                .routing_div
                {
                    margin-left: 5%;
                }
                .acc_div
                {
                    margin-left: 16.5%;
                }
                .check_div
                {
                    display: inline-block;
                    margin-left: 5%;
                    width: 15%;
                }
                .pp_nums
                {
                    font-size: 2em;
                    font-weight: bold;
                    letter-spacing: 4px;
                    margin-top: -1em;
                }

                .and_qualifier
                {
                    font-size: 1.5em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                }
                .cents_written_out
                {
                    font-size: 1.5em;
                    font-family: 'Permanent Marker', cursive;
                    word-spacing: 5px;
                    margin-left: 1em;
                    top: -0.75em;
                    position: relative;
                }
                .cent_divisor
                {
                    font-weight: bold;
                    font-size: 2em;
                    position: relative;
                    top: -0.25em;
                }
                .out_of_one_hundred
                {
                    font-weight: bold;
                    font-size: 1.25em;
                    position: relative;
                    font-family: "Permanent Marker", cursive;
                    top: -0.1em;
                }
                .cust_name_pp_list
                {
                    font-size: 1.25em;
                }
                .lbl_div_rep_pp .lblone
                {
                    position: relative;
                    left: 7.8em;
                }
                .lbl_div_rep_pp .lbltwo
                {
                    position: relative;
                    left: 36em;
                }
                .lbl_div_rep_pp .lblthree
                {
                    float: right;
                    margin-right: 6.5em;
                    margin-top: 0.25em;
                }
                .cust_date
                {
                    float: right;
                    position: relative;
                    font-size: 0.85em;
                    line-height: 1.6em;
                    color: #6ABCA5;
                    left: -5.7em;
                    cursor: default;
                    -webkit-user-select: none;
                }
                .mr
                {
                    margin-right: 2.9em;
                }
                .packet_list_item_container
                {
                    margin-top: 2em;
                }
                .items_attetion_reqd_h2
                {
                    width: 100%;
                    position: relative;
                    left: 0%;
                }
                #preview_form
                {
                      width: 95%;
                      position: relative;
                      left: 2.5%;
                }
                .thx
                {
                    font-size: 1.5em;
                }
                .routing_div, .acc_div, .check_div
                {
                    font-size: 0.7em;
                }
                .lbl_div_rep_pp_rejected .lblone
                {
                    left: 4.1em;
                }
                .lbl_div_rep_pp_rejected .lbltwo
                {
                    left: 48.5em;
                }
                .lbl_div_rep_pp_rejected .lblthree
                {
                    margin-right: 2.75em;
                    left: 3em;
                }
                .rejected_packet_list_item_container .mr
                {
                    margin-right: 1em;
                }
                .rejected_packet_list_item_container .cust_name_pp_list
                {
                    left: 0em;
                }
                .rejected_packet_list_item_container .cust_date
                {
                    left: -1em;
                }
            }
            @media(min-width:1200px)
            {
                .pp_line_pp_dollar, #pp_line_pp_dollar
                {
                    margin-top: -0.6em;
                }
                .cust_name_pp_list
                {
                    font-size: 1.25em;
                }
                .lbl_div_rep_pp .lblone
                {
                    position: relative;
                    left: 7.8em;
                }
                .lbl_div_rep_pp .lbltwo
                {
                    position: relative;
                    left: 51.5em;
                }
                .lbl_div_rep_pp .lblthree
                {
                    float: right;
                    margin-right: 6.5em;
                    margin-top: 0.25em;
                }
                .cust_date
                {
                    float: right;
                    position: relative;
                    font-size: 0.85em;
                    line-height: 1.6em;
                    color: #6ABCA5;
                    left: -5.5em;
                    cursor: default;
                    -webkit-user-select: none;
                }
                .mr
                {
                    margin-right: 3em;
                }
                .packet_list_item_container
                {
                    margin-top: 2em;
                }
                .items_attetion_reqd_h2
                {
                    width: 100%;
                    position: relative;
                    left: 0%;
                }
                #preview_form
                {
                      width: 100%;
                      position: relative;
                      left: 0%;
                }
                .thx
                {
                    font-size: 1.5em;
                }

                .routing_div, .acc_div, .check_div
                {
                    font-size: 0.8em;
                }
                .lbl_div_rep_pp_rejected .lblone
                {
                    left: 4em;
                }
                .lbl_div_rep_pp_rejected .lbltwo
                {
                    left: 64em;
                }
                .lbl_div_rep_pp_rejected .lblthree
                {
                    margin-right: 2.75em;
                    left: 3em;
                }
                .rejected_packet_list_item_container .mr
                {
                    margin-right: 1em;
                }
                .rejected_packet_list_item_container .cust_name_pp_list
                {
                    left: 0em;
                }
                .rejected_packet_list_item_container .cust_date
                {
                    left: -1em;
                }

            }
            @media(min-width: 845px) and (max-width: 1091px)
            {
                .pp_line_pp_dollar, #pp_line_pp_dollar
                {
                    margin-top: 0.5em !important;
                }
            }
            .pp_line3_pp_for, .pp_line3_pp_sig
            {
                margin-top: 0.1em !important;
            }
            .rejected_packets_lbl
            {
                cursor: pointer;
                color: #FFFFFF;
                -webkit-user-select: none;
                float: right;
                font-size: 1.25em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .rej_header_rep_msg
            {
                text-align: center;
                font-size: 1.2em;
                width: 90%;
            }
            .reason_reason
            {
                width: 90%;
                margin-left: 2em;
                position: relative;
                font-style: italic;
                letter-spacing: 1px;
            }
            .address_rejected_pp_row > div
            {
                  width: 95%;
                  margin-left: auto;
                  margin-right: auto;
            }
            .response_reason
            {
                background: #585555;
                color: #E8E8E8;
                width: 25em;
                height: 5em;
                margin-top: 1em;
                border: 0px solid #000000;
                padding: 0.5em;
            }
            .rej_screen_action_btns .btn-danger
            {
                margin-left: 1em;
            }
            #perfect_packet_paycheck
            {
                    -ms-transform: rotate(-90deg) scaleY(-1);
                -webkit-transform: rotate(-90deg) scaleY(-1);
                        transform: rotate(-90deg) scaley(-1);
                left: 0.025em;
            }
            .perfect_packet_usd_cont
            {
                width: 90%;
                position: absolute;
                top: 40%;
                left: -0.25em;
            }
            .perfect_packet_usd
            {
                font-size: 3em;
                color: #006400;
            }
            .bd_description_header
            {
                text-align: left;
                color: #F4801F;
            }
            .bd_date_applied_header
            {
                text-align: right;
                color: #F4801F;
            }
            .bd_amount_header
            {
                text-align: right;
                color: #F4801F;
            }
            .bd_description
            {
                text-align: justify;
                font-size: 0.9em;
                margin-bottom: 2em;
                padding-bottom: 0.5em;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }
            .bd_date_applied
            {
                text-align: right;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }
            .bd_amount
            {
                text-align: right;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }
            .main_bd
            {
                display: none;
                background: #2A2323;
                margin-top: 0.5em;
                box-shadow: inset 0px 0px 0.5em #000000;
            }
            .show_bd
            {
                background-color: #1B86B5;
                box-shadow: 0px 0px 0.1em #000000;
                font-size: 1.5em;
                text-align: center;
                width: 85%;
                margin-left: auto;
                margin-right: auto;
                display: block;
                position: relative;
                text-shadow: 0px 0px 0.05em #000;
                margin-top: 0.5em;
                left: -1%;
                -webkit-user-select: none;
                cursor: pointer;
            }
            .centered_bd_header
            {
                text-align: center;
                background: #0E8AAE;
                text-shadow: 0px 0px 0.05em #000;
            }
            .grid_icon_wrapper .glyphicon-time
            {
                left: 0.025em;
            }
            .export_overlay_div
            {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background: #000000;
                background: rgba(0, 0, 0, 0.9);
            }
            .export_overlay_div .btn
            {
                width: 50%;
                height: 5em;
                top: 5em;
                position: relative;
                margin-left: auto;
                margin-right: auto;
                display: block;
                font-size: 2em;
                background-color: #CB8211;
                text-shadow: 0px 0px 0.1em #000000;
            }
            .paycheck_back_btn
            {
                width: 50%;
                margin-left: auto;
                margin-right: auto;
                display: block;
                position: relative;
                top: 5em;
                height: 3em;
            }
            .bd_negative
            {
                color: #FFF141;
            }
            .bancirclered
            {
                color: #FF7777;
            }
            #landscape_reqd
            {
                display: none;
                position: absolute;
                z-index: 999;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                -webkit-user-select: none;
                cursor: default;
            }
            .grid_icon_wrapper_special_treatment
            {
                top: 0.25em;
            }
            .grid_icon_wrapper_special_treatment .action_name
            {
                top: 0.25em;
                position: relative;
            }
            .fc-today-button
            {
                display: none;
            }
            .fc-day-grid
            {
                /*display: none;*/
            }
            .fc-time-grid .fc-slats td
            {
                height: 5em;
                min-height: 5em;
            }
            .fc-unthemed .fc-today
            {
                background: #484847;
            }
            .fc-event
            {
                border: 1px solid #000000;
                background-color: #117B29;
                font-weight: 400;
                padding-top: 0.5em;
                padding-left: 0.5em;
            }
            .cal_back .btn-danger
            {
                width: 7.5em;
                margin-bottom: 1em;
                left: 1.15em;
                position: relative;
            }
            .cal_back .glyphicon-list-alt, .cal_back .glyphicon-calendar
            {
                font-size: 2em;
                float: right;
                margin-right: 0.5em;
                cursor: pointer;
            }
            .cal_back .glyphicon-calendar
            {
                display: none;
            }
            .sp2_title
            {
                text-align: center !important;
                margin-top: 0em !important;
            }
            #sp2_lst > .row
            {
                border: 1px solid rgba(34, 189, 233, 0.2);
                padding-top: 1em;
                padding-bottom: 1em;
            }
            .sp2_divider
            {
                width: 100%;
                height: 2px;
                min-height: 2px;
                background: rgba(45, 202, 126, 0.15);
                clear: both;
                position: relative;
                margin-top: 50px;
                margin-bottom: 1em;
            }
            .pending_rej_archive
            {
                float: left;
                top: 0.1em;
                margin-right: 1em;
                cursor: pointer;
            }
            #amnt_in
            {
                width: 140px;
            }
            .reimbursement_desc
            {
                background-color: #575757;
                border: 0px solid #000;
                padding: 0.5em;
            }
            .amnt_cnt
            {
                display: inline-block;
                width: 200px;
                vertical-align: middle;
                padding-bottom: 2em;
            }
            .desc_cnt
            {
                display: inline-block;
                padding-bottom: 2em;
            }
            .file_cnt
            {
                margin-bottom: 15px;
            }
            .paycheck_reimburse_btn
            {
                margin-left: auto;
                margin-right: auto;
                display: block;
                position: relative;
                top: 1em;
                left: 33.5%;
            }
            .glyphicon-camera
            {
                color: #FB8A0B;
                font-size: 5em;
                cursor: pointer;
                float: left;
            }
            #file_sel_confirm
            {
                top: -1.25em;
                position: relative;
                display: block;
                left: -5em;
                color: #FFF;
                display: none;
                float: left;
            }
            #reimbursement_form
            {
                margin-top: 15px;
            }
            #reimbursement_form .glyphicon-camera
            {
                top: -0.2em;
            }
            .reimbursement_cancel
            {
                margin-left: 1em;
            }
            #reimbursement_form #file_sel_confirm
            {
                top: -3em;
            }
            #customer_notes
            {
                font-family: 'Symbola', 'Unicode', Arial;
                height: 1em;
                position: relative;
                left: -0.1em;
            }
            .cust_note_container_list, .cust_hold_container_list
            {
                border: 1px solid rgba(34, 233, 185, 0.17);
                padding: 1em;
                margin-top: 2em;
                clear: both;
            }
            .cust_name_cust_note_list, .cust_name_cust_hold_list
            {
                font-size: 1.25em;
                border-bottom: 1px solid rgba(10,170,239,0.25);
                padding-bottom: 0.5em;
                margin-bottom: 0.5em;
                cursor: pointer;
            }
            .cust_note_details
            {
                background-color: rgba(0, 0, 0, 0.45);
                padding-left: 1em;
                top: -0.75em;
                position: relative;
                padding-bottom: 1em;
            }
            .new_note_actual_content
            {
                width: 94%;
                position: relative;
                display: block;
                background: rgba(25,23,23,0.45);
                left: 3%;
                margin-top: 1em;
                padding: 1em;
                padding-bottom: 7em;
            }
            .new_note_actual_content textarea
            {
                width: 100%;
                background: #353535;
                border: 0px;
                padding: 0.5em;
                height: 10em;
                box-shadow: 0px 0px 1px rgba(255, 255, 255, 0.25);
            }
            .plus_new_note_div .btn-primary, .new_note_actual_content .btn-primary
            {
                background: #353535;
                text-shadow: 0px 0px 0.1em #000;
            }
            .camera-note-div
            {
                float: right;
            }
            #customer_notes_post_note_btn
            {
                float: left;
                top: 0.5em;
                position: relative;
            }
            .note_detail_content img
            {
                display: block;
                position: relative;
                width: 25%;
                clear: both;
                margin-bottom: 1em;
            }
            .note_author_timestamp
            {
                background: rgba(10,170,239,0.25);
                text-indent: 0.25em;
                left: -1em;
                position: relative;
                margin-top: 1em;
            }
            .cust_prog_div > .customer_progress_outer > .col-xs-12
            {
                border: 1px solid rgba(26, 218, 122, 0.3);
                padding-top: 1em;
                padding-bottom: 1em;
                margin-top: 1em;
            }
            .cust_prog_cust_name
            {
                width: 86.7%;
                border-bottom: 1px solid rgb(54, 77, 109);
                padding-bottom: 0.75em;
                border-top: 1px solid rgb(54, 77, 109);
                padding-top: 0.25em;
                padding-left: 0.25em;
                text-shadow: 0px 0px 0.1em #000;
                -webkit-user-select: none;
                cursor: pointer;
                border-bottom: 0px solid #000000;
                border-top: 0px solid #000000;
            }
            .cust_prog_cust_name_actual
            {
                background: #436988;
                padding-left: 0.5em;
                padding-right: 0.5em;
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                margin-top: 0.25em;
                display: inline-block;
            }
            .cust_prog_div .cust_prog_days_since, .cust_prog_div .permit_rej_cnt
            {
                display: inline-block;
                min-width: 10px;
                padding: 3px 7px;
                font-size: 12px;
                font-weight: 700;
                line-height: 1;
                color: #fff;
                text-align: center;
                white-space: nowrap;
                vertical-align: baseline;
                background-color: #777;
                border-radius: 10px;
                height: 2.25em;
                border-radius: 0em;
                top: -0.1em;
                position: relative;
                line-height: 1.75em;
                text-shadow: 0px 0px 0.1em #000000;
            }
            .cust_prog_div .cust_prog_days_since
            {
                float: left;
                top: 0.3em;
            }
            .in_the_red
            {
                background: #D04B4B !important;
            }
            .in_the_yellow
            {
                background: #CEC01B !important;
                color: #403D3D !important;
                text-shadow: 0px 0px 0px #000 !important;
            }
            .in_the_green
            {
                background: #059454 !important;
            }
            .seventy_five_percent
            {
                width: 75%;
            }
            .sixty_percent
            {
                width: 60%;
            }
            .forty_five_percent
            {
                width: 45%;
            }
            .progression_arrow
            {
                font-size: 3em;
                line-height: 0em;
                position: relative;
                display: inline-block;
                background-color: #108444;
                padding-bottom: 0.3em;
                float: right;
            }
            .progression_arrow:hover, .progression_arrow:active, .progression_arrow:focus
            {
                background-color: #108444 !important;
            }
            .cust_prog_div .badge
            {
                left: 0em;
                width: auto;
                text-indent: 0em;
                margin-top: 0em;
            }
            .cust_prog_div .glyphicon-info-sign
            {
                display: none;
            }
            .panel_cp_util_provider
            {
                display: block;
                left: 2em;
                position: relative;
                background: #232121;
                width: 60%;
                height: 2em;
                padding-top: 0.25em;
                padding-left: 0.3em;
            }
            .date-scheduled
            {
                display: block;
                position: relative;
                background: #232121;
                width: 6em;
                height: 2em;
                padding-top: 0.25em;
                padding-left: 0.3em;
            }
            #cust_prog_back
            {
                float: right;
                top: -2em;
                position: relative;
            }
            #cust_notes_back
            {
                float: right;
                top: -2em;
                position: relative;
            }
            #sp2_date
            {
                text-indent: 1em;
                position: relative;
                top: 0.5em;
            }
            #sp2_hours, #sp2_mins, #sp2_ampm
            {
                background-color: #575757;
                border: 0;
                color: #D8D1D1;
            }
            .fc-time-grid-event
            {
                cursor: pointer;
            }
            .reschedule-button
            {
                color: #FB8A0B;
                font-size: 1.3em;
                cursor: pointer;
                margin-left: 0.75em;
                top: -0.1em;
            }
            .field_value
            {
                width: 18em;
                margin-right: 1em;
                text-indent: 0.5em;
            }
            .setting_update
            {
                height: 1.75em;
                line-height: 0em;
            }
            .archiving_reason, .saveme_reason
            {
                width: 80%;
                height: 4em;
                padding: 0.25em;
                background-color: #575757;
            }
            .rep_cust_prog_archive_btn
            {
                float: left;
                line-height: 2em;
                width: 2em;
                background: #252323;
                height: 2em;
                text-indent: 0.5em;
                top: 0.22em;
                box-shadow: inset 0px 0px 0.25em #000000;
            }
			.label-followup
            {
                background-color: #277786;
            }
            .followup_labels > .col-xs-4 > .label-warning, .expense_labels > .col-xs-4 > .label-warning
            {
                background-color: #277786;
            }
            .followup_list
            {
                display: inline-table;
                width: 100%;
                margin-bottom: 25px;
            }
            .followup_labels
            {
                display: inline-table;
                width: 100%;
                margin-bottom: 15px;
                font-size: 1.2em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .followup_row
            {
                display: inline-table;
                width: 100%;
                font-size: .95em;
                line-height: 2.35em;
                margin-top: 1.15em;
            }
            .follow_up_btn
            {
                margin-right: 10px;
            }
            .followup_container
            {
                border: 1px solid rgba(39,119,134,0.2);
            }
            .q_container
            {
                line-height: 1.10em;
                margin-top: 20px;
                padding: 15px;
            }
            .survey_container
            {
                background: rgba(0, 0, 0, 0.45);
                display: none;
                margin-top: 10px;
            }
            .survey_button_div
            {
                margin-top: 20px;
                margin-bottom: 20px;
            }
            .grid_icon_wrapper_for_customer_holds
            {
                top: -1.5em;
            }
            .held_badge
            {
                left: 4.75em;
                top: 0.15em;
            }
            .rep_holds_ul
            {
                background-color: rgba(10,170,239,0.25);
                position: relative;
                top: -0.75em;
                padding-top: 1em;
                padding-bottom: 1em;
            }
            .action_name_of_customer_holds
            {
                top: -1.5em;
                position: relative;
            }
            .archived_cust_row, .held_cust_row
            {
                width: 100%;
                left: 1em;
                position: relative;
            }
            .archived_cust_row
            {
                border-bottom: 1px solid rgba(26, 218, 122, 0.3);
                /* border-top: 1px solid rgba(26, 218, 122, 0.3); */
                margin-bottom: 0.25em;
                padding-top: 0.5em;
                padding-bottom: 0.5em;
            }
            .archived_cust_row .glyphicon-repeat, .archived_cust_row .glyphicon-question-sign, .held_cust_row .glyphicon-thumbs-up, .held_cust_row .glyphicon-question-sign
            {
                float: right;
                cursor: pointer;
                margin-right: 0.5em;
                left: 0.5em;
                background: rgb(33, 125, 140);
                padding: 0.5em;
                border-radius: 0.25em;
                text-shadow: 0px 0px 0.1em #000000;
            }
            .archived_cust_search_filters input, .held_cust_search_filters input
            {
                margin-right: 1em;
                margin-bottom: 1em;
                text-indent: 0.25em;
                background-color: #575757;
                border: 0;
                color: #D8D1D1;
            }
            .archive_hint, .held_hint
            {
                position: relative;
                left: -0.25em;
                background: rgba(4, 132, 97, 0.28);
                width: 101%;
                margin-top: 1em;
                margin-bottom: 0.5em;
                padding-top: 0.5em;
                box-shadow: inset 0px 0px 5px #000000;
            }
            .badgee
            {
                position: absolute;
                font-size: 0.6em;
                width: 3.5em;
                text-align: center;
                background: #E24646;
                line-height: 1.5em;
                border-radius: 0.5em;
                color: #fff;
                text-shadow: 0px 0px 0.05em #000;
                left: 11em;
                top: 20em;
                visibility: hidden;
            }
            #inbox .glyphicon-refresh
            {
                float: right;
                top: 0.2em;
                visibility: hidden;
            }
            .clist_title .glyphicon-envelope
            {
                color: #1590AF;
                top: 0.15em;
                left: 0.5em;
            }
            .inboxrow .glyphicon-pencil
            {
                font-size: 1.5em;
                float: right;
                top: -3.25em;
                background-color: #EFA946;
                width: 2em;
                text-align: center;
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                border-radius: 0.15em;
                border: 1px inset #000;
                text-shadow: 0px 0px 0.05em #000;
                cursor: pointer;
            }
            .compose_row
            {
                clear: both;
                display: none;
                margin-top: -3em;
                overflow: hidden;
            }
            .inbox_inner_row
            {
                overflow: hidden;
                padding-top: 0em;
                padding-bottom: 0em;
                left: 1.5%;
                position: relative;
                background: #211E1E;
            }
            .hinted_users
            {
                border-top: 1px solid rgba(0, 0, 0, 0.4);
                border-left: 1px solid rgba(0, 0, 0, 0.4);
                border-right: 1px solid rgba(0, 0, 0, 0.4);
                display: none;
                padding: 1em;
                background: #2A3C48;
                top: 5.5em;
                position: absolute;
                box-shadow: inset 0px 0px 0.25em #000;
                position: absolute;
                z-index: 2;
            }
            .hinted_user
            {
                vertical-align: middle;
                display: table-cell;
                float: left;
                clear: both;
                cursor: pointer;
                -webkit-user-select: none;
                text-shadow: 0px 0px 0.1em #000;
                border: 1px solid rgba(0, 0, 0, 0.25);
            }
            .hinted_user img
            {
                width: 20%;
                float: left;
                margin-right: 1em;
                box-shadow: 0px 0px 0.25em #000;
            }
            .hinted_user p
            {
                position: relative;
                top: 0.75em;
            }
            .to_box
            {
                border: 1px solid rgba(0, 0, 0, 0.4);
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                text-indent: 0.5em;
                clear: both;
                margin-top: -1em;
            }
            .compose_row textarea
            {
                width: 100%;
                background: #272525;
                border: 0px;
                padding: 0.5em;
                height: 10em;
                position: relative;
                top: -0.5em;
                z-index: 1;
            }
            .recipients_div
            {
                min-height: 40px;
                margin-bottom: 1em;
            }
            .recipients_div img
            {
                float: left;
                width: 40px;
                margin-right: 5px;
                box-shadow: 0px 0px 0.1em #000;
                position: relative;
                z-index: 54;
            }
            .hinted_users .glyphicon-remove
            {
                float: right;
                position: relative;
                overflow: visible;
                top: -1.4em;
                left: 1.4em;
                color: #CE3F3F;
                border: 1px solid rgba(0, 0, 0, 0.25);
                background: #2A3C48;
            }
            .remove_recipients
            {
                height: 0.8em;
            }
            .remove_recipients .glyphicon-remove
            {
                color: #CE3F3F;
                font-size: 0.8em;
                text-shadow: 0px 0px 0.1em #000;
                top: -5.25em;
                width: 45px;
                z-index: 55;
                cursor: pointer;
                margin-left: 0.2;
                left: -0.1em;
            }
            .compose_row .btn-success, .compose_row .btn-danger
            {
                float: right;
            }
            .compose_row .btn-danger
            {
                left: -0.25em;
                position: relative;
            }
            .msg_file_list, .inline_msg_file_list
            {
                clear: both;
                margin-top: 2em;
            }
            .thread_synopsis
            {
                font-style: italic;
            }
            .msg_icons
            {
                float: right;
            }
            .inbox_thread_item
            {
                margin-top: 0.5em;
                margin-bottom: 0.5em;
                cursor: pointer;
                padding-top: 0.75em;
                background: #313131;
                -webkit-transition: all 0.5s ease-out;  /* Android 2.1+, Chrome 1-25, iOS 3.2-6.1, Safari 3.2-6  */
                transition: all 0.5s ease-out;  /* Chrome 26, Firefox 16+, iOS 7+, IE 10+, Opera, Safari 6.1+  */
            }
            .unread_thread_item
            {
                background: #074C47;
            }
            .inbox_thread_item:hover
            {
                background: #1590AF;
            }
            .inbox_profile_thumb
            {
                position: relative;
                top: -0.35em;
            }
            .msg_attachment .glyphicon-paperclip, .msg_attachment a
            {
                cursor: pointer !important;
            }
            .msg_content hr
            {
                margin-top: 0px;
                margin-bottom: 0px;
                border-top: 1px solid rgba(21,144,175,0.25);
            }
            .inline_content_box
            {
                width: 100%;
                background: #272525;
                border: 0px;
                padding: 0.5em;
                height: 10em;
                position: relative;
                z-index: 1;
            }
            .msg_content .btn
            {
                font-size: 0.75em;
            }
            .msg_content .btn-success, .msg_content .btn-danger
            {
                float: right;
                margin-left: 0.5em;
            }
            .msg_row pre
            {
                word-break: break-all;
                background-color: #DEE09E;
                border: 0px solid #ccc;
                border-radius: 0px;
                overflow: hidden;
                white-space: normal;
                overflow: auto;
            }
            .hinted_users .glyphicon-remove
            {
                cursor: pointer;
            }
            .profile-pic-thumb
            {
                width: 200px;
                height: 200px;
                cursor: pointer;
                box-shadow: 0px 0px 0.25em #000000;
            }
            #profile_pic_save
            {
                margin-top: 1em;
            }
            .profile-pic-div img
            {
                max-width: 40%;
            }
            .profile_pic__preview
            {
                display: none;
            }
            .uploading_photo
            {
              background: rgba(0, 0, 0, 0.75);
              width: 38.1%;
              position: absolute;
              top: 20em;
              padding-top: 2em;
              padding-bottom: 2em;
              text-indent: 1em;
            }
            #lb_trophee
            {
                left: 0.03em;
                position: relative;
            }
            #leaderboard .glyphicon
            {
                font-size: 1.2em;
                margin-left: -0.3em;
                left: 0.3em;
                top: -0.05em;
            }
            .lb_trophy
            {
                font-family: "Symbola", 'Symbola', Symbola, Arial, Helvetica, sans-serif;
            }
            .lb_dds .dropdown
            {
                display: inline-block;
                margin-right: 0.5em;
            }
            .lb_main_div
            {
                border: 1px solid rgba(30, 31, 31, 0.4);
                background: rgba(0, 0, 0, 0.1);
                margin-top: 2em;
            }
            .lb_plain_list
            {
                margin-top: 2em;
                margin-bottom: 0.5em;
            }
            .lb_plain_list > .row
            {
                background: rgba(9,67,74,0.4);
                margin-bottom: 0.25em;
                margin-top: 0.25em;
                box-shadow: inset 0px 0px 0.5em rgba(0,0,0,0.5);
            }
            .pl_ico
            {
                font-family: 'Symbola', Symbola, Arial, Helvetica, sans-serif;
                font-size: 1.5em;
                color: #EC961C;
            }
            .pl_cnt
            {
                font-family: Monospace, monospace, Arial, Helvetica, sans-serif;
                margin-right: 0.5em;
                background: rgba(51,49,49,0.5);
                padding: 0.5em;
                border: 1px solid rgba(0, 0, 0, 0.2);
            }
            .pl_name
            {

            }
            #lb_back
            {
                margin-top: 2em;
            }
            .grid_icon_wrapper_special_treatment_cn
            {
                /*top: -1.5em;*/
            }
            .notes_badge
            {
                background: #6D1B82;
                top: -5em;
                left: 6em;
            }
            .customer_notes_list_item
            {
                text-indent: 0.5em;
            }
            .notes_unread
            {
                background: #AD7611;
                text-shadow: 0px 0px 0.1em #000;
            }
            .notes_unread > p
            {
                top: 0.2em;
                position: relative;
            }
            .clk_notifications
            {
                color: #D0C21A;
                margin-top: 1em;
                cursor: pointer;
            }
            .inner_notification_settings_div
            {
                border: 1px solid rgba(22, 213, 222, 0.5);
                padding-left: 0.5em;
                display: none;
            }
            .noti_action
            {
                clear: both;
                width: 200px;
                float: left;
            }
            .noti_sms
            {
                width: 50px;
                float: left;
            }
            .noti_email
            {
                width: 50px;
                float: left;
                margin-bottom: 0.5em;
            }
            #profile_pic
            {
                clear: both;
            }
            #survey_scheduler
            {
                text-indent: 0.15em;
            }
            .grid_icon_wrapper_special_treatment_usvys
            {
                top: -1.6em;
            }
            .action_name_special_treatment_usvys
            {
                top: -1.75em;
                position: relative;
            }
            .unbooked_badge
            {
                background: #d9534f;
            }
            .scheduler_row .dropdown-toggle
            {
                margin-bottom: 2em;
            }
            .svy_lbl
            {
                color: #5CB85C;
                border: 1px solid rgba(115, 115, 111, 0.55);
                font-size: 0.8em;
            }
            .svy_data
            {
                background: rgba(0, 0, 0, 0.2);
                box-shadow: inset 0px 0px 2px #000;
                padding-top: 0.5em;
                padding-bottom: 0.5em;
            }
            .no_svys
            {
                text-indent: 0.6em;
                background: rgba(0, 0, 0, 0.3);
                margin-top: 1.5em;
            }
            .svy_name, .svy_city, .svy_ltime
            {
                line-height: 2.4em;
                font-size: 0.8em;
            }
            .svy_schedule_btn .data_slot
            {
                font-size: 0.8em;
            }
            #svy_leaddate_desc, #svy_leaddate_asc
            {
                color: #1F6FBD;
                cursor: pointer;
            }
            #svy_leaddate_asc
            {
                margin-left: 1em;
            }
            .svy_name
            {
                clear: both;
            }
            .scheduler_row .glyphicon-calendar
            {
                font-size: 1.8em;
                line-height: 0.5em;
                top: 0.2em;
                color: #5bc0de;
            }
            @media(max-width: 640px)
            {
                .svy_data
                {
                    min-height: 6em;
                }
                .svy_lbl
                {
                    min-height: 2.9em;
                }
                .svy_dt
                {
                    height: 4.75em !important;
                    min-height: 4.75em !important;
                }
            }
            .svy_map
            {
                height: 100%;
            }
            .svy_booking_lbl
            {
                background: #1F6FBD;
                color: #fff;
                text-indent: 0.25em;
                text-shadow: 0px 0px 0em #000;
            }
            .svy_booking_info
            {
                text-indent: 0.25em;
            }
            #svy_sched_form label
            {
                text-align: left;
            }
            #dt_333
            {
                margin-top: 1em;
            }
            #dt_333 #cust_appointment_date
            {
                text-indent: 0.5em;
            }
            .svy_sub_btn
            {
                margin-top: 1em;
                margin-bottom: 1em;
            }
            .data_slot
            {
                margin-left: 0.75em;
            }
            .scheduler_back_btn
            {
                margin-top: 2em;
            }
            .symbola
            {
                font-family: "Symbola", Symbola;
            }
            .pp_floppy
            {
                top: -0.15em;
                left: 0.5em;
                cursor: pointer;
            }
            .cp_floppy
            {
                float: left;
                line-height: 2em;
                width: 2em;
                background: #252323;
                height: 2em;
                text-indent: 0.5em;
                top: 0.22em;
                box-shadow: inset 0px 0px 0.25em #000000;
            }
            .cp_floppy .fa-life-ring
            {
                position: relative;
                left: -0.5em;
                top: -0.1em;
            }
            .save_me_wrapper
            {
                border: 1px solid rgba(15, 236, 155, 0.5);
                padding-left: 1em;
                padding-right: 1em;
                padding-bottom: 1em;
            }
            .saved_item
            {
                background: rgba(0, 0, 0, 0.2);
                min-height: 2.5em;
            }
            .saved_name
            {
                min-height: 1.5em;
                line-height: 2.5em;
                margin-left: 4em;
            }
            .save_me_wrapper .glyphicon-repeat, .save_me_wrapper .glyphicon-info-sign
            {
                cursor: pointer;
                float: left;
                font-size: 1.5em;
                padding: 0.5em;
                height: 1.5em;
                background: #155794;
                line-height: 0.5em;
                box-shadow: inset 0px 0px 5px rgba(0, 0, 0, 0.75);
            }
            .save_me_wrapper .glyphicon-info-sign
            {
                background: #1D651F;
                margin-right: 1em;
            }
            .grid_icon_wrapper .fa-life-ring
            {
                position: relative;
                left: 0.025em;
            }
            .save_me_reason_tmp
            {
                padding: 1em;
                background: rgba(0, 0, 0, 0.3);
                box-shadow: inset 0px 0px 0.5em rgba(255, 255, 255, 0.3);
            }
            .grid_icon_wrapper_for_save_me_special_treatment
            {
                position: relative;
                top: -1.75em;
            }
            .action_name_special_treatment_saveme
            {
                top: -2.5em;
                position: relative;
            }
            .grid_icon_wrapper .fa
            {
                font-size: 0.8em;
                top: -0.2em;
                position: relative;
            }
            .grid_icon_wrapper .fa-diamond
            {
                left: 0.05em;
            }
            h2 .fa-diamond
            {
                color: #008DCB;
            }
            .contest_div
            {
                background: #008DCB;
                padding: 1em;
                box-shadow: inset 0px 0px 1em rgba(0, 0, 0, 0.5);
                text-shadow: 0px 0px 0.1em #000;
                margin-bottom: 2em;
            }
            .contest_name
            {
                font-size: 1.5em;
            }
            .contest_info_btn_row .glyphicon-info-sign
            {
                float: right;
                font-size: 2em;
                cursor: pointer;
            }
            .contest_description
            {
                background: rgba(0, 0, 0, 0.2);
                padding: 1em;
                box-shadow: inset 0px 0px 0.5em rgba(0, 0, 0, 0.2);
            }
            .contest_main_div .btn-danger
            {
                float: right;
                padding-left: 3em;
                padding-right: 3em;
            }
            .sp2_reschedule .glyphicon-info-sign
            {
                font-size: 1.5em;
                color: #5bc0de;
                cursor: pointer;
                top: -0.05em;
            }
            .sp2_reschedule .glyphicon-open-file
            {
                font-size: 1.5em;
                margin-left: 0.5em;
                color: #10B069;
                cursor: pointer;
            }
            .sp2_reschedule .glyphicon
            {
                text-shadow: 0px 2px 0.1em #000
            }
            .proposal_form_row form
            {
                clear: both;
                background: rgba(255, 255, 255, 0.025);
                top: 1em;
                position: relative;
                padding-top: 1em;
                padding-bottom: 1em;
            }
            .proposal_form_row form input
            {
                text-indent: 0.5em;
            }
            .reconfigure_dolla
            {
                color: #30FF26;
                font-size: 1.5em;
                line-height: 0em;
                padding-right: 0.25em;
                top: -0.2em;
                position: relative;
                left: 1.25em;
            }
            .curr_proposal_href
            {
                margin-left: 0.5em;
                padding-bottom: 0.5em;
                display: inline-block;
            }
            .proposal_form_row center .btn-primary
            {
                margin-left: 2em;
            }
            #sp_schedule_icon
            {
                left: 0.075em;
            }
            .sp2_nayme
            {
                padding-top: 0.25em;
                padding-bottom: 0.25em;
                cursor: pointer;
            }
            .proposal_form_row
            {
                padding: 1em;
                padding-top: 2em;
                background: rgba(255, 255, 255, 0.1);
                clear: both;
            }
            .proposal_form_row td
            {
                padding: 1em;
                padding-top: 2em;
                background: rgba(255, 255, 255, 0.1);
                clear: both;
            }
            .proposal_form_row button
            {
                margin-top: 1.5em;
            }
            .docs_gen_btn
            {
                margin-left: 1em;
                clear: both;
            }
            .extra_dropdowns
            {
                width: 100%;
                display: block;
                position: relative;
                float: left;
            }
            .extra_dropdowns .dropdown
            {
                float: left;
                margin-left: 1em;
            }
            .prop_gen_btn
            {
                clear: both;
                margin-left: 1em;
            }
            .docs_gen_btn_2
            {
                margin-left: 1em;
                clear: both;
            }
            .utility_bill_person
            {
                text-indent: 0.5em;
                width: 80%;
            }
            .incentive_ta
            {
                width: 80%;
                background: #353030;
                padding: 0.5em;
                border: 1px solid rgba(0, 0, 0, 0.5);
            }
            .close_deal_btn
            {
                float: right;
            }
            .shared_uplink, .closer_inp
            {
                text-indent: 0.5em;
                width: 80%;
            }
            .rep_result
            {
                display: block;
                margin-top: 1em;
                background: rgba(0, 0, 0, 0.2);
                padding: 0.25em;
                text-indent: 1em;
            }
            .starburst
            {
                float: right;
                display:block;
	            width:3em;
	            height:3em;
	            background:#0BA2FB;
	            -webkit-transform:rotate(-45deg);
	            -moz-transform:rotate(-45deg);
	            rotation:-45deg;
                position:relative;
                top: -0.5em;
                left: -1em;
                text-align:center;
                text-decoration:none;
                color:#000;
                font-weight:bold;
                font-family:Arial, sans-serif;
                box-shadow: 0px 0px 0.5em #E4FF08;

            }
            .starburst span
            {
                display:block;
                width:3em;
                height:3em;
                background: #FB8A0B;
                -webkit-transform:rotate(22.5deg);
                -moz-transform:rotate(22.5deg);
                rotation:22.5deg;
            }
            .starburst b
            {
                position: relative;
                top: -1em;
                left: -0.25em;
                color: #fff;
                text-shadow: 0px 0px 1em #000;
            }
            .shopping_acct_num, .cvv_num
            {
                text-indent: 0.5em;
            }
            #exp_year, #exp_month, #signing_mode
            {
                background: #575757;
                border: 0px solid #000;
                margin-right: 1.75em;
            }
            #signing_mode
            {
                margin-top: 1.25em;
            }
            .additional_costs_button
            {
                float: right;
                top: -5em;
                position: relative;
                left: 6.5em;
            }
            .reconfig_additional_costs
            {
                text-indent: 0.5em;
                width: 80%;
            }
            .panel_qty_dd
            {
                clear: both;
                margin-left: 1em;
            }
            .rep_fee_schedule
            {
                margin-top: 1.5em;
            }
            .rep_fee_schedule td
            {
                padding: 0.5em;
            }
            .rep_fee_schedule .glyphicon-pencil
            {
                margin-right: 0.5em;
                color: #C8B20A;
            }
            .interval_span
            {
                float: right;
                font-size: 2em;
                color: #D3EF0E;
            }
            #update_customer_details
            {
                background: #575757;
                border: 0px solid #000;
                display: block;
            }
            .docs_update_customer_details_div input
            {
                margin-top: 1em;
                display: block;
                margin-bottom: 1em;
                width: 80%;
                text-indent: 0.5em;
            }
            .special_note_admin
            {
                width: 80%;
                background: rgba(255, 255, 255, 0.1);
                border: 0px solid #000;
                padding: 0.5em;
                height: 5em;
            }
            .biggie_restore
            {
                float: right;
                position: relative;
                top: -7em;
            }
            #restore_cust_search
            {
                text-indent: 0.5em;
                width: 23em;
            }
            .reschedge_result
            {
                background: rgba(3,150,55,0.5);
                text-shadow: 0px 0px 0.1em #000;
                text-indent: 0.5em;
                cursor: pointer;
            }
            #reschedge_date_input
            {
                text-indent: 0.5em;
            }
            .pm_inner
            {
                background: rgba(255, 255, 255, 0.1);
                padding: 1em;
                box-shadow: inset 0px 0px 1em #000;
            }
            .pm_progress
            {
                margin-bottom: 0.5em;
                background: #3375a5;
                padding-left: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            .inner_d_details
            {
                width: 48%;
                margin-left: 1%;
                float: left;
            }
            .inner_d_details > p
            {
                min-height: 1em;
                background: #eee;
                color: #000;
                text-shadow: 0px 0px 0px #000;
                padding-left: 0.5em;
            }
            .inner_d_details a
            {
                color: #000 !important;
                text-decoration: underline; !important;
                text-shadow: 0px 0px 0em #000 !important;
            }
            .pm_progress_details_div
            {
                box-shadow: 0px 0px 0px 0.1em #3375a5;
                padding: 0.5em;
            }
            .pm_progress_details_div .glyphicon-remove
            {
                position: relative;
                top: 0em;
                float: right;
                background: #F44336;
                text-shadow: 0px 0px 0.2em #000;
                padding-left: 0.75em;
                padding-right: 0.75em;
                padding-top: 0.75em;
                padding-bottom: 0.75em;
                font-size: 1.5em;
                border-radius: 0.36em;
                cursor: pointer;
            }
            .pm_status
            {
                background: #eee;
                color: #000;
                padding-left: 0.5em;
            }
            .pm_checkoff_datespan
            {
                background: #eee;
                color: #000;
                display: inline-block;
                width: 100%;
                padding-left: 0.5em;
            }
            .pm_checkoff_item
            {
                float: left;
                width: 48%;
                margin-left: 1%;
            }
            .todo_required_action
            {
                background: rgba(255, 255, 255, 0.2);
                padding: 0.5em;
                margin-bottom: 1em;
                padding-bottom: 2em;
                clear: both;
            }
            .reqd_actions_back
            {
                float: right;
                position: relative;
                top: -4em;
            }
            .required_action_cust_name
            {
                background: #2196F3;
                text-shadow: 0px 0px 0.1em #000;
                text-indent: 0.5em;
                display: inline-block;
                padding-right: 0.5em;
            }
            .required_action_reason
            {
                background: #009688;
                position: relative;
                top: -0.5em;
                padding: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .todo_required_action textarea
            {
                width: 100%;
                background: #3a3939;
                color: #fff;
                padding: 0.5em;
            }
            .todo_required_action .label
            {
                text-shadow: 0px 0px 0.1em #000;
                font-size: 1em;
                box-shadow: 0px 0px 0.1em #000;
                float: right;
                cursor: pointer;
            }
            .todo_required_action .glyphicon-trash
            {
                margin-left: 5em;
                cursor: pointer;
                line-height: 1.5em;
            }
            .calced_details_show
            {
                padding: 0.5em;
                cursor: pointer;
                border-radius: 0.25em;
                background: #2196F3;
                color: #fff;
                text-shadow: 0px 0px 0.1em #000;
                font-weight: bold;
            }
            .proposal_form_row th
            {
                padding: 1em;
                padding-top: 2em;
                background: rgba(255, 255, 255, 0.1);
                clear: both;
            }   
            .calced_details_tbod td
            {
                border: 1px solid rgb(116, 141, 152);
                text-align: center;
                padding: 0.25em;
            }
            .calced_details_tbod .label-primary
            {
                margin-bottom: 1em;
                float: left;
                position: relative;
                top: 0.5em;
                font-size: 1.25em;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            .special_message_calced_details
            {
                display: inline-block;
                width: 100%;
                background: #FF9800;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            .lb_thumb_img
			{
				max-width: 40px;
			    margin-right: 1em;
			}
			.lb_tally_total
			{
				position: relative;
				font-size: 1.5em;
				top: 1em;
				background: #307984;
				text-indent: 3.75em;
				text-shadow: 0px 0px 0.1em #000;
				display: none;
			}
			.pm_warning_msg
			{
				background: #F44336;
				color: #fff;
				padding-left: 0.5em;
				padding-right: 0.5em;
				text-shadow: 0px 0px 0.1em #000;
			}
            .paycheck_dp_input, .payment_export_start, .payment_export_end
            {
                text-indent: 0.5em;
                font-size: 2em;
                margin-left: 6.5%;
            }
            .rep_payment_export_button
            {
                float: left;
                margin-left: 6.5%;
                position: relative;
                margin-top: 1em;
                margin-bottom: 1em;
            }
            #required_actions
            {
                margin-left: 0.1em;
            }
            #required_actions .badge
            {
                float: left;
                position: relative;
                top: 0em;
                left: 6em;
            }
            .btn-settings-back
            {
                margin-top: -1.5em;
                margin-bottom: 1em;
            }
            .saveme_badge
            {
                position: relative;
                top: -6.5em;
            }
            .btn-messaging-back
            {
                float: right;
                width: 10em;
                margin-right: 5em;
                position: relative;
                top: 0.25em;
            }
            .cp-back-btn
            {
                float: right;
            }
            .rep_report_paycheck_issue
            {
                float: left;
                margin-left: 6.5%;
                position: relative;
                margin-top: 0em;
                margin-bottom: 1em;
                clear: both;
            }
            .paycheck_issue_ta
            {
                background: rgba(0, 0, 0, 0.3);
                border: 0px solid #000;
                width: 80%;
                min-height: 5em;
                padding: 0.5em;
            }
            #featured_lb_area
            {
                position: fixed;
                width: 6em;
                background: rgba(0, 0, 0, 0.4);
                height: 100%;
                top: 8em;
            }
            #featured_lb_tbl
            {
                width: 95%;
                margin-left: 2.5%;
                font-size: 0.5em;
            }
            #featured_lb_tbl center
            {
                text-shadow: 0px 0px 0.1em #000;
                background: #005f96;
                margin-bottom: 1em;
                font-size: 1.25em;
            }
            #featured_lb_tbl tr td:nth-child(2)
            {
                display: none;
            }
            #featured_lb_tbl td
            {
                border: 1px solid rgba(255, 255, 255, 0.05);
                padding: 0.25em;
                text-align: center;
            }
            #featured_lb_tbl img
            {
                max-width: 25px;
                margin-left: auto;
                margin-right: auto;
            }
            #lb_featured_refresh
            {
                font-size: 0.75em;
                margin-top: 1em;
            }            
            @media(min-width:320px)
            {
                #featured_lb_area
                {
                    width: 8em;
                    height: 15em;
                }
                #featured_lb_area
                {
                    display: block;
                }                
            }
            @media(min-width:580px)
            {
                #featured_lb_area
                {
                    width: 11em;
                    height: 17em;
                }
                #featured_lb_tbl
                {
                    font-size: 0.7em;
                }
                #featured_lb_tbl tr td:nth-child(2)
                {
                    display: table-cell;
                }                
            }
            @media(min-width:720px)
            {
                #featured_lb_area
                {
                    width: 12em;                    
                }
            }
            @media(min-width:800px)
            {
                #featured_lb_area
                {
                    width: 14em;
                    height: 23em;
                }
                #featured_lb_tbl
                {
                    font-size: 0.8em;
                }
                #featured_lb_tbl img
                {
                    max-width: 40px;
                } 
            }
            @media(min-width:1024px)
            {
                #featured_lb_area
                {
                    width: 18em;
                    height: 23em;
                    font-size: 1em;
                } 
            }
            /*@media(min-width:1200px)
            {
                #featured_lb_area
                {
                    width: 18em;
                    font-size: 1.25em;
                } 
            }*/
            .interest_rate_btn
            {
                position: relative;
                top: -2em;
            }
            .interest_ul
            {
                margin-top: -2em;
            }
            .deal_closed_checklist_item
            {
                float: right;
                font-size: 2em;
            }
            .points_banked
            {
                background: #337ab7;
                text-shadow: 0px 0px 0.1em #000;
                font-size: 2em;
                float: left;
                padding-left: 1em;
                padding-right: 1em;
            }
            .custom_options_tbl td, .custom_options_tbl th
            {
                border: 1px solid #03A9F4;
                padding: 0.5em;
            }
            .custom_options_tbl th
            {
                background: #06524b;
            }
            .custom_options_tbl input
            {
                text-indent: 0.5em;
            }
            .custom_option_dollar
            {
                color: #4CAF50;
                font-size: 1.5em;
                line-height: 0em;
                display: inline-block;
                margin-right: 0.5em;
            }
            .custom_options_tbl .glyphicon-remove
            {
                color: #E91E63;
                display: inline-block;
                margin-left: auto;
                margin-right: auto;
                font-size: 1.5em;
                margin-left: 1em;
                cursor: pointer;
            }
            .tax_info_btn
            {
                margin-left: 1em;
            }
            #filing_status_sel, #filing_status_sel option, #federal_tax_percentage_sel, #federal_tax_percentage_sel, #state_tax_percentage_sel, #state_tax_percentage_sel option
            {
                color: #fff;
                background: #000;
            }
            .labels_div
            {
                margin-left: 2em;
            }
            .labels_div span
            {
                font-size: 1.25em;
                margin-right: 0.5em;
                cursor: pointer;
            }
            .training_media
            {
                box-shadow: 0px 0px 5px #000;
                background: #134a45;
                padding: 1em;
                margin-bottom: 1.5em;
                width: 50;
            }
            .training_media img
            {
                max-width: 50px;
            }
            .trees_need_cut_warning
            {
                background: #F44336;
                text-shadow: 0px 0px 0.1em #000;
                font-size: 1.5em;
            }
            .trees_need_cut_details
            {
                background: #FFC107;
                color: #000;
                padding: 0.25em;
            }
            .income_verification_warning
            {
                background: #F44336;
                font-size: 1.5em;
                padding: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .training_media_quiz
            {
                cursor: pointer;
            }
            .quiz_question_card
            {
                background: #fff;
                color: #5f5b5b;
            }
            .quiz_question_card > p
            {
                background: #2196F3;
                padding: 0.5em;
                color: #fff;
                text-shadow: 0px 0px 0.1em #000;
                border-top: 5px solid #fff;
            }
            .quiz_choices_ul
            {
                list-style-type: none;
            }
            .quiz_choices_ul input
            {
                float: right;
                margin-right: 1em;
            }
            .quiz_choices_ul li
            {
                border: 1px solid rgba(0, 0, 0, 0.1);
                margin-bottom: 0.5em;
                padding: 0.5em;
            }
            .missing_answer
            {
                border: 5px solid red;
            }
            .power_up_div
            {
                padding-bottom: 2.5em;
                background: #2196F3;
                border: 1px solid #000;
                margin-bottom: 2em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .power_up_div > p
            {
                background: #FF9800;
                text-indent: 1em;
            }
            .power_up_div .glyphicon-info-sign
            {
                float: right;
                margin-right: 2em;
                font-size: 1.25em;
                cursor: pointer;
            }
            .power_up_div ul
            {
                list-style-type: decimal;
            }
            .power_up_div li
            {
                background: rgba(0, 0, 0, 0.1);
                padding: 0.25em;
                border: 1px solid rgba(0, 0, 0, 0.5);
                margin-bottom: 1em;
            }
            .power_up_div input
            {
                float: right;
                margin-right: 2.5em;
            }
            .label-claim-prize
            {
                cursor: pointer;
                font-size: 1.5em;
                float: right;
                background: #FF9800;
                background-color: #FF9800;
            }
            .training_media_section_video, .training_media_section_audio, .training_media_section_doc
            {
                background: #337ab7;
                text-shadow: 0px 0px 0.1em #000;
                font-size: 1.5em;
                line-height: 1em;
            }
            .residual_bill_warning
            {
                background: #fff;
                color: #000;
                border: 1px solid red;
                padding: 0.5em;
                font-size: 1.25em;
            }
            #close_deal_utility_number
            {
                text-indent: 0.5em;
            }
            .unclaimed_lead_div
            {
                background: #FFF;
                color: #000;
                padding: 1em;
                width: 50%;
                margin-bottom: 2em;
            }
            .unclaimed_lead_div > p
            {
                border: 1px solid rgba(0, 0, 0, 0.25);
                padding: 0.5em;
            }
            .unclaimed_lead_name
            {
                background: #098bc2;
                color: #fff;
            }
            .active_leads_tbl th
            {
                background: rgba(255, 255, 255, 0.2);
                padding: 0.5em;
            }
            .active_leads_tbl .green a, .active_leads_tbl .yellow a
            {
                background: #fff;
                padding: 0.5em;
                min-width: 10em;
                display: inline-block;
            }            
            .active_leads_tbl td
            {
                min-width: 5em;
            }
            .active_leads_tbl .green td
            {
                background: #009688;
                padding: 0.5em;
            }
            .active_leads_tbl .yellow td
            {
                background: #FFEB3B;
                padding: 0.5em;
                color: #000;
            }
            .rep_checklist_date_edit_pencil
            {
                cursor: pointer;
            }
            .active_leads_tbl .green td .rep_checklist_date_edit_pencil
            {
                color: yellow;
            }
            .active_leads_tbl select
            {
                background: #5d5959;
                color: #fff;
            }
            .active_leads_tbl select option
            {
                background: #5d5959;
                color: #fff;
            }
            .active_leads_tbl td
            {
                border: 1px dotted #000;
            }
            #sp2_annoy_sel1, #sp2_annoy_sel2, #sp2_annoy_care_sel, #sp2_usage_sel
            {
                background: #000;
                border: 1px solid #fff;
            }
            .sp2_annoy_no_options_div
            {
                display: none;
            }
            .past_customers_status_filter_sel
            {
                background: #000;
                margin-right: 1em;
                position: relative;
                top: 0.25em;
            }
            .past_customers_tbl td, .past_customers_tbl th
            {
                padding: 0.5em;
                border: 1px solid rgba(255, 255, 255, 0.5);
            }

            .past_customers_tbl
            {
                border: 1px solid #000;
                margin-top: 1.5em;
            }
            .past_customers_tbl th
            {
                background: #4CAF50;
                text-shadow: 0px 0px 0.1em #000;
            }
            .past_customers_tbl td
            {
                background: #272525;
            }
            .my_abs_tbl td, th
            {
                padding: 0.5em;
            }
            .my_abs_tbl th
            {
                background: #03A9F4;
                text-shadow: 0px 0px 0.1em #000;
            }
            .my_abs_tbl
            {
                border: 1px solid #000;
            }
            .my_abs_tbl td
            {
                background: rgba(255, 255, 255, 0.1);
            }
            .my_abs_tbl a
            {
                display: inline-block;
                min-width: 10em;
                background: #8BC34A;
                padding: 0.25em;
                color: #fff;
                text-shadow: 0px 0px 0.1em #000;
            }
            .my_abs_back_btn
            {
                font-size: 2em;
                margin-bottom: 1em;
            }
            .sp2_annoy_opt_lead_notes
            {
                min-height: 5em;
                background: #000;
                width: 80%;
            }
            .rep_lead_notes_info_sign
            {
                cursor: pointer;
            }
            .my_ab_notes_info
            {
                cursor: pointer;
                color: #04a9f4;
            }
            .rep_lead_notes_ta
            {
                width: 80%;
                min-height: 5em;
                background: #252222;
                padding: 0.5em;
            }
            .admin_lead_notes_and_checklist_lbl
            {
                cursor: pointer;
            }
            .sp2_cal_back_button
            {
                position: relative;
                top: -1em;
                width: 10em;
            }
            #breadcrumb_select_rep, #breadcrumb_select_hour
            {
                margin-right: 1em;
                background: #000;
                border: 0px solid #000;
                margin-bottom: 1em;
            }
            .grid_icon_wrapper_for_area_management > a > span
            {
                font-size: 3em;
                line-height: 1.7em;
            }
            #grid_map
            {
                margin-left: auto;
                margin-right: auto;
                width: 800px;
                height: 500px;
            }
            .grid_region_market_sel, .grid_region_office_sel, .grid_region_time_sel, .grid_region_status_sel, .grid_region_rep_sel
            {
                background: #000;
                border: 0px solid #000;
                margin-bottom: 1.5em;
                margin-right: 0.5em;
                position: relative;
            }
            #grid_area_management .symbola
            {
                position: relative;
                left: -0.5em;
            }
            .region_info_tbl td, .info_window_transaction_tbl td, .info_window_transaction_tbl th
            {
                color: #000;
                padding: 0.5em;
                border: 1px solid rgba(0, 0, 0, 0.25);
            }
            .info_window_region_delete, .info_window_region_reassign
            {
                float: right;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            #region_draw_reset_btn, #region_draw_save_btn
            {
                margin-right: 1em;
                height: 2em;
                line-height: 0em;
                text-shadow: 0px 0px 0.1em #000;
            }
            #boundaries_save_btn, #boundaries_cancel_btn
            {
                display: none;
                margin-right: 1em;
                margin-bottom: 1em;
            }
            .emergency_contact_label
            {
                text-shadow: 0px 0px 0.1em #000;
                font-size: 1em;
                margin-top: 1em;
                display: inline-block;
            }
            .notes_from_solar_pro
            {
                width: 50%;
                background: #817c7c;
                padding: 0.5em;
            }
            .submit_btn_99
            {
                background: rgba(0, 0, 0, 0.5);
                border: 0px solid #000;
                font-size: 1.5em;
                margin-top: 1em;
            }
            .upcoming_installs_table
            {
                border: 1px solid #000;
                width: 100%;
            }
            .upcoming_installs_table td, .upcoming_installs_table th
            {
                padding: 0.5em;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: #488c54;
                text-shadow: 0px 0px 0.1em #000;
            }
            .upcoming_installs_table th
            {
                background: #34737d;
            }
            .data_logger_proposals_icon
            {
                position: relative;
                top: -0.75em;
                left: 0.75em;
            }
            .chart_gen_from_my_proposals_icon
            {
                position: relative;
                left: 0.75em;
                font-size: 1.5em;
                top: -0.15em;
                background: #d9534f;
                padding: 0.1em;
                cursor: pointer;
            }
            .upcoming_installs_btn
            {
                margin-top: 1em;
                margin-bottom: 1em;
                margin-right: 0.5em;
            }
            #data_logger_map_div
            {
                width: 80%;
                min-height: 300px;
                margin-top: 2em;
            }
            .dl_info_window
            {
                background: #35302f;
                padding: 1em;
                color: #09b8ec;
                font-weight: bold;
                font-size: 1.5em;
            }
            #chart_gen_ak_status_sel, #chart_gen_care_sel, #chart_gen_usage_sel
            {
                background: #000;
                border: 0px solid #000;
            }
            #chart_gen_care_sel
            {
                
            }
            #chart_gen_ak_status_notes
            {
                width: 80%;
                background: rgba(0, 0, 0, 0.5);
                border: 1px solid #000;
                margin-top: 1em;
            }
            #chart_gen_ak_status_notes::-webkit-input-placeholder { /* Chrome/Opera/Safari */
                color:#fff;
            }
            #chart_gen_ak_status_notes::-moz-placeholder { /* Firefox 19+ */
                color:#fff;
            }
            #chart_gen_ak_status_notes:-ms-input-placeholder { /* IE 10+ */
                color:#fff;
            }
            #chart_gen_ak_status_notes:-moz-placeholder { /* Firefox 18- */
                color:#fff;
            }
            .not_accepting
            {
                display: inline;
                text-decoration: none;
                background: #d9534f;
                color: white;
                padding: 0.25em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .accepting
            {
                display: inline;
                text-decoration: none;
                background: #5cb85c;
                color: white;
                padding: 0.25em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .infoBox
            {
                background: #000;
                width: auto !important;
            }
            #show_ownership_span
            {
                margin-right: 0.5em;
            }
            #potential_bonus_lbl
            {
                float: right;
                clear: both;
                margin-bottom: 1em;
                margin-right: 8.33%;
                font-size: 1.5em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .bonus_disclaimer
            {
                float: left;
                clear: both;
                margin-bottom: 1em;
                margin-left: 6.5%;
                background: #da6e6e;
                padding: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
            }
            .runway_level_1_tbl td
            {
                padding: 0.5em;
                border: 3px solid #000;
            }
            .runway_level_1_ul input
            {
                margin-right: 1em;
            }
            .repeated_day_custom_li input
            {
                float: right;
            }
            #carve_out_num
            {
                font-size: 2em;
                text-align: center;
                background: #0097d5;
                text-shadow: 0px 0px 0.1em #000;
                box-shadow: inset 0px 0px 0.25em #000000;
            }
            #carve_out_whoah_nelly
            {
                background: #f19f2c;
                text-shadow: 0px 0px 0.1em #000;
                display: inline-block;
                width: 100%;
                font-size: 1.25em;
                box-shadow: inset 0px 0px 0.25em #000;
            }
            .mark_as_ak
            {
                background: #3379b6;
                color: #FFFFFF;
                padding-left: 1em;
                padding-right: 1em;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            .thomas_warning
            {
                background: #d9534f;
                text-shadow: 0px 0px 0.1em #000;
                padding: 0.5em;
                text-align: center;
            }
            #my_area_map
            {
                min-height: 500px;
            }
            #my_area_map .gm-style .gm-style-iw-a {
                position: absolute;
                /*width: auto !important;*/
                height: 5em !important;
            }
            .my_area_map_i_dub
            {
                color: #000000;
            }
            #my_area_back
            {
                font-size: 2em;
                margin-bottom: 2em;
            }
            #nirnberger_map
            {
                margin-left: auto;
                margin-right: auto;
                width: 100%;
                height: 500px;
            }
            .nirnberger_addy
            {
                color: #000;
                font-weight: bold;
            }
            .cole_dive_in_a
            {
                font-size: 1.5em;
                text-decoration: underline;
            }
            .cole_details
            {
                margin-left: auto;
                margin-right: auto;
                overflow: visible;
                background: #FFFFFF;
            }
            .cole_details_wait
            {
                color: #000;
                font-size: 2em;
                text-decoration: underline;
            }
            #cole_hr
            {
                width: 100%;
                min-height: 5px;
                background: #000;
                margin-bottom: 1em;
            }
            .cole_no_results
            {
                text-align: center;
                color: #000;
            }
            .cole_details table
            {
                width: 90%;
                margin-left: auto;
                margin-right: auto;
            }
            .cole_details table td, .cole_details table th
            {
                color: #000;
                padding: 1em;
                border: 1px solid #000;
            }
            .cole_street_view_div
            {
                min-width: 400px;
                min-height: 400px;
                overflow: visible;
            }
            .cole_details > p
            {
                font-size: 1.25em;
                text-align: center;
                border: 1px solid #000;
                padding: 0.5em;
                color: #000;
            }
            .roof_work_needed_div
            {
                background: rgb(15, 120, 125);
                padding: 1em;
            }
            .before_details_roof_work
            {
                margin-bottom: 1em;
                text-shadow: 0px 0px 0.1em #000;
                background: rgba(0, 0, 0, 0.25);
                padding-left: 0.5em;
                padding-bottom: 0.25em;
                padding-top: 0.25em;
                cursor: pointer;
            }
            .roof_work_sub_root
            {
                margin-left: 2%;
                width: 98%;
                background: #033d40;
                padding: 0.5em;
                margin-top: 1em;
                margin-bottom: 1em;
            }
            .roof_item_details_label
            {
                display: block;
                background: #ffffff;
                color: #000;
                text-shadow: 0px 0px 0em #000;
                padding-left: 0.5em;
            }
            .roof_item_details_value
            {
                width: 100%;
                display: block;
                margin-top: 0.5em;
                background: rgba(255, 255, 255, 0.1);
                padding-left: 0.5em;
                padding-top: 0.5em;
                padding-right: 0.5em;
                padding-bottom: 0.5em;
            }
            .roof_work_sub_root select
            {
                background: #353030;
                border: 0px solid #000;
                padding: 0.25em;
                margin-bottom: 1em;
            }
            .roof_work_sub_root img
            {
                width: 45%;
                margin-left: 2.5%;
                margin-right: 2.5%;
                box-shadow: 0em 0em 0.5em 0em #000;
                display: inline-block;
                margin-bottom: 1.75em;
            }
            #number_4_warning_roof_work .roof_item_details_label, #number_9_warning_roof_work .roof_item_details_label            
            {
                background: #e09916;
                color: #FFF;
                text-shadow: 0px 0px 0.1em #000;
                font-weight: bold;
                font-size: 1em;
                text-decoration: underline;
                letter-spacing: 1px;
            }
            #roof_work_secondary_fund_group ul
            {
                background: rgba(0, 0, 0, 0.3);
                padding: 1em;
                padding-left: 1.5em;
            }
            .steps_and_links_first_group
            {
                display: none;
            }
            .steps_and_links
            {
                background: #FFF;
                width: 95%;
                margin-left: 5%;
                margin-top: 0.75em;
                text-shadow: 0px 0px 0em #000;
                color: #000;
                padding: 1em;
            }
            .steps_and_links ol
            {
                display: block;
                background: rgba(0, 0, 0, 0.05);
                border: 1px solid #000;
            }
            .steps_and_links li
            {
                margin-bottom: 0.25em;
                margin-top: 0.25em;
            }
            .always_show_num_two_amt, .always_show_num_three
            {
                background: #FFEB3B;
                padding: 0.5em;
                border: 1px solid #000;
            }
            #full_reroof_photo img
            {
                margin-left: auto;
                margin-right: auto;
                display: block;
            }
            .roof_work_divider
            {
                margin-bottom: 5em;
                border-top: 5px solid #57b0b5;
            }
            .roof_work_sub_sub_group
            {
                background: #FFF;
                padding: 0.5em;
                box-shadow: 2px 2px 2px 2px #353030 inset;
                margin-bottom: 1em;
            }
            .roof_work_header
            {
                background: #353030;
                position: relative;
                width: 102%;
                left: -1%;
                text-indent: 1em;
                margin-bottom: 1em;
            }
            .roof_item_details_label
            {
                background: #353030;
                color: #FFF;
                width: 98%;
                margin-left: 2%;
            }
            .roof_item_details_value
            {
                text-shadow: 0px 0px 0px #000 !important;
                margin-left: 2%;
                width: 98%;
                color: #000;
                border: 1px solid;
                position: relative;
                top: -0.5em;
            }
            .roof_work_sub_root img
            {
                box-shadow: inherit !important;
                border: 2px solid #000;
            }
            .roof_work_sub_root select
            {
                position: relative;
                left: 2%;
                position: relative;
                left: 2%;
                color: #FFF;
                position: relative;
                left: -0.125em;
                background: #125a5d;
            }
            .roof_work_sub_root select
            {
                position: relative;
                left: 2%;
                color: #FFF;
                position: relative;
                left: -0.125em;
                background: #125a5d;
            }
            #roof_work_secondary_fund_group ul
            {
                background: rgb(255, 255, 255);
                padding: 1em;
                padding-left: 1.5em;
                border: 1px solid #000;
            }
            #rep_option_one_sel
            {
                position: relative;
                left: 2% !important;
            }
            .roof_work_sub_sub_group > ol
            {
                list-style-type: none;
            }
            #roof_work_go_btn
            {
                font-size: 1.5em;
                background: #1c777c;
                border: 1px solid #000;
                padding: 0.5em;
                cursor: pointer;
            }
            #roof_work_go_btn a
            {
                color: #FFF;
            }
            .assistance_cust_item
            {
                background: rgba(255, 255, 255, 0.2);
                padding: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
                border: 1px solid #000;
            }
            .assistance_details
            {
                border: 1px solid #000;
                background: rgba(255, 255, 255, 0.2);
                padding-top: 1em;
                border: 1px solid #000;
                position: relative;
                top: -0.75em;
            }
            .assistance_details button
            {
                margin-left: 1em;
                margin-bottom: 1em;
            }
            .completed_notes_assistance
            {
                background: #000;
                width: 100%;
                min-height: 5em;
                border: 0px solid #000;
            }
            .titan_customer
            {
                background: #009688;
                padding-left: 0.5em;
                text-shadow: 0px 0px 0.1em #000;
                cursor: pointer;
            }
            .titan_details
            {
                background: rgba(0, 0, 0, 0.5);
                padding: 1em;
            }
            .titan_close
            {
                font-size: 1.5em;
                background: red;
                color: #FFF;
                width: 1.5em;
                height: 1.5em;
                float: right;
                text-align: center;
                line-height: 1.5em;
                cursor: pointer;
            }
            .titan_cancelled
            {
                background: #f44336;
            }
            .incentive_sel
            {
                width: 175px;
                background: #000;
                position: relative;
                top: 0.5em;
                left: 1em;
                font-size: 2em;
            }
            .mark_followup
            {
                background: #337ab7;
                color: #FFF;
                display: block;
                border: 1px solid #000;
            }
            .fu_view_date
            {
                background: #19a017;
                text-shadow: 0px 0px 0.1em #000;
                display: inline-block;
                padding-left: 0.25em;
                padding-right: 0.25em;
                margin-right: 1em;
            }
            .fu_view_name
            {
                text-decoration: underline;
                cursor: pointer;
            }
            .fu_view_item
            {
                border: 1px solid #000;
                padding: 0.5em;
            }
            .fe_details
            {
                background: rgba(255, 255, 255, 0.1);
                padding: 0.75em;
                border: 1px solid #000;
            }
            #fu_go_back
            {
                font-size: 2em;
            }
            .later_notes
            {
                background: rgba(0, 0, 0, 0.9);
                width: 100%;
                min-height: 5em;
                padding: 0.25em;

            }
            .pulled_notes_in_followup
            {
                background: rgba(0, 0, 0, 0.9);
                margin-top: 0.5em;
                width: 100%;
                min-height: 5em;
                color: #FFF;
                padding: 0.25em;
            }
            .fu_details_close
            {
                float: right;
                background: #d9534f;
                font-size: 1.5em;
                padding: 0.25em;
                border-radius: 50%;
                height: 1.5em;
                width: 1.5em;
                text-align: center;
                line-height: 1em;
                cursor: pointer;
            }
            .fe_restore
            {
                background: #ffc107;
                color: #FFF;
                font-size: 1.25em;
                text-shadow: 0px 0px 0.05em #000;
                padding: 0.1em;
                padding-left: 0.25em;
                padding-right: 0.25em;
                border: 1px solid #000;
                cursor: pointer;
            }
            #cosign_cb
            {
               margin-right: 1em;
            }
            .titan_pto
            {
                background: #2196f3;
            }
            #cs_plan
            {
                margin-left: 1em;
            }
            #cs_price_sel, #cs_price_sel option
            {
                background: #000;
                color: #FFF;
            }
            #bank_details
            {
                margin-left: 1em;
            }
        </style>    



        <script type="text/javascript">
            Array.prototype.shuffle = function()
            {
                var i = this.length;
                while (i)
                {
                    var j = Math.floor(Math.random() * i);
                    var t = this[--i];
                    this[i] = this[j];
                    this[j] = t;
                }
                return this;
            }
            String.prototype.digits = function()
            {
              var arr = [];
              var digits = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
              for(var i = 0; i < this.length; i++)
              {
                if(digits.indexOf(this[i]) > -1)
                {
                  arr.push(this[i]);
                }
              }
              if(arr.length === 0)
              {
                return null;
              }
              return arr.join("");
            };
            function numToEnglish(num)
            {
                if(num < 1)
                {
                    return "Zero";
                }
                // lifted from somewhere off the web
                var th = ['','thousand','million', 'billion','trillion'];
                var dg = ['zero','one','two','three','four', 'five','six','seven','eight','nine'];
                var tn = ['ten','eleven','twelve','thirteen', 'fourteen','fifteen','sixteen', 'seventeen','eighteen','nineteen'];
                var tw = ['twenty','thirty','forty','fifty', 'sixty','seventy','eighty','ninety'];

                s = num + '';
                s = s.replace(/[\, ]/g,'');
                if (s != parseFloat(s)) return 'not a number';
                var x = s.indexOf('.');
                if (x == -1) x = s.length;
                if (x > 15) return 'too big';
                var n = s.split('');
                var str = '';
                var sk = 0;
                for (var i=0; i < x; i++)
                {
                    if ((x-i)%3==2)
                    {
                        if (n[i] == '1')
                        {
                            str += tn[Number(n[i+1])] + ' ';
                            i++;
                            sk=1;
                        }
                        else if (n[i]!=0)
                        {
                            str += tw[n[i]-2] + ' ';
                            sk=1;
                        }
                    }
                    else if (n[i]!=0)
                    {
                        str += dg[n[i]] +' ';
                        if ((x-i)%3==0) str += 'hundred ';
                        sk=1;
                    }

                    if ((x-i)%3==1)
                    {
                        if (sk) str += th[(x-i-1)/3] + ' ';
                        sk=0;
                    }
                }
                if (x != s.length)
                {
                    var y = s.length;
                    str += 'point ';
                    for (var i=x+1; i<y; i++) str += dg[n[i]] +' ';
                }
                var ret_str = str.replace(/\s+/g,' ');
                if(ret_str.indexOf("thousand") > 0)
                {
                    ret_str = ret_str.replace("thousand", "thousand,");
                }

                var num_words = ret_str.split(" ");
                var new_num_words = [];
                $.each(num_words, function(i, num_word)
                {
                    if(num_word.length < 1)
                    {
                        return;
                    }
                    var new_str = num_word[0] + '';
                    new_str = new_str.toUpperCase();
                    for(var i = 1; i < num_word.length; i++)
                    {
                        new_str += num_word[i];
                    }
                    new_num_words.push(new_str);
                });
                return new_num_words.join(" ");

            }
            function getDateString()
            {
                var fn = function()
                {
                    var d = new Date();
                    var str = (d.getMonth() + 1) + '';
                    str += "/";
                    str += d.getDate() + '';
                    str += "/";
                    str += d.getFullYear() + '';

                    return str;

                    str += " ";
                    var hours = d.getHours();
                    var is_pm = false;
                    if(hours > 11)
                    {
                        is_pm = true;
                        hours -= 12;
                    }
                    str += hours + '';
                    str += ":";
                    var mins_str = d.getMinutes() + '';
                    if(mins_str.length === 1)
                    {
                        mins_str = "0" + mins_str;
                    }
                    str += mins_str;
                    str += ":";
                    var seconds_str = d.getSeconds() + '';
                    if(seconds_str.length === 1)
                    {
                        seconds_str = "0" + seconds_str;
                    }
                    str += " ";
                    if(is_pm)
                    {
                        str += "PM";
                    }
                    else
                    {
                        str += "AM";
                    }
                    return str;
                };
                return fn();
            }

            function generateTimesInSelectMenus()
            {
                // do the hours
                for(var i = 1; i < 13; i++)
                {
                    var padded_i = i + '';
                    if(padded_i.length === 1)
                    {
                        padded_i = "0" + padded_i;
                    }
                    $("#sp2_hours").append($("<option></option>").attr("value", (i + '')).text(padded_i));
                }

                // do the mins
                for(var i = 0; i <= 45; i += 15)
                {
                    var padded_i2 = i + '';
                    if(padded_i2.length === 1)
                    {
                        padded_i2 = "0" + padded_i2;
                    }
                    $("#sp2_mins").append($("<option></option>").attr("value", (i + '')).text(padded_i2));
                }
            }
            window.user_identifier = "{{ user_identifier }}";
            window.n00b = ({{n00b}} === 1);
            window.rep_id = "{{ rep_id }}";
            window.tax_data = {{ tax_brackets_json|safe }};
            window.temp_intervals = [];
            window.all_keys_reserved = [];
            window.onunload = function() {killReservations(false);};
            window.onbeforeunload = function() {killReservations(false);};
            window.required_actions_count = {{required_actions_count}};
            window.is_manager = {{ is_manager }};
            //window.held_count = {{held_count}};
            //window.perfect_packet_count = {{perfect_packet_count}};
            //window.perfect_packet_rejection_count = {{perfect_packet_rejection_count}};
            window.unread_note_count = {{unread_note_count}};
            window.save_me_count = {{save_me_count}};

            function clearApp(cb)
            {
                $(".msg_file").remove();
                $.each(window.temp_intervals, function(i, interval)
                {
                    window.clearInterval(interval);
                });
                window.temp_intervals = [];
                if(window.all_keys_reserved.length > 0)
                {
                    
                }

                var time = 250 * (($.trim($("#app_area").html()) !== "") * 1);
                $("#app_area").animate({opacity: 0.0}, time, function()
                {
                    $("#app_area").html("");
                    cb();
                    $("#app_area").animate({opacity: 1.0}, time, function()
                    {
                    });
                });
                $("#app_area")[0].scrollIntoView();
            }
            function landscapeCheck()
            {
                /*var width = $(window).width();
                var height = $(window).height();

                width = width + '';
                height = height + '';
                width = width.replace("px", "");
                height = height.replace("px", "");
                width = parseInt(width);
                height = parseInt(height);

                if(height > width)
                {
                    $("#landscape_reqd").css("display", "block");
                    $(".container").css("display", "none");
                }
                else
                {
                    $("#landscape_reqd").css("display", "none");
                    $(".container").css("display", "block");
                }*/
                return;
            }
            window.step_info =
            [
                {
                    "name": "Step 1",
                    "description": "Perfect Packet Submission",
                    "step_no": "0",
                    "step_key": "pp_sub",
                    "bg": "#908D8D"
                },
                {
                    "name": "Step 2",
                    "description": "Rejected Perfect Packet Pending Resubmission",
                    "step_no": "1",
                    "step_key": "pp_rejected_pending_resubmission",
                    "bg": "#7B7575"
                },
                {
                    "name": "Step 3",
                    "description": "Pending Perfect Packet Approval",
                    "step_no": "2",
                    "step_key": "pp_pending_approval",
                    "bg": "#676565"
                },
                {
                    "name": "Step 4",
                    "description": "Pending Permit Submission",
                    "step_no": "3",
                    "step_key": "perm_sub_pending",
                    "bg": "#536877"
                },
                {
                    "name": "Step 5",
                    "description": "Pending Permit Approval",
                    "step_no": "4",
                    "step_key": "pending_perm_approved",
                    "bg": "#4D5D69"
                },
                {
                    "name": "Step 6",
                    "description": "Permit Rejected Pending Resubmission",
                    "step_no": "5",
                    "step_key": "perm_rejected_pending_resubmission",
                    "bg": "#3C5365"
                },
                {
                    "name": "Step 7",
                    "description": "Permit Approved Pending Scheduling",
                    "step_no": "6",
                    "step_key": "perm_approved_pending_scheduling",
                    "bg": "#436988"
                },
                {
                    "name": "Step 8",
                    "description": "Panel Work Needed",
                    "step_no": "7",
                    "step_key": "panel_work_needed",
                    "bg": "#4E8CC1"
                },
                {
                    "name": "Step 9",
                    "description": "Panel Work Scheduled",
                    "step_no": "8",
                    "step_key": "panel_work_scheduled",
                    "bg": null
                },
                {
                    "name": "Step 10",
                    "description": "Construction Start Scheduled",
                    "step_no": "9",
                    "step_key": "construction_start_scheduled",
                    "bg": "#2580CE"
                },
                {
                    "name": "Step 11",
                    "description": "Construction Completed - Pending PTO",
                    "step_no": "10",
                    "step_key": "construction_completed",
                    "bg": "#1E86E0"
                },
                {
                    "name": "Step 12",
                    "description": "Permission to Operate Granted",
                    "step_no": "11",
                    "step_key": "operation_perm",
                    "bg": "#0089FF"
                }
            ];

            function initCustomerProgressLayout(step_idx)
            {
                if(typeof(step_idx) + '' === "undefined")
                {
                    step_idx = 0;
                }
                var app_area = $("#app_area");

                var cust_prog_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var cust_prog_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("cust_prog_div");
                var list_of_customers_div = $("<div></div>").addClass("row").addClass("customer_progress_outer").append($("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12"));
                var cust_prog_spacer2 = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");

                $("<h2></h2>").addClass("cust_prog_main_lbl").html("Customer Progress:").css("clear", "both")
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-danger").text("Back").addClass("cp-back-btn")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                )
                .appendTo(cust_prog_list_div);

                var customer_progress_ul_dd = $("<div></div>").addClass("dropdown");
                var customer_progress_ul_btn = $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("aria-expanded", "true").attr("id", "dropdownMenu333");
                customer_progress_ul_btn.text(window.step_info[step_idx].name).append($("<span></span>").addClass("caret"));

                var customer_progress_ul = $("<ul></ul>").addClass("customer_progress_ul").addClass("dropdown-menu").attr("role", "menu").attr("aria-labelledby", "dropdownMenu333");

                $.each(window.step_info, function(i, step_info_item)
                {
                    var li = $("<li></li>").attr("role", "presentation");
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text(step_info_item.name);
                    li.attr("title", step_info_item.description);
                    li.click(function()
                    {
                        $("#dropdownMenu333").text(li.text());
                        $("<span></span>").addClass("caret").appendTo($("#dropdownMenu333"));
                        showCustomerProgressForRep(step_info_item);
                    });
                    a.appendTo(li);
                    li.appendTo(customer_progress_ul);

                    li.appendTo(customer_progress_ul);
                });

                $("<li></li>").attr("role", "presentation")
                .append
                (
                    $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("Archived Customers")
                )
                .attr("title", "Archived Customers")
                .click(function()
                {
                    $("#dropdownMenu333").text("Archived Customers");
                    $("<span></span>").addClass("caret").appendTo($("#dropdownMenu333"));
                    showArchivedCustomersForRep();
                }).prependTo(customer_progress_ul);

                customer_progress_ul_btn.appendTo(customer_progress_ul_dd);
                customer_progress_ul.appendTo(customer_progress_ul_dd);

                customer_progress_ul_dd.appendTo(cust_prog_list_div);

                $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").attr("id", "cust_prog_back").click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                }).appendTo(cust_prog_list_div);

                list_of_customers_div.appendTo(cust_prog_list_div);

                cust_prog_spacer.appendTo(app_area);
                cust_prog_list_div.appendTo(app_area);
                cust_prog_spacer2.appendTo(app_area);

            }
            function showCustomerProgressDetailsForRep(customer, div)
            {
                var orig_txt = div.find(".pm_progress_customer_name").text();
                div.css("opacity", "0.2");
                div.find(".pm_progress_customer_name").text("Loading...");

                var details_div = $("<div></div>").addClass("pm_progress_details_div");

                var display_items =
                [
                    [
                        {
                            "name": "Project Manager Name",
                            "value": function(obj)
                            {
                                if(typeof(obj["pm"]) + '' === "undefined")
                                {
                                    return "n/a";
                                }
                                return obj.pm.name;

                            }
                        },
                        {
                            "name": "Project Manager Phone",
                            "value": function(obj)
                            {
                                if(typeof(obj["pm"]) + '' === "undefined")
                                {
                                    return "n/a";
                                }
                                var phone = obj.pm.phone.digits().split("");
                                return "<a href='tel:'" + phone.join("") + "'>(" + phone[0] + phone[1] + phone[2] + ") " + phone[3] + phone[4] + phone[5] + "-" + phone[6] + phone[7] + phone[8] + phone[9] + "</a><br /><span class='pm_warning_msg'>PLEASE ONLY CALL M-F 9-5</span>";
                            }
                        },
                        {
                            "name": "Project Manager Email",
                            "value": function(obj)
                            {
                                if(typeof(obj["pm"]) + '' === "undefined")
                                {
                                    return "n/a";
                                }
                                return "<a href='mailto:'" + obj.pm.email + "'>" + obj.pm.email + "</a>";
                            }
                        }
                    ]
                ];

                $.post("./data", {"fn": "get_pm_details_for_customer", "identifier": customer.identifier}).done(function(resp)
                {
                    if(typeof(resp["closer"]) + '' !== "undefined")
                    {
                        display_items[0].push
                        (
                            {
                                "name": "Closer Name",
                                "value": function(obj)
                                {
                                    return obj.closer.name;
                                }
                            }
                        );
                    }
                    display_items.push
                    (
                        [
                            {
                                "name": "Customer Name",
                                "value": function(obj)
                                {
                                    return obj.customer_first_name + " " + obj.customer_last_name;
                                }
                            },
                            {
                                "name": "Customer Address",
                                "value": function(obj)
                                {
                                    return obj.customer_address + "<br />" + obj.customer_city + "<br />" + obj.customer_state;
                                }
                            },
                            {
                                "name": "Customer Phone",
                                "value": function(obj)
                                {
                                    var phone = obj.customer_phone.digits().split("");
                                    return "<a href='tel:'" + phone.join("") + "'>(" + phone[0] + phone[1] + phone[2] + ") " + phone[3] + phone[4] + phone[5] + "-" + phone[6] + phone[7] + phone[8] + phone[9] + "</a>";
                                }
                            },
                            {
                                "name": "Customer Email",
                                "value": function(obj)
                                {
                                    return "<a href='mailto:'" + obj.customer_email + "'>" + obj.customer_email + "</a>";
                                }
                            }
                        ]
                    );

                    display_items.push
                    (
                        [
                            {
                                "name": "Panel Count",
                                "value": function(obj)
                                {
                                    return obj.proposal.panel_qty;
                                }
                            },
                            {
                                "name": "Panel Type",
                                "value": function(obj)
                                {
                                    return obj.proposal.panel_type.substring(0, obj.proposal.panel_type.indexOf("[[["));
                                }
                            },
                            {
                                "name": "System Size",
                                "value": function(obj)
                                {
                                    return obj.proposal.system_size;
                                }
                            },
                            {
                                "name": "Total System Cost",
                                "value": function(obj)
                                {
                                    return currencyFormat(parseFloat(obj.total_system_cost));
                                }
                            }
                        ]
                    );
                    display_items.push
                    (
                        [
                            {
                                "name": "Signed Date",
                                "value": function(obj)
                                {
                                    var mom = moment(obj.signed_date, "YYYY-MM-DD");;
                                    if(mom.year() === 1970)
                                    {
                                        return "N/A";
                                    }
                                    return mom.format("MM/DD/YYYY");
                                }
                            },
                            {
                                "name": "Welcome Call Date",
                                "value": function(obj)
                                {
                                    var mom = moment(obj.welcome_call_date, "YYYY-MM-DD");;
                                    if(mom.year() === 1970)
                                    {
                                        return "N/A";
                                    }
                                    return mom.format("MM/DD/YYYY");

                                }
                            },
                            {
                                "name": "Roof Work Needed",
                                "value": function(obj)
                                {
                                    return {"0": "No", "1": "Yes"}[obj.roof_work_needed];
                                }
                            },
                            {
                                "name": "New Layout Needed",
                                "value": function(obj)
                                {
                                    return {"0": "No", "1": "Yes"}[obj.new_layout_needed];
                                }
                            }
                        ]
                    );
                    display_items.push
                    (
                        [
                            {
                                "name": "Fund",
                                "value": function(obj)
                                {
                                    var ret = "N/A";
                                    $.each(obj.funds, function(ii, fund)
                                    {
                                        if(fund.value === obj.fund)
                                        {
                                            ret = fund.value_friendly;
                                        }
                                    });
                                    return ret;
                                }
                            },
                            {
                                "name": "Commission",
                                "value": function(obj)
                                {                                    
                                    if(obj.commission_option === "A")
                                    {
                                        return "Standard Commission";
                                    }
                                    return "-$" + (Math.abs(parseInt(obj.commission_options[obj.commission_option])) + '') + "/KW";
                                }
                            },
                            {
                                "name": "Commission Reviewed",
                                "value": function(obj)
                                {
                                    return {"0": "No", "1": "Yes"}[obj.commission_reviewed];
                                }
                            },
                            {
                                "name": "Jursidction",
                                "value": function(obj)
                                {
                                    var ret_val = "TBD";
                                    $.each(obj.jurisdictions, function(iiiii, eeeee)
                                    {
                                        if(eeeee.value === obj.jurisdiction)
                                        {
                                            ret_val = eeeee.value_friendly;
                                        }
                                    });
                                    return ret_val;
                                }
                            },
                            {
                                "name": "Verified By",
                                "value": function(obj)
                                {
                                    if(typeof(obj["verified_by"]) + '' === "undefined")
                                    {
                                        return "Not Yet Verified";
                                    }
                                    return obj.verified_by;
                                }
                            },
                            {
                                "name": "Utility Account #",
                                "value": function(obj)
                                {
                                    return obj.customer_utility_account_number;
                                }
                            },
                            {
                                "name": "Meter #",
                                "value": function(obj)
                                {
                                    return obj.meter_number;
                                }
                            },
                            {
                                "name": "Offset",
                                "value": function(obj)
                                {
                                    return obj.proposal.offset;
                                }
                            }
                        ]
                    );

                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove").click(function()
                    {
                        details_div.remove();
                    }).appendTo(details_div);
                    $("<h3></h3>").text("Customer Details:").appendTo(details_div);
                    $("<hr />").appendTo(details_div);
                    $.each(display_items, function(iii, group)
                    {
                        $.each(group, function(iiii, item)
                        {
                            var inner_d = $("<div></div>").addClass("inner_d_details");
                            $("<span></span>").addClass("label").addClass("label-primary").text(item.name).appendTo(inner_d);
                            $("<p></p>").html(item.value(resp)).appendTo(inner_d);
                            inner_d.appendTo(details_div);
                        });
                    });
                    $("<div></div>").css("clear", "both").css("min-height", "1em").appendTo(details_div);
                    $("<h3></h3>").text("Customer Progress:")
                    .append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-danger").text("Back").addClass("cp-back-btn")
                        .click(function()
                        {
                            clearApp(function()
                            {
                                showIconGrid();
                            });
                        })
                    )
                    .appendTo(details_div);

                    var checklist_1 =
                    [
                        {
                            "name": "Welcome Call Completed",
                            "type": "checkbox",
                            "key": "welcome_call_completed"
                        },
                        {
                            "name": "Initial Payment Requested/Received",
                            "type": "checkbox",
                            "key": "initial_payment_requested_received"
                        },
                        {
                            "name": "Perfect Packet",
                            "type": "checkbox",
                            "key": "perfect_packet"
                        },
                        {
                            "name": "Panel Assessment",
                            "type": "checkbox",
                            "key": "panel_assessment",
                            "secondary_type": "panel_assessment"
                        },
                        {
                            "name": "Plan Set Ordered",
                            "type": "checkbox",
                            "key": "plan_set_ordered"
                        },
                        {
                            "name": "Plan Set Received",
                            "type": "checkbox",
                            "key": "plan_set_received"
                        },
                        {
                            "name": "Enphase Mapped",
                            "type": "checkbox",
                            "key": "enphase_mapped"
                        },
                        {
                            "name": "Placards Ordered",
                            "type": "checkbox",
                            "key": "placards_ordered"
                        },
                        {
                            "name": "Equipment Ordered",
                            "type": "checkbox",
                            "key": "equipment_ordered"
                        },
                        {
                            "name": "PE Stamps Ordered",
                            "type": "checkbox",
                            "key": "pe_stamps_ordered"
                        },
                        {
                            "name": "PE Stamps Received",
                            "type": "checkbox",
                            "key": "pe_stamps_received"
                        },
                        {
                            "name": "Placards Received",
                            "type": "checkbox",
                            "key": "placards_received"
                        }
                    ];

                    var checklist_2 =
                    [
                        {
                            "name": "Permits With City",
                            "type": "checkbox",
                            "key": "permits_with_city",
                        },
                        {
                            "name": "Permit Status",
                            "type": "checkbox",
                            "key": "permit_status",
                            "secondary_type": "permit_status"
                        },
                        {
                            "name": "Permits with Contractor",
                            "type": "checkbox",
                            "key": "permits_with_contractor"
                        },
                        {
                            "name": "Install",
                            "type": "checkbox",
                            "key": "install"
                        },
                        {
                            "name": "Final Payment Requested/Received",
                            "type": "checkbox",
                            "key": "final_payment_requested_received"
                        },
                        {
                            "name": "Final Inspection",
                            "type": "checkbox",
                            "key": "final_inspection"
                        },
                        {
                            "name": "Submit for PTO",
                            "type": "checkbox",
                            "key": "submit_for_pto"
                        },
                        {
                            "name": "Received PTO",
                            "type": "checkbox",
                            "key": "received_pto"
                        }
                    ];

                    $.each(resp.extra_project_specifics, function(iii, eee)
                    {
                        checklist_2.push(eee);
                    });

                    var kustomer = resp;
                    $.each([checklist_1, checklist_2], function(ii, list)
                    {
                        var checkoff_div = $("<div></div>").addClass("pm_checkoff_div");
                        $.each(list, function(iii, list_item)
                        {
                            var checkoff_item = $("<div></div>").addClass("pm_checkoff_item");
                            var name_span = $("<span></span>").addClass("label").addClass("label-primary").addClass("pm_checkoff_item_name").text(list_item.name);

                            var status = $("<div></div>").addClass("pm_status").text("Incomplete");

                            var date_span = $("<span></span>").addClass("pm_checkoff_datespan").text("TBD");
                            if(typeof(kustomer.project_management_checkoffs[list_item.key]) + '' !== "undefined")
                            {
                                if(typeof(kustomer.project_management_checkoffs[list_item.key]["checked"]) + '' !== "undefined")
                                {
                                    if(kustomer.project_management_checkoffs[list_item.key]["checked"] === true)
                                    {
                                        status.text("Complete");
                                    }
                                }
                                if(typeof(kustomer.project_management_checkoffs[list_item.key]["date"]) + '' !== "undefined")
                                {
                                    date_span.text(moment(kustomer.project_management_checkoffs[list_item.key]["date"], "YYYY-MM-DD").format("MM/DD/YYYY"));
                                }
                            }


                            $.each([name_span, status, date_span], function(iiiii, eeeee)
                            {
                                eeeee.appendTo(checkoff_item);
                            });
                            if(list_item.name === "Permit Status")
                            {
                                if(kustomer.permit_history.length > 0)
                                {
                                    $("<span></span>").addClass("pm_checkoff_datespan").text("Last Status: " + kustomer.permit_history[kustomer.permit_history.length - 1].status).appendTo(checkoff_item);
                                }
                            }
                            checkoff_item.appendTo(checkoff_div);
                        });
                        checkoff_div.appendTo(details_div);
                    });
                    $("<div></div>").css("clear", "both").css("min-height", "0.5em").appendTo(details_div);

                    $(".pm_progress_details_div").remove();
                    details_div.insertAfter(div);
                    div.find(".pm_progress_customer_name").text(orig_txt);
                    div.css("opacity", "1.0");
                });
            }
            function currencyFormat(n)
            {
                return "$" + n.toFixed(2).replace(/./g, function(c, i, a)
                {
                    return i && c !== "." && ((a.length - i) % 3 === 0) ? ',' + c : c;
                });
            }
            function showCustomerProgressForRepV2()
            {
                hideIconGrid();
                $.post("./data", {"fn": "rep_customer_progress_pm_v2"}).done(function(resp)
                {
                    var app_area = $("#app_area");
                    var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var main = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                    var spacer_clone = spacer.clone();

                    $("<h2></h2>").text("Customer Progress")
                    .append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-danger").text("Back").addClass("cp-back-btn")
                        .click(function()
                        {
                            clearApp(function()
                            {
                                showIconGrid();
                            });
                        })
                    )
                    .appendTo(main);
                    var inner_div = $("<div></div>").addClass("pm_inner");

                    $.each(resp.customers, function(i, e)
                    {
                        $("<div><div>").addClass("pm_progress")
                        .append
                        (
                            $("<span></span>").addClass("pm_progress_customer_name")
                            .text(e.customer_name)
                        )
                        .click(function()
                        {
                            showCustomerProgressDetailsForRep(e, $(this));
                        })
                        .appendTo(inner_div);
                    });
                    inner_div.appendTo(main);

                    $.each([spacer, main, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                });
            }
            function showCustomerProgressForRep(step_item, rejected_packets)
            {
                hideIconGrid();

                if(typeof(step_item) + '' === "undefined")
                {
                    step_item = step_info[0];
                    initCustomerProgressLayout();
                }
                if(typeof(rejected_packets) + '' === "undefined" && ((parseInt(step_item.step_no) === 1) || parseInt(step_item.step_no) === 2))
                {
                    $.post("./data", {"fn": "list_rejected_perfect_packets_for_rep"}).done(function(resp)
                    {
                        showCustomerProgressForRep(step_item, resp.packets);
                    });
                    return;
                }
                $(".archived_cust_search_filters").remove();
                $(".customer_progress_outer").find("> .col-xs-12").find("> *").each(function(i, e)
                {
                    $(e).remove();
                });
                $(".cust_prog_div .cust_prog_cust_name, .cust_prog_div h3").remove();

                var step = step_item.step_no;

                $(".cust_prog_div").addClass("step_" + step);

                var days_threshold_classname_fn_map =
                {
                    "pp_sub": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "in_the_green";
                        }
                        if(days <= 6)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "pp_rejected_pending_resubmission": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "in_the_green";
                        }
                        if(days <= 6)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "pp_pending_approval": function(days, util)
                    {
                        if(days <= 3)
                        {
                            return "in_the_green";
                        }
                        if(days <= 6)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "perm_sub_pending": function(days, util)
                    {
                        if(days <= 5)
                        {
                            return "in_the_green";
                        }
                        if(days <= 11)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "pending_perm_approved": function(days, util)
                    {
                        if(days <= 13)
                        {
                            return "in_the_green";
                        }
                        if(days <= 27)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "perm_rejected_pending_resubmission": function(days, util)
                    {
                        if(days <= 3)
                        {
                            return "in_the_green";
                        }
                        if(days <= 6)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "perm_approved_pending_scheduling": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "in_the_green";
                        }
                        if(days <= 4)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "panel_work_needed": function(days, util)
                    {
                        if(days <= 6 + (7 * (util === "san_diego_gas_&_electric" * 1)))
                        {
                            return "in_the_green";
                        }
                        if(days <= 13 + (14 * (util === "san_diego_gas_&_electric" * 1)))
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "panel_work_scheduled": function(days, util)
                    {
                        return "in_the_nothing";
                    },
                    "construction_start_scheduled": function(days, util)
                    {
                        return "in_the_nothing";
                    },
                    "construction_completed": function(days, util)
                    {
                        if(days <= 20)
                        {
                            return "in_the_green";
                        }
                        if(days <= 27)
                        {
                            return "in_the_yellow";
                        }
                        return "in_the_red";
                    },
                    "operation_perm": function(days, util)
                    {
                        return "in_the_nothing"
                    }
                };

                var days_threshold_classname_fn_map2 =
                {
                    "pp_sub": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 6)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "pp_rejected_pending_resubmission": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 6)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "pp_pending_approval": function(days, util)
                    {
                        if(days <= 3)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 6)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "perm_sub_pending": function(days, util)
                    {
                        if(days <= 5)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 11)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "pending_perm_approved": function(days, util)
                    {
                        if(days <= 13)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 27)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                     "perm_rejected_pending_resubmission": function(days, util)
                    {
                        if(days <= 3)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 6)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "perm_approved_pending_scheduling": function(days, util)
                    {
                        if(days <= 2)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 4)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "panel_work_needed": function(days, util)
                    {
                        if(days <= 6 + (7 * (util === "san_diego_gas_&_electric" * 1)))
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 13 + (14 * (util === "san_diego_gas_&_electric" * 1)))
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "panel_work_scheduled": function(days, util)
                    {
                        return "sixty_percent";
                    },
                    "construction_start_scheduled": function(days, util)
                    {
                        return "sixty_percent";
                    },
                    "construction_completed": function(days, util)
                    {
                        if(days <= 20)
                        {
                            return "forty_five_percent";
                        }
                        if(days <= 27)
                        {
                            return "sixty_percent";
                        }
                        return "seventy_five_percent";
                    },
                    "operation_perm": function(days, util)
                    {
                        return "sixty_percent";
                    }
                };

                $(".cust_prog_main_lbl").text("Loading...");
                $.post("./data", {"fn": "get_customer_progress_info_for_rep", "step": step_item.step_key}).done(function(resp)
                {
                    $(".cust_prog_main_lbl").text("Step " + (((step * 1) + 1) + '') + " - " + step_info[step * 1].description + ":");
                    if(resp.items.length === 0)
                    {
                        var h3 = $("<h3></h3>");
                        h3.text("No customers are currently in this step.");
                        h3.css("text-align", "center").css("margin-right", "10%");

                        h3.insertAfter($(".cust_prog_main_lbl"));
                    }
                    $.each(resp.items, function(i, item)
                    {
                        var y1 = item.date.year + '';
                        var m1 = item.date.month + '';
                        if(m1.length === 1)
                        {
                            m1 = "0" + m1;
                        }
                        var d1 = item.date.day + '';
                        if(d1.length === 1)
                        {
                            d1 = "0" + d1;
                        }
                        var date1 = moment(y1 + m1 + d1, "YYYYMMDD");
                        var ago = date1.fromNow();

                        var days_ago = parseInt((date1.diff(moment()) * -1) / (60 * 60 * 24 * 1000));

                        var div = $("<div></div>").addClass("cust_prog_cust_name").addClass("entity_identifier_of_" + item.identifier);
                        div.attr("id", "cust_prog_field_app_id_" + item.field_app_identifier);
                        div.append
                        (
                            $("<input />").attr("type", "hidden").attr("value", item.booking_identifier).addClass("booking_identifier_of_" + item.booking_identifier)
                        )
                        .append(
                            $("<span></span>")
                            .text(item.name)
                            .addClass("cust_prog_cust_name_actual")
                            /*.addClass(days_threshold_classname_fn_map2[step_item.step_key](days_ago, item["utility_provider"] + ''))*/
                            .addClass("sixty_percent")
                            .click(function()
                            {
                                if($(this).nextAll(".progression_arrow").size() > 0)
                                {
                                    $(this).nextAll(".progression_arrow").eq(0).trigger("click");
                                }
                            })
                        );

                        var days_span = $("<span></span>").addClass("badge").addClass("cust_prog_days_since");
                        days_span.click(function()
                        {
                            $(this).nextAll(".progression_arrow").eq(0).trigger("click");
                        });

                        if(date1.fromNow().indexOf("second") > -1 || date1.fromNow().indexOf("minute") > 0 || date1.fromNow().indexOf("hour") > 0)
                        {
                            date1.fromNow = function()
                            {
                                return "Sometime today";
                            };
                        }
                        var padding = "";
                        if(parseInt(days_ago) < 10)
                        {
                            padding += "0";
                        }
                        days_span.text(padding + (days_ago + ''));
                        var txt_part2 = (m1 + "-" + d1 + "-" + y1);
                        var txt_part3 = (m1 + "-" + d1 + "-" + y1);
                        if(days_ago === 0)
                        {
                            txt_part2 = "today";
                        }
                        days_span.attr("title", date1.fromNow() + ", " + txt_part2);
                        days_span.addClass(days_threshold_classname_fn_map[step_item.step_key](days_ago, item["utility_provider"] + ''));

                        if(step_item.step_key !== "panel_work_scheduled" && step_item.step_key !== "construction_start_scheduled" && step_item.step_key !== "operation_perm")
                        {
                            days_span.appendTo(div);
                        }
                        else
                        {
                            var d_span = $("<span></span>").addClass("date-scheduled").text(date1.format("MM-DD-YYYY")).attr("title", "Date work is scheduled for");
                            if(step_item.step_key === "operation_perm")
                            {
                                d_span.attr("title", "Date permission to operate was granted")
                            }
                            d_span.appendTo(div);
                        }

                        if(step_item.step_key === "perm_rejected_pending_resubmission")
                        {
                            var rej_count_span = $("<span></span>").addClass("badge").addClass("permit_rej_cnt");
                            rej_count_span.text(item.rejection_count + '');
                            rej_count_span.attr("title", "This permit has been rejected " + (item.rejection_count + '') + " times by the city.");
                            if(item.rejection_count === 1)
                            {
                                rej_count_span.attr("title", rej_count_span.attr("title").replace("times", "time"));
                            }
                            rej_count_span.appendTo(div);
                        }

                        if(step_item.step_key === "panel_work_needed")
                        {
                            $("<span></span>").addClass("panel_cp_util_provider").text("  " + item["utility_provider"]).prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-flash")).appendTo(div);
                        }

                        if(item.step_key == "perm_approved_pending_scheduling")
                        {
                            var tytle = "No info on whether " + item.name + "'s  permit required panel work.";
                            if(item["extras"]["panel_work_suggestion"] === "no")
                            {
                                tytle = "No panel work required for " + item.name + "'s job.";
                            }
                            else if(item["extras"]["panel_work_suggestion"] === "yes")
                            {
                                tytle = item.name + "'s job requires panel work.'"
                            }
                            var info_glyph = $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").attr("title", tytle);
                            info_glyph.appendTo(div);
                        }

                        var archiv_btn = $("<span></span>").addClass("glyphicon").addClass("glyphicon-trash").addClass("rep_cust_prog_archive_btn").click
                        (
                            function()
                            {
                                promptForArchive(item.field_app_identifier, item.name);
                            }
                        );

                        var save_ico = $("<span></span>").addClass("glyphicon").addClass("cp_floppy")
                        .append
                        (
                            $("<i></i>").addClass("fa").addClass("fa-life-ring")
                        );

                        save_ico.click(function()
                        {
                            saveCustomer(item.field_app_identifier, $(this).parent(), item.name);
                        });

                        if(step_item.step_key !== "operation_perm")
                        {
                            if(div.find(".cust_prog_days_since").size() > 0)
                            {
                                save_ico.prependTo(div);
                                archiv_btn.prependTo(div);
                            }
                            else
                            {
                                save_ico.insertBefore(div.find(".cust_prog_cust_name_actual").eq(0));
                                //archiv_btn.insertBefore(div.find(".cust_prog_cust_name_actual").eq(0));
                                archiv_btn.insertBefore(save_ico);
                            }
                        }
                        div.appendTo($(".cust_prog_div").find(".col-xs-12").eq(0));
                    });

                    var add_progress_button_fn = function()
                    {
                        $.each(resp.items, function(i, item)
                        {
                            var progression_arrow = $("<button></button>").addClass("progression_arrow").addClass("btn").addClass("btn-primary");
                            progression_arrow.html("&rarr;").attr("title", "Progress to next step");
                            progression_arrow.css("display", "none");
                            progression_arrow.click(function()
                            {
                                clearApp(function()
                                {
                                    showCustomerNotes(item.field_app_identifier);
                                });
                            });

                            progression_arrow.appendTo($(".cust_prog_cust_name").eq(i));
                        });
                    };

                    var hint_at_rejections_fn = function()
                    {
                        $.each(resp.items, function(i, item)
                        {
                            if(item.rejected === true)
                            {
                                var rejection_hint_span = $("<span></span>").addClass("glyphicon").addClass("glyphicon-exclamation-sign").attr("title", "This packet is currently in a rejected state with outstanding items");
                                rejection_hint_span.appendTo($(".cust_prog_cust_name").eq(i));
                            }
                        });
                    };

                    add_progress_button_fn();

                    if(parseInt(step) === 1)
                    {
                        //hint_at_rejections_fn();
                    }
                });
            }
            function saveCustomer(identifier, jq_div_to_remove, name)
            {
                var html =
                $("<div></div>").append
                (
                    $("<p></p>").text("In a few words, please explain why " + name + " is being marked as \"Save Me\"...")
                )
                .append
                (
                    $("<textarea></textarea>").addClass("saveme_reason").attr("placeholder", "Marking " + name + " as \"Save Me\" because...")
                );

                BootstrapDialog.show
                (
                    {
                        "title": "Annotating " + name + " as \"Save Me\"",
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Nevermind",
                                "cssClass": "btn-primary",
                                "action": function(dialog)
                                {
                                    dialog.close();
                                }
                            },
                            {
                                "label": "Save " + name.split(" ")[0],
                                "cssClass": "btn-danger",
                                "action": function(dialog)
                                {
                                    if($.trim($(".saveme_reason").eq(0).val()).length < 5)
                                    {
                                        window.alert("A descriptive reason must be provided.");
                                        return;
                                    }
                                    var ok_btn = $(".bootstrap-dialog-footer").find(".btn");
                                    ok_btn.text("Saving...");
                                    $.post("./data", {"fn": "save_customer", "identifier": identifier, "reason": $.trim($(".saveme_reason").eq(0).val())}).done(function(resp)
                                    {
                                        dialog.close();
                                        jq_div_to_remove.remove();
                                    });
                                }
                            }
                        ]
                    }
                );
            }
            function showArchivedCustomersForRep(offset, fname, lname)
            {
                $(".cust_prog_main_lbl").text("Loading...");
                $(".archived_cust_search_filters").remove();
                $(".customer_progress_outer").find("> .col-xs-12").find("> *").each(function(i, e)
                {
                    $(e).remove();
                });
                $(".cust_prog_div .cust_prog_cust_name, .cust_prog_div h3").remove();
                var req_payload =
                {
                    "offset": offset,
                    "fname": fname + '',
                    "lname": lname + '',
                    "has_firstname_filter": ((typeof(fname) + '') !== "undefined"),
                    "has_lastname_filter":  ((typeof(lname) + '') !== "undefined")
                }
                $.post("./data", {"fn": "list_archived_customers_for_rep", "payload": JSON.stringify(req_payload)})
                .done(function(resp)
                {
                    var search_fn = function()
                    {
                        var v1 = $.trim($("#cust_archive_search_fname").val());
                        if(v1.length === 0)
                        {
                            v1 = undefined;
                        }

                        var v2 = $.trim($("#cust_archive_search_lname").val());
                        if(v2.length === 0)
                        {
                            v2 = undefined;
                        }
                        showArchivedCustomersForRep(0, v1, v2);
                    };
                    $.each(resp.customers, function(i, customer)
                    {
                        var cust_div = $("<div></div>").attr("id", "identifier_of_" + customer.identifier).addClass("row").addClass("archived_cust_row");
                        cust_div.append
                        (
                            $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").text(customer.name)
                            .append
                            (
                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-question-sign").attr("title", "Show reason why " + customer.name + " was archived")
                                .click(function()
                                {
                                    $(".archive_hint").remove();
                                    var hint_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").addClass("archive_hint");
                                    hint_div.append($("<p></p>").text(customer.name + " was archived because:"));
                                    hint_div.append
                                    (
                                        $("<br />")
                                    );
                                    hint_div.append
                                    (
                                        $("<p></p>").text(customer.archive_reason)
                                    );
                                    hint_div.appendTo($("#identifier_of_" + customer.identifier));
                                })
                            )
                        );
                        cust_div.appendTo($(".cust_prog_div").find(".col-xs-12").eq(0));
                    });
                    var val1 = "";
                    var val2 = "";
                    if(resp.original_payload["fname"] !== "undefined")
                    {
                        val1 = resp.original_payload["fname"];
                    }
                    if(resp.original_payload["lname"] !== "undefined")
                    {
                        val2 = resp.original_payload["lname"];
                    }
                    $("<div></div>").addClass("archived_cust_search_filters")
                    .append
                    (
                        $("<input />").attr("placeholder", "First Name...").attr("id", "cust_archive_search_fname").attr("value", val1)
                        .on("blur", function()
                        {
                            search_fn();
                        })
                    )
                    .append
                    (
                        $("<input />").attr("placeholder", "Last Name...").attr("id", "cust_archive_search_lname").attr("value", val2)
                        .on("blur", function()
                        {
                            search_fn();
                        })
                    ).insertBefore($(".archived_cust_row").first());
                    $(".cust_prog_main_lbl").text("Archived Customers");
                });

            }
            function buildIcons()
            {
                var iconInfo =
                [
                    {
                        'name': 'Paycheck Preview',
                        'glyphicon_class': 'glyphicon-file',
                        'href': null,
                        'id': 'perfect_packet_paycheck',
                        'click_fn': function(el)
                        {
                            $("#perfect_packet_paycheck").closest(".grid_icon_wrapper").css("opacity", "0.1");
                            $.post("./data", {"fn": "calculate_upcoming_paycheck_for_rep"}).done(function(resp)
                            {
                                clearApp(function()
                                {
                                    $("#perfect_packet_paycheck").closest(".grid_icon_wrapper").css("opacity", "1.0");
                                    previewPaycheck(resp.paycheck_data);
                                });
                            });
                        },
                        'onload': function(el)
                        {
                            var cont = $("<div></div>").addClass("perfect_packet_usd_cont").click(this.click_fn);
                            var usd = $("<span></span>").addClass("glyphicon glyphicon-usd perfect_packet_usd");
                            cont.append(usd);
                            el.parent().append(cont);
                        }
                    },
                    {
                        'name': 'Appointment Form',
                        'glyphicon_class': 'glyphicon-list-alt',
                        'href': './sales'
                    },/*
                    {
                        'name': 'Perfect Packet',
                        'glyphicon_class': 'glyphicon-paste',
                        'href': null,
                        'id': 'perfect_packet_main_icon',
                        'click_fn': function(el)
                        {
                            var badge_cnt = 0;
                            $("#icon_grid").find(".badge").each(function(i, e)
                            {
                                badge_cnt += parseInt($(e).text());
                            });
                            if(badge_cnt > 0)
                            {
                                clearApp(function()
                                {
                                    listPerfectPackets(parseInt($(".badgered").eq(0).text()));
                                });
                            }
                        },
                        'onload': function(el)
                        {

                        }
                    },*/
                    {
                        "name": "Leads",
                        "glyphicon_class": "glyphicon-star-empty",
                        "href": null,
                        "id": "my_leads",
                        "click_fn": function()
                        {
                            clearApp(function()
                            {
                                loadLeads();
                            });
                        }
                    },
                    {
                        "name": "Calendar",
                        "glyphicon_class": "glyphicon-time",
                        "href": null,
                        "id": "sp2_cal",
                        "click_fn": function()
                        {
                            clearApp(function()
                            {
                                loadSP2Calendar();
                            });
                        }
                    },
                    {
                        'name': 'My Proposals',
                        'glyphicon_class': 'glyphicon-open-file',
                        'href': null,
                        'id': 'sp_schedule_icon',
                        'click_fn': function(el)
                        {
                            /*if(window.confirm("You understand that your schedule only needs to be exported once, and that it can be updated directly from within Google Sheets. If you're exporting more than once, it should be because you've accidentally deleted the spreadsheet or because you switched Google accounts.\n\nAgreed?"))
                            {
                                var gmail_address = window.prompt("Please enter your Gmail or Google Apps for Work email addres:");
                                if(gmail_address === null || gmail_address === "" || (typeof(gmail_address) + '') === "undefined")
                                {
                                    return;
                                }
                                var whole_name = "{{ user_name }}";
                                var name_vals = whole_name.split(" ");

                                var last_name = "";
                                var first_name = "";

                                last_name = name_vals[name_vals.length - 1];
                                first_name = name_vals[0];

                                $.post("./data", {"fn": "get_apps_script_url", "label": "rep_sp2_schedule"}).done(function(resp)
                                {
                                    var overlay_div = $("<div></div>").addClass("export_overlay_div");
                                    var form = $("<form></form>");
                                    form.attr("target", "_blank");
                                    form.attr("method", "POST");
                                    form.attr("action", resp);
                                    $("<input />").attr("type", "hidden").attr("name", "gmail_address").attr("value", gmail_address).val(gmail_address).appendTo(form);
                                    $("<input />").attr("type", "hidden").attr("name", "first_name").attr("value", first_name).val(first_name).appendTo(form);
                                    $("<input />").attr("type", "hidden").attr("name", "last_name").attr("value", last_name).val(last_name).appendTo(form);

                                    var btn = $("<button></button>").addClass("btn").addClass("btn-success").attr("type", "submit").text("Continue Export");
                                    btn.click(function()
                                    {
                                        setTimeout(function()
                                        {
                                            $(".export_overlay_div").remove();
                                        }, 1000);
                                    }).appendTo(form);

                                    form.appendTo(overlay_div);
                                    overlay_div.appendTo($("body"));
                                });
                            }*/
                            clearApp(function()
                            {
                                showSP2Schedule();
                            });
                        }
                    },
                    {
                        "name": "Past Customers",
                        "glyphicon_class": "glyphicon-time",
                        "href": null,
                        "id": "pasts_customers",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showPastCustomers();
                            });
                        }
                    },
                    {
                        "name": "Customer Notes",
                        "glyphicon_class": "glyphicon-null",
                        "glyphicon_inner_html": "&#128210;",
                        "href": null,
                        "id": "customer_notes",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showCustomerNotes();
                            });
                        }
                    },
                    {
                        "name": "Customer Progress",
                        "glyphicon_class": "glyphicon-user",
                        "href": null,
                        "id": "customer_prog",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                //showCustomerProgressForRepV2();
                                titanProgress();
                            });
                        }
                    },
                    {
                        "name": "My Settings",
                        "glyphicon_class": "glyphicon glyphicon-cog",
                        "href": null,
                        "id": "user_settings",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                manageSettings();
                            });
                        }
                    },
                    /*{
                        "name": "Customer Holds",
                        "glyphicon_class": "glyphicon-nada-hold",
                        "href": null,
                        "id": "customer_holds",
                        "symbola_html": "&#x1f6c2;",
                        "click_fn": function(el)
                        {
                            showCustomerHolds();
                        }
                    },*/
                    {
                        "name": "Messaging",
                        "glyphicon_class": "glyphicon-envelope",
                        "href": null,
                        "id": "inbox",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                loadInbox();
                            });
                        }
                    },
                    /*{
                        "name": "Active Competitions",
                        "glyphicon-class": "glyphicon-nonexistent",
                        "href": null,
                        "id": "show_contests",
                        "font_awesome_class": "fa-diamond",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showContests();
                            });
                        }
                    },*/
                    {
                        "name": "Leaderboard",
                        "glyphicon_class": "glyphicon-nada-leaderboard",
                        "href": null,
                        "id": "leaderboard",
                        "symbola_html": "<span id='lb_trophee'>&#127942;</span>",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showLeaderBoard();
                            });
                        }
                    },
                    {
                        "name": "SAVE ME PLEASE",
                        "glyphicon-class": "glyphicon-nayyyyyyyyy",
                        "href": null,
                        "id": "save_me",
                        "font_awesome_class": "fa-life-ring",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showSavedCustomers();
                            });
                        }
                    },
                    /*{
                        "name": "Installs Scheduled",
                        "glyphicon-class": "glyphicon-nah-dawg",
                        "href": null,
                        "id": "installs_scheduled",
                        "symbola_html": "&#128736;",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                hideIconGrid();
                                initCustomerProgressLayout(9);
                                showCustomerProgressForRep(step_info[9]);
                            });
                        }
                    }*/
                    {
                        "name": "Required Actions",
                        "glyphicon-class": "glyphicon-exclamation-sign",
                        "href": null,
                        "id": "required_actions",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showRequiredActions();
                            });
                        }
                    },
                    /*{
                        "name": "Solar Reader Chart Generator",
                        "glyphicon-class": "glyphicon-nada",
                        "href": null,
                        "symbola_html": "&#x25D0;",
                        "id": "solar_reader_chart_gen",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                solarReaderChartGen();
                            });
                        }
                    },*/
                    {
                        "name": "My Deals",
                        "glyphicon_class": "glyphicon-nahdawg",
                        "href": null,
                        "id": "upcoming_installs",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                myDeals();
                                
                            });
                        },
                        "symbola_html": "&#129309;"
                    },  
                    {
                        "name": "Training Resources",
                        "glyphicon_class": "glyphicon-film",
                        "href": null,
                        "id": "training_resources",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showTrainingMedia();
                            });
                        }
                    },
                    {
                        "name": "Data Logger Map",
                        "glyphicon_class": "glyphicon-map-marker",
                        "href": null,
                        "id": "data_logger_map",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showDataLoggerMap();
                            });
                        }
                    },
                    {
                        "name": "My Area",
                        "glyphicon_class": "glyphicon-map-marker",
                        "href": null,
                        "id": "my_area",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showMyAreas();
                            });
                        }
                    },
                    {
                        "name": "Nirnberger Special",
                        "glyphicon_class": "glyphicon-nada-dawg",
                        "href": null,
                        "id": "nirnberger_special",
                        "icon_img": "/bootstrap/images/nirnberger.jpg",
                        "click_fn": function(el)
                        {
                            clearApp(function(el)
                            {
                                nirnbergerSpecial();
                            });
                        }
                    },
                    {
                        "name": "Roof Work Needed",
                        "glyphicon_class": "nada-dawg",
                        "href": null,
                        "id": "roof_work_needed",
                        "symbola_html": "&#127983;",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                roofWorkNeeded();
                            });
                        }
                    },
                    {
                        "name": "Assistance Needed",
                        "glyphicon_class": "nada-dawg2",
                        "href": null,
                        "id": "assistance_needed",
                        "symbola_html": "&#128588;",
                        "click_fn": function(el)
                        {
                            clearApp(function()
                            {
                                showAssistanceNeeded();
                            });
                        }
                    }
                ];
                if("{{ assumed }}" === "0")
                {
                    if("{{ carve_out }}" === "1")
                    {
                        iconInfo.push
                        (
                            {
                                "name": "Carve Out",
                                "glyphicon_class": "glyphicon-nahdawg",
                                "href": null,
                                "id": "carve_out",
                                "click_fn": function(el)
                                {
                                    clearApp(function()
                                    {
                                        carveOutRep();
                                    
                                    });
                                },
                                "symbola_html": "&#127831;"
                            }
                        );                  
                    }
                }
                if("{{ user_type }}" !== "solar_pro" && "{{ user_type }}" !== "solar_pro_manager")
                {
                    iconInfo.push
                    (
                        {
                            "name": "Followup",
                            "glyphicon_class": "glyphicon-nahdawg",
                            "href": null,
                            "id": "follow_up_tool",
                            "click_fn": function(el)
                            {
                                clearApp(function()
                                {
                                    loadFollowups();
                                
                                });
                            },
                            "symbola_html": "&#129406;"
                        }
                    );   
                }


                var solar_pro_icon_info = [];
                if("{{ user_type }}" === "solar_pro" || "{{ user_type }}" === "solar_pro_manager")
                {
                    $.each(iconInfo, function(i, icon)
                    {
                        if(icon.name !== "My Proposals" && icon.name !== "Customer Progress" && icon.name !== "Customer Notes" && icon.name !== "Required Actions" && icon.name !== "SAVE ME PLEASE"  && icon.name !== "Leads" && icon.name !== "Past Customers" && icon.name !== "SP2 Calendar" && icon.name !== "Solar Reader Chart Generator" && icon.name !== "Data Logger Map" && icon.name !== "Roof Work Needed" && icon.name !== "Assistance Needed")
                        {
                            solar_pro_icon_info.push(icon);
                        }
                    });
                    iconInfo = solar_pro_icon_info;
                    iconInfo.push
                    (
                        {
                            "name": "My ABs",
                            "glyphicon_class": "glyphicon-user",
                            "href": null,
                            "id": "my_abs",
                            "click_fn": function(el)
                            {
                                clearApp(function()
                                {
                                    showMyABs();
                                });
                            }
                        }
                    );
                    if(["12f019d829c565a4fb4fc97bfa3c246889a709387bb5faa898ba776a8ea5e3e2ec05038fca8b3e662062c3c5dd15dae30ee8221a6881ea24d48cbbc4279b0dd3", "73ce40c80aa8bfbefb9931c2dacd126317c7dc135d239aee9b60cb52a87910be312164e8ce69514a8a35454fa93830947dee1a983bfadda8c065f75b9da0db21"].indexOf(window.user_identifier) > -1)
//                    if(window.n00b)
                    {
                        iconInfo.push
                        (
                            {
                                "name": "Runway",
                                "glyphicon_class": "glyphicon-nada",
                                "href": null,
                                "id": "runway",
                                "symbola_html": "&#9992;",
                                "click_fn": function(el)
                                {
                                    clearApp(function()
                                    {
                                        runWay();
                                    });
                                }
                            }
                        );
                    }                    
                }

                if("{{ user_type }}" === "solar_pro_manager")
                {
                    iconInfo.push
                    (
                        {
                            "name": "Breadcrumbs",
                            "glyphicon-class": "symbola",
                            "href": null,
                            "id": "BreadCrumbIframe",
                            "click_fn": function(el)
                            {
                                clearApp(function()
                                {
                                    BreadCrumbIframe();
                                });
                            }
                        }
                    )
                }
                if(window.user_identifier === "757847f220a5c7d2ce1a13052695176dc5a8f28830fa77565317183d6a3d3897d7e52edd9438d4ff41954d3f3110ae34f9f7f8661cfaf515f654db1062642269" || window.user_identifier === "38655a8a3e258861c88e0bb74ba206af08970f499c355ee9739c95c2b39ff5f7f9ecb7adfef8756f33868e7385a2a951190ad97b332a247e2817fc70253f235c" || window.user_identifier === "b5784e4cc54ecad51cfb2514cddf7dfac070f5df16cb087be40001658a598c14bd775217c7ceb57e05d3f6de57ec259184836526bace120a529811637822d50e" || window.user_identifier === "7c8a5b67f73c4a5b1aab36911b83b5e51cb1a0ba8dabfaaa953e6f1a9fcf8c4213123b3d2d10dc58b62df2c201c1554bf25dd4f10e61c7a1e0d0b20357ce806e")
                {
                    var reader_icon = 
                    {
                        "name": "Data Loggers",
                        "glyphicon_class": "nada symbola",
                        "symbola_html": "&#128223;",
                        "href": null,
                        "id": "data_logger_inventory",
                        "click_fn": function(el)
                        {
                            el.css("opacity", "0.1");
                            $.post("./data", {"fn": "list_all_users"}).done(function(resp)
                            {
                                $.post("/data", {"fn": "get_solar_reader_devices"}).done(function(resp2)
                                {
                                    dlInventory(resp.contacts, resp2.devices);
                                    el.css("opacity", "1.0");
                                });                                
                            });                            
                        }
                    }
                    iconInfo.push(reader_icon);
                }

                var md = new MobileDetect(window.navigator.userAgent);

                if("{{ user_type }}" === "solar_pro_manager" && (md.os() !== "AndroidOS") && (md.os() !== "iOS"))
                {
                    iconInfo.push
                    (
                        {
                            "name": "Area Management",
                            "glyphicon-class": "symbola",
                            "href": null,
                            "id": "area_management",
                            "symbola_html": "&#128506;",
                            "click_fn": function(el)
                            {
                                clearApp(function()
                                {
                                    gridRegionAdministration();
                                });
                            }
                        }
                    );
                }

                $.each(iconInfo, function(i, glyph)
                {
                    var code_name = glyph.name.toLowerCase();
                    while(code_name.indexOf(" ") > -1)
                    {
                        code_name = code_name.replace(" ", "_");
                    }
                    var d = $('<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3"></div>');
                    if([/*"Customer Progress","SAVE ME PLEASE"*/].indexOf(glyph.name) > -1)
                    {
                        d.css("clear", "both");
                    }
                    var i_wrapper = $('<div></div>').addClass('grid_icon_wrapper').addClass("grid_icon_wrapper_for_" + glyph.id);
                    if(glyph.visible === false)
                    {
                        d.css("opacity", "0.0");
                    }
                    var s = $('<span></span>');

                    if(typeof(glyph.id) + '' !== 'undefined')
                    {
                        s.attr('id', glyph.id);
                    }
                    if(glyph.name === "Breadcrumbs")
                    {
                        s.html("&#127838;");
                        s.addClass("symbola");
                    }

                    var p = $('<p></p>');

                    s.addClass('glyphicon').addClass(glyph.glyphicon_class).addClass('grid_icon');
                    
                    if(typeof(glyph.glyphicon_inner_html) + '' !== "undefined")
                    {
                        s.html(glyph.glyphicon_inner_html);
                    }
                    else if(typeof(glyph.symbola_html) + '' !== "undefined")
                    {
                        s.html(glyph.symbola_html);
                        s.css("font-family", "Symbola, \"Symbola\", Arial, Helectiva, sans-serif");
                    }
                    else if(typeof(glyph.font_awesome_class) + '' !== "undefined")
                    {
                        $("<i></i>").addClass("fa").addClass(glyph.font_awesome_class).appendTo(s);
                    }
                    if(glyph.glyphicon_class === 'glyphicon-paste')
                    {
                        i_wrapper.addClass('pp_parent_div');
                    }
                    if(glyph.href === null)
                    {
                        s.click(function()
                        {
                            glyph.click_fn(s);
                        });
                        i_wrapper.append(s);
                    }
                    if(i_wrapper.hasClass("grid_icon_wrapper_for_required_actions"))
                    {
                        s.attr("class", s.attr("class") + " glyphicon-exclamation-sign");
                    }
                    else
                    {
                        i_wrapper.append
                        (
                            $('<a></a>').attr('target', '_blank').attr('href', glyph.href)
                            .append(s)
                        );
                    }
                    if(glyph.onload !== undefined)
                    {
                        glyph.onload(s);
                    }

                    if(glyph["icon_img"] !== undefined)
                    {
                        s.empty();
                        $("<img />").addClass("img").addClass("img-responsive").addClass("rep_icon_img").attr("src", glyph.icon_img).appendTo(s);
                    }

                    d.append(i_wrapper);
                    p.text(glyph.name).addClass('action_name').addClass("action_name_of_" + code_name);

                    d.append(p);

                    var iconGrid = $('#icon_grid');
                    iconGrid.append(d);
                });
            }
            function hint_at_users3(p_el, hint_dictionary, optional_cb)
            {
                if(typeof(optional_cb) + '' === "undefined")
                {
                    optional_cb = function(id){};
                }
                var rem = function()
                {
                    $(".hinted_user").remove();
                };
                var hint_at_yousers = function(p_el, hint_dictionary)
                {
                    var possible_match = $.trim(p_el.val()).toLowerCase();
                    if(typeof(hint_dictionary[possible_match]) + '' !== "undefined")
                    {
                        $.each(hint_dictionary[possible_match], function(i, match)
                        {
                            if(i > 4)
                            {
                                return;
                            }
                            var hinted_user_div = $("<div></div>").addClass("hinted_user").attr("id", "compose_to_" + match.identifier);
                            $("<img />").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + match.identifier + ".jpg")
                            .addClass("img")
                            .addClass("img-responsive")
                            .appendTo(hinted_user_div);

                            hinted_user_div.click(function()
                            {
                                $(".transaction_user_match, .hidden_identifier_for_transaction_match").remove();
                                var img = $(this).find("img");
                                var cloned = img.clone();
                                cloned.addClass("transaction_user_match");
                                cloned.appendTo($(".bootstrap-dialog-body"));
                                $("<p><p>").attr("data-identifier", match.identifier).attr("data-rep_id", match.rep_id).addClass("hidden_identifier_for_transaction_match").text(match.name).appendTo($(".bootstrap-dialog-body"));
                                rem();
                                $(".hinted_users").find("span").trigger("click");
                                var dels = [];
                                $(".hidden_identifier_for_transaction_match").each(function(iii, eee)
                                {
                                    if(iii > 0)
                                    {
                                        dels.push($(eee));
                                    }
                                });
                                $.each(dels, function(iii, eee)
                                {
                                    eee.remove();
                                });
                                p_el.val("");
                                optional_cb(match.identifier);
                            });

                            $("<p></p>").text(match.name).appendTo(hinted_user_div);

                            if($("#compose_to_" + match.identifier).size() + $("#recipient_of_" + match.identifier).size() === 0)
                            {
                                hinted_user_div.appendTo($(".hinted_users"));
                            }
                        });
                    }
                };
                if($(".hinted_user").size() > 0)
                {
                    $(".hinted_user").animate({opacity: 0.0}, 200, function()
                    {
                        rem();
                        hint_at_yousers(p_el, hint_dictionary);
                    });
                }
                else
                {
                    hint_at_yousers(p_el, hint_dictionary);
                }

                if($(".hinted_user").size() === 0)
                {
                    $(".hinted_users").css("display", "none");
                }
                else
                {
                    $(".hinted_users").css("display", "table");
                }
            }
            function selectUser(contacts, on_selected, title, btn_text, msg_txt, processing_txt)
            {
                var hint_dictionary = {};
                var ident_name_map = {};

                // do the first name hints
                $.each(contacts, function(i, contact)
                {
                    ident_name_map[contact.identifier] = contact.name;

                    var fname = contact.first_name.toLowerCase();
                    for(var k = 0; k < fname.length; k++)
                    {
                        var hint = fname.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }

                    var lname = contact.last_name.toLowerCase();
                    for(var k = 0; k < lname.length; k++)
                    {
                        var hint = lname.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }

                    var name = contact.name.toLowerCase();
                    for(var k = 0; k < name.length; k++)
                    {
                        var hint = name.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }
                });
                //var contacts = hint_dictionary;

                var html = $("<div></div>");
                $("<p></p>").text(msg_txt).appendTo(html);
                $("<input />").attr("type", "text").addClass("wc_recipient_transaction_input_box").attr("placeholder", "Rep's name...").appendTo(html);
                var hinted_users_div = $("<div></div>").addClass("hinted_users");
                $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove").appendTo(hinted_users_div);

                hinted_users_div.appendTo(html);

                BootstrapDialog.show
                (
                    {
                        "title": title,
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Nevermind",
                                "cssClass": "btn-danger",
                                "action": function(d)
                                {
                                    d.close();
                                }
                            },
                            {
                                "label": btn_text,
                                "cssClass": "btn-primary",
                                "action": function(d)
                                {
                                    if($(".hidden_identifier_for_transaction_match").size() === 0)
                                    {
                                        window.alert("But you haven't chosen anyone yet?");
                                        return;
                                    }
                                    $(".bootstrap-dialog-footer").find(".btn-primary").css("opacity", "0.5").text(processing_txt);
                                    on_selected(d, $(".hidden_identifier_for_transaction_match").data("identifier"));
                                }
                            }
                        ],
                        "onshown": function(d)
                        {
                            $(".hinted_users").find("span").first().click(function()
                            {
                                $(".hinted_users").css("display", "none");
                                $(".hinted_user").remove();
                                $(".bootstrap-dialog-footer").find("input").first().trigger("keyup");
                            });

                            var to_box = $(".bootstrap-dialog-body").find("input").eq(0);
                            to_box
                            .focus(function()
                            {
                                if(to_box.val() === "Enter someone's name...")
                                {
                                    to_box.val("");
                                }
                            })
                            .blur(function()
                            {
                                if($.trim(to_box.val()) === "")
                                {
                                    to_box.val("Enter someone's name...");
                                }
                            })
                            .on("keyup", function()
                            {
                                if($.trim(to_box.val()).length > 0)
                                {
                                    hint_at_users3(to_box, hint_dictionary, function(data)
                                    {
                                        //confirmCloser(data);
                                    });
                                }
                            });

                            if(typeof(optional_name) + '' !== "undefined")
                            {
                                to_box.val(optional_name);
                                setTimeout(function()
                                {
                                    to_box.trigger("keyup");
                                    setTimeout(function()
                                    {
                                        if($(".hinted_user").size() === 1)
                                        {
                                            $(".hinted_user").first().trigger("click");
                                        }
                                    }, 750);
                                }, 250);
                            }
                        }
                    }
                );
            }
            function dlInventory(contacts, devices)
            {
                var html = $("<div></div>");
                $("<p></p>").text("Please enter the device hash:").appendTo(html);
                $("<input />").attr("type", "text").attr("id", "dev_hash_check_in_check_out").appendTo(html);
                BootstrapDialog.show
                (
                    {
                        "title": "Checking in or checking out?",
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Cancel",
                                "cssClass": "btn-danger",
                                "action": function(d)
                                {
                                    d.close();
                                }
                            },
                            {
                                "label": "Check in Device",
                                "cssClass": "btn-warning",
                                "action": function(d)
                                {
                                    var ret_early9 = true;
                                    var hash = $.trim($("#dev_hash_check_in_check_out").val()).toLowerCase();
                                    var dev_id = "null";
                                    $.each(devices, function(i, device)
                                    {
                                        var lowered = device.hash.toLowerCase();
                                        if(lowered === hash)
                                        {
                                            ret_early9 = false;
                                            dev_id = device.identifier;
                                        }
                                    });
                                    if(ret_early9)
                                    {
                                        window.alert("The device hash could not be found.");
                                        return;
                                    }
                                    $(".bootstrap-dialog-footer").find(".btn-warning").text("Checking In...");
                                    $.post("/data", {"fn": "check_in_reader", "identifier": dev_id}).done(function(r6)
                                    {
                                        $(".bootstrap-dialog-body").text("The device was checked in.");
                                        setTimeout(function()
                                        {
                                            d.close();
                                            dlInventory(contacts, devices);
                                        }, 1000);
                                    });


                                }
                            },
                            {
                                "label": "Check Out Device",
                                "cssClass": "btn-primary",
                                "action": function(d)
                                {
                                    var ret_early9 = true;
                                    var hash = $.trim($("#dev_hash_check_in_check_out").val()).toLowerCase();
                                    var dev_id = "null";
                                    $.each(devices, function(i, device)
                                    {
                                        var lowered = device.hash.toLowerCase();
                                        if(lowered === hash)
                                        {
                                            ret_early9 = false;
                                            dev_id = device.identifier;
                                        }
                                    });
                                    if(ret_early9)
                                    {
                                        window.alert("The device hash could not be found.");
                                        return;
                                    }
                                    d.close();
                                    setTimeout(function()
                                    {
                                        selectUser(contacts, function(dialog, identifier)
                                        {
                                            $.post("/data", {"fn": "check_out_reader", "identifier": dev_id, "rep_identifier": identifier}).done(function(r6)
                                            {                                            
                                                $(".bootstrap-dialog-body").text("The device has been checked out.");
                                                setTimeout(function()
                                                {
                                                    dialog.close();       
                                                    dlInventory(contacts, devices);
                                                }, 1000);
                                            });
                                        }, "Checking Out " + hash, "Check Out", "Choose a rep or solar pro", "Checking Out...");
                                    }, 1000);                                    
                                }
                            }
                        ]
                    }
                );
            }
            function sortByLeadDate(dir)
            {
                var predicate = null;
                if(dir === "asc")
                {
                    predicate = function(a, b)
                    {
                        var mom_a = moment(a.text(), "MM-DD-YYYY");
                        var mom_b = moment(b.text(), "MM-DD-YYYY");

                        return mom_b < mom_a;
                    };
                }
                else
                {
                    predicate = function(a, b)
                    {
                        var mom_a = moment(a.text(), "MM-DD-YYYY");
                        var mom_b = moment(b.text(), "MM-DD-YYYY");

                        return mom_b > mom_a;
                    };
                }

                var svy_ltimes = $(".svy_ltime");
                if(svy_ltimes.length < 2)
                {
                    return;
                }

                svy_ltimes.each(function(i, e)
                {
                    if(i < svy_ltimes.length - 1)
                    {
                        var a = $(e);
                        var b = $(e).next().next().next().next();
                        if(predicate(a, b))
                        {
                            var a_divs = [a.prev().prev(), a.prev(), a, a.next()];
                            var b_divs = [b.prev().prev(), b.prev(), b, b.next()];

                            $.each(b_divs, function(k, ee)
                            {
                                ee.insertBefore(a_divs[0]);
                            });

                            sortByLeadDate(dir);

                        }
                    }

                });
            }
            function showRequiredActions()
            {
                hideIconGrid();
                var row = $("<div></div>").addClass("row").addClass("req_actions_row");
                var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var spacer_clone = spacer_div.clone();
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                $("<h2></h2>").text("Required Actions:").appendTo(main_div);
                $("<div></div>").addClass("dropdown").css("margin-bottom", "1em")
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("data-toggle", "dropdown").text("Choose an Action Category")
                    .append
                    (
                        $("<span></span>").addClass("caret")
                    )
                )
                .append
                (
                    $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu")
                    .append
                    (
                        $("<li></li>").attr("role", "presentation").attr("id", "action_proposal_incomplete")
                        .append
                        (
                            $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("Incomplete Proposals")
                        )
                    )
                )
                .appendTo(main_div);
                $("<button></button>").addClass("btn").addClass("btn-danger").addClass("reqd_actions_back").html("&larr; Back")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                })
                .appendTo(main_div);

                main_div.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        var action_type = $(e).attr("id").replace("action_", "");
                        $(e).closest("ul").prev().text($(e).text());
                        $("<span></span>").addClass("caret").appendTo($(e).closest("ul").prev());
                        $.post("./data", {"fn": "list_required_actions", "action_key": action_type}).done(function(r)
                        {
                            $(".todo_required_action").remove();
                            if(r.actions.length === 0)
                            {
                                $("<div></div>").addClass("todo_required_action")
                                .append
                                (
                                    $("<h4></h4>").text("No required actions for this category").appendTo(main_div)
                                )
                                .appendTo(main_div);
                            }
                            $.each(r.actions, function(i, action)
                            {
                                $("<div></div>").addClass("todo_required_action").attr("id", "required_action_" + action.field_app_identifier)
                                .append
                                (
                                    $("<p></p").addClass("required_action_cust_name").text(action.name)
                                    .append
                                    (
                                        $("<span></span>").attr("title", "Archive Customer").addClass("glyphicon").addClass("glyphicon-trash")
                                        .click(function()
                                        {
                                            promptForArchive(action.field_app_identifier, action.name);
                                        })
                                    )
                                )
                                .append
                                (
                                    $("<p></p>").addClass("required_action_reason").text(action.message)
                                )
                                .append
                                (
                                    $("<textarea></textarea>").attr("placeholder", "Respond to this required action...")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("label").addClass("label-primary").addClass("label-respond-to-action").text("Certiy as Completed")
                                    .click(function()
                                    {
                                        var that = $(this);                                    
                                        if($.trim(that.prev().val()).length > 0)
                                        {
                                            that.parent().css("opacity", "0.2");
                                            $.post("./data", {"fn": "respond_to_required_action", "identifier": action.identifier, "response": $.trim(that.prev().val()), "action_key":  action_type}).done(function(rrr)
                                            {
                                                that.parent().remove();
                                            });
                                        }
                                        else
                                        {
                                            window.alert("You must provide a response to the action in the text input box.");
                                        }
                                    })
                                )
                                .appendTo(main_div);
                            });
                        });
                    });
                });                

                $.each([spacer_div, main_div, spacer_clone], function(i, e)
                {
                    e.appendTo(row);
                });
                row.appendTo(app_area);
                main_div.find("li").first().trigger("click");
            }
            function showSurveyScheduler(cnt)
            {
                hideIconGrid();
                var scheduler_div = $("<div></div>").addClass("row").addClass("scheduler_row");

                var dropdown_div = $("<div></div>").addClass("dropdown");

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("data-toggle", "dropdown")
                .text("")
                .attr("id", "svy_choice_selector")
                .appendTo(dropdown_div);

                var choices_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                if(cnt > 0 || true)
                {
                    $("<li></li>").attr("role", "presentation").attr("id", "choice_of_unbooked")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);")
                        .text
                        (
                            "Surveys to Schedule"
                        )
                    ).appendTo(choices_ul);
                }

                $("<li></li>").attr("role", "presentation").attr("id", "choice_of_upcoming")
                .append
                (
                    $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);")
                    .text
                    (
                        "Upcoming Surveys"
                    )
                ).appendTo(choices_ul);

                choices_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        $("#svy_choice_selector").text($(e).text());
                        $("<span></span>").addClass("caret").appendTo($("#svy_choice_selector"));

                        var criteria = $(e).attr("id").replace("choice_of_", "");

                        loadSurveysForRep(criteria);
                    });
                });

                choices_ul.appendTo(dropdown_div);
                dropdown_div.appendTo(scheduler_div);

                $("<div></div>").addClass("svy_lbl").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").text("Customer Name").appendTo(scheduler_div);
                $("<div></div>").addClass("svy_lbl").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").text("Location").appendTo(scheduler_div);
                $("<div></div>").addClass("svy_lbl").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").text("Lead Date")
                .append
                (
                    $("<span></span>").attr("title", "Sort in ascending order").attr("id", "svy_leaddate_asc").addClass("glyphicon").addClass("glyphicon-arrow-up")
                    .click(function()
                    {
                        sortByLeadDate("asc");
                    })
                )
                .append
                (
                    $("<span></span>").attr("title", "Sort in descending order").attr("id", "svy_leaddate_desc").addClass("glyphicon").addClass("glyphicon-arrow-down")
                    .click(function()
                    {
                        sortByLeadDate("desc");
                    })
                )
                .appendTo(scheduler_div);
                $("<div></div>").addClass("svy_lbl").addClass("sv_lbl_cal_ico").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3")
                .append
                (
                    $("<span></span>").text("Schedule")
                ).appendTo(scheduler_div);

                scheduler_div.appendTo($("#app_area"));

                var idx_to_click = (cnt === 0) * 1;

                $(".scheduler_row").find("ul").find("li").eq(idx_to_click).trigger("click");

                $("<div></div>").addClass("row")
                .append
                (
                    $("<button></button>").addClass("scheduler_back_btn").addClass("btn").addClass("btn-danger").html("&larr; Back").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                ).appendTo($("#app_area"));
            }
            function padDoubleDigits(num)
            {
                num = num * 1;
                if(num < 10)
                {
                    return "0" + (num + '');
                }
                return num + '';
            }
            function loadSurveysForRep(criteria)
            {
                if(criteria === "upcoming")
                {
                    $(".sv_lbl_cal_ico").find("span").text("Reschedule");
                }
                else
                {
                    $(".sv_lbl_cal_ico").find("span").text("Schedule");
                }
                $(".scheduler_row").find(".no_svys").remove();
                $(".scheduler_row").find(".svy_data").remove();
                $.post("./data", {"fn": "get_surveys_for_rep", "criteria": criteria}).done(function(surveys)
                {
                    var surveys2 = [];
                    for(var i = 0; i < 3; i++)
                    {
                        surveys2.push(surveys[0]);
                    }
                    var scheduler_row = $(".scheduler_row");
                    if(surveys.length === 0)
                    {
                        $("<h3></h3>").addClass("no_svys").text("No surveys match this criteria").appendTo(scheduler_row);
                        return;
                    }

                    $.each(surveys, function(i, survey)
                    {
                        scheduler_row.append
                        (
                            $("<div></div>").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").addClass("svy_data").addClass("svy_data_" + survey.identifier).addClass("svy_name").text(survey.name)
                        );

                        scheduler_row.append
                        (
                            $("<div></div>").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").addClass("svy_data").addClass("svy_data_" + survey.identifier).addClass("svy_city").text(survey.city + ", " + survey.state)
                        );

                        var ts = moment.unix(survey.insert_time / 1000);

                        scheduler_row.append
                        (
                            $("<div></div>").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3").addClass("svy_data").addClass("svy_data_" + survey.identifier).addClass("svy_ltime").text(ts.format("MM-DD-YYYY"))
                        );

                        if(criteria === "upcoming")
                        {

                            scheduler_row.append
                            (
                                $("<div></div>")
                                .addClass("svy_data")
                                .addClass("svy_data_" + survey.identifier)
                                .addClass("svy_schedule_btn")
                                .addClass("col-xs-3")
                                .addClass("col-sm-3")
                                .addClass("col-md-3")
                                .addClass("col-lg-3")
                                .addClass("svy_data")
                                .addClass("svy_dt")
                                .append
                                (
                                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-calendar")
                                    .click(function()
                                    {
                                        scheduleSurvey(survey, criteria);
                                    })
                                )
                                /*.append
                                (
                                    $("<br />")
                                )*/
                                .append
                                (
                                    $("<span></span>")
                                    .addClass("data_slot")
                                    .text
                                    (
                                        "Slot #" + (survey.slot_number + '')
                                    )
                                )
                            );
                        }
                        else
                        {
                            scheduler_row.append
                            (
                                $("<div></div>")
                                .addClass("col-xs-3")
                                .addClass("col-sm-3")
                                .addClass("col-md-3")
                                .addClass("col-lg-3")
                                .addClass("svy_data")
                                .addClass("svy_data_" + survey.identifier)
                                .addClass("svy_dt")
                                .append
                                (
                                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-calendar")
                                    .click(function()
                                    {
                                        scheduleSurvey(survey, criteria);
                                    })
                                )
                            );
                        }
                    });
                    try
                    {
                        $("#svy_choice_selector").eq(0)[0].scrollIntoView();
                    }
                    catch(e5956221302)
                    {
                    }
                });
            }
            function scheduleSurvey(survey, criteria)
            {
                var html = $("<div></div>");
                html
                .append
                (
                    $("<p></p>").addClass("svy_booking_lbl").text("Name:")
                )
                .append
                (
                    $("<p></p>").addClass("svy_booking_info").text(survey.name)
                )
                .append
                (
                    $("<p></p>").addClass("svy_booking_lbl").text("Address:")
                )
                .append
                (
                    $("<iframe></iframe>")
                    .attr("frameborder", "0")
                    .attr("scrolling", "0")
                    .attr("marginheight", "0")
                    .attr("marginwidth", "0")
                    .attr("width", "250")
                    .attr("seamless", "seamless")
                    .attr("src", "https://maps.google.com/maps?hl=en&q=" + encodeURIComponent(survey.address + " " + survey.city + ", " + survey.state) + "&ie=UTF8&t=roadmap&z=14&iwloc=B&output=embed")
                )
                .append
                (
                    $("<p></p>").addClass("svy_booking_info").text(survey.address)
                )
                .append
                (
                    $("<p></p>").addClass("svy_booking_lbl").text("SP2 Appointment:")
                )
                .append
                (
                    $("<p></p>").addClass("svy_booking_info").text(moment(survey.sp2_time, "YYYY-MM-DD HH:mm:ss").format("MM-DD-YYYY hh:mm:ss a"))
                );

                $("<hr />").appendTo(html);

                var form = $("<form></form>").addClass("form-horizontal").attr("role", "form").attr("action", "#").attr("method", "GET").attr("id", "svy_sched_form").css("display", "none");
                form.attr("onsubmit", "javascript:return false;");
                form.on("submit", function()
                {
                    return false;
                });
                var date_picker_div = $("<div></div>").addClass("form-group");
                date_picker_div.append
                (
                    $("<label></label>")
                    .addClass("control-label")
                    .addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12")
                    .text("Appointment Time for Survey")
                )
                .append
                (
                    $("<div></div>")
                    .addClass("col-xs-12")
                    .addClass("col-sm-12")
                    .addClass("col-md-12")
                    .addClass("col-lg-12")
                    .append
                    (
                        $("<div></div>").attr("id", "dt_333").addClass("input-append").addClass("date").attr("data-date", "12-02-2012").attr("data-date-format", "dd-mm-yyyy")
                        .append
                        (
                            $("<input />").attr("size", "16").addClass("span2").addClass("eightpoint5").attr("type", "text").attr("value", "12-02-2012").attr("id", "cust_appointment_date")
                        )
                        .append
                        (
                            $("<span></span>").addClass("add-on")
                            .append
                            (
                                $("<i></i>").addClass("icon-th")
                            )
                        )
                        .append
                        (
                            $("<input />").attr("type", "hidden").attr("id", "appt_slot_num").attr("value", "N/A")
                        )
                    )
                ).appendTo(form);
                form.appendTo(html);

                $("<p></p>").addClass("tmp_finding").text("Finding the soonest appointment slot....").appendTo(html);

                var title = "Booking " + survey.name;
                if(criteria === "upcoming")
                {
                    title = "Rescheduling " + survey.name;
                }
                BootstrapDialog.show
                (
                    {
                        "title": title,
                        "message": html.html(),
                        "onshown": function()
                        {
                            var disabled_days = [];
                            var val = getDateString();
                            var split = val.split("/");
                            for(var i = 0; i < split.length; i++)
                            {
                                if(split[i].length === 1)
                                {
                                    split[i] = "0" + split[i];
                                }
                            }
                            disabled_days.push(split.join("-"));
                            var switched_up = split[2] + "-" + split[0] + "-" + split[1];

                            var today = moment(switched_up);
                            for(var i = 0; i < 712; i++)
                            {
                                var day = today;
                                disabled_days.push(day.format("MM-DD-YYYY"));
                                day = day.subtract(1, "days");
                                today = day;
                            }
                            var today2 = moment(switched_up);
                            for(var i = 0; i < 712; i++)
                            {
                                var day = today2;
                                disabled_days.push(day.format("MM-DD-YYYY"));
                                day = day.add(1, "days");
                                today2 = day;
                            }


                            $.post("./data", {"fn": "time_slot_days_available", "office_id": survey.office_identifier, "lead_id": survey.field_app_lead_id}).done(function(resp)
                            {
                                if(typeof(window.office_time_slots) + '' === "undefined" || !window.office_time_slots)
                                {
                                    window.office_time_slots = {};
                                }
                                if(typeof(window.office_time_slots["o_" + survey.office_identifier]) + '' === "undefined" || !window.office_time_slots["o_" + survey.office_identifier])
                                {
                                    window.office_time_slots["o_" + survey.office_identifier] = {};
                                }

                                for(var i = 0; i < resp.dates.length; i++)
                                {
                                    var date_str = resp.dates[i].date;
                                    if(typeof(window.office_time_slots["o_" + survey.office_identifier]["d_" + date_str]) + '' === "undefined" || !window.office_time_slots["o_" + survey.office_identifier]["d_" + date_str])
                                    {
                                        window.office_time_slots["o_" + survey.office_identifier]["d_" + date_str] = {};
                                    }
                                    var slot_available = false;
                                    for(var j = 1; j < 13; j++)
                                    {
                                        window.office_time_slots["o_" + survey.office_identifier]["d_" + date_str]["slot_" + (j + '') + "_enabled"] = resp.dates[i]["slot_" + (j + '') + "_enabled"];
                                        if(resp.dates[i]["slot_" + (j + '') + "_enabled"])
                                        {
                                            slot_available = true;
                                            j = 13;
                                        }
                                    }
                                    if(slot_available)
                                    {
                                        while(disabled_days.indexOf(date_str) !== -1)
                                        {
                                            disabled_days.splice(disabled_days.indexOf(date_str), 1);
                                        }
                                    }
                                }

                                var clone = $("#cust_appointment_date").clone();
                                clone.addClass("cloned_dp");
                                clone.removeAttr("id");
                                $("#cust_appointment_date").replaceWith(clone);
                                $(".cloned_dp").attr("id", "cust_appointment_date").removeClass("cloned_dp");
                                var suggested_day = resp.suggested_date + '';
                                var suggested_slot_num = resp.suggested_slot_number + '';

                                if(suggested_day !== "undefined")
                                {
                                    $("#cust_appointment_date").attr("value", suggested_day);
                                    $("#dt").attr("data-date", suggested_day);
                                }
                                else
                                {
                                    var val2 = getDateString();
                                    var split2 = val.split("/");
                                    for(var i = 0; i < split2.length; i++)
                                    {
                                        if(split2[i].length === 1)
                                        {
                                            split2[i] = "0" + split2[i];
                                        }
                                    }
                                    var switched_up2 = split[2] + "-" + split[0] + "-" + split[1];

                                    var today2 = moment(switched_up2);
                                    var new_str = today2.format("MM-DD-YYYY")
                                    $("#cust_appointment_date").attr("value", new_str);
                                    //$("#dt").attr("data-date", new_str);
                                }

                                $.post("./data", {"fn": "get_bookings", "date": (resp.suggested_date + ''), "office": survey.office_identifier, "lead_id": survey.field_app_lead_id, "v2": "1", "v2": "1"}).done(function(resp2)
                                {
                                    var dropdown_div = $("<div></div>").addClass("dropdown");
                                    var dropdown_btn = $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle");
                                    dropdown_btn.attr("type", "button").attr("id", "dropdownMenu3").attr("data-toggle", "dropdown").attr("aria-expanded", "false");
                                    dropdown_btn.text("Select a Slot");
                                    $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                                    var ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labelledby", "dropdownMenu3");
                                    for(var i = 0; i < resp2.slot_reservations.length; i++)
                                    {
                                        var li = $("<li></li>").attr("role", "presentation");
                                        li.addClass("slot_" + ((i + 1) + ''));
                                        var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("Slot #" + ((i + 1) + ''));
                                        if(resp2.slot_reservations[i])
                                        {
                                            a.css("text-decoration", "line-through");
                                            a.addClass("linethrough_anchor")
                                        }
                                        else
                                        {
                                            a.css("text-decoration", "none");
                                        }
                                        a.appendTo(li);
                                        li.appendTo(ul);
                                    }
                                    ul.find("li").each(function(i, e)
                                    {
                                        $(e).click(function()
                                        {
                                            if(! $(e).find("a").eq(0).hasClass("linethrough_anchor"))
                                            {
                                                var new_val = $(e).attr("class").replace("slot_", "");
                                                $("#appt_slot_num").attr("value", new_val).val(new_val);
                                                var split_items = $("#cust_appointment_date").val().split("-");
                                                var key = survey.office_identifier + "_" + split_items[1] + "_" + split_items[0] + "_" + split_items[2] + "_slot_" + $("#appt_slot_num").val();
                                                if(window.all_keys_reserved.indexOf(key) === -1)
                                                {
                                                    window.all_keys_reserved.push(key);
                                                }
                                                window.current_reservation_key = key;
                                                $.post("/data", {"fn": "reserve_slot", "date": (resp.suggested_date + ''), "office": survey.office_identifier, "lead_id": survey.field_app_lead_id, "slot": new_val}).done(function(resp22)
                                                {
                                                    //
                                                });
                                                $("#dropdownMenu3").eq(0).text($(e).text());
                                                $("<span></span>").addClass("caret").appendTo($("#dropdownMenu3").eq(0));
                                            }
                                        });
                                    });

                                    dropdown_btn.appendTo(dropdown_div);
                                    ul.appendTo(dropdown_div);
                                    if($("#appt_slot_num").nextAll(".dropdown").size() === 0)
                                    {
                                        dropdown_div.appendTo($("#cust_appointment_date").parent().parent());
                                    }

                                    $("#dropdownMenu3").nextAll("ul").eq(0).find("li").each(function(i, e)
                                    {
                                        if($(e).attr("class").replace("slot_", "") === suggested_slot_num)
                                        {
                                            $(e).click();
                                        }
                                    });

                                    $("<button></button>").addClass("btn").addClass("btn-success").addClass("svy_sub_btn").text("Book it!").click(function()
                                    {
                                        if($("#appt_slot_num").val().toLowerCase() === "n/a")
                                        {
                                            window.alert("You must choose an appointment slot");
                                            return;
                                        }
                                        //handle the SP2 logic

                                        // compare the SP2 date with the appointment date/time
                                        var appt_dayte = $("#cust_appointment_date").val();
                                        var sp2_dayte = survey.sp2_time.split(" ")[0];

                                        var appt_dayte_moment = moment($("#cust_appointment_date").val().replace(/-/g, ""), "MMDDYYYY");
                                        var sp2_dayte_moment = moment(sp2_dayte.replace(/-/g, ""), "YYYYMMDD");

                                        // california vs utah logic
                                        var is_california = survey.state.toUpperCase() === "CA";
                                        // for now
                                        var is_utah = !is_california;

                                        var time_diff = sp2_dayte_moment - appt_dayte_moment;
                                        var is_next_business_day = (appt_dayte_moment.format("E") === "5" && ["6", "7", "1"].indexOf(sp2_dayte_moment.format("E")) > -1) || time_diff === 86400000;
                                        if(is_utah && !is_next_business_day)
                                        {
                                            is_next_business_day = (sp2_dayte_moment.format("E") === "5" && ["6", "7", "1"].indexOf(appt_dayte_moment.format("E")) > -1)

                                                                   ||

                                                                   (["6","7","1"].indexOf(appt_dayte_moment.format("E")) > -1 && sp2_dayte_moment.format("E") === "5")

                                                                   ||

                                                                   time_diff === -86400000;
                                        }

                                        if(is_california)
                                        {

                                            var hours_value = parseInt(survey.sp2_time.split(" ")[1].split(":")[0]);

                                            // ensure the sp2 date is after 4:59 PM if it's the next day
                                            if(is_next_business_day)
                                            {
                                                var five_pm_or_later = true;

                                                if(hours_value < 17)
                                                {
                                                    five_pm_or_later = false;
                                                }

                                                if(!five_pm_or_later)
                                                {
                                                    window.alert
                                                    (
                                                        "The survey date is invalid:\n\n" +
                                                        "SP2 Date: " + moment(survey.sp2_time, "YYYY-MM-DD HH:mm:ss").format("MM-DD-YYYY hh:mm:ss a") + "\n\n" +
                                                        "Message: The SP2 date would be < 1 business day after the survey date. In this case, the SP2 time must be 5 P.M. or later"
                                                    );
                                                    return;
                                                }
                                            }

                                            // don't allow the SP2 on a saturday or sunday if the survey is on a friday
                                            if(appt_dayte_moment.isoWeekday() === 5 && time_diff <= (86400000 * 2))
                                            {
                                                window.alert
                                                (
                                                    "The survey date is invalid:\n\n" +
                                                    "SP2 Date: " + moment(survey.sp2_time, "YYYY-MM-DD HH:mm:ss").format("MM-DD-YYYY hh:mm:ss a") + "\n\n" +
                                                    "Message: The SP2 date would be < 1 business day after the survey date. Please reschedule the survey or SP2 appointment"
                                                );
                                                return;
                                            }
                                        }
                                        else if(is_utah)
                                        {
                                            // ensure the sp2 date is after 2:59 PM if it's the next day
                                            if(is_next_business_day)
                                            {
                                                var three_pm_or_later = hours_value >= 15;

                                                if(!three_pm_or_later)
                                                {
                                                    window.alert
                                                    (
                                                        "The survey date is invalid:\n\n" +
                                                        "SP2 Date: " + moment(survey.sp2_time, "YYYY-MM-DD HH:mm:ss").format("MM-DD-YYYY hh:mm:ss a") + "\n\n" +
                                                        "Message: For cases when the SP2 date and the survey date are within one business day of each other, the SP2 time must be 3:00 P.M or later"
                                                    );
                                                    return;
                                                }
                                            }
                                        }

                                        var sub_btn = $(this);
                                        sub_btn.css("opacity", "0.3").text("Booking...");
                                        bookSurvey(survey, function(result)
                                        {
                                            if(result.success)
                                            {
                                                $(".bootstrap-dialog-message").empty();
                                                $("<p></p>").text("The survey has been booked.").appendTo($(".bootstrap-dialog-message"));
                                                setTimeout(function()
                                                {
                                                    $.each(BootstrapDialog.dialogs, function(k, d)
                                                    {
                                                        d.close();
                                                        $(".svy_data_" + survey.identifier).remove();
                                                        var num = parseInt($.trim($(".unbooked_badge").text()));
                                                        num -= 1;
                                                        $(".unbooked_badge").text((num + ''));
                                                    });
                                                }, 1500);
                                            }
                                            else
                                            {
                                                if(result.already_booked === true)
                                                {
                                                    window.alert("The survey could not be booked because someone else has already taken the slot");
                                                }
                                                else
                                                {
                                                    window.alert("For an unknown reason, the survey could not be booked");
                                                }
                                                sub_btn.css("opacity", "1.0").text("Try again");
                                            }
                                        });
                                    }).insertAfter($("#dt_333").next());

                                    $(".tmp_finding").remove();
                                    $("#svy_sched_form").removeAttr("style");

                                    $("#cust_appointment_date").datepicker
                                    (
                                        {
                                            "format": "mm-dd-yyyy",
                                            "autoClose": true,
                                            "datesDisabled": disabled_days
                                        }
                                    ).on("change", function()
                                    {
                                        $("#svy_sched_form").css("display", "none");
                                        $("<p></p>").addClass("tmp_finding").text("Looking at slots for " + $(this).val()).insertAfter($("#svy_sched_form"));
                                        $("#appt_slot_num").val("N/A");
                                        $.post("./data", {"fn": "get_bookings", "date": $(this).val(), "office": survey.office_identifier, "lead_id": survey.field_app_lead_id, "v2": "1"}).done(function(resp3)
                                        {
                                            var ul = $("#dt_333").next().find("ul");
                                            ul.find("li").remove();

                                            for(var i = 0; i < resp3.slot_reservations.length; i++)
                                            {
                                                var li = $("<li></li>").attr("role", "presentation");
                                                li.addClass("slot_" + ((i + 1) + ''));
                                                var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("Slot #" + ((i + 1) + ''));
                                                if(resp3.slot_reservations[i])
                                                {
                                                    a.css("text-decoration", "line-through");
                                                    a.addClass("linethrough_anchor")
                                                }
                                                else
                                                {
                                                    a.css("text-decoration", "none");
                                                }
                                                a.appendTo(li);
                                                li.appendTo(ul);
                                            }

                                            ul.find("li").each(function(i, e)
                                            {
                                               $(e).click(function()
                                               {
                                                   if(! $(e).find("a").eq(0).hasClass("linethrough_anchor"))
                                                   {
                                                       var new_val = $(e).attr("class").replace("slot_", "");
                                                       $("#appt_slot_num").attr("value", new_val).val(new_val);
                                                       var split_items = $("#cust_appointment_date").val().split("-");
                                                       var key = survey.office_identifier + "_" + split_items[1] + "_" + split_items[0] + "_" + split_items[2] + "_slot_" + $("#appt_slot_num").val();
                                                       if(window.all_keys_reserved.indexOf(key) === -1)
                                                       {
                                                           window.all_keys_reserved.push(key);
                                                       }
                                                       window.current_reservation_key = key;
                                                       $.post("/data", {"fn": "reserve_slot", "date": (resp.suggested_date + ''), "office": survey.office_identifier, "lead_id": survey.field_app_lead_id, "slot": new_val}).done(function(resp2222)
                                                       {
                                                           //
                                                       });
                                                       $("#dropdownMenu3").eq(0).text($(e).text());
                                                       $("<span></span>").addClass("caret").appendTo($("#dropdownMenu3").eq(0));
                                                   }
                                               });
                                            });
                                            $("#dropdownMenu3").eq(0).text("Choose a slot");
                                            $("<span></span>").addClass("caret").appendTo($("#dropdownMenu3").eq(0));
                                            $(".tmp_finding").remove();
                                            $("#svy_sched_form").removeAttr("style");
                                        });
                                    });
                                });
                            });
                        },
                        "onhidden": function()
                        {
                            killReservations(false);
                        }
                    }
                );
            }
            function bookSurvey(survey, cb)
            {
                $.post("./data", {"fn": "adjust_survey_appointment", "identifier": survey.identifier, "office_identifier": survey.office_identifier, "slot": $.trim($("#appt_slot_num").val()), "date": $.trim($("#cust_appointment_date").val())}).done(function(resp)
                {
                    cb(resp);
                });
            }
            function killReservations(rightBeforePOST)
            {
                var predicate = function(item)
                {
                    return true;
                }
                if(rightBeforePOST)
                {
                    predicate = function(item)
                    {
                        return item !== window.current_reservation_key;
                    }
                }
                if(window.all_keys_reserved.length > 0)
                {
                    var diffed_keys = [];
                    for(var i = 0; i < window.all_keys_reserved.length; i++)
                    {
                        if(window.all_keys_reserved[i] !== "" && predicate(window.all_keys_reserved[i]))
                        {
                            diffed_keys.push(window.all_keys_reserved[i]);
                        }
                    }
                    if(diffed_keys.length > 0)
                    {
                        
                    }
                }
            }
            function manageSettings(rep_info)
            {
                hideIconGrid();
                if(typeof(rep_info) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_rep_info"}).done(function(resp)
                    {
                        manageSettings(resp.info);
                    });
                    return;
                }

                var settings_div = $("<div></div>").addClass("row");
                var inner_settings_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");

               $("<h3></h3>").text("My Settings").css("margin-bottom", "2em").appendTo(inner_settings_div);
               $("<h3></h3>").append
               (
                   $("<button></button>").addClass("btn").addClass("btn-danger").addClass("btn-settings-back").text("Go Back")
                   .click(function()
                   {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                   })
               ).appendTo(inner_settings_div);

                var phone_div = $("<div></div>");
                $("<p class='field-label'></p>").text("My Phone Number:").appendTo(phone_div);
                $("<input />").attr("type", "text").attr("id", "updated_phone").addClass("field_value").attr("value", rep_info.phone).attr("id", "settings_rep_phone").appendTo(phone_div);

                var email_div = $("<div></div>");
                $("<p class='field-label'></p>").text("My email:").appendTo(email_div);
                $("<input />").addClass("field_value").attr("type", "text").attr("value", rep_info.email).attr("id", "settings_rep_email").appendTo(email_div);

                var address_div = $("<div></div>");
                $("<p></p>").addClass("field-label").text("My Address:").appendTo(address_div);
                $("<input />").addClass("field_value").attr("type", "text").attr("value", rep_info.address).attr("id", "settings_rep_address").appendTo(address_div);

                var city_div = $("<div></div>");
                $("<p></p>").addClass("field-label").text("My City:").appendTo(city_div);
                $("<input />").addClass("field_value").attr("type", "text").attr("value", rep_info.city).attr("id", "settings_rep_city").appendTo(city_div);

                var state_div = $("<div></div>");
                $("<p></p>").addClass("field-label").text("My State:").appendTo(state_div);
                $("<input />").addClass("field_value").attr("type", "text").attr("value", rep_info.state).attr("id", "settings_rep_state").appendTo(state_div);

                var postal_div = $("<div></div>");
                $("<p></p>").addClass("field-label").text("My Postal:").appendTo(postal_div);
                $("<input />").addClass("field_value").attr("type", "text").attr("value", rep_info.postal).attr("id", "settings_rep_postal").appendTo(postal_div);

                var emergency_info_div = $("<div></div>");
                $("<span></span>").text("My Emergency Contact").addClass("label").addClass("label-primary").addClass("emergency_contact_label")
                .click(function()
                {
                    $.getJSON("/kv/emergency_info_" + window.user_identifier).done(function(obj)
                    {
                        var name = "";
                        var phone = "";
                        if(obj.value !== null)
                        {
                            var parsed = $.parseJSON(obj.value);
                            name = parsed.name;
                            phone = parsed.phone;
                        }
                        var html = $("<div></div>");
                        $("<p></p>").text("Name:").appendTo(html);
                        $("<input />").attr("type", "text").addClass("emergency_info_name").attr("value", name).appendTo(html);
                        $("<p></p>").text("Phone:").appendTo(html);
                        $("<input />").attr("type", "text").addClass("emergency_info_phone").attr("value", phone).appendTo(html);

                        BootstrapDialog.show
                        (
                            {
                                "title": "My Emergency Contact",
                                "message": html.html(),
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(d)
                                        {
                                            d.close();
                                        }
                                    },
                                    {
                                        "label": "Update",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            var serialized = {"name": $.trim($(".emergency_info_name").first().val()), "phone": $.trim($(".emergency_info_phone").first().val())};
                                            serialized = JSON.stringify(serialized);
                                            $.post("/kv/emergency_info_" + window.user_identifier, {"value": serialized}).done(function()
                                            {
                                                d.close();
                                            });
                                        }
                                    }
                                ]
                            }
                        );
                    });
                })
                .appendTo(emergency_info_div);

                var notifications_div = $("<div></div>");
                $("<p></p>").addClass("clk_notifications").text("Notification Settings ")
                .append
                (
                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-send")
                ).click(function()
                {
                    $(this).parent().nextAll("div").eq(0).css("display", "block");
                }).appendTo(notifications_div);

                var inner_notification_div = $("<div></div>").addClass("inner_notification_settings_div");
                var notification_header_div = $("<div></div>");
                $("<div></div>").text("Action:").appendTo(notification_header_div).addClass("noti_action");
                $("<div></div>").text("SMS:").appendTo(notification_header_div).addClass("noti_sms");
                $("<div></div>").text("Email:").appendTo(notification_header_div).addClass("noti_email");
                notification_header_div.appendTo(inner_notification_div);
                $.each(Object.keys(rep_info.notification_settings), function(i, notification_item)
                {
                    var words = notification_item.split("_");
                    var new_words = [];
                    $.each(words, function(k, word)
                    {
                        new_words.push(word[0].toUpperCase() + word.substring(1));
                    });
                    var row = $("<div></div>");
                    $("<div></div>").text(new_words.join(" ")).addClass("noti_action").appendTo(row);
                    var sms_cb = $("<input />").attr("type", "checkbox");
                    sms_cb.addClass("notification_key_" + notification_item);
                    if(rep_info.notification_settings[notification_item].sms)
                    {
                        sms_cb.attr("checked", "checked");
                    }
                    sms_cb.on("change", function()
                    {
                        updateNotificationSetting(window.user_identifier, "sms", $(this));
                    });
                    $("<div></div>").addClass("noti_sms").append(sms_cb).appendTo(row);

                    var email_cb = $("<input />").attr("type", "checkbox");
                    email_cb.addClass("notification_key_" + notification_item);
                    if(rep_info.notification_settings[notification_item].email)
                    {
                        email_cb.attr("checked", "checked");
                    }
                    email_cb.on("click", function()
                    {
                        updateNotificationSetting(window.user_identifier, "email", $(this));
                    });
                    $("<div></div>").addClass("noti_email").append(email_cb).appendTo(row);

                    row.appendTo(inner_notification_div);
                });

                $("<div></div>").html("&nbsp;").css("clear", "both").appendTo(inner_notification_div);

                var profile_pic_div = $("<div></div>").addClass("profile-pic-div").attr("id", "profile_pic");
                $("<p class='field-label'></p>").text("Profile Picture:").appendTo(profile_pic_div);
                var profile_pic_btn = $("<div></div>").addClass("js-fileapi-wrapper").appendTo(profile_pic_div);
                var profile_pic_browse = $("<div></div>").addClass("js-browse").appendTo(profile_pic_btn);
                $("<img />").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Full/" + window.user_identifier + ".jpg" + "?v=" + (new Date().getTime() + '')).click(function()
                {
                    $("#settings_rep_pic").trigger("click");
                }).appendTo(profile_pic_browse);
                $("<div></div>").addClass("js-preview").addClass("profile_pic__preview").appendTo(profile_pic_browse);
                $("<input />").css("display","none").addClass("field_value").attr("name", "filedata").attr("type", "file").attr("id", "settings_rep_pic").appendTo(profile_pic_browse);
                $("<input />").attr("type", "hidden").attr("id", "profile_pic_coords").attr("name", "coords").appendTo(profile_pic_browse);
                var profile_pic_upload = $("<div></div>").addClass("js-upload").css("display", "none").appendTo(profile_pic_btn);
                var profile_pic_status = $("<div></div>").addClass("progress").addClass("progress-success").appendTo(profile_pic_upload);
                $("<div></div>").addClass("js-progress").addClass("bar").appendTo(profile_pic_status);
                $("<span></span>").addClass("btn-txt").text("Uploading").appendTo(profile_pic_upload);


                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepPhone();
                }).appendTo(phone_div);

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepEmail();
                }).appendTo(email_div);

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepAddress();
                }).appendTo(address_div);

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepCity();
                }).appendTo(city_div);

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepState();
                }).appendTo(state_div);

                $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-success").addClass("setting_update").text("Save").click(function()
                {
                    updateRepPostal();
                }).appendTo(postal_div);

                phone_div.appendTo(inner_settings_div);
                email_div.appendTo(inner_settings_div);
                address_div.appendTo(inner_settings_div);
                city_div.appendTo(inner_settings_div);
                state_div.appendTo(inner_settings_div);
                postal_div.appendTo(inner_settings_div);
                emergency_info_div.appendTo(inner_settings_div);

                notifications_div.appendTo(inner_settings_div);
                inner_notification_div.appendTo(inner_settings_div);
                profile_pic_div.appendTo(inner_settings_div);
                $("<div></div>").addClass("col-sm-2").addClass("col-md-2").addClass("col-xs-2").addClass("col-lg-2").appendTo(settings_div);
                inner_settings_div.appendTo(settings_div);
                settings_div.appendTo(app_area);
                profile_pic_crop();
            }
            function updateNotificationSetting(identifier, medium, jqCB)
            {
                jqCB.css("opacity", "0.2");
                $.post("./data", {"fn": "update_rep_notification_setting", "identifier": identifier, "medium": medium, "notification_key": jqCB.attr("class").replace("notification_key_", ""), "value": ((jqCB[0].checked * 1) + '')}).done(function(resp)
                {
                    jqCB.removeAttr("style");
                });
            }
            function updateRepAddress()
            {
                $.post("./data", {"fn": "update_rep_address", "address": $.trim($("#settings_rep_address").val())}).done(function(resp)
                {
                    $("#settings_rep_address").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_address").next().text("Save")
                    }, 2000);
                });
            }
            function updateRepCity()
            {
                $.post("./data", {"fn": "update_rep_city", "city": $.trim($("#settings_rep_city").val())}).done(function(resp)
                {
                    $("#settings_rep_city").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_city").next().text("Save")
                    }, 2000);
                });
            }
            function updateRepState()
            {
                $.post("./data", {"fn": "update_rep_state", "state": $.trim($("#settings_rep_state").val())}).done(function(resp)
                {
                    $("#settings_rep_state").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_state").next().text("Save")
                    }, 2000);
                });
            }
            function updateRepPostal()
            {
                $.post("./data", {"fn": "update_rep_postal", "postal": $.trim($("#settings_rep_postal").val())}).done(function(resp)
                {
                    $("#settings_rep_state").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_state").next().text("Save")
                    }, 2000);
                });
            }
            function updateRepPhone()
            {
                var phone = $.trim($("#settings_rep_phone").val()).match(/\d/g);

                if(phone === null || phone.length !== 10)
                {
                    BootstrapDialog.alert
                    (
                        {
                            "title": "Invalid Phone Number",
                            "message": "Your phone number is invalid, please provide a ten-digit phone number."
                        }
                    );
                    return;
                }
                $.post("./data", {"fn": "update_rep_phone", "new_phone": phone.join("")}).done(function(resp)
                {
                    $("#settings_rep_phone").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_phone").next().text("Save")
                    }, 2000);
                });
            }
            function updateRepEmail()
            {
                if ($("#settings_rep_email").val().match(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}/) === null)
                {
                    BootstrapDialog.alert
                    (
                        {
                            "title": "Invalid Email",
                            "message": "The email address is invalid, please provide a proper email address."
                        }
                    );
                    return;
                }
                $.post("./data", {"fn": "update_rep_email", "new_email": $("#settings_rep_email").val().toLowerCase()}).done(function(resp)
                {
                    $("#settings_rep_email").next().text("Updated...")
                    setTimeout(function()
                    {
                        $("#settings_rep_email").next().text("Save")
                    }, 2000);
                });
            }
            function profile_pic_crop()
            {

                var crop_div = $("<div></div>").addClass("crop-div");
                var crop_img = $("<div></div>").addClass("js-img").appendTo(crop_div);

                window.file_api_hack = {"fn": "upload_rep_pic", "coords": $("#profile_pic_coords").val()};
                window.test = $('#profile_pic').fileapi({
                    url: './data',
                    accept: 'image/*',
                    imageSize: { minWidth: 200, minHeight: 200 },
                    data: file_api_hack,
                    elements: {
                        preview: {
                            el: '.js-preview',
                            width: 200,
                            height: 200
                        }
                    },
                    onSelect: function (evt, ui)
                    {
                        var file = ui.files[0];
                        if( !FileAPI.support.transform )
                        {
                            alert('Your browser does not support Flash :(');
                        }
                        else if( file )
                        {
                            BootstrapDialog.show
                            (
                                {
                                    title: "Crop Pic",
                                    type: BootstrapDialog.TYPE_WARNING,
                                    closable: true,
                                    closeByBackdrop: false,
                                    closeByKeyboard: false,
                                    message: crop_div,
                                    buttons:
                                    [
                                        {
                                            label: "Upload",
                                            action: function(dialogRef)
                                            {
                                                dialogRef.close();
                                                $('#profile_pic').fileapi('upload');
                                            }
                                        },
                                        {
                                            label: "Close",
                                            action: function(dialogRef)
                                            {
                                                $(".profile-pic-thumb").show();
                                                $(".js-preview >*").remove();
                                                dialogRef.close();
                                            }
                                        }
                                    ],
                                    onshown: function(dialog,overlay)
                                    {
                                        $(".profile-pic-thumb").hide();
                                        setTimeout(function(overlay)
                                        {
                                            $(".js-img", overlay).cropper
                                            (
                                              {
                                                ascpectRation: 1,
                                                file: file,
                                                bgColor: '#fff',
                                                maxSize: [$(window).width()-100, $(window).height()-100],
                                                minSize: [200, 200],
                                                boxWidth: 567,
                                                selection: '90%',
                                                onSelect: function (coords)
                                                {
                                                    window.file_api_hack["coords"] = JSON.stringify(coords);
                                                    $("#profile_pic").fileapi('crop', file, coords);
                                                    $("#profile_pic_coords").val(JSON.stringify(coords));
                                                    $(".js-preview > div > div > canvas").css("cursor","pointer").click(function()
                                                    {
                                                        $("#settings_rep_pic").trigger("click");
                                                    });
                                                }
                                              }
                                            );
                                        },50);
                                        setTimeout(function()
                                        {
                                            $(".jcrop-holder > div > canvas").css("max-width","567px");
                                        },100);
                                    }
                                }
                            );
                        }
                    },
                    onBeforeUpload: function(ev, ui)
                    {
                        localStorage.setItem("button_to_click", "user_settings");
                        ev.widget.options.data.coords = $("#profile_pic_coords").val();
                        $("<p></p>").addClass("uploading_photo").text("Uploading photo...").prependTo($(".js-fileapi-wrapper"))
                    },
                    onComplete: function(ev, ui)
                    {
                        window.location.reload();
                    }
                });
            }
            function doRequiredActionsTally()
            {
                //$(".grid_icon_wrapper_for_required_actions").addClass("grid_icon_wrapper_special_treatment");
                var badge = $("<span></span>").text(window.required_actions_count + '').addClass("badge").addClass("req_actions_badge");
                if((window.required_actions_count + '').length > 1)
                {
                    badge.addClass("badge_special_treatment");
                }
                if(window.required_actions_count === 0)
                {
                    badge.css("opacity", "0.0");
                }

                $(".grid_icon_wrapper").each(function(i, e)
                {
                    if($(e).hasClass("grid_icon_wrapper_for_required_actions"))
                    {
                        badge.appendTo($(e).find("> span"));
                    }
                });
            }
            function doCustomerHoldsTally()
            {
                /*$(".grid_icon_wrapper_for_customer_holds").addClass("grid_icon_wrapper_special_treatment");
                var badge = $("<span></span>").text(window.held_count + '').addClass("badge").addClass("held_badge");
                if((window.held_count + '').length > 1)
                {
                    badge.addClass("badge_special_treatment");
                }
                if(window.held_count === 0)
                {
                    badge.css("opacity", "0.0");
                }

                $(".grid_icon").each(function(i, e)
                {
                    if($(e).hasClass("glyphicon-nada-hold"))
                    {
                        badge.insertBefore($(e).parent());
                    }
                });*/
            }
            function doUnbookedSurveysTally()
            {
                /*$.post("./data", {"fn": "get_unbooked_surveys"}).done(function(resp)
                {
                    var badge = $("<span></span>").text(resp.count + '').addClass("badge").addClass("unbooked_badge");
                    if((resp.count > 0))
                    {
                        $(".grid_icon_wrapper_for_survey_scheduler").addClass("grid_icon_wrapper_special_treatment_usvys");
                    }
                    else
                    {
                        badge.css("display", "none");
                    }

                    if((badge.count + '').length > 1)
                    {
                        badge.addClass("badge_special_treatment");
                    }
                    if(resp.count === 0)
                    {
                        badge.css("opacity", "0.0");
                    }

                    $(".grid_icon").each(function(i, e)
                    {
                        if($(e).hasClass("glyphicon-calendar"))
                        {
                            badge.insertBefore($(e).parent());

                            if(resp.count > 0)
                            {
                                badge.next().next().addClass("action_name_special_treatment_usvys");
                            }
                        }
                    });
                });*/
            }
            function doSaveMeTally()
            {
                var badge = $("<span></span>").text(window.save_me_count + '').addClass("badge").addClass("saveme_badge");

                if((window.save_me_count > 0))
                {
                    $(".grid_icon_wrapper_for_survey_scheduler").addClass("grid_icon_wrapper_special_treatment_saveme");
                }
                else
                {
                    badge.css("display", "none");
                }

                if((badge.count + '').length > 1)
                {
                    badge.addClass("badge_special_treatment");
                }
                if(window.save_me_count === 0)
                {
                    badge.css("opacity", "0.0");
                }
                $(".grid_icon").each(function(i, e)
                {
                    if($(e).attr("id") === "save_me")
                    {
                        badge.insertBefore($(e).parent());

                        if(window.save_me_count > 0)
                        {
                            $(e).parent().addClass("grid_icon_wrapper_for_save_me_special_treatment");
                            badge.next().next().addClass("action_name_special_treatment_saveme");
                        }
                    }
                });
            }
            function doPerfectPacketTally()
            {
                /*$(".grid_icon_wrapper_for_perfect_packet_main_icon").addClass("grid_icon_wrapper_special_treatment");
                var badge = $("<span></span>").text(window.perfect_packet_count + '').addClass("badge");

                if((window.perfect_packet_count + '').length > 1)
                {
                    badge.addClass("badge_special_treatment");
                }
                if(window.perfect_packet_count === 0)
                {
                    badge.css("opacity", "0.0");
                }

                var badge2 = $("<span></span>").text(window.perfect_packet_rejection_count + '').addClass("badge").addClass("badgered");
                if((window.perfect_packet_rejection_count + '').length > 1)
                {
                    badge2.addClass("badge_special_treatment");
                }
                if(window.perfect_packet_rejection_count === 0)
                {
                    badge2.css("opacity", "0.0");
                }
                $(".grid_icon").each(function(i, e)
                {
                    if($(e).hasClass("glyphicon-paste"))
                    {
                        badge.insertBefore($(e).parent());
                        badge2.insertBefore($(e).parent());
                    }
                });*/
            }
            function doNotesTally()
            {
                $(".grid_icon_wrapper_for_customer_notes").addClass("grid_icon_wrapper_special_treatment_cn");
                var badge = $("<span></span>").text(window.unread_note_count + '').addClass("badge").addClass("notes_badge");
                if((window.unread_note_count + '').length > 1)
                {
                    badge.addClass("badge_special_treatment");
                }
                if(window.unread_note_count === 0)
                {
                    badge.css("opacity", "0.0");
                    badge.css("display", "none");
                    $(".grid_icon_wrapper_special_treatment_cn").removeClass("grid_icon_wrapper_special_treatment_cn");
                }

                $(".grid_icon").each(function(i, e)
                {
                    if($(e).attr("id") === "customer_notes")
                    {
                        badge.insertBefore($(e).parent());
                    }
                });
            }
            function hideIconGrid()
            {
                $("#icon_grid").css("display", "none");
                $("#featured_lb_area").css("display", "none");
            }
            function showIconGrid()
            {
                $("#icon_grid").css("display", "block");
                $("#featured_lb_area").css("display", "block");
            }
            function promptForArchive(field_app_identifier, name)
            {
                var html =
                $("<div></div>").append
                (
                    $("<p></p>").text("In a few words, please explain why " + name + " is being archived...")
                )
                .append
                (
                    $("<textarea></textarea>").addClass("archiving_reason").attr("placeholder", "Archiving " + name + " because...")
                );

                BootstrapDialog.show
                (
                    {
                        "title": "Archiving " + name,
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Nevermind",
                                "cssClass": "btn-primary",
                                "action": function(dialog)
                                {
                                    dialog.close();
                                }
                            },
                            {
                                "label": "Archive " + name.split(" ")[0],
                                "cssClass": "btn-danger",
                                "action": function(dialog)
                                {
                                    if($.trim($(".archiving_reason").eq(0).val()).length < 5)
                                    {
                                        window.alert("A descriptive reason must be provided.");
                                        return;
                                    }
                                    var ok_btn = $(".bootstrap-dialog-footer").find(".btn");
                                    ok_btn.text("Archiving...");
                                    $.post("./data", {"fn": "archive_customer", "identifier": field_app_identifier, "reason": $.trim($(".archiving_reason").eq(0).val())}).done(function(resp)
                                    {
                                        dialog.close();
                                        $(".field_app_identifier_of_" + field_app_identifier + ", #cust_prog_field_app_id_" + field_app_identifier).remove();
                                        $("#required_action_" + field_app_identifier).remove();
                                    });
                                }
                            }
                        ]
                    }
                );
            }
            function listPerfectPackets(rejection_count, cb)
            {
                if(typeof(cb) + '' === "undefined")
                {
                    cb = function() {};
                }
                hideIconGrid();

                var app_area = $("#app_area");
                var pp_list_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var pp_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("pp_list_div_main");

                var pp_list_spacer2 = pp_list_spacer.clone();

                if(rejection_count > 0)
                {
                    $("<h6></h6>").text("Rejected Packets ( " + (rejection_count + '') + " )").addClass("rejected_packets_lbl").addClass("label").addClass("label-danger").click(function()
                    {
                        clearApp(function()
                        {
                            showRejectedPackets(rejection_count);
                        });
                    }).appendTo(pp_list_div);
                }

                $("<h2></h2>").css("clear", "both").text(" Packets to Complete:").prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-pencil")).appendTo(pp_list_div);

                var label_div = $("<div></div>").addClass("lbl_div_rep_pp");
                $("<span></span>").addClass("label").addClass("label-success").addClass("lblone").text("Customer Name").appendTo(label_div);
                $("<span></span>").addClass("label").addClass("label-success").addClass("lbltwo").text("Surveyor Submission Date").appendTo(label_div);
                $("<span></span>").addClass("label").addClass("label-success").addClass("lblthree").text("Survey Appt. Date").appendTo(label_div);
                label_div.appendTo(pp_list_div);

                var pp_list_container = $("<div></div>").addClass("packet_list_item_container");

                $.post("./data", {"fn": "list_perfect_packets_for_user"}).done(function(resp)
                {
                    var packets = resp.packets;

                    /*$.each(packets, function(i, packet)
                    {
                        var div = $("<div></div>").addClass("packet_list_item").addClass("field_app_identifier_of_" + packet.field_app_identifier);
                        $("<p></p>").addClass("pp_list_item_icons").append
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-trash").attr("title", "Archive").click(function()
                            {
                                promptForArchive(packet.field_app_identifier, packet.name);
                            })
                        )
                        .append
                        (
                            $("<span></span>").addClass("glyphicon").attr("title", "Save Customer for Later").addClass("pp_floppy")
                            .append
                            (
                                $("<i></i>").addClass("fa").addClass("fa-life-ring")
                            )
                            .click(function()
                            {
                                saveCustomer(packet.field_app_identifier, $(this).parent().parent(), packet.name);
                            })
                        )
                        .append
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-warning-sign").attr("title", "Outstanding items are present")
                        ).appendTo(div);

                        if(!packet.has_outstanding_items)
                        {
                            div.find(".glyphicon-warning-sign").css("visibility", "hidden");
                        }
                        $("<p></p>").addClass("cust_name_pp_list").text(packet.name).click(function()
                        {
                            loadPerfectPacket(packet.identifier, packet.booking_identifier);
                        }).appendTo(div);
                        $("<p></p>").addClass("cust_date").text(packet.survey_date).appendTo(div);
                        $("<p></p>").addClass("cust_date").text(packet.surveyor_date).addClass("mr").appendTo(div);
                        div.appendTo(pp_list_container);
                    });

                    if(packets.length === 0)
                    {
                        $("<h4></h4>").css("text-align", "center").text("There are no packets to complete...").appendTo(pp_list_container);
                        pp_list_div.find(".lbl_div_rep_pp").remove();
                    }*/

                    $("<h4></h4>").css("text-align", "center").text("To submit a packet, mark a deal as 'closed' in the 'My Proposals' screen").appendTo(pp_list_container);
                    pp_list_div.find(".lbl_div_rep_pp").remove();

                    pp_list_container.appendTo(pp_list_div);
                    $("<center></center>").append
                    (
                        $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-danger").attr("id", "pp_list_back_btn").text("Back").click(function()
                        {
                            clearApp(function()
                            {
                                showIconGrid();
                            });
                        })
                    ).appendTo(pp_list_div);

                    pp_list_spacer.appendTo(app_area);
                    pp_list_div.appendTo(app_area);
                    pp_list_spacer2.appendTo(app_area);

                    cb();

                });
            }
            function showAssistanceNeeded()
            {
                var app_area = $("#app_area");
                var back_btn = $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").addClass("assistance_back").click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                });

                hideIconGrid();
                $.post("/data", {"fn": "get_assistance_needed_for_rep", "identifier": window.user_identifier}).done(function(r)
                {
                    var spacer = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12");
                    var spacer2 = spacer.clone();

                    var cust_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-12");

                    var customers = r.customers;
                    $.each(customers, function(i, cust)
                    {
                        var cust_p = $("<p></p>").addClass("assistance_cust_item").text(cust.name);
                        cust_p.appendTo(cust_list_div);
                        
                        var details_div = $("<div></div>").addClass("assistance_details");
                        var ul = $("<ul></ul>");
                        $.each(cust.data, function(ii, piece)
                        {
                            ul.append($("<li></li>").text(piece));
                        });                        
                        ul.appendTo(details_div);
                        $("<button></button>").addClass("btn").addClass("btn-success").text("Mark Complete!")
                        .click(function()
                        {
                            var that3 = $(this);

                            var completed_html = $("<div></div>");
                            $("<p></p>").text("Notes for project manager:").appendTo(completed_html);
                            $("<textarea></textarea>").addClass("completed_notes_assistance").appendTo(completed_html);

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Let's wrap this up!",
                                    "message": completed_html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Cancel",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                d.close();
                                            }
                                        },
                                        {
                                            "label": "Mark as Completed",
                                            "cssClass": "btn-primary",
                                            "action": function(d)
                                            {
                                                
                                                that3.closest(".assistance_details").prev().remove();
                                                that3.closest(".assistance_details").remove();

                                                d.close();
                                                $.post("/data", {"fn": "drop_assistance_item", "identifier": cust.item_identifier, "msg": $.trim($(".completed_notes_assistance").val())}).done(function()
                                                {
                                                    
                                                })
                                            }
                                        }
                                    ]
                                }
                            );
                        })
                        .appendTo(details_div);

                        cust_p.click(function()
                        {
                            $(".assistance_details").remove();
                            details_div.insertAfter(cust_p);
                        });

                        cust_p.appendTo(cust_list_div);
                    });

                    var wrapper_div = $("<div></div>").addClass("assistance_wrapper");
                    $("<h2></h2>").css("text-indent", "0.5em").text("Assistance Needed:").appendTo(wrapper_div);
                    $("<br />").appendTo(wrapper_div);


                    $.each([spacer, cust_list_div, spacer2], function(ii, item)
                    {
                        item.appendTo(app_area);
                    });

                    $("<center></center>")
                    .append
                    (
                        back_btn
                    )
                    .appendTo($("#app_area"));
                });

            }
            function showSavedCustomers()
            {
                hideIconGrid();
                $.post("./data", {"fn": "show_saved_customers"}).done(function(resp)
                {
                    var back_btn = $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").addClass("save_me_back").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    });
                    if(resp.customers.length === 0)
                    {
                        $("<h3></h3>").text("No customers need saved.")
                        .appendTo($("#app_area"));

                        $("<center></center>")
                        .append
                        (
                            $("<br />")
                        )
                        .append
                        (
                            back_btn
                        ).appendTo($("#app_area"));
                        return;
                    }

                    var wrapper_div = $("<div></div>").addClass("save_me_wrapper");
                    $("<h2></h2>").css("text-indent", "0.5em").text("Please save these customers:").appendTo(wrapper_div);
                    $("<br />").appendTo(wrapper_div);
                    $.each(resp.customers, function(i, customer)
                    {
                        var restore_ico = $("<span></span>").addClass("glyphicon").addClass("glyphicon-repeat").attr("title", "Restore customer");
                        restore_ico.click(function()
                        {
                            if(window.confirm("Are you sure you would like to restore " + customer.name +  "?"))
                            {
                                BootstrapDialog.show
                                (
                                    {
                                        "title": "Choose an Option",
                                        "message": "Do you need to change the deal for this customer? If you change the deal for this customer, you will have to resign the customer.",
                                        "buttons":
                                        [
                                            {
                                                "label": "Yes, deal needs changing",
                                                "cssClass": "btn-primary",
                                                "action": function(d)
                                                {
                                                    $.post("./data", {"fn": "restore_customer", "identifier": customer.identifier, "unlock": "1"}).done(function(resp2)
                                                    {
                                                        restore_ico.parent().remove();
                                                        d.close();
                                                    });                    
                                                }
                                            },
                                            {
                                                "label": "No, deal stays",
                                                "cssClass": "btn-primary",
                                                "action": function(d)
                                                {
                                                    $.post("./data", {"fn": "restore_customer", "identifier": customer.identifier}).done(function(resp2)
                                                    {
                                                        restore_ico.parent().remove();
                                                        d.close();                                                        
                                                    });
                                                }
                                            }
                                        ]
                                    }
                                );
                            }
                        });
                        var info_ico = $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").attr("title", "Info for " + customer.name + " ");
                        info_ico.click(function()
                        {
                            $(".save_me_reason_tmp").remove();
                            $.post("./data", {"fn": "save_me_info", "identifier": customer.identifier}).done(function(resp3)
                            {
                                $("<div></div>").addClass("save_me_reason_tmp").text("Reason annotated as \"Save Me\":")
                                .append
                                (
                                    $("<br />")
                                )
                                .append
                                (
                                    $("<p></p>")
                                )
                                .append
                                (
                                    $("<p></p>").text(resp3.reason)
                                )
                                .append
                                (
                                    $("<hr />")
                                )
                                .append
                                (
                                    $("<b></b>").text("Customer Phone:")
                                )
                                .append
                                (
                                    $("<p></p>").text(resp3.phone)
                                )
                                .append
                                (
                                    $("<b></b>").text("Customer Address:")
                                )
                                .append
                                (
                                    $("<p></p>").text(resp3.address)
                                )
                                .insertAfter(info_ico.nextAll(".saved_name").eq(0));
                            });
                        });

                        var name_p = $("<p></p>").addClass("saved_name").text(customer.name);
                        name_p.appendTo();

                        var item_div = $("<div></div>").addClass("saved_item");
                        restore_ico.appendTo(item_div);
                        info_ico.appendTo(item_div);
                        name_p.appendTo(item_div);
                        item_div.appendTo(wrapper_div);
                    });

                    wrapper_div.appendTo($("#app_area"));
                    $("<br />").appendTo($("#app_area"));
                    $("<center></center>")
                    .append
                    (
                        back_btn
                    )
                    .appendTo($("#app_area"));
                });
            }
            window.app_bucket = document.domain;
            function showPastCustomers()
            {
                var app_area = $("#app_area");
                hideIconGrid();
                $("<h2></h2>").text("Loading...").appendTo(app_area);
                $.post("/data", {"fn": "past_customers_for_rep", "rep_id": window.rep_id}).done(function(r)
                {
                    app_area.find("h2").remove();
                    var cust_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var cust_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                    var cust_spacer2 = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");

                    $("<select></select>")
                    .append
                    (
                        $("<option><>/option>").attr("value", "installed").text("Installed Customers")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "deal_closed").text("Closed Not Installed")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "not_closed").text("Not Closed Customers")
                    )
                    .addClass("past_customers_status_filter_sel")
                    .change(function()
                    {
                        var status = $(this).val();
                        $(".past_customer_row").each(function(i, e)
                        {
                            if($(e).hasClass("past_customer_status_" + status))
                            {
                                $(e).css("display", "table-row")
                            }
                            else
                            {
                                $(e).css("display", "none");
                            }
                        });
                    })
                    .appendTo(cust_list_div);

                    $("<button></button>").addClass("btn").addClass("btn-danger").addClass("past_customers_back_btn").text("Back")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    }).appendTo(cust_list_div);

                    var table = $("<table></table>").addClass("past_customers_tbl");
                    var tbody = $("<tbody></tbody>");
                    $("<tr></tr>")
                    .append
                    (
                        $("<th></th>").text("Name")
                    )
                    .append
                    (
                        $("<th></th>").text("Address")
                    )
                    .append
                    (
                        $("<th></th>").text("Email")
                    )
                    .append
                    (
                        $("<th></th>").text("Phone")
                    )
                    .appendTo(tbody);

                    $.each(r, function(i, customer)
                    {
                        var tr = $("<tr></tr>").addClass("past_customer_row").addClass("past_customer_status_" + customer.status);
                        $("<td></td>").text(customer.name).appendTo(tr);
                        $("<td></td>").html(customer.address + "<br />" + customer.city + ", " + customer.state + "<br />" + customer.postal).appendTo(tr);
                        $("<td></td>")
                        .append
                        (
                            $("<a></a>").attr("href", "mailto:" + customer.email).text(customer.email)
                        )
                        .appendTo(tr);
                        $("<td></td>")
                        .append
                        (
                            $("<a></a>").attr("href", "tel:" + customer.phone.digits()).text(customer.phone)
                        )
                        .appendTo(tr);
                        tr.appendTo(tbody);
                    });

                    tbody.appendTo(table);
                    table.appendTo(cust_list_div);                    

                    $.each([cust_spacer, cust_list_div, cust_spacer2], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                    $(".past_customers_status_filter_sel").first().trigger("change");
                });
            }
            function showCustomerNotes(field_app_identifier)
            {
                var app_area = $("#app_area");
                hideIconGrid();
                $.post("./data", {"fn": "list_customers_for_user_in_session"}, function(resp)
                {
                    var cust_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var cust_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("cust_list_div");
                    var cust_spacer2 = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");

                    $("<h2></h2>").text("Customer Notes:").css("clear", "both").appendTo(cust_list_div);

                    $("<button></button>").html("&larr; Back").addClass("btn").addClass("btn-danger").attr("id", "cust_notes_back").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    }).appendTo(cust_list_div);

                    var cust_note_container_div = $("<div></div>").addClass("cust_note_container_list");

                    $.each(resp.customers, function(i, customer)
                    {
                        var div = $("<div></div>").addClass("customer_notes_list_item");
                        div.attr("id", "cust_note_identifier_of_" + customer.identifier);
                        if(customer.unread_count > 0)
                        {
                            div.addClass("notes_unread");
                        }

                        $("<p></p>").addClass("cust_name_cust_note_list").text(customer.cust_name).appendTo(div);
                        div.click(function()
                        {
                            showNotesForUser(customer.identifier, customer.cust_name);
                        });

                        div.appendTo(cust_note_container_div);
                    });

                    cust_note_container_div.appendTo(cust_list_div);

                    cust_spacer.appendTo(app_area);
                    cust_list_div.appendTo(app_area);
                    cust_spacer2.appendTo(app_area);

                    if(typeof(field_app_identifier) + '' !== "undefined")
                    {
                        $(".customer_notes_list_item").each(function(i, e)
                        {
                            var identifier = $(e).attr("id").replace("cust_note_identifier_of_", "");
                            if(identifier === field_app_identifier)
                            {
                                $(e).trigger("click");
                                setTimeout(function()
                                {
                                    $(e)[0].scrollIntoView();
                                }, 250);
                            }
                        });
                    }
                });
            }
            function showCustomerHolds()
            {
                var app_area = $("#app_area");
                hideIconGrid();
                $.post("./data", {"fn": "list_held_customers_for_rep"}).done(function(resp)
                {
                    var cust_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var cust_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("cust_list_div");
                    var cust_spacer2 = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");

                    $("<h2></h2>").text("Customer with Holds:").css("clear", "both").appendTo(cust_list_div);

                    $("<button></button>").html("&larr; Back").addClass("btn").addClass("btn-danger").attr("id", "cust_notes_back").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    }).appendTo(cust_list_div);

                    var cust_hold_container_div = $("<div></div>").addClass("cust_hold_container_list");
                    console.log(resp.customers);
                    for(var k = 0; k < resp.customers.length; k++)
                    {
                        var customer = resp.customers[k];
                        var div = $("<div></div>").addClass("customer_hold_list_item");
                        div.attr("id", "cust_hold_identifier_of_" + customer.identifier);

                        $("<p></p>").addClass("cust_name_cust_hold_list").text(customer.name).appendTo(div);
                        div.click(function()
                        {
                            showHoldsForCustomer(customer);
                        });
                        div.appendTo(cust_hold_container_div);
                    }
                    cust_hold_container_div.appendTo(cust_list_div);

                    cust_spacer.appendTo(app_area);
                    cust_list_div.appendTo(app_area);
                    cust_spacer2.appendTo(app_area);

                });
            }
            function showHoldsForCustomer(customer)
            {
                var hold_items_div = $("<div></div>").addClass("rep_hold_items");
                var ul = $("<ul></ul>").addClass("rep_holds_ul");
                $.each(customer.hold_items, function(i, item)
                {
                    var li = $("<li></li>").text(item);
                    li.appendTo(ul);
                });
                ul.appendTo(hold_items_div);

                hold_items_div.appendTo("#cust_hold_identifier_of_" + customer.identifier);
            }
            function showNotesForUser(customer_identifier, customer_name, from_customer_progress)
            {
                from_customer_progress = (from_customer_progress === true);
                if(!from_customer_progress)
                {
                    loadNotesForCustomer(customer_identifier, customer_name);
                }
            }
            function loadNotesForCustomer(field_app_identifier, customer_name, expecting_return, insert_new_content_fn, insert_notes_fn, post_completion_fn)
            {
                $.post("./data", {"fn": "pull_notes_for_customer", "identifier": field_app_identifier}).done(function(resp)
                {
                    $(".cust_note_details").remove();
                    $(".activenote").removeClass("activenote");
                    var notes_results_div = $("<div></div>").addClass("cust_note_details").addClass("row");
                    $("#cust_note_identifier_of_" + field_app_identifier).addClass("activenote");
                    if(resp.notes.length === 0)
                    {
                        $("<h3></h3>").text("No notes have been recorded for " + customer_name).appendTo(notes_results_div);
                    }
                    else
                    {
                        $.each(resp.notes, function(i, note)
                        {
                            var note_div = $("<div></div>").addClass("cust_note_detail_item");
                            var author_p = $("<p></p>").addClass("note_author_timestamp");
                            var date = moment(note.pacific);
                            var m = (date.month() + 1) + '';
                            if(m.length === 1)
                            {
                                m = "0" + m;
                            }
                            var d = date.date() + '';
                            if(d.length === 1)
                            {
                                d = "0" + d;
                            }
                            var y = date.year() + '';
                            author_p.text("On " + m + "-" + d + "-" + y + ", " + note.author_name + " recorded...");

                            var content_div = $("<div></div>").addClass("note_detail_content");
                            content_div
                            .append(author_p)
                            .append
                            (
                                $("<p></p>").addClass("note_text_content").text(note.content.txt[0])
                            );
                            if(note.blob_count > 0)
                            {
                                for(var i = 0; i < note.content.mime_types.length; i++)
                                {
                                    var ext = "jpg";
                                    if(note.content.mime_types[i] === "image/png")
                                    {
                                        ext = "png";
                                    }
                                    var img = $("<img />");
                                    img.attr("src", "//storage.googleapis.com/" + window.app_bucket + "/CustomerNoteBlobs/" + note.identifier + "_" + ((i + 1) + '') + "." + ext);

                                    var a = $("<a></a>").attr("hef", img.attr("src"));
                                    img.appendTo(a);
                                    a.appendTo(content_div);
                                }
                            }

                            content_div.appendTo(notes_results_div);
                        });
                    }
                    $("<div></div>").addClass("plus_new_note_div").append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-primary").text(" New Note").prepend
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-plus")
                        ).click(function()
                        {
                            var new_content_div = $("<div></div>").addClass("new_note_actual_content");
                            $("<textarea></textarea>").attr("placeholder", "Your note...").appendTo(new_content_div);

                            var image_div = $("<div></div>").addClass("camera-note-div");
                            $("<input />").attr("type", "file").css("display", "none").attr("id", "note_image").attr("accept", "image/*").appendTo(image_div);
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-camera").click(function()
                            {
                                $(this).prevAll("input").eq(0).trigger("click");
                            }).appendTo(image_div);

                            image_div.appendTo(new_content_div);

                            $("<button></button>").attr("id", "customer_notes_post_note_btn").addClass("btn").addClass("btn-primary").html("&nbsp;<span id='post_note_btn_msg'>Post Note</span>").prepend
                            (
                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-upload")
                            ).click(function()
                            {
                                postCustomerNote(field_app_identifier, post_completion_fn);
                            }).appendTo(new_content_div);

                            if(typeof(insert_new_content_fn) + '' === "undefined")
                            {
                                new_content_div.appendTo($("#cust_note_identifier_of_" + field_app_identifier).next());
                            }
                            else
                            {
                                insert_new_content_fn(new_content_div);
                            }
                        })
                    ).appendTo(notes_results_div);

                    if(typeof(insert_notes_fn) + '' === "undefined")
                    {
                        notes_results_div.insertAfter($("#cust_note_identifier_of_" + field_app_identifier));
                    }
                    else
                    {
                        insert_notes_fn(notes_results_div);
                    }

                    if($("#cust_note_identifier_of_" + field_app_identifier).hasClass("notes_unread"))
                    {
                        var undefined_count = 0;
                        $.each([expecting_return, insert_new_content_fn, insert_notes_fn, post_completion_fn], function(i, item)
                        {
                            if(typeof(item) + '' === "undefined")
                            {
                                undefined_count++;
                            }
                        });

                        if(undefined_count === 4)
                        {
                            $.post("./data", {"fn": "read_notes_for_customer", "identifier": field_app_identifier}).done(function(resp2)
                            {
                                if(resp2.count > 0)
                                {
                                    var curr_count = parseInt($(".notes_badge").text());
                                    curr_count -= resp2.count;
                                    if(curr_count < 0)
                                    {
                                        curr_count = 0;
                                    }
                                    $(".notes_badge").text(curr_count + '');
                                    if(curr_count === 0)
                                    {
                                        $(".notes_badge").css("opacity", "0.0");
                                        $(".notes_badge").css("display", "none");

                                        if($(".grid_icon_wrapper_special_treatment_cn").size() > 0)
                                        {
                                            $(".grid_icon_wrapper_special_treatment_cn").removeClass("grid_icon_wrapper_special_treatment_cn");
                                        }
                                    }

                                    $("#cust_note_identifier_of_" + field_app_identifier).removeClass("notes_unread");
                                }
                            });
                        }
                    }
                });
            }
            function postCustomerNote(field_app_identifier, post_completion_fn)
            {
                if($.trim($(".new_note_actual_content").find("textarea").eq(0).val()).length === 0)
                {
                    BootstrapDialog.alert
                    (
                        {
                            "title": "Missing text content",
                            "message": "At least some text content is required. If the intention is to only upload an image, please put a caption for the image inside the textbox."
                        }
                    );
                    return;
                }
                var img_file_name = $.trim($("#note_image").val());
                if(img_file_name.length === 0)
                {

                    $.post("./data", {"fn": "add_note_for_customer", "identifier": field_app_identifier, "has_file": "0", "txt": $.trim($(".new_note_actual_content").find("textarea").eq(0).val())}).done(function(resp)
                    {
                        if(typeof(post_completion_fn) + '' === "undefined")
                        {
                            $("#cust_note_identifier_of_" + field_app_identifier).trigger("click");
                        }
                        else
                        {
                            post_completion_fn();
                        }
                    });
                }
                else
                {
                    var split = null;
                    var extension = null;
                    try
                    {
                        split = img_file_name.split(".");
                        extension = split[split.length - 1].toLowerCase();
                    }
                    catch(e)
                    {
                        extension = "bawb";
                    }
                    if(extension !== "jpg" && extension !== "png")
                    {
                        BootstrapDialog.alert
                        (
                            {
                                "title": "Unsupported file type",
                                "message": "The uploaded file must be a JPG or PNG image."
                            }
                        );
                        return;
                    }
                    var formData = new FormData();

                    formData.append("txt", $.trim($(".new_note_actual_content").find("textarea").eq(0).val()));

                    formData.append("note_image", $("#note_image")[0].files[0]);

                    var xhr = new XMLHttpRequest();
                    (xhr.upload || xhr).addEventListener("progress", function(e)
                    {
                        var done = e.position || e.loaded
                        var total = e.totalSize || e.total;
                        var completion_percentage = (Math.round(done/total*100) + '') + "%";
                        $("#post_note_btn_msg").html("&nbsp;&nbsp;&nbsp;&nbsp;" + completion_percentage);

                    });
                    xhr.addEventListener("load", function(e)
                    {
                        if(typeof(post_completion_fn) + '' === "undefined")
                        {
                            setTimeout(function()
                            {
                                $("#cust_note_identifier_of_" + field_app_identifier).trigger("click");
                            }, 250);
                        }
                        else
                        {
                            post_completion_fn();
                        }
                    });
                    xhr.open("POST", "./data?fn=add_note_for_customer&identifier=" + field_app_identifier + "&has_file=1");
                    xhr.send(formData);
                }
            }
            function showRejectedPackets(rejection_count)
            {
                var app_area = $("#app_area");
                var pp_list_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var pp_list_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("pp_list_div_rejected");

                var pp_list_spacer2 = pp_list_spacer.clone();

                $("<h2></h2>").css("clear", "both").text(" Rejected Packets:").prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-ban-circle").addClass("bancirclered")).appendTo(pp_list_div);

                var label_div = $("<div></div>").addClass("lbl_div_rep_pp").addClass("lbl_div_rep_pp_rejected");
                $("<span></span>").addClass("label").addClass("label-success").addClass("lblone").text("Customer Name").appendTo(label_div);
                $("<span></span>").addClass("label").addClass("label-success").addClass("lbltwo").text("Rejection Date").appendTo(label_div);
                $("<span></span>").addClass("label").addClass("label-success").addClass("lblthree").text("Submission Date").appendTo(label_div);
                label_div.appendTo(pp_list_div);

                var pp_list_container = $("<div></div>").addClass("packet_list_item_container").addClass("rejected_packet_list_item_container");
                $.post("./data", {"fn": "list_rejected_packets_for_user"}).done(function(resp)
                {
                    var packets = resp.packets;

                    $.each(packets, function(i, packet)
                    {
                        var div = $("<div></div>").addClass("packet_list_item").addClass("packet_list_item_rejected");
                        $("<span></span>").addClass("glyphicon").addClass("glyphicon-trash").addClass("pending_rej_archive").attr("title", "Archive this item")
                        .click(function()
                        {
                            if(window.confirm("Are you sure you would like to archive this item?"))
                            {
                                $.post("./data", {"fn": "archive_customer", "identifier": packet.field_app_identifier}).done(function(resp)
                                {
                                    div.remove();
                                });
                            }
                        }).appendTo(div);
                        $("<p></p>").addClass("cust_name_pp_list").text(packet.name).click(function()
                        {
                            loadRejectedPacket(packet, rejection_count);
                        }).appendTo(div);
                        $("<p></p>").addClass("cust_date").addClass("cust_date_submission").text(packet.rep_submission_date).appendTo(div);
                        $("<p></p>").addClass("cust_date").addClass("cust_date_rejection").text(packet.last_rejection_date).addClass("mr").appendTo(div);
                        div.appendTo(pp_list_container);
                    });

                    pp_list_container.appendTo(pp_list_div);
                    $("<center></center>").append
                    (
                        $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-danger").attr("id", "pp_list_back_btn").text("Back").click(function()
                        {
                            clearApp(function()
                            {
                                listPerfectPackets(rejection_count);
                            });
                        })
                    ).appendTo(pp_list_div);

                    pp_list_spacer.appendTo(app_area);
                    pp_list_div.appendTo(app_area);
                    pp_list_spacer2.appendTo(app_area);

                });
            }
            function loadPerfectPacket(identifier, booking_identifier)
            {
                clearApp(function()
                {
                    $.post("./data", {"fn": "get_perfect_packet", "identifier": identifier}).done(function(resp)
                    {
                        if(resp.has_outstanding_items)
                        {
                            loadOutstandingItems(identifier, resp.outstanding_questions);
                        }
                        else
                        {
                            window.packet_identifier = identifier;
                            initPerfectPacket(booking_identifier);
                        }
                    });
                });
            }
            function loadRejectedPacket(packet, rejection_count)
            {
                clearApp(function()
                {
                    var rejected_packet_div = $("<div></div>").addClass("address_rejected_pp_row").addClass("row");
                    var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    spacer_div.html("&nbsp;");
                    var spacer_div2 = spacer_div.clone();

                    $("<p></p>").addClass("rej_header_rep_msg").text("Your most recent submission for " + packet.name + " was rejected.").appendTo(rejected_packet_div);

                    var last_idx = packet.rejection_reasons.reasons.length - 1;
                    var reasons = packet.rejection_reasons.reasons[last_idx];
                    var date = packet.rejection_reasons.dates[last_idx];
                    var inner_div = $("<div></div>");
                    $.each(reasons, function(i, reason)
                    {
                        $("<hr />").appendTo(inner_div);
                        var txt_p1 = $("<p></p>").addClass("reason_info").text("The following item caused your submission to be rejected:").appendTo(inner_div);
                        var txt_p2 = $("<p></p>").addClass("reason_reason").text(reason).appendTo(inner_div);
                        var txt_p3 = $("<p></p>").addClass("reason_question").text("Did you address this?").appendTo(inner_div);

                        var dropdown_div = $("<div></div>").addClass("dropdown");
                        var dropdown_ul = $("<ul></ul>").attr("role", "menu").addClass("dropdown-menu");

                        var btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").text("Choose a value");
                        $("<span></span>").addClass("caret").appendTo(btn);

                        var li1 = $("<li></li>").attr("role", "presentation");
                        li1.addClass("value_of_yes");

                        var a1 = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                        a1.text("Yes");

                        var li2 = $("<li></li>").attr("role", "presentation");
                        li2.addClass("value_of_no");

                        var a2 = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                        a2.text("No");

                        a1.appendTo(li1);
                        a2.appendTo(li2);

                        dropdown_ul.append(li1);
                        dropdown_ul.append(li2);

                        dropdown_ul.find("li").each(function(i, e)
                        {
                            $(e).click(function()
                            {
                                var val = $(e).attr("class").replace("value_of_", "");
                                if(val === "yes")
                                {
                                    $("<textarea></textarea>").addClass("response_reason").insertAfter($(e).closest(".dropdown"));
                                }
                                else
                                {
                                    if($(e).closest(".dropdown").next().hasClass("response_reason"))
                                    {
                                        $(e).closest(".dropdown").next().remove();
                                    }
                                }
                                $(e).closest(".dropdown").find(".btn").text($(e).text());
                                $("<span></span>").addClass("caret").appendTo($(e).closest(".dropdown").find(".btn"));
                            });
                        });

                        btn.appendTo(dropdown_div);
                        dropdown_ul.appendTo(dropdown_div);
                        dropdown_div.appendTo(inner_div);

                        $("<hr />").appendTo(inner_div);

                        inner_div.appendTo(rejected_packet_div);

                    });

                    var btns_div = $("<div></div>").addClass("rej_screen_action_btns");
                    $("<button></button>").attr("type", "button").text("Resubmit Packet").addClass("btn").addClass("btn-success").click(function()
                    {
                        var good = true;
                        var good2 = true;
                        $(".address_rejected_pp_row").find(".dropdown").find("button").each(function(i, e)
                        {
                            if($(e).text().toLowerCase() !== "yes")
                            {
                                good = false;
                            }
                            if($.trim($(e).parent().nextAll(".response_reason").first().val()).length === 0)
                            {
                                good2 = false;
                            }
                        });

                        if(!good)
                        {
                            window.alert("The response(s) you provided are such that this packet would be ineligible for resubmission. ");
                            return;
                        }
                        if(!good2)
                        {
                            window.alert("A response is required when affirming that an action has been addressed. Please populate the text box with the response you would like to provide.");
                            return;
                        }

                        $(".address_rejected_pp_row").find("textarea").each(function(i, e)
                        {
                            if($.trim($(e).val()).length < 0)
                            {
                                good = false;
                            }
                        });

                        if(!good)
                        {
                                window.alert("For each item marked \"Yes\", a response message is required.");
                                return;
                        }


                        var responses = [];
                        $(".address_rejected_pp_row textarea").each(function(i, e)
                        {
                            responses.push($.trim($(e).val()));
                        });

                        $.post("./data", {"fn": "contest_rejection", "identifier": packet.identifier, "responses": JSON.stringify(responses)}).done(function(resp)
                        {
                            clearApp(function()
                            {
                                window.location.reload();
                            });
                        });
                    }).appendTo(btns_div);
                    $("<button></button>").attr("type", "button").html("&nbsp;&nbsp;&nbsp;Cancel&nbsp;&nbsp;&nbsp;").addClass("btn").addClass("btn-danger").click(function()
                    {
                        clearApp(function()
                        {
                            listPerfectPackets(rejection_count, function()
                            {
                                $(".pp_list_div_main").find("h6").trigger("click");
                            });
                        });
                    }).appendTo(btns_div);
                    btns_div.appendTo(rejected_packet_div);

                    spacer_div.appendTo(app_area);
                    rejected_packet_div.appendTo(app_area);
                    spacer_div2.appendTo(app_area);
                });
            }
            function loadOutstandingItems(identifier, questions)
            {
                var app_area = $("#app_area");
                var form = $("<form></form>").addClass("form-horizontal").attr("role", "form").attr("action", "#").attr("method", "GET").attr("id", "preview_form");

                $("<h2></h2>").text("The following items require your attention:").addClass("items_attetion_reqd_h2").appendTo(app_area);

                $.each(questions, function(i, question)
                {
                    switch(question.type)
                    {
                        case "yes_or_no":
                            var question_div = $("<div></div>").addClass("form-group").attr("id", "question_" + question.identifier).addClass("q_container");
                            var label = $("<label></label>").addClass("control-label").addClass("col-sm-2").attr("for", "who_cares");
                            label.text(question.text);
                            label.appendTo(question_div);

                            var item_div = $("<div></div>").addClass("col-sm-10");

                            var dropdown_div = $("<div></div>").addClass("dropdown");
                            var dropdown_btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("id", "q_btn_" + question.identifier).text("Choose a value");
                            $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                            var dropdown_ul = $("<ul></ul>").attr("role", "menu").attr("aria-labelledby", "q_btn_" + question.identifier).addClass("dropdown-menu");

                            var checkbox_opts = ["1", "0"];
                            var checkbox_opts_friendly = ["Yes", "No"]

                            $.each(checkbox_opts, function(i, checkbox_opt)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                li.attr("id", "value_of_" + checkbox_opt);

                                var a = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                                a.text(checkbox_opts_friendly[i]);

                                a.appendTo(li);
                                li.appendTo(dropdown_ul);
                            });

                            dropdown_ul.find("li").each(function(i, e)
                            {
                                $(e).click(function()
                                {
                                    var val = $(e).attr("id").replace("value_of_", "");
                                    $("#q_btn_" + question.identifier).text($(e).text());
                                    $("<span></span>").addClass("caret").appendTo($("#q_btn_" + question.identifier));

                                    $("#hidden_value_for_" + question.identifier).attr("value", val).val(val);
                                });
                            });
                            dropdown_btn.appendTo(dropdown_div);
                            dropdown_ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(dropdown_div);

                            dropdown_div.appendTo(item_div);
                            item_div.appendTo(question_div);

                            question_div.appendTo(form);

                            break;
                    }
                });
                $("<div></div>").addClass("outstanding_submit_div").append
                (
                    $("<button></button>").text("Update").attr("type", "submit").addClass("btn").addClass("btn-info")
                ).append
                (
                    $("<button></button>").text("Cancel").attr("type", "button").addClass("btn").addClass("btn-danger").click(function()
                    {
                        clearApp(function()
                        {
                            listPerfectPackets();
                        });
                    })
                ).appendTo(form);
                form.submit(function()
                {
                    if(!validateOutstandingItems())
                    {
                        return false;
                    }
                    else
                    {
                        var new_items = [];
                        $(".true_question_value").each(function(i, e)
                        {
                            if($(e).val().toLowerCase() !== "1")
                            {
                                new_items.push($(e).attr("id").replace("hidden_value_for_", ""));
                            }
                        });
                        $.post("./data", {"fn": "set_outstanding_items_for_packet", "identifier": identifier, "new_items": JSON.stringify(new_items)}).done(function(resp)
                        {
                            clearApp(function()
                            {
                                listPerfectPackets();
                            });
                        });
                    }
                    return false;
                });
                form.appendTo(app_area);
            }
            function validateOutstandingItems()
            {
                var ret_val = true;
                $(".true_question_value").each(function(i, e)
                {
                    if($(e).val().toLowerCase() === "unanswered")
                    {
                        window.alert("You must answer all questions with a \"Yes\" or \"No\" option");
                        ret_val = false;
                    }
                });
                return ret_val;
            }
            function initPerfectPacket(booking_identifier, booking_info, survey_info)
            {
                if(typeof(booking_info) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_survey_booking_info", "identifier": booking_identifier}).done(function(resp)
                    {
                        initPerfectPacket(booking_identifier, resp.result);
                    });
                    return;
                }

                if(typeof(survey_info) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_questions_for_survey", "identifier": "{{ packet_survey_identifier }}"}).done(function(resp)
                    {
                        initPerfectPacket(booking_identifier, booking_info, resp);
                    });
                    return;
                }
                $("<form></form>").addClass("form-horizontal").attr("role", "form").attr("action", "./sales").attr("method", "POST").attr("id", "preview_form").submit(function()
                {
                    return false;
                }).appendTo($("#app_area"));

                renderSurvey(booking_info, survey_info);
            }
            function initSP2FollowUp(booking_identifier, survey_identifier)
            {
                if(typeof(window.booking_info) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_survey_booking_info", "identifier": booking_identifier}).done(function(resp)
                    {
                        window.booking_info = resp.result;
                        initSP2FollowUp(booking_identifier,survey_identifier);
                    });
                    return;
                }

                if(typeof(window.survey_info) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_questions_for_survey", "identifier": survey_identifier}).done(function(resp)
                    {
                        window.survey_info = resp;
                        initSP2FollowUp(booking_identifier,survey_identifier);
                    });
                    return;
                }

                renderSP2Survey(booking_info,survey_info);
            }

            function renderSurvey(booking_info, survey_info)
            {
                $.each(survey_info.questions, function(i, question)
                {
                    var question_div = $("<div></div>").addClass("form-group").attr("id", "question_" + question.identifier).addClass("q_container");
                    var label = $("<label></label>").addClass("control-label").addClass("col-sm-2").attr("for", "who_cares");
                    label.text(question.question_text);
                    label.appendTo(question_div);

                    var item_div = $("<div></div>").addClass("col-sm-10");
                    switch(question.question_type)
                    {
                        case "yes_or_no":
                            var dropdown_div = $("<div></div>").addClass("dropdown");
                            var dropdown_btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("id", "q_btn_" + question.identifier).text("Choose a value");
                            $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                            var dropdown_ul = $("<ul></ul>").attr("role", "menu").attr("aria-labelledby", "q_btn_" + question.identifier).addClass("dropdown-menu");

                            var checkbox_opts = ["1", "0"];
                            var checkbox_opts_friendly = ["Yes", "No"]

                            $.each(checkbox_opts, function(i, checkbox_opt)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                li.attr("id", "value_of_" + checkbox_opt);

                                var a = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                                a.text(checkbox_opts_friendly[i]);

                                a.appendTo(li);
                                li.appendTo(dropdown_ul);
                            });

                            dropdown_ul.find("li").each(function(i, e)
                            {
                                $(e).click(function()
                                {
                                    var val = $(e).attr("id").replace("value_of_", "");
                                    $("#q_btn_" + question.identifier).text($(e).text());
                                    $("<span></span>").addClass("caret").appendTo($("#q_btn_" + question.identifier));

                                    $("#hidden_value_for_" + question.identifier).attr("value", val).val(val);
                                });
                            });
                            dropdown_btn.appendTo(dropdown_div);
                            dropdown_ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(dropdown_div);

                            dropdown_div.appendTo(item_div);
                            break;

                        case "mult_choice":
                            var dropdown_div = $("<div></div>").addClass("dropdown");
                            var dropdown_btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("id", "q_btn_" + question.identifier).text("Choose a value");
                            $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                            var dropdown_ul = $("<ul></ul>").attr("role", "menu").attr("aria-labelledby", "q_btn_" + question.identifier).addClass("dropdown-menu");
                            $.each(question.question_options["multi_choices"], function(i, choice_item)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                li.attr("id", "value_of_" + choice_item.choice.split(" ").join("_____"));

                                var a = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                                a.text(choice_item.choice);

                                a.appendTo(li);
                                li.appendTo(dropdown_ul);
                            });

                            dropdown_ul.find("li").each(function(i, e)
                            {
                                $(e).click(function()
                                {
                                    var val = $(e).attr("id").replace("value_of_", "").split("_____").join(" ");
                                    $("#q_btn_" + question.identifier).text($(e).text());
                                    $("<span></span>").addClass("caret").appendTo($("#q_btn_" + question.identifier));

                                    $("#hidden_value_for_" + question.identifier).attr("value", val).val(val);
                                });
                            });
                            dropdown_btn.appendTo(dropdown_div);
                            dropdown_ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(dropdown_div);
                            dropdown_div.appendTo(item_div);
                            break;

                        case "text":
                            switch(question.question_layout)
                            {
                                case "multiple":
                                    var textarea = $("<textarea></textarea>").addClass("form-control").addClass("survey_textarea");

                                    textarea
                                    .on("keydown", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("keyup", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("change", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("blur", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .appendTo(item_div);

                                    $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(item_div);
                                    break;

                                default:
                                    break;
                            }
                            break;

                        default:
                            break;
                    }
                    item_div.appendTo(question_div);
                    question_div.appendTo($("#preview_form"));
                });

                $("<div></div>")
                .addClass("checkbox")
                .append
                (
                    $("<label></label>")
                    .append
                    (
                        $("<input />").attr("type", "checkbox")
                        .change(function()
                        {
                            if (this.checked)
                            {
                                $(".pp_submit_btns").find(".btn").eq(0).prop("disabled", false);
                            }
                            else
                            {
                                $(".pp_submit_btns").find(".btn").eq(0).prop("disabled", true);
                            }
                        })
                    ).append
                    (
                        "On my honor, I certify that this job is COMPLETELY Perfect Packet."
                    )
                ).appendTo($("#preview_form"));

                $("<div></div>").addClass("form-group").addClass("pp_submit_btns").append
                (
                    $("<button></button>")
                    .addClass("btn")
                    .addClass("btn-success")
                    .prop("disabled", true)
                    .text("Submit")
                    .attr("type", "button")
                    .click(function()
                    {
                        submitForm();
                    })
                )
                .append
                (
                    $("<button></button>")
                    .addClass("btn")
                    .addClass("btn-danger")
                    .attr("type", "button")
                    .text("Cancel")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            window.clearInterval(window.temp_packet_check_interval);
                            listPerfectPackets();
                        });
                    })
                ).appendTo($("#preview_form"));

                doBookingBasedDependencies(booking_info, survey_info);
                window.temp_packet_check_interval = setInterval(function()
                {
                    checkPreviousValueBasedDependencies(survey_info);
                    //checkValueBasedPopupAlerts();
                }, 500);
            }
            function renderSP2Survey(booking_info,survey_info)
            {
                booking_identifier = booking_info.identifier
                $.each(survey_info.questions, function(i, question)
                {
                    var question_div = $("<div></div>").attr("id", "question_" + question.identifier).addClass("q_container").addClass("form-group");
                    var label = $("<label></label>").addClass("control-label").addClass("col-sm-6").attr("for", "who_cares");
                    label.text(question.question_text);
                    label.appendTo(question_div);

                    var item_div = $("<div></div>").addClass("col-sm-6");
                    switch(question.question_type)
                    {
                        case "yes_or_no":
                            var dropdown_div = $("<div></div>").addClass("dropdown");
                            var dropdown_btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("id", "q_btn_" + question.identifier).text("Choose a value");
                            $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                            var dropdown_ul = $("<ul></ul>").attr("role", "menu").attr("aria-labelledby", "q_btn_" + question.identifier).addClass("dropdown-menu");

                            var checkbox_opts = ["1", "0"];
                            var checkbox_opts_friendly = ["Yes", "No"]

                            $.each(checkbox_opts, function(i, checkbox_opt)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                li.attr("id", "value_of_" + checkbox_opt);

                                var a = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                                a.text(checkbox_opts_friendly[i]);

                                a.appendTo(li);
                                li.appendTo(dropdown_ul);
                            });

                            dropdown_ul.find("li").each(function(i, e)
                            {
                                $(e).click(function()
                                {
                                    var val = $(e).attr("id").replace("value_of_", "");
                                    $("#q_btn_" + question.identifier).text($(e).text());
                                    $("<span></span>").addClass("caret").appendTo($("#q_btn_" + question.identifier));

                                    $("#hidden_value_for_" + question.identifier).attr("value", val).val(val);
                                });
                            });
                            dropdown_btn.appendTo(dropdown_div);
                            dropdown_ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(dropdown_div);

                            dropdown_div.appendTo(item_div);
                            break;

                        case "mult_choice":
                            var dropdown_div = $("<div></div>").addClass("dropdown");
                            var dropdown_btn = $("<button></button>").attr("type", "button").addClass("btn-default").addClass("btn").addClass("dropdown-toggle").attr("data-toggle", "dropdown").attr("id", "q_btn_" + question.identifier).text("Choose a value");
                            $("<span></span>").addClass("caret").appendTo(dropdown_btn);
                            var dropdown_ul = $("<ul></ul>").attr("role", "menu").attr("aria-labelledby", "q_btn_" + question.identifier).addClass("dropdown-menu");
                            $.each(question.question_options["multi_choices"], function(i, choice_item)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                li.attr("id", "value_of_" + choice_item.choice.split(" ").join("_____"));

                                var a = $("<a></a>").attr("href", "javascript:void(0);").attr("role", "menuitem").attr("tabindex", "-1");
                                a.text(choice_item.choice);

                                a.appendTo(li);
                                li.appendTo(dropdown_ul);
                            });

                            dropdown_ul.find("li").each(function(i, e)
                            {
                                $(e).click(function()
                                {
                                    var val = $(e).attr("id").replace("value_of_", "").split("_____").join(" ");
                                    $("#q_btn_" + question.identifier).text($(e).text());
                                    $("<span></span>").addClass("caret").appendTo($("#q_btn_" + question.identifier));

                                    $("#hidden_value_for_" + question.identifier).attr("value", val).val(val);
                                });
                            });
                            dropdown_btn.appendTo(dropdown_div);
                            dropdown_ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(dropdown_div);
                            dropdown_div.appendTo(item_div);
                            break;

                        case "text":
                            switch(question.question_layout)
                            {
                                case "multiple":
                                    var textarea = $("<textarea></textarea>").addClass("form-control").addClass("survey_textarea");

                                    textarea
                                    .on("keydown", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("keyup", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("change", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .on("blur", function()
                                    {
                                        $("#hidden_value_for_" + question.identifier).attr("value", textarea.val()).val(textarea.val());
                                    })
                                    .appendTo(item_div);

                                    $("<input />").attr("type", "hidden").addClass("true_question_value").attr("value", "unanswered").val("unanswered").attr("id", "hidden_value_for_" + question.identifier).appendTo(item_div);
                                    break;

                                default:
                                    break;
                            }
                            break;

                        default:
                            break;
                    }
                    if(question.dependent_value !== "n/a")
                    {
                        question_div.css("display", "none");
                        $("#hidden_value_for_" + question.identifier).attr("value", "n/a").val("n/a");
                    }

                    item_div.appendTo(question_div);
                    question_div.appendTo($("." + booking_identifier));
                });

                $("<div></div>").addClass("col-sm-12").addClass("survey_button_div").append
                (
                    $("<center></center>").append
                    (
                        $("<button></button>")
                        .addClass("btn")
                        .addClass("btn-success")
                        .addClass(booking_identifier)
                        .text("Submit")
                        .attr("id", "survey_submit")
                        .click(function()
                        {
                            submitFormSP2(booking_identifier);
                        })
                    )
                ).appendTo($("." + booking_identifier));

                doBookingBasedDependencies(booking_info,survey_info);
                setInterval(function()
                {
                    checkPreviousValueBasedDependencies(survey_info);
                    $("." + booking_identifier).show();
                    //checkValueBasedPopupAlerts();
                }, 500);

                $("#loading").css("display", "none");
                $("body").css("cursor", "auto");
            }
            function doBookingBasedDependencies(booking_info, survey_info)
            {
                $.each(survey_info.questions, function(i, question)
                {
                    if(question.dependency_type === "entity_info")
                    {
                        var field = question.dependency_value_type.split("|")[1];

                        var predicate_fn = function(val)
                        {
                            return true;
                        };
                        if(question.dependency_value_comp_mode === "equal")
                        {
                            predicate_fn = function(val, vals)
                            {
                                return vals.indexOf(val) > -1;
                            };
                        }
                        if(question.dependency_value_comp_mode === "not_equal")
                        {
                            predicate_fn = function(val, vals)
                            {
                                return vals.indexOf(val) === -1;
                            };
                        }
                        var vals = question.dependent_value.split("|||||");
                        var first_arg = null;
                        first_arg = booking_info[field];
                        if(predicate_fn(first_arg, vals))
                        {
                            $("#question_" + question.identifier).css("display", "block");
                        }
                        else
                        {
                            $("#question_" + question.identifier).css("display", "none").find(".true_question_value").val("n/a").attr("value", "n/a");
                        }
                    }
                });
            }
            function checkPreviousValueBasedDependencies(survey_info)
            {
                $.each(survey_info.questions, function(i, question)
                {
                    if(question.dependency_type === "prev_q")
                    {
                        switch(question.dependency_value_type)
                        {
                            case "yes_or_no":
                                var this_idx = question.question_idx;
                                var prev_idx = this_idx - 1;

                                switch(question.dependency_value_comp_mode)
                                {
                                    case "equal":
                                        if($(".true_question_value").eq(prev_idx).val() === question.dependent_value)
                                        {
                                            if($(".q_container").eq(this_idx).val() === "n/a")
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                    $(".true_question_value").eq(this_idx).val("unanswered").attr("value", "unanswered");
                                                }
                                            }
                                            else
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }
                                        }
                                        else
                                        {
                                            $(".true_question_value").eq(this_idx).val("n/a").attr("value", "n/a");
                                            $(".q_container").eq(this_idx).css("display", "none");
                                        }
                                        break;

                                    case "not_equal":
                                        if($(".true_question_value").eq(prev_idx).val() !== question.dependent_value)
                                        {
                                            if($(".q_container").eq(this_idx).val() === "n/a")
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                    $(".true_question_value").eq(this_idx).val("unanswered").attr("value", "unanswered");
                                                }
                                            }
                                            else
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }
                                        }
                                        else
                                        {
                                            $(".true_question_value").eq(this_idx).val("n/a").attr("value", "n/a");
                                            $(".q_container").eq(this_idx).css("display", "none");
                                        }
                                        break;

                                    default:
                                        break;
                                }
                                break;

                            case "mult_choice":
                                var this_idx = question.question_idx;
                                var prev_idx = this_idx - 1;

                                switch(question.dependency_value_comp_mode)
                                {
                                    case "equal":
                                        if($(".true_question_value").eq(prev_idx).val() === question.dependent_value)
                                        {
                                            if($(".q_container").eq(this_idx).val() === "n/a")
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".true_question_value").eq(this_idx).val("unanswered").attr("value", "unanswered");
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }
                                            else
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }
                                        }
                                        else
                                        {
                                            $(".true_question_value").eq(this_idx).val("n/a").attr("value", "n/a");
                                            $(".q_container").eq(this_idx).css("display", "none");
                                        }
                                        break;

                                    case "not_equal":
                                        if($(".true_question_value").eq(prev_idx).val() !== question.dependent_value)
                                        {
                                            if($(".q_container").eq(this_idx).val() === "n/a")
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".true_question_value").eq(this_idx).val("unanswered").attr("value", "unanswered");
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }
                                            else
                                            {
                                                if($(".q_container").eq(this_idx).css("display").toLowerCase() !== "block")
                                                {
                                                    $(".q_container").eq(this_idx).css("display", "block");
                                                }
                                            }

                                        }
                                        else
                                        {
                                            $(".true_question_value").eq(this_idx).val("n/a").attr("value", "n/a");
                                            $(".q_container").eq(this_idx).css("display", "none");
                                        }
                                        break;

                                    default:
                                        break;
                                }
                                break;

                            default:
                                break;
                        }
                    }
                });
            }
            function submitForm()
            {
                var ret_false = false;
                $(".true_question_value").each(function(i, e)
                {
                    if(i === 1 && $(e).val().toLowerCase() === "no")
                    {
                        ret_false = true;
                    }
                    if($(e).val().toLowerCase() === "unanswered")
                    {
                        ret_false = true;
                    }
                    if((i === 8 || i === 13) && $(e).val().toLowerCase() === "0")
                    {
                        ret_false = true;
                    }
                });
                if(ret_false)
                {
                    window.alert("Either the answers you provided are incomplete, or they were answered in a way that would make this packet ineligible for submission");
                    return false;
                }

                $(".pp_submit_btns").find(".btn").eq(0).text("Submitting...").css("opacity", "0.5");

                var identifiers = [];
                var vals = [];
                $(".true_question_value").each(function(i, e)
                {
                    var identifier = $(e).attr("id").replace("hidden_value_for_", "");
                    identifiers.push(identifier);

                    vals.push($(e).val());
                });
                $.post("./data", {"fn": "record_survey_response", "identifiers": JSON.stringify(identifiers), "vals": JSON.stringify(vals), "survey_identifier": "{{ packet_survey_identifier }}", "packet_identifier": window.packet_identifier}).done(function(resp)
                {
                    localStorage.setItem("button_to_click", "perfect_packet_main_icon");
                    window.location.reload();
                });
                setTimeout(function()
                {
                    window.submitting_form = false;
                }, 500);
            }
            function submitFormSP2(booking_identifier)
            {
                var survey_identifier = "{{ survey_identifier }}";
                var ret_false = false;
                $(".true_question_value").each(function(i, e)
                {
                    if($(e).val().toLowerCase() === "unanswered")
                    {
                        $(e).closest(".form-group")
                        .css("border", "1px solid red")
                        .css("background", "#C31919")

                        setTimeout(function()
                        {
                            $(e).closest(".form-group")
                            .css("border", "0px solid red")
                            .css("background", "transparent")
                        }, 5000);

                        $(e).closest(".form-group")[0].scrollIntoView();

                        ret_false = true;
                    }
                });
                if(ret_false)
                {
                    return false;
                }
                $("#survey_submit").text("Submitting...").css("opacity", "0.5");
                var identifiers = [];
                var vals = [];
                $(".true_question_value").each(function(i, e)
                {
                    var identifier = $(e).attr("id").replace("hidden_value_for_", "");
                    identifiers.push(identifier);

                    vals.push($(e).val());
                });
                $.post("./data", {"fn": "record_survey_response", "identifiers": JSON.stringify(identifiers), "vals": JSON.stringify(vals), "survey_identifier": survey_identifier, "booking_identifier": booking_identifier}).done(function(resp)
                {
                    if($(".followup_row").length > 1)
                    {
                        $('.' + booking_identifier).empty().hide().parent().remove();
                    }
                    else
                    {
                        window.location.reload();
                    }
                });
            }
            function exportPaymentHistory(start_date, end_date)
            {
                var today = moment();
                var jan_1 = moment(today.format("YYYY") + "-01-01", "YYYY-MM-DD");
                var dec_31 = moment(today.format("YYYY") + "-12-31", "YYYY-MM-DD");
                if(typeof(start_date) + '' === "undefined")
                {
                    var html = $("<div></div>");
                    $("<p></p>").text("From: ").appendTo(html);
                    
                    $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12")
                    .append
                    (
                      $("<div></div>").addClass("input-append").addClass("date").attr("data-date", jan_1.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                      .append
                      (
                          $("<input />").attr("type", "text").addClass("span2").addClass("payment_export_start").attr("size", "16").attr("value", jan_1.format("MM/DD/YYYY"))
                      )
                      .append
                      (
                          $("<span></span>").addClass("add-on")
                          .append
                          (
                              $("<i></i>").addClass("icon-th")
                          )
                      )
                    ).appendTo(html);

                    $("<p></p>").text("To: ").appendTo(html);
                    
                    $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12")
                    .append
                    (
                      $("<div></div>").addClass("input-append").addClass("date").attr("data-date", dec_31.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                      .append
                      (
                          $("<input />").attr("type", "text").addClass("span2").addClass("payment_export_end").attr("size", "16").attr("value", dec_31.format("MM/DD/YYYY"))
                      )
                      .append
                      (
                          $("<span></span>").addClass("add-on")
                          .append
                          (
                              $("<i></i>").addClass("icon-th")
                          )
                      )
                    ).appendTo(html);

                    BootstrapDialog.show
                    (
                        {
                            "title": "Exporting Payment History",
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "Cancel",
                                    "cssClass": "btn-danger",
                                    "action": function(d)
                                    {
                                        d.close();
                                    }
                                },
                                {
                                    "label": "Export",
                                    "cssClass": "btn-primary",
                                    "action": function(d)
                                    {
                                        d.close();
                                        exportPaymentHistory(moment($(".payment_export_start").val(), "MM/DD/YYYY").format("YYYY-MM-DD"), moment($(".payment_export_end").val(), "MM/DD/YYYY").format("YYYY-MM-DD"));
                                    }
                                }
                            ],
                            "onshown": function(d)
                            {
                                $.each(["payment_export_start", "payment_export_end"], function(i, e)
                                {
                                    $("." + e).datepicker
                                    (
                                        {
                                            "format": "mm/dd/yyyy",
                                            "autoClose": true
                                        }
                                    );
                                    $.each(["keyup", "keypress", "keydown"], function(ii, ee)
                                    {
                                        $(".paycheck_dp_input").on(ee, function(ev)
                                        {
                                            ev.preventDefault();
                                        });
                                    });
                                });                                
                            }
                        }
                    );
                    return;
                }

                $.post("/data", {"fn": "export_payment_history_for_rep", "start": start_date, "end": end_date, "identifier": window.user_identifier}).done(function(r)
                {
                    BootstrapDialog.alert("Your data will be emailed to you within an hour. If you do not get the email, please report the issue to your supervivsor. Thanks!");
                });                
            }
            function reportPaycheckIssue()
            {
                var html = $("<div></div>");
                $("<p></p>").text("All corrections to paychecks must be submitted by 10AM PST on Wednesdays. Please describe in detail the issue with this paycheck.").appendTo(html);
                $("<textarea></textarea>").addClass("paycheck_issue_ta").appendTo(html);

                BootstrapDialog.show
                (
                    {
                        "title": "Reporting a Paycheck Issue",
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Cancel",
                                "cssClass": "btn-danger",
                                "action": function(d)
                                {
                                    d.close();
                                }
                            },
                            {
                                "label": "Save",
                                "cssClass": "btn-primary",
                                "action": function(d)
                                {
                                    if($.trim($(".paycheck_issue_ta").val()).length === 0)
                                    {
                                        window.alert("You must first describe the issue");
                                        return;
                                    }
                                    $.post("/data", {"fn": "report_paycheck_issue", "name": "{{ user_name }}", "issue": $(".paycheck_issue_ta").val(), "phone": "{{ rep_phone}}", "email": "{{ rep_email }}"}).done(function(r)
                                    {
                                        d.close();
                                    });
                                }
                            }
                        ]
                    }
                )
                
            }
            function previewPaycheck(data, friday)
            {
                hideIconGrid();
                
                var mommy = null;
                if(typeof(friday) + '' === "undefined")
                {
                    mommy = moment();
                    if(mommy.weekday() === 6)
                    {
                        mommy = mommy.subtract(1, "days");
                    }
                    else
                    {
                        while(mommy.weekday() !== 5)
                        {
                            mommy = mommy.add(1, "days");
                        }
                    }    
                }
                else
                {
                    mommy = moment(friday, "MM/DD/YYYY");
                }                

                if(data.ready === false)
                {
                    window.alert("Paycheck Preview for this week is not yet available.");
                    data.transactions = [];
                }

                var cents_total = 0;
                $.each(data.transactions, function(i, transaction)
                {
                    cents_total += transaction.amount;
                });

                var usd_total = ((cents_total + 0.1 - 0.1) / (100 + 0.1 - 0.1));
                if(usd_total < 0 || cents_total < 0)
                {
                    usd_total = 0;
                    cents_total = 0;
                }

                var dollar_total = parseInt(cents_total / 100);
                var cent_total = cents_total % 100;
                var cent_total_zero_padded = cent_total + '';
                cent_total_zero_padded = cent_total_zero_padded.replace("-", "");
                if(cent_total_zero_padded.length === 1)
                {
                    cent_total_zero_padded = "0" + cent_total_zero_padded;
                }

                var app_area = $("#app_area");
                $("<div></div>").addClass("row")
                .append
                (
                    $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12")
                    .append
                    (
                      $("<div></div>").addClass("input-append").addClass("date").attr("data-date", mommy.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                      .append
                      (
                          $("<input />").attr("type", "text").addClass("span2").addClass("paycheck_dp_input").attr("size", "16").attr("value", mommy.format("MM/DD/YYYY"))
                      )
                      .append
                      (
                          $("<span></span>").addClass("add-on")
                          .append
                          (
                              $("<i></i>").addClass("icon-th")
                          )
                      )
                    )
                    .append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-primary").text("Export Payment History").addClass("rep_payment_export_button")
                        .append
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-download-alt")
                        )
                        .click(function()
                        {
                            exportPaymentHistory();
                        })
                    )
                    .append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-primary").text("Report Issue with Paycheck").addClass("rep_report_paycheck_issue")
                        .click(function()
                        {
                            reportPaycheckIssue();
                        })
                    )
                )
                .appendTo(app_area);
                if(["solar_pro", "solar_pro_manager"].indexOf("{{ user_type }}") > -1)
                {
                    $("<span></span>").addClass("label").addClass("label-primary").text("Potential Bonus Amount: " + currencyFormat(300 * data.potential_bonuses.length)).attr("id", "potential_bonus_lbl")
                    .insertAfter(app_area.find(".rep_report_paycheck_issue").first())

                    $("<p></p>").addClass("bonus_disclaimer").text("The potential bonus amount is estimated by multiplying multiplying $300 times the number of jobs on the calendar you set an appointment for. Commissions are not earned until all the requirements in your Solar Pro Commission Plan are met.  See plan for details.").addClass("bonus_disclaimer")
                    .insertAfter("#potential_bonus_lbl");

                }

                $(".paycheck_dp_input").datepicker
                (
                    {
                        "format": "mm/dd/yyyy",
                        "autoClose": true,
                        "daysOfWeekDisabled": [0, 1, 2, 3, 4, 6]
                    }
                );
                $.each(["keyup", "keypress", "keydown"], function(i, e)
                {
                    $(".paycheck_dp_input").on(e, function(ev)
                    {
                        ev.preventDefault();
                    });
                });
                $(".paycheck_dp_input").on("change.dp", function(ev)
                {
                    var fri = moment($(this).val(), "MM/DD/YYYY");
                    $.post("./data", {"fn": "calculate_upcoming_paycheck_for_rep", "custom_date": "1", "date": fri.format("YYYY-MM-DD")}).done(function(resp2)
                    {
                        clearApp(function()
                        {
                            $("#perfect_packet_paycheck").closest(".grid_icon_wrapper").css("opacity", "1.0");
                            previewPaycheck(resp2.paycheck_data, fri.format("MM/DD/YYYY"));
                        });
                    });
                });
                var pp_list_spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var check = $("<div></div>").addClass("row").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10").addClass("pp_check");
                var input_spacer = $("<span></span>").addClass("pp_input_spacer");
                var date_div = $("<div></div>").addClass("pp_dt");
                var date_hdr = $("<span></span>").addClass("pp_hdr").text("DATE:");

         
                var date_input = $("<span></span>").addClass("pp_input pp_dt_txt").text(mommy.format("MM-DD-YY"));
                date_div.append(date_hdr);
                date_div.append(input_spacer);
                date_div.append(date_input);
                var date_underline = $("<hr>").addClass("pp_dt pp_line pp_dt_line");
                check.append(date_div);
                check.append(date_underline);
                var pay_order_div = $("<div></div>").addClass("pp_pay_order");
                var pay_order_hdr = $("<span></span>").addClass("pp_hdr").text("PAY TO THE ORDER OF");
                var pay_order_input = $("<span></span>").addClass("pp_input2").text("{{ user_name }}");                
                pay_order_div.append(pay_order_hdr);
                pay_order_div.append(input_spacer.clone());
                pay_order_div.append(pay_order_input);
                var pay_order_underline = $("<hr>").addClass("pp_pay_order pp_line2");
                var dollar_amnt = $("<div></div>").addClass("pp_dollar_amnt");
                var dollar_sign = $("<span></span>").addClass("glyphicon glyphicon-usd");
                var dollar_box = $("<span></span>").addClass("pp_dollar_box pp_input2").attr("id", "dollas").text("00.00");
                dollar_amnt.append(dollar_sign);
                dollar_amnt.append(dollar_box);
                check.append(pay_order_div);
                check.append(dollar_amnt);
                check.append(pay_order_underline);
                var dollar_word_div = $("<div></div>").addClass("pp_dollar");


                var dollar_words = numToEnglish(dollar_total);
                if(dollar_words === "")
                {
                    dollar_words = "Zero";
                }

                var dollar_word = $("<div></div>").addClass("pp_dollar_word")
                .append
                (
                        $("<span></span>").addClass("pp_input").text(dollar_words)
                )
                .append
                (
                    $("<span></span>").addClass("and_qualifier").text("and")
                )
                .append
                (
                    $("<span></span>").addClass("cents_written_out").text(cent_total_zero_padded)
                )
                .append
                (
                    $("<span></span>").addClass("cent_divisor").text("/")
                )
                .append
                (
                    $("<span></span>").addClass("out_of_one_hundred").text("100")
                );

                var dollar_hdr = $("<div></div>").addClass("pp_dollar_hdr_cont").append
                (
                    $("<span></span>").addClass("pp_hdr").text("DOLLARS")
                )
                var dollar_underline = $("<hr>").addClass("pp_line pp_dollar").addClass("pp_line_pp_dollar").attr("id", "pp_line_pp_dollar");
                dollar_word_div.append(input_spacer.clone());
                dollar_word_div.append(dollar_word);
                dollar_word_div.append(dollar_hdr);
                check.append(dollar_word_div);
                check.append(dollar_underline);
                var fourth_div = $("<div></div>").addClass("pp_for_sig_div");
                var for_div = $("<div></div>").addClass("pp_for");
                var signature_div = $("<div></div>").addClass("pp_sig");
                fourth_div.append
                (
                   for_div
                ).append
                (
                    signature_div
                )
                var for_hdr = $("<span></span>").addClass("pp_hdr").text("FOR");
                var for_input = $("<span></span>").addClass("pp_input").addClass("thx").text("Thanks for your hard work");
                for_div.append(for_hdr);
                for_div.append(input_spacer.clone());
                for_div.append(for_input);
                signature_div.append
                (
                    $("<span></span>").addClass("pp_input3").text("New Power")
                );
                check.append(fourth_div);
                $("<div></div>").addClass("pp_for_sig_div").append
                (
                    $("<hr>").addClass("pp_line3 pp_for").addClass("pp_line3_pp_for")
                ).append
                (
                    $("<hr>").addClass("pp_line3 pp_sig").addClass("pp_line3_pp_sig")
                ).appendTo(check);
                var routing_div = $("<div></div>").addClass("routing_div").append
                (
                    $("<span></span>").addClass("routing_num").text("122105278")
                );
                var acc_div = $("<div></div>").addClass("acc_div").append
                (
                    $("<span></span>").addClass("acc_num").text("6724301068")
                );
                var check_div = $("<div></div>").addClass("check_div").append
                (
                    $("<span></span>").addClass("check_num").text("148")
                );
                $("<div></div>").addClass("pp_nums").append
                (
                    routing_div
                ).append
                (
                    acc_div
                ).append
                (
                    check_div
                ).appendTo(check);
                var logo = $("<img>").attr("src", "/bootstrap/images/np_logox21.png").addClass("pp_check_logo");
                check.append(logo);

                $("<div></div>").addClass("row").append
                (
                    pp_list_spacer
                )
                .append
                (
                    check
                )
                .append
                (
                    pp_list_spacer.clone()
                )
                .appendTo(app_area);

                var breakdown = $("<div></div>").addClass("row").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10 main_bd").append
                (
                    $("<h3></h3>").addClass("centered_bd_header").text("Payment Breakdown")
                )
                .append
                (
                    $("<div></div>").addClass("row")
                    .append
                    (
                        $("<h4></h4>").addClass("col-xs-6 col-sm-6 col-md-6 col-lg-6").text("Description").addClass("bd_description_header")
                    )
                    .append
                    (
                        $("<h4></h4>").addClass("col-xs-3 col-sm-3 col-md-3 col-lg-3").text("Date Applied").addClass("bd_date_applied_header")
                    )
                    .append
                    (
                        $("<h4></h4>").addClass("col-xs-3 col-sm-3 col-md-3 col-lg-3").text("Amount").addClass("bd_amount_header")
                    )
                )
                .append
                (
                    $("<hr>").addClass("pp_breakdown_separator")
                );

                $.each(data.transactions, function(i, transaction)
                {
                    var usd_amount = "$";
                    usd_amount += (parseInt(transaction.amount / 100) + '');
                    var cents = transaction.amount % 100 + '';
                    cents = cents.replace("-", "");
                    if(cents.length === 1)
                    {
                        cents = "0" + cents;
                    }
                    usd_amount += ("." + cents);


                    var bd_item =
                    $("<div></div>").addClass("row").append
                    (
                        $("<div></div>").addClass("col-xs-6 col-sm-6 col-md-6 col-lg-6").addClass("bd_description").text(transaction.description)
                    )
                    .append
                    (
                        $("<div></div").addClass("col-xs-3 col-sm-3 col-md-3 col-lg-3").addClass("bd_date_applied").text(transaction.effective.split(" ")[0])
                    )
                    .append
                    (
                        $("<span></span>").addClass("col-xs-3 col-sm-3 col-md-3 col-lg-3").addClass("bd_amount").text(usd_amount)
                    );

                    if(usd_amount.indexOf("-") > -1)
                    {
                        bd_item.find(".bd_amount").eq(0).text(bd_item.find(".bd_amount").eq(0).text().replace("$", "( ").replace("-", " - $"));
                        bd_item.find(".bd_amount").eq(0).text(bd_item.find(".bd_amount").eq(0).text() + " )");
                        bd_item.find(".bd_amount").eq(0).addClass("bd_negative");
                    }
                    bd_item.appendTo(breakdown);
                });

                $("<div></div>").addClass("row").append
                (
                    pp_list_spacer.clone()
                )
                .append
                (
                    breakdown
                )
                .append
                (
                    pp_list_spacer.clone()
                )
                .appendTo(app_area);
                $("<div></div>").addClass("row").append
                (
                    pp_list_spacer.clone()
                )
                .append
                (
                    breakdown
                )
                .append
                (
                    pp_list_spacer.clone()
                )
                .appendTo(app_area);
                //sh-start
                $("<div id='reimbursement_div'><form id='reimbursement_form' class='form-horizontal' role='form' action='./rep' method='POST' enctype='multipart/form-data'></form></div>").addClass("row").appendTo(app_area);
                //sh-end
                //sh-start
                $("<button></button>").addClass("btn").addClass("btn-primary").addClass("paycheck_reimburse_btn").text(" Request Reimbusement").prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-refresh")).click(function()
                {
                    $("#reimbursement_div").show();
                    $(".paycheck_reimburse_btn").hide();
                })
                .appendTo(app_area);
                //sh-end
                $("<button></button>").addClass("btn").addClass("btn-danger").addClass("paycheck_back_btn").text("Go Back").click(function()
                {
                    clearApp(function()
                    {
                        window.location.reload();
                    });
                }).appendTo(app_area);

                setTimeout(function()
                {
                    if(data.transactions.length > 0)
                    {
                        $("<div></div>").addClass("show_bd").addClass("label").addClass("label-success").text("Show Details").append($("<span></span>").addClass("caret")).click(function()
                        {
                            $(".show_bd").remove();
                            $(".main_bd").css("display", "block");
                            setTimeout(function()
                            {
                                resize_fn();
                            }, 150);
                        }).insertAfter($(".pp_check").eq(0).parent());
                        $("#dollas").text(usd_total);
                        $("#dollas").counterUp();
                    }
                }, 250);
                //sh-start
                reimbursementRequest();
                $("#reimbursement_div").hide();
                //sh-end
            }
            //sh-start
            function reimbursementRequest()
            {
                var app_area = $("#app_area");
                var reimbursement_form = $("#reimbursement_form");
                var spacer = $("<div></div>").addClass("col-xs-1 col-sm-1 col-md-1 col-lg-1");
                var row = $("<div></div>").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10");
                var cat_sel_cnt = $("<div>").addClass("col-xs-5 col-sm-5 col-md-5 col-lg-5");
                var cat_sel = $("<input>").attr("type", "hidden").attr("id", "cat_sel").attr("name", "cat_sel").val("N/A");
                var cat_sel_div = $("<div></div>").addClass("dropdown").addClass("dropdownCatSel");
                var btn = $("<button></button>").html("Select a Category <span class='caret'></span>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("id", "btnCatSel").attr("data-toggle", "dropdown").attr("aria-expanded", "true");


                btn.appendTo(cat_sel_div);

                var catsel_ul = $("<ul></ul>").addClass("dropdown-menu").addClass("cat_sel_menu").attr("role", "menu").attr("aria-labelledby", "btnCatSel");

                var li1 = $("<li></li>").attr("role", "presentation").attr("id", "cat_sel_reimbursement_customer");
                $("<a></a>").text("Customer expense").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").appendTo(li1);
                li1.appendTo(catsel_ul);
                var li2 = $("<li></li>").attr("role", "presentation").attr("id", "cat_sel_reimbursement_recruiting");
                $("<a></a>").text("Recruiting expense").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").appendTo(li2);
                li2.appendTo(catsel_ul);
                var li3 = $("<li></li>").attr("role", "presentation").attr("id", "cat_sel_reimbursement_incentive");
                $("<a></a>").text("Incentive expense").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").appendTo(li3);
                li3.appendTo(catsel_ul);
                var li4 = $("<li></li>").attr("role", "presentation").attr("id", "cat_sel_reimbursement_office");
                $("<a></a>").text("Office materials expense").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").appendTo(li4);
                li4.appendTo(catsel_ul);
                var li5 = $("<li></li>").attr("role", "presentation").attr("id", "cat_sel_reimbursement_other");
                $("<a></a>").text("Other expense").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").appendTo(li5);
                li5.appendTo(catsel_ul);

                catsel_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        btn.text($(e).text());
                        $("<span></span>").addClass("caret").appendTo(cat_sel_div.find(".btn"));

                        $("#cat_sel").val($(e).attr("id").replace("cat_sel_", ""));
                        $("#cat_sel").attr("value", $(e).attr("id").replace("cat_sel_", ""));

                        var value = ($(e).attr("id").replace("cat_sel_", ""));
                        if (value == "reimbursement_customer")
                        {
                            desc_val.val("Reimbursement - Customer expenses");
                        }
                        if (value == "reimbursement_recruiting")
                        {
                            desc_val.val("Reimbursement - Recruitment expenses");
                        }
                        if (value == "reimbursement_incentive")
                        {
                            desc_val.val("Reimbursement - Incentive expenses(including dinner goals)");
                        }
                        if (value == "reimbursement_office")
                        {
                            desc_val.val("Reimbursement - Office materials expenses");
                        }
                        if (value == "reimbursement_other")
                        {
                            desc_val.val("Reimbursement - Other expenses");                            
                        }
                    });
                });                

                cat_sel_div.append(catsel_ul);
                cat_sel_cnt.append(cat_sel_div);
                cat_sel_cnt.append(cat_sel);

                $("<p></p>").addClass("reimburse_cat_label").text("Reimbursement Category").prependTo(cat_sel_cnt);

                reimbursement_form.append
                (
                    spacer.clone()
                );

                reimbursement_form.append
                (
                    cat_sel_cnt
                );

                var amnt_in = $("<input>").attr("type", "text").attr("name", "amnt_in_val").attr("id", "amnt_in_val").addClass("form-control").keypress(function(e)
                {
                    var dot_loc = $(this).val().indexOf(".", 0);
                    var k = e.keyCode;
                    // Accept 0-9
                    if (((k - '0'.charCodeAt(0) >= 0 && k - '0'.charCodeAt(0) <= 9))
                        || (dot_loc === -1 && String.fromCharCode(k) === '.'))
                    {
                        // Pass
                    }
                    else
                    {
                        e.preventDefault();
                    }
                }).blur(function()
                {
                    var amnt = $(this).val();
                    var dot_loc = $(this).val().indexOf(".", 0);
                    if (dot_loc === -1)
                    {
                        $(this).val($(this).val() + ".00");
                    }
                    else if (dot_loc === $(this).val().length - 1)
                    {
                        $(this).val($(this).val() + "00");
                    }
                    else if (dot_loc === $(this).val().length - 2)
                    {
                        $(this).val($(this).val() + "0");
                    }
                    else
                    {
                        $(this).val($(this).val().substring(0, dot_loc + 3));
                    }

                    dot_loc = $(this).val().indexOf(".", 0);
                    if (dot_loc === 0)
                    {
                        $(this).val('0' + $(this).val());
                    }
                    var length = $(this).val().length;
                    // XXX.XX A comma is inserted if the string is more than 6 chars long
                    if (length > 6)
                    {
                        var comma_exists = $(this).val().indexOf(",", 0) !== -1;
                        if (!comma_exists)
                        {
                            $(this).val($(this).val().substr(0, dot_loc - 3) + "," + $(this).val().substr(dot_loc - 3));
                        }
                    }
                    var amnt = parseFloat($(this).val().replace(',','')).toFixed(2);
                    if (amnt < 0.01)
                    {
                        $(this).parent().css("box-shadow", "0 0 7px #f55");
                        amnt_in._valid = false;
                    }
                    else
                    {
                        amnt_in._valid = true;
                    }
                }).focus(function()
                {
                    $(this).parent().css("box-shadow", "");
                });
                amnt_in._valid = false;

                var amnt_cnt2 = $("<div>").addClass("amnt_cnt")
                .append
                (
                    $("<div>").addClass("input-group").attr("id", "amnt_in")
                    .append
                    (
                        $("<span>").addClass("input-group-addon").text("$")
                    )
                    .append
                    (
                        amnt_in
                    )
                );

                $("<p></p>").addClass("amount_lbl").text("Amount:").prependTo(amnt_cnt2);

                amnt_cnt2.appendTo(reimbursement_form);

                $("<div>").addClass("row").append
                (
                    spacer
                ).append
                (
                    row
                ).append
                (
                    spacer.clone()
                ).appendTo
                (
                    reimbursement_form
                );

                row = $("<div>").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10").addClass("desc_cnt");
                var desc_lbl = $("<span>").addClass("col-xs-2 col-sm-2 col-md-2 col-lg-2").text("Description:");
                var desc_val = $("<input>").attr("type", "hidden").attr("id", "reimbursement_desc_val").attr("name", "reimbursement_desc_val").val("N/A");
                var desc = $("<textarea>").addClass("reimbursement_desc").attr("id", "reimbursement_desc").attr("name", "reimbursement_desc").attr("placeholder", "Be as detailed as possible...").attr("rows", "2").attr("cols", "60").blur(function()
                {
                    if ($.trim($(this).val()).length === 0)
                    {
                        $(this).css("box-shadow", "0 0 7px #f55");
                        desc._valid = false;
                    }
                    else
                    {
                        $(this).css("box-shadow", "");
                        desc._valid = true;
                    }
                });
                desc._valid = false;

                row.append
                (
                    desc_lbl
                ).append
                (
                    desc
                ).append
                (
                    desc_val
                );

                $("<div>").addClass("row").append
                (
                    spacer.clone()
                ).append
                (
                    row
                ).append
                (
                    spacer.clone()
                ).appendTo
                (
                    reimbursement_form
                );

                row = $("<div>").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10").addClass("file_cnt");
                var file_lbl = $("<span>").addClass("col-xs-2 col-sm-2 col-md-2 col-lg-2").text("Upload Receipt:");
                var file_confirm = $("<p>").attr("id", "file_sel_confirm").html("File selected &#10004;");
                var file = $("<input>").attr("type", "file").attr("id", "pic").attr("name", "pic").attr("required", "required").attr("accept", "image/*").css("display", "none");
                /*.change(function()
                {
                    if(file.val().length > 0)
                    {
                        file_confirm.css("display", "block");
                    }
                });*/
                var file_camera = $("<span>").addClass("glyphicon glyphicon-camera").click(function()
                {
                    file.click();
                });

                row.append
                (
                    file_lbl
                ).append
                (
                    file_camera
                ).append
                (
                    file_confirm
                ).append
                (
                    file
                );

                $("<div>").addClass("row").append
                (
                    spacer.clone()
                ).append
                (
                    row
                ).append
                (
                    spacer.clone()
                ).appendTo
                (
                    reimbursement_form
                );


                var validation_fn = function()
                {
                    //check category
                    if($("#cat_sel").val().toLowerCase() === "n/a")
                    {
                       BootstrapDialog.show
                        (
                            {
                                title: "Fail!",
                                type: BootstrapDialog.TYPE_WARNING,
                                closable: true,
                                closeByBackdrop: false,
                                closeByKeyboard: false,
                                message: "You must first select a category",
                                buttons:
                                [
                                    {
                                        label: "Close",
                                        action: function(dialogRef)
                                        {
                                            dialogRef.close();
                                        }
                                    }
                                ]
                            }
                        );
                        return false;
                    }
                    //verify the amount
                    $("#amnt_in").find("input").eq(0).val($.trim($("#amnt_in").find("input").eq(0).val()));

                    var vals_1 = $("#amnt_in").find("input").eq(0).val().split("");
                    var valid = true;
                    var found_period = false;
                    var found_comma = false;
                    $.each(vals_1, function(i, char)
                    {
                        var ascii = char.charCodeAt(0);
                        if((ascii >= 48 && ascii <= 57) || ascii === 46 || ascii === 44)
                        {
                            if(ascii === 46)
                            {
                                if(!found_period)
                                {
                                    found_period = true;
                                }
                                else
                                {
                                    valid = false;
                                }
                            }
                            else if(ascii === 44)
                            {
                                if(!found_comma)
                                {
                                    found_comma = true;
                                }
                                else
                                {
                                    valid = false;
                                }
                            }
                        }
                        else
                        {
                            valid = false;
                        }
                    });
                    valid = valid && vals_1.length > 0;
                    if(!valid)
                    {
                        BootstrapDialog.show
                        (
                            {
                                title: "Fail!",
                                type: BootstrapDialog.TYPE_WARNING,
                                closable: true,
                                closeByBackdrop: false,
                                closeByKeyboard: false,
                                message: "The amount provided was invalid",
                                buttons:
                                [
                                    {
                                        label: "Close",
                                        action: function(dialogRef)
                                        {
                                            dialogRef.close();
                                        }
                                    }
                                ]
                            }
                        );
                        return false;
                    }
                    //verify description
                    var desc_val = $.trim($(".reimbursement_desc_val").val());
                    var desc = $.trim($(".reimbursement_desc").val());
                    if(desc.length === 0)
                    {
                        BootstrapDialog.show
                        (
                            {
                                title: "Fail!",
                                type: BootstrapDialog.TYPE_WARNING,
                                closable: true,
                                closeByBackdrop: false,
                                closeByKeyboard: false,
                                message: "A description is required.",
                                buttons:
                                [
                                    {
                                        label: "Close",
                                        action: function(dialogRef)
                                        {
                                            dialogRef.close();
                                        }
                                    }
                                ]
                            }
                        );
                        return false;
                    }
                    //verify pic
                    var val = $.trim($("#pic").val());
                    if(val === "" || (val.toLowerCase().indexOf("jpg") === -1 && val.toLowerCase().indexOf("png")) === -1)
                    {
                        BootstrapDialog.show
                        (
                            {
                                title: "Fail!",
                                type: BootstrapDialog.TYPE_WARNING,
                                closable: true,
                                closeByBackdrop: false,
                                closeByKeyboard: false,
                                message: "You must first add a JPEG or PNG image file of the receipt.",
                                buttons:
                                [
                                    {
                                        label: "Close",
                                        action: function(dialogRef)
                                        {
                                            dialogRef.close();
                                        }
                                    }
                                ]
                            }
                        );

                        return false;
                    }
                };


                $("<div></div>").addClass("row").append
                (
                    spacer.clone()
                ).append
                (
                    $("<div></div>").addClass("col-xs-10 col-sm-10 col-md-10 col-lg-10").append
                    (
                        $("<div></div>").addClass("col-xs-5 col-sm-5 col-md-5 col-lg-5").append
                        (
                            $("<button></button>").text("Submit Request").addClass("reimbursement_submit").attr("type", "submit").addClass("btn").addClass("btn-success").click(function()
                            {
                                //check category
                                if($("#cat_sel").val() === "N/A")
                                {
                                   BootstrapDialog.show
                                    (
                                        {
                                            title: "Fail!",
                                            type: BootstrapDialog.TYPE_WARNING,
                                            closable: true,
                                            closeByBackdrop: false,
                                            closeByKeyboard: false,
                                            message: "Failed to add reimbursement, because you must select a category",
                                            buttons:
                                            [
                                                {
                                                    label: "Close",
                                                    action: function(dialogRef)
                                                    {
                                                        dialogRef.close();
                                                    }
                                                }
                                            ]
                                        }
                                    );
                                    return false;
                                }
                                //verify the amount
                                $("#amnt_in").find("input").eq(0).val($.trim($("#amnt_in").find("input").eq(0).val()));

                                var vals_1 = $("#amnt_in").find("input").eq(0).val().split("");
                                var valid = true;
                                var found_period = false;
                                var found_comma = false;
                                $.each(vals_1, function(i, char)
                                {
                                    var ascii = char.charCodeAt(0);
                                    if((ascii >= 48 && ascii <= 57) || ascii === 46 || ascii === 44)
                                    {
                                        if(ascii === 46)
                                        {
                                            if(!found_period)
                                            {
                                                found_period = true;
                                            }
                                            else
                                            {
                                                valid = false;
                                            }
                                        }
                                        else if(ascii === 44)
                                        {
                                            if(!found_comma)
                                            {
                                                found_comma = true;
                                            }
                                            else
                                            {
                                                valid = false;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        valid = false;
                                    }
                                });
                                valid = valid && vals_1.length > 0;
                                if(!valid)
                                {
                                    BootstrapDialog.show
                                    (
                                        {
                                            title: "Fail!",
                                            type: BootstrapDialog.TYPE_WARNING,
                                            closable: true,
                                            closeByBackdrop: false,
                                            closeByKeyboard: false,
                                            message: "Failed to add reimbursement, because amount provided was invalid",
                                            buttons:
                                            [
                                                {
                                                    label: "Close",
                                                    action: function(dialogRef)
                                                    {
                                                        dialogRef.close();
                                                    }
                                                }
                                            ]
                                        }
                                    );
                                    return false;
                                }
                                //verify description
                                var desc_val = $.trim($(".reimbursement_desc_val").val());
                                var desc = $.trim($(".reimbursement_desc").val());
                                if(desc.length === 0)
                                {
                                    BootstrapDialog.show
                                    (
                                        {
                                            title: "Fail!",
                                            type: BootstrapDialog.TYPE_WARNING,
                                            closable: true,
                                            closeByBackdrop: false,
                                            closeByKeyboard: false,
                                            message: "Failed to add reimbursement, because the description was left blank.",
                                            buttons:
                                            [
                                                {
                                                    label: "Close",
                                                    action: function(dialogRef)
                                                    {
                                                        dialogRef.close();
                                                    }
                                                }
                                            ]
                                        }
                                    );
                                    return false;
                                }
                                //verify pic
                                var val = $.trim($("#pic").val());
                                if(val === "" || (val.toLowerCase().indexOf("jpg") === -1 && val.toLowerCase().indexOf("png")) === -1)
                                {
                                    BootstrapDialog.show
                                    (
                                        {
                                            title: "Fail!",
                                            type: BootstrapDialog.TYPE_WARNING,
                                            closable: true,
                                            closeByBackdrop: false,
                                            closeByKeyboard: false,
                                            message: "Failed to add reimbursement, You must first add a jpeg or png image file of the receipt.",
                                            buttons:
                                            [
                                                {
                                                    label: "Close",
                                                    action: function(dialogRef)
                                                    {
                                                        dialogRef.close();
                                                    }
                                                }
                                            ]
                                        }
                                    );

                                    return false;
                                }
                                localStorage.setItem("button_to_click", "perfect_packet_paycheck");
                            })
                        ).append
                        (
                            $("<button></button>").text("Cancel").addClass("reimbursement_cancel").attr("type", "button").addClass("btn").addClass("btn-danger").click(function(ev)
                            {
                                ev.preventDefault();
                                $("#reimbursement_div").hide();
                                $(".paycheck_reimburse_btn").show();
                            })

                        ).append
                        (
                            $("<input>").attr("type", "hidden").attr("id", "rep_id").attr("name", "rep_id").val("{{ rep_id }}")
                        )
                    )
                ).append
                (
                    spacer.clone()
                ).appendTo
                (
                    reimbursement_form
                );

                setTimeout(function()
                {

                    //desc.hide();
                    //desc_lbl.hide();

                }, 50);
            }
            function resize_fn()
            {
                $(".bd_description").attr("style", "");
                setTimeout(function()
                {
                    $(".bd_description").each(function(i, e)
                    {
                        var h = $(e).outerHeight();
                        if(h > parseInt($(e).outerHeight()))
                        {
                            h = parseInt(h) + 1;
                        }
                        $(e).css("height", h);
                    });
                    $(".bd_date_applied, .bd_amount").each(function(i, e)
                    {
                        var h = ($(e).prevAll("div").eq(1 * $(e).hasClass("bd_amount")).outerHeight() + 0) + '';
                        h = h.replace("px", "");
                        h = parseInt(h);
                        $(e).css("min-height", (h + 'px'));
                    });
                    landscapeCheck();
                }, 500);
            }
            function showSP2Schedule(appointments, system_options)
            {
                hideIconGrid();

                var rescheduleSP2 = function(appointment)
                {
                    var reschedule_form = $("<form></form>").addClass("form-horizontal").attr("role", "form").attr("method", "POST").attr("id", "sp2_reschedule_form")
                    var sp2_date = "<div class='form-group'><label class='control-label col-sm-3' for='sp2_date'>Date and Time For SP2:</label><div class='col-sm-9'><div id='dt4' class='input-append date' data-date='12-02-2012' data-date-format='dd-mm-yyyy'><input class='span2' size='16' type='text' value='12-02-2012' name='sp2_date' id='sp2_date' /><span class='add-on'><i class='icon-th'></i></span></div></div></div>";
                    var sp2_time = "<div class='form-group'><label class='control-label col-sm-3' for='sp2_hours'>&nbsp;</label><div class='col-sm-9'><div class='sel_grouper'><select name='sp2_hours' id='sp2_hours'><option value='N/A'>Select One</option></select><select name='sp2_mins' id='sp2_mins'><option value='N/A'>Select One</option></select><select name='sp2_ampm' id='sp2_ampm'><option value='AM'>AM</option><option value='PM'>PM</option></select></div></div></div>";
                    var survey_date = "<input type='hidden' id='survey_date' name='survey_date' />";
                    var cust_state = "<input type='hidden' id='cust_state' name='cust_state' />";
                    reschedule_form.html(sp2_date + sp2_time + survey_date + cust_state);

                    var sp2_y = appointment.year + '';
                    var sp2_m = appointment.month + '';
                    if(sp2_m.length === 1)
                    {
                        sp2_m = "0" + sp2_m;
                    }

                    var sp2_d = appointment.day + '';
                    if(sp2_d.length === 1)
                    {
                        sp2_d = "0" + sp2_d;
                    }
                    var sp2_dayte = (sp2_m + "-" + sp2_d + "-" + sp2_y);

                    var survey_y = appointment.survey_year + '';
                    var survey_m = appointment.survey_month + '';
                    if(survey_m.length === 1)
                    {
                        survey_m = "0" + survey_m;
                    }

                    var survey_d = appointment.survey_day + '';
                    if(survey_d.length === 1)
                    {
                        survey_d = "0" + survey_d;
                    }
                    var survey_dayte = (survey_m + "-" + survey_d + "-" + survey_y);

                    var cust_stayte = appointment.state;

                    var identifier = appointment.identifier;

                    BootstrapDialog.show
                    (
                        {
                            title: "Reschedule sp2 appointment",
                            type: BootstrapDialog.TYPE_WARNING,
                            closable: true,
                            closeByBackdrop: false,
                            closeByKeyboard: false,
                            message: reschedule_form,
                            buttons:
                            [
                                {
                                    label: "Save",
                                    action: function(dialogRef)
                                    {
                                        if($.trim($("#sp2_hours").val()).toLowerCase() === "n/a")
                                        {
                                            window.alert("You must choose a complete time for the SP2 date");
                                            return false;
                                        }
                                        if($.trim($("#sp2_mins").val()).toLowerCase() === "n/a")
                                        {
                                            window.alert("You must choose a complete time for the SP2 date");
                                            return false;
                                        }

                                        // compare the SP2 date with the appointment date/time
                                        var appt_dayte = $("#survey_date").val();
                                        var sp2_dayte = $("#sp2_date").val();

                                        var appt_dayte_moment = moment($("#survey_date").val().replace(/-/g, ""), "MMDDYYYY");
                                        var sp2_dayte_moment = moment($("#sp2_date").val().replace(/-/g, ""), "MMDDYYYY");

                                        // california vs utah logic
                                        var is_california = $("#cust_state").val().toUpperCase() === "CA";
                                        //            for now
                                        var is_utah = !is_california;

                                        var time_diff = sp2_dayte_moment - appt_dayte_moment;
                                        var is_next_business_day = (appt_dayte_moment.format("E") === "5" && ["6", "7", "1"].indexOf(sp2_dayte_moment.format("E")) > -1) || time_diff === 86400000;
                                        if(is_utah && !is_next_business_day)
                                        {
                                            is_next_business_day = (sp2_dayte_moment.format("E") === "5" && ["6", "7", "1"].indexOf(appt_dayte_moment.format("E")) > -1)

                                                                ||

                                            (["6","7","1"].indexOf(appt_dayte_moment.format("E")) > -1 && sp2_dayte_moment.format("E") === "5")

                                                                ||

                                            time_diff === -86400000;

                                        }

                                        if(is_california)
                                        {
                                            // ensure the sp2 date is in the future
                                            if(appt_dayte_moment >= sp2_dayte_moment)
                                            {
                                                window.alert("An SP2 date must be later than the survey date.")
                                                return false;
                                            }

                                            // ensure the sp2 date is after 4:59 PM if it's the next day
                                            if(is_next_business_day)
                                            {
                                                var five_pm_or_later = true;
                                                if($("#sp2_ampm").val().toLowerCase() !== "pm")
                                                {
                                                    five_pm_or_later = false;
                                                }
                                                if(parseInt($("#sp2_hours").val()) < 5)
                                                {
                                                    five_pm_or_later = false;
                                                }

                                                if(!five_pm_or_later)
                                                {
                                                    window.alert("For cases when the SP2 date is one business day after the survey date, the SP2 time must be 5:00 P.M or later");
                                                    return false;
                                                }
                                            }

                                            // don't allow the SP2 on a saturday or sunday if the survey is on a friday
                                            if(appt_dayte_moment.isoWeekday() === 5 && time_diff <= (86400000 * 2))
                                            {
                                                window.alert("The SP2 date must be at least one business day after the survey appointment");
                                                return false;
                                            }
                                        }
                                        else if(is_utah)
                                        {
                                            // ensure the sp2 date is after 2:59 PM if it's the next day
                                            if(is_next_business_day)
                                            {
                                                var three_pm_or_later = true;
                                                if($("#sp2_ampm").val().toLowerCase() !== "pm")
                                                {
                                                    three_pm_or_later = false;
                                                }
                                                if(parseInt($("#sp2_hours").val()) < 3)
                                                {
                                                    three_pm_or_later = false;
                                                }

                                                if(!three_pm_or_later)
                                                {
                                                    window.alert("For cases when the SP2 date and the survey date are within one business day of eachother, the SP2 time must be 3:00 P.M or later");
                                                    return false;
                                                }
                                            }
                                        }
                                        else
                                        {
                                        //
                                        }

                                        var add_twelve = ($("#sp2_ampm").val().toUpperCase() === "PM") && ($("#sp2_hours").val() !== "12");
                                        var is_pm = ($("#sp2_ampm").val().toUpperCase() === "PM");
                                        var mmm = parseInt($("#sp2_mins").val());
                                        var hhh = parseInt($("#sp2_hours").val());

                                        if($("#sp2_mins").val().toLowerCase() === "n/a" || $("#sp2_hours").val().toLowerCase() === "n/a")
                                        {
                                            window.alert("You must specify a time");
                                            return;
                                        }

                                        var is_after = is_pm && (hhh > 9 && hhh < 12);
                                        is_after = (is_after || !is_after && (hhh === 9  && mmm !== 0 && is_pm));

                                        var is_before = !is_pm && (hhh < 8 || hhh === 12);

                                        if(is_pm && hhh !== 12)
                                        {
                                            hhh += 12;
                                        }

                                        if(is_after)
                                        {
                                            window.alert("The SP2 time chosen was too late.\n\nValid times are from 8:00 A.M. - 9:00 P.M.");
                                            return false;
                                        }
                                        if(is_before)
                                        {
                                            window.alert("The SP2 time chosen was too early.\n\nValid times are from 8:00 A.M. - 9:00 P.M.");
                                            return false;
                                        }

                                        var spee2_hours = $("#sp2_hours").val();
                                        var spee2_mins = $("#sp2_mins").val();
                                        var spee2_ampm = $("#sp2_ampm").val();

                                        $.post("./data", {"fn": "rep_sp2_reschedule_inhouse", "sp2_date": sp2_dayte, "sp2_hour": spee2_hours, "sp2_minute": spee2_mins, "sp2_ampm": spee2_ampm, "identifier": identifier}).done(function(resp)
                                        {
                                            if(resp.success)
                                            {
                                                dialogRef.close();
                                                clearApp(function(dialogRef)
                                                {
                                                    showSP2Schedule(dialogRef);
                                                });
                                            }
                                            else
                                            {
                                                window.alert("The chosen SP2 time conflicts with the following event:\n" + resp.conflicting_event);
                                            }
                                        });
                                    }
                                },
                                {
                                    label: "Close",
                                    action: function(dialogRef)
                                    {
                                        dialogRef.close();
                                    }
                                }
                            ],
                            onshown: function(dialog)
                            {
                                setTimeout(function()
                                {

                                    var sp2_length = $('#sp2_hours > option').length;

                                    if(sp2_length <= 1)
                                    {
                                        generateTimesInSelectMenus();
                                    }

                                    var val = getDateString();
                                    var split = val.split("/");
                                    for(var i = 0; i < split.length; i++)
                                    {
                                        if(split[i].length === 1)
                                        {
                                            split[i] = "0" + split[i];
                                        }
                                    }
                                    $("#sp2_date").attr("value", split.join("-"));
                                    $("#sp2_date").datepicker(
                                    {
                                        format: "mm-dd-yyyy",
                                        autClose: true
                                    });
                                    $("#sp2_date").each(function(i, e)
                                    {
                                        $(e).keydown(function(ev)
                                        {
                                            ev.preventDefault();
                                        }).keyup(function(ev)
                                        {
                                            ev.preventDefault();
                                        });
                                    });
                                    $("#sp2_date").val(sp2_dayte);
                                    $("#sp2_hours").val(appointment.hour);
                                    $("#sp2_mins").val(appointment.minute);
                                    $("#sp2_ampm").val(appointment.ampm);
                                    $("#survey_date").val(survey_dayte);
                                    $("#cust_state").val(cust_stayte);

                                },50);

                            }
                        }
                    );

                }

                if(typeof(appointments) + '' === "undefined")
                {
                    $.post("./data", {"fn": "rep_sp2_schedule_inhouse_v2", "identifier": window.user_identifier, "rep_id": window.rep_id }).done(function(resp)
                    {
                        showSP2Schedule(resp.appointments);
                    });
                    return;
                }

                if(typeof(system_options) + '' === "undefined")
                {
                    $.post("./data", {"fn": "read_setting", "value": "system_options"}).done(function(resp)
                    {
                        showSP2Schedule(appointments, resp.data);
                    });
                    return;
                }


                var app_area = $("#app_area");

                var events = [];
                appointments = bubbleSortArrayOfObjectsByKey(appointments, "sp2_string");
                appointments.reverse();
                $.each(appointments, function(i, appointment)
                {
                    
                    var obj = {}
                    obj["title"] = appointment.name + "\n\n" + appointment.address + "\n" + appointment.city + ", " + appointment.state;
                    start_str = appointment.year + '';

                    var time_info = {};
                    time_info["m"] = appointment.month + '';
                    time_info["d"] = appointment.day + '';

                    var hhhhh = appointment.hour;
                    if(appointment.ampm.toUpperCase() == "PM")
                    {
                        hhhhh += 12;
                    }
                    time_info["h"] = hhhhh + '';
                    time_info["mm"] = appointment.minute + '';

                    $.each(["m", "d", "h", "mm"], function(i, key)
                    {
                        if(time_info[key].length === 1)
                        {
                            time_info[key] = "0" + time_info[key];
                        }
                    });

                    start_str += "-";
                    start_str += time_info["m"];
                    start_str += "-";
                    start_str += time_info["d"];
                    start_str += "T";
                    start_str += time_info["h"];
                    start_str += ":";
                    start_str += time_info["mm"];
                    start_str += ":";
                    start_str += "00";

                    obj["start"] = start_str;
                    mom = moment(start_str);
                    end_mom = mom.add(3600, "seconds");

                    end_str = end_mom.format("YYYY-MM-DDTHH:mm:ss");
                    obj["end"] = end_str;

                    obj["identifier"] = appointment.identifier
                    obj["year"] = appointment.year
                    obj["month"] = appointment.month
                    obj["day"] = appointment.day
                    obj["hour"] = appointment.hour
                    obj["minute"] = appointment.minute
                    obj["ampm"] = appointment.ampm

                    obj["survey_year"] = appointment.survey_year
                    obj["survey_month"] = appointment.survey_month
                    obj["survey_day"] = appointment.survey_day

                    obj["state"] = appointment.state

                    events.push(obj);
                });

                var cal_area = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").attr("id", "f_cal");

                /*var view_option = $.cookie("sp2_view_option");
                if((typeof(view_option) + '').toLowerCase() !== "string")
                {
                    view_option = "calendar";
                }
                */
                var view_option = "list";
                if(view_option !== "calendar")
                {
                    cal_area.css("display", "none");
                }


                cal_area.appendTo(app_area);

                var list_row = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").attr("id", "sp2_lst");
                var h2 = $("<h2></h2>").addClass("sp2_title");
                if(appointments.length === 0)
                {
                    h2.text("No recent SP2 appointments found/ No recent proposals to generate");
                }
                else
                {
                    h2.text("My Proposals / My SP2 Appointments:");
                }
                h2.append
                (
                    $("<br />")
                )
                .append
                (
                    $("<button></button>").addClass("biggie_restore").addClass("btn").addClass("btn-primary").text("Restore Older Customer")
                    .click(function()
                    {
                        restoreOlderCustomer();
                    })
                )
                h2.appendTo(list_row);
                $("<center></center>")
                .append
                (
                    $("<p></p>").addClass("points_banked").text("Points Banked: ")
                    .append
                    (
                        $("<span></span>").text({{points_banked}})
                    )
                )
                .appendTo(list_row);
                $("<hr />").css("clear", "both").appendTo(list_row);

                var inner_row = $("<div></div>").addClass("row");

                $.each(appointments, function(i, appointment)
                {
                    var dayte = appointment.year + '';
                    var m = appointment.month + '';
                    if(m.length === 1)
                    {
                        m = "0" + m;
                    }

                    var d = appointment.day + '';
                    if(d.length === 1)
                    {
                        d = "0" + d;
                    }

                    dayte += ("-" + m + "-" + d);

                    var tyme = "";
                    var h = appointment.hour + '';

                    var mm = appointment.minute + '';

                    if(h.length === 1)
                    {
                        h = "0" + h;
                    }

                    if(mm.length === 1)
                    {
                        mm = "0" + mm;
                    }

                    tyme += (h + ":" + mm + " " + appointment.ampm);

                    var dt_div = $("<div></div>").addClass("sp2_date_and_time").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4");
                    $("<span></span>").addClass("sp2_dayte_item").text(dayte + " ").appendTo(dt_div);
                    $("<span></span>").addClass("sp2_tyme_item").text(tyme).appendTo(dt_div);

                    var name_div = $("<div></div>").addClass("sp2_nayme").addClass("col-xs-6").addClass("col-sm-6").addClass("col-md-6").addClass("col-lg-6");
                    name_div.text(appointment.name);

                    name_div.click(function()
                    {
                        $(this).prev().prev().find(".glyphicon-info-sign").trigger("click");
                    });

                    if(appointment.closed)
                    {
                        $("<div></div>").addClass("starburst")
                        .append
                        (
                            $("<span></span>")
                            .append
                            (
                                $("<span></span>")
                                .append
                                (
                                    $("<span></span>")
                                    .append
                                    (
                                        $("<label></label>").html("&#128077;")
                                    )
                                    .append
                                    (
                                        $("<b></b>").text("Closed")
                                    )
                                )
                            )
                        ).appendTo(name_div);
                    }

                    var reschedule_div = $("<div></div>").addClass("sp2_reschedule").attr("id", "reschedule_" + appointment.identifier).addClass("col-xs-2").addClass("col-sm-2").addClass("col-md-2").addClass("col-lg-2");
                    var reschedule_button = $("<a></a>").click(function()
                    {
                        rescheduleSP2(appointment);
                    }).appendTo(reschedule_div);
                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-calendar").addClass("reschedule-button").appendTo(reschedule_button);

                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").addClass("sp2_cust_details").click(function()
                    {
                        let that = $(this);
                        that.css("display", "none");
                        showDetailsForSP2CustomerInfo(appointment, that);
                    }).prependTo(reschedule_div);
                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-open-file").click(function()
                    {
                        var that = $(this);
                        that.css("opacity", "0.1");
                        $.post("/data", {"fn": "proposal_preparation_for_rep_portal", "identifier": appointment.identifier}).done(function(r5)
                        {
                            appointment.credit_notes = r5.notes;
                            appointment.proposal = r5.proposal;
                            appointment.income_verification_required = r5.income_verification_required;
                            appointment.usage_type = r5.usage_type;
                            appointment.titan_incentive = r5.titan_incentive;
                            that.css("opacity", "1.0");
                            prepareCustomerForProposal(appointment, system_options.panels, system_options.panel_points);
                        });
                    }).appendTo(reschedule_div);

                    $("<span></span>").addClass("label").addClass("label-warning").text("DL").addClass("data_logger_proposals_icon")
                    .click(function()
                    {
                        getDataLoggerInfo(appointment.identifier);
                    }).appendTo(reschedule_div);

                    $("<span></span>").addClass("symbola").addClass("chart_gen_from_my_proposals_icon").html("&#x25D0;")
                    .click(function()
                    {
                        var device_hash = window.prompt("What is the device hash?");
                        device_hash = $.trim(device_hash);
                        device_hash = device_hash.toUpperCase();
                        
                        var ret_early9 = true;
                        $.ajax
                        (
                            {
                                "type": "POST",
                                "async": true,
                                "url": "/data",
                                "dataType": "json",
                                "data": {"fn": "solar_header_hash_check", "hash": device_hash, "with_identifier": "1", "identifier": appointment.identifier},
                                "complete": function(resp)
                                {
                                    ret_early9 = (resp.responseJSON.success === false);

                                    if(ret_early9)
                                    {
                                        window.alert("The device hash you provided does not match the one deployed in the customer home.");
                                        return;
                                    }
                                    clearApp(function()
                                    {
                                        solarReaderChartGen(appointment.identifier, appointment.name);
                                    });
                                }
                            }
                        )
                    }).appendTo(reschedule_div);

                    $("<br />").appendTo(reschedule_div);
                    $("<center></center>")
                    .append
                    (
                        $("<a></a>").addClass("mark_as_ak").text("Mark as AK")
                        .attr("href", "/AKR/" + window.user_identifier + "_" + appointment.identifier)
                        .attr("target", "_blank")
                    )
                    .append
                    (
                        $("<a></a>").addClass("mark_followup").text("Mark as followup")
                        .attr("href", "javascript:void(0)")
                        .click(() =>
                        {
                            let html = $("<div></div>");
                            $("<p></p>").text("Followup Date for " + appointment.name + ":").appendTo(html);

                            $("<div></div>").addClass("input-append").addClass("date").attr("data-date", moment().format("YYYY-MM-DD")).attr("data-date-format", "yyyy-mm-dd")
                            .append
                            (
                                $("<input />").attr("size", "16").attr("type", "text").attr("value", moment().format("YYYY-MM-DD")).attr("id", "fu_item")
                            )
                            .append
                            (
                                $("<span></span>").addClass("add-on")
                                .append
                                (
                                    $("<i></i>").addClass("icon-th")
                                )
                            )
                            .appendTo(html);

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Followup",
                                    "message": html.html(),
                                    "onshown": ((d) =>
                                    {
                                        $("#fu_item").first().datepicker
                                        (
                                            {
                                                "autoClose": true,
                                                "format": "yyyy-mm-dd"
                                            }
                                        );
                                    }),
                                    "buttons":
                                    [
                                        {
                                            "label": "Cancel",
                                            "cssClass": "btn-danger",
                                            "action": ((d) =>
                                            {
                                                d.close();
                                            })
                                        },
                                        {
                                            "label": "Save",
                                            "cssClass": "btn-primary",
                                            "action": ((d) =>
                                            {

                                                let curr_json = localStorage.getItem("followup_data");
                                                if(curr_json === null || curr_json === undefined)
                                                {
                                                    curr_json = "[]";
                                                }
                                                let decoded = JSON.parse(curr_json);
                                                decoded.push({"name": appointment.name, "identifier": appointment.identifier, "date": $("#fu_item").first().val()});
                                                let encoded = JSON.stringify(decoded);

                                                localStorage.setItem("followup_data", encoded);
                                                $("#reschedule_" + appointment.identifier).next().remove();
                                                $("#reschedule_" + appointment.identifier).next().remove();
                                                if($("#reschedule_" + appointment.identifier).next().hasClass("proposal_form_row"))
                                                {
                                                    $("#reschedule_" + appointment.identifier).remove();
                                                } 
                                                $("#reschedule_" + appointment.identifier).remove();
                                                d.close();
                                            })
                                        }
                                    ]
                                }
                            );                            
                        })
                    )
                    .appendTo(reschedule_div);                    


                    let decoded_customers = localStorage.getItem("followup_data");
                    if(decoded_customers !== null && decoded_customers !== undefined)
                    {
                        let b = JSON.parse(decoded_customers);
                        let ids = b.map((item) => item.identifier);
                        if(ids.indexOf(appointment.identifier) > -1)
                        {
                            return;
                        }
                    }

                    $.each([reschedule_div, dt_div, name_div], function(k, div)
                    {
                        div.appendTo(inner_row);
                    });

                    if(i !== appointments.length - 1)
                    {
                        $("<div></div>").addClass("sp2_divider").appendTo(inner_row);
                    }

                });

                inner_row.appendTo(list_row);

                if(view_option === "calendar")
                {
                    list_row.css("display", "none");
                }

                list_row.appendTo(app_area);

                var cal_back = $("<div></div>").addClass("cal_back")
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                )
                .append
                (
                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-list-alt").attr("title", "List View").click(function()
                    {
                        $.cookie("sp2_view_option", "list");
                        $.cookie("button_to_click", "sp_schedule_icon");
                        window.location.reload();
                    })
                )
                .append
                (
                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-calendar").attr("title", "Calendar View").click(function()
                    {
                        $.cookie("sp2_view_option", "calendar");
                        $.cookie("button_to_click", "sp_schedule_icon");
                        window.location.reload();
                    })
                );

                if(view_option === "calendar")
                {
                    cal_back.find(".glyphicon-calendar").css("display", "none");
                    $("#f_cal").fullCalendar
                    (
                        {
                            "contentHeight": "auto",
                            "defaultDate": moment(new Date()).format("YYYY-MM-DD"),
                            "defaultView": "agendaWeek",
                            "editable": false,
                            "eventLimit": true, // allow "more" link when too many events
                            "events": events,
                            "minTime": "08:00:00",
                            "maxTime": "22:00:00",
                            eventClick: function(event)
                            {
                                rescheduleSP2(event);
                            }

                        }
                    );
                }
                else
                {
                    cal_back.find(".glyphicon-list-alt").css("display", "none");
                }
                cal_back.prependTo(app_area);
            }
            function getDataLoggerInfo(identifier)
            {
                $.post("/data", {"fn": "get_data_logger_info", "identifier": identifier}).done(function(r)
                {
                    var html = $("<div></div>");
                    if(r.data_exists === false)
                    {
                        $("<p></p>").text("Data is not available.").appendTo(html);
                    }
                    else
                    {
                        if(r.data.logging === false)
                        {
                            $("<p></p>").text("The rep did not place a logger.").appendTo(html);
                        }   
                        else
                        {
                            if(r.data.started)
                            {
                                $("<p></p>").text("The rep started logging.").appendTo(html);    
                            }
                            else
                            {
                                $("<p></p>").text("The rep did not start logging.").appendTo(html);
                            }
                            $("<p></p>").text("Location: " + r.data.location).appendTo(html);
                        }
                    }

                    BootstrapDialog.show
                    (
                        {
                            "title": "Data Logger Info",
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "OK",
                                    "cssClass": "btn-primary",
                                    "action": function(d)
                                    {
                                        d.close();
                                    }
                                }
                            ]
                        }
                    )
                });
            }
            function restoreOlderCustomer(results, result, reload_schedule, cb)
            {
                if(typeof(reload_schedule) + '' === "undefined")
                {
                    reload_schedule = true;
                }
                if(typeof(cb) + '' === "undefined")
                {
                    cb = function(){};
                }
                if(typeof(results) + '' === "undefined")
                {
                    BootstrapDialog.show
                    (
                            {
                                "title": "Search for the customer...",
                                "message": "<br />" + $("<div></div>").append($("<input />").attr("type", "text").attr("placeholder", "Search for customer by first and/or last name...").attr("id", "restore_cust_search")).html() + "<br />",
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(dialog)
                                        {
                                            dialog.close();
                                        }
                                    },
                                    {
                                        "label": "Search",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            if($.trim($("#restore_cust_search").val()) !== "")
                                            {
                                                $.post("./data", {"fn": "rep_reschedule_customer_search_by_name", "query": $.trim($("#restore_cust_search").val())}).done(function(r)
                                                {
                                                    if(r.results.length > 0)
                                                    {
                                                        d.close();
                                                        restoreOlderCustomer(r.results, undefined, reload_schedule, cb);
                                                    }
                                                    else
                                                    {
                                                        window.alert("No customers matched that query. (HINT: Archived, and 'save me' customers are not included in results).");
                                                    }
                                                });
                                            }
                                            else
                                            {
                                                window.alert("You must provide a search query.");
                                            }
                                        }
                                    }
                                ]
                            }
                    );
                    return;
                }
                if(typeof(result) + '' === "undefined")
                {
                    var html = $("<div><h2>Results:</h2><hr /></div>");
                    $.each(results, function(i, res)
                    {
                        $("<p></p>").addClass("reschedge_result").text(res.name).appendTo(html);
                    });
                    BootstrapDialog.show
                    (
                        {
                            "title": "Search Results...",
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "Cancel",
                                    "cssClass": "btn-danger",
                                    "action": function(d)
                                    {
                                        d.close();
                                    }
                                }
                            ],
                            "onshown": function(d)
                            {
                                $(".reschedge_result").each(function(i, e)
                                {
                                    $(e).click(function()
                                    {
                                        d.close();
                                        restoreOlderCustomer(results, results[i], reload_schedule, cb);
                                    });
                                });
                            }
                        }
                    );
                    return;
                }

                var html = $("<div></div>");
                html.append
                (
                    $("<p></p>").text("Rescheduling SP2 appointment for " + result.name + "...")
                );
                $("<hr />").appendTo(html);
                html.append
                (
                    $("<div></div>")
                    .attr("id", "dtwhyumwhy")
                    .addClass("input-append")
                    .addClass("date")
                    .attr("data-date", "12-02-2012")
                    .attr("data-date-format", "dd-mm-yyyy")
                    .append
                    (
                        $("<input />")
                        .addClass("span2")
                        .addClass("eightpoint5")
                        .attr("size", "16")
                        .attr("type", "text")
                        .attr("value", "12-02-2012")
                        .attr("id", "reschedge_date_input")
                    )
                    .append
                    (
                        $("<span></span>")
                        .addClass("add-on")
                        .append
                        (
                            $("<i></i>")
                            .addClass("icon-th")
                        )
                    )
                );

                $("<select name='sp2_hours' id='sp2_hours' style='margin-right: 1em;''><option value='N/A'>Select One</option></select><select name='sp2_mins' style='margin-right: 1em;' id='sp2_mins'><option value='N/A'>Select One</option></select><select name='sp2_ampm' id='sp2_ampm'><option value='AM'>AM</option><option value='PM'>PM</option></select>").appendTo(html);

                BootstrapDialog.show
                (
                        {
                            "title": "Set the date and time...",
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "Cancel",
                                    "cssClass": "btn-danger",
                                    "action": function(d)
                                    {
                                        d.close();
                                    }
                                },
                                {
                                    "label": "Confirm",
                                    "cssClass": "btn-primary",
                                    "action": function(d)
                                    {
                                        if($.trim($("#sp2_hours").val()).toLowerCase() === "n/a")
                                        {
                                            window.alert("You must choose a complete time for the SP2 date");
                                            return false;
                                        }
                                        if($.trim($("#sp2_mins").val()).toLowerCase() === "n/a")
                                        {
                                            window.alert("You must choose a complete time for the SP2 date");
                                            return false;
                                        }
                                        $(".bootstrap-dialog-footer").find(".btn-primary").css("opacity", "0.5");



                                        var add_twelve = ($("#sp2_ampm").val().toUpperCase() === "PM") && ($("#sp2_hours").val() !== "12");
                                        var is_pm = ($("#sp2_ampm").val().toUpperCase() === "PM");
                                        var mmm = parseInt($("#sp2_mins").val());
                                        var hhh = parseInt($("#sp2_hours").val());

                                        var is_after = is_pm && (hhh > 9 && hhh < 12);
                                        is_after = (is_after || !is_after && (hhh === 9  && mmm !== 0 && is_pm));

                                        var is_before = !is_pm && (hhh < 8 || hhh === 12);

                                        if(is_pm && hhh !== 12)
                                        {
                                            hhh += 12;
                                        }

                                        if(is_after)
                                        {
                                            window.alert("The SP2 time chosen was too late.\n\nValid times are from 8:00 A.M. - 9:00 P.M.");
                                            $(".bootstrap-dialog-footer").find(".btn-primary").css("opacity", "1.0");
                                            return;
                                        }
                                        if(is_before)
                                        {
                                            window.alert("The SP2 time chosen was too early.\n\nValid times are from 8:00 A.M. - 9:00 P.M.");
                                            $(".bootstrap-dialog-footer").find(".btn-primary").css("opacity", "1.0");
                                            return;
                                        }

                                        var spee2_hours = $("#sp2_hours").val();
                                        var spee2_mins = $("#sp2_mins").val();
                                        var spee2_ampm = $("#sp2_ampm").val();
                                        var sp2_dayte = $("#reschedge_date_input").val();

                                        var exit = false;
                                        $.ajax
                                        (
                                            "/data",
                                            {
                                                "async": true,
                                                "dataType": "json",
                                                "data":
                                                {
                                                    "fn": "sp2_booking_doublecheck",
                                                    "sp2_date": $("#reschedge_date_input").val(),
                                                    "sp2_hours": $("#sp2_hours").val(),
                                                    "sp2_mins": $("#sp2_mins").val(),
                                                    "pm": ((($("#sp2_ampm").val() === "PM") * 1) + '')
                                                },
                                                "complete": function(data2)
                                                {
                                                    var data2 = data2.responseJSON;
                                                    if((typeof(data2) + '').toLowerCase() === "object")
                                                    {
                                                        if(data2.double_booked === true)
                                                        {
                                                            exit = true;
                                                        }
                                                        if(exit)
                                                        {
                                                            window.alert("You have already reserved the chosen SP2 date/time with another customer");
                                                            $(".bootstrap-dialog-footer").find(".btn-primary").css("opacity", "1.0");
                                                            return;
                                                        }

                                                        // sam's lameness
                                                        var dialogRef = d;
                                                        $.post("./data", {"fn": "rep_sp2_reschedule_inhouse", "sp2_date": sp2_dayte, "sp2_hour": spee2_hours, "sp2_minute": spee2_mins, "sp2_ampm": spee2_ampm, "identifier": result.identifier, "skip_email": "1"}).done(function(resp)
                                                        {
                                                            dialogRef.close();
                                                            if(reload_schedule)
                                                            {
                                                                clearApp(function(dialogRef)
                                                                {
                                                                    showSP2Schedule(dialogRef);
                                                                });
                                                            }
                                                            cb();                                            
                                                        });
                                                    }
                                                }
                                            }
                                        );
                                    }
                                }
                            ],
                            "onshown": function(d)
                            {
                                $("#reschedge_date_input").val(moment().format("MM-DD-YYYY"));
                                $("#reschedge_date_input").datepicker({
                                    format: "mm-dd-yyyy",
                                    autoClose: true
                                });
                                generateTimesInSelectMenus();
                            }
                        }
                );
            }
            function getSP2Survey(booking_identifier)
            {

            }
            function checkSP2trigger()
            {
                var SP2FollowUp = function(followups)
                {
                    var app_area = $("<div></div>");
                    var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1").html("&nbsp;");
                    var row = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                    var labels_div = $("<div></div>").addClass("followup_labels");

                    $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4")
                    .append(
                        $("<span></span>").addClass("label").addClass("label-warning").text("Customer").addClass("lbl1")
                    ).appendTo(labels_div);
                    $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4")
                    .append(
                        $("<span></span>").addClass("label").addClass("label-warning").text("SP2 Date").addClass("lbl2")
                    ).appendTo(labels_div);
                    $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4")
                    .append(
                        $("<span></span>").addClass("label").addClass("label-warning").text("Actions").addClass("lbl5")
                    ).appendTo(labels_div);

                    var followup_list = $("<div></div>").addClass("followup_list");
                    var follow_up_container = $("<div></div>").addClass("followup_container");
                    followup_list.appendTo(row);
                    spacer.appendTo(app_area);
                    row.appendTo(app_area);

                    $.each(followups, function(i, followup)
                    {

                        var survey_container = $("<div></div>").addClass(followup.booking_identifier).addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").addClass("survey_container");
                        var survey_btn = $("<button></button>").attr("title", "Take Survey").html("Complete").addClass("follow_up_btn").attr("name", followup.booking_identifier).attr("id", followup.booking_identifier).addClass("btn").addClass("btn-info").addClass("btn-sm").click(function()
                        {
                            window.booking_info = undefined;
                            window.survey_info = undefined;

                            $(".survey_container").empty().hide();
                            initSP2FollowUp(followup.booking_identifier, "{{ survey_identifier }}");
                        });
                        var followup_row = $("<div></div>").addClass("followup_row");
                        followup_row.append(
                            $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4").text(followup.cust_name)
                        ).append(
                            $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4").text(followup.sp2_date)
                        ).append(
                            $("<div></div>").addClass("col-xs-4").addClass("col-sm-4").addClass("col-md-4").addClass("col-lg-4").append(survey_btn)
                       ).append(survey_container).appendTo(follow_up_container);

                    });

                    labels_div.appendTo(followup_list);
                    follow_up_container.appendTo(followup_list);

                    BootstrapDialog.show
                    (
                        {
                            title: "Follow-up Required",
                            type: BootstrapDialog.TYPE_WARNING,
                            closable: true,
                            closeByBackdrop: false,
                            closeByKeyboard: false,
                            message: app_area,
                            buttons:
                            [
                                {
                                    label: "Dismiss",
                                    action: function(dialogRef)
                                    {
                                        dialogRef.close();
                                    }
                                }
                            ]
                        }
                    )

                }
                /*$.post("./data", {"fn": "rep_sp2_trigger_after"}).done(function(resp)
                {
                    if(resp.success)
                    {
                        var cpy = [];
                        $.each(resp.items, function(i, item)
                        {
                            if(item !== null)
                            {
                                cpy.push(item);
                            }
                        });
                        if(cpy.length > 0)
                        {
                            SP2FollowUp(cpy);
                        }
                    }
                });*/
            }
            function hint_at_users(p_el, hint_dictionary)
            {
                var rem = function()
                {
                    $(".hinted_user").remove();
                };
                var hint_at_yousers = function(p_el, hint_dictionary)
                {
                    var possible_match = $.trim(p_el.text()).toLowerCase();
                    if(typeof(hint_dictionary[possible_match]) + '' !== "undefined")
                    {
                        $.each(hint_dictionary[possible_match], function(i, match)
                        {
                            if(i > 4)
                            {
                                return;
                            }
                            var hinted_user_div = $("<div></div>").addClass("hinted_user").attr("id", "compose_to_" + match.identifier);
                            $("<img />").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + match.identifier + ".jpg")
                            .addClass("img")
                            .addClass("img-responsive")
                            .appendTo(hinted_user_div);

                            hinted_user_div.click(function()
                            {
                                var img = $(this).find("img");
                                img.attr("id", "recipient_of_" + $(this).attr("id").replace("compose_to_", "")).appendTo($(".recipients_div"));
                                img.attr("title", $(this).find("p").text());
                                rem();
                                $(".hinted_users").css("display", "none");

                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove").click(function()
                                {
                                    var prev_count = $(this).prevAll("span").size();
                                    $(".recipients_div").find("img").eq(prev_count).remove();
                                    $(this).remove();
                                }).appendTo($(".remove_recipients"));

                                $(".to_box").text("");
                                $(".recipients_div").eq(0)[0].scrollIntoView();
                            });

                            $("<p></p>").text(match.name).appendTo(hinted_user_div);

                            if($("#compose_to_" + match.identifier).size() + $("#recipient_of_" + match.identifier).size() === 0)
                            {
                                hinted_user_div.appendTo($(".hinted_users"));
                            }
                        });
                    }
                };
                if($(".hinted_user").size() > 0)
                {
                    $(".hinted_user").animate({opacity: 0.0}, 200, function()
                    {
                        rem();
                        hint_at_yousers(p_el, hint_dictionary);
                    });
                }
                else
                {
                    hint_at_yousers(p_el, hint_dictionary);
                }

                if($(".hinted_user").size() === 0)
                {
                    $(".hinted_users").css("display", "none");
                }
                else
                {
                    $(".hinted_users").css("display", "table");
                }
            }
            function composeMessage()
            {
                $(".inbox_inner_row").animate({"height": "0px"}, 350, function()
                {
                    $(".compose_row").removeAttr("style").css("display", "block");
                });
            }
            function loadInbox(contacts, offset, thread_data)
            {
                hideIconGrid();
                if(typeof(contacts) + '' === "undefined" && typeof(offset) + '' === "undefined" && typeof(thread_data) + '' === "undefined")
                {
                    $("<h2></h2>").addClass("tmp_h2").text("Loading inbox...").appendTo($("#app_area"));
                }
                if(typeof(contacts) + '' === "undefined")
                {
                    $.post("./data", {"fn": "list_all_users"}).done(function(resp)
                    {
                        loadInbox(resp.contacts);
                    });
                    return;
                }
                if(typeof(offset) + '' === "undefined")
                {
                    offset = 0;
                }

                if(typeof(thread_data) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_threads_for_user", "offset": (offset + '')}).done(function(resp)
                    {
                        loadInbox(contacts, offset, resp.threads);
                    });
                    return;
                }

                $(".msg_file").remove();
                $(".tmp_h2").remove();

                // build the contacts dictionary and the identifier => name map
                var hint_dictionary = {};
                var ident_name_map = {};

                // do the first name hints
                $.each(contacts, function(i, contact)
                {
                    ident_name_map[contact.identifier] = contact.name;

                    var fname = contact.first_name.toLowerCase();
                    for(var k = 0; k < fname.length; k++)
                    {
                        var hint = fname.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }

                    var lname = contact.last_name.toLowerCase();
                    for(var k = 0; k < lname.length; k++)
                    {
                        var hint = lname.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }

                    var name = contact.name.toLowerCase();
                    for(var k = 0; k < name.length; k++)
                    {
                        var hint = name.substring(0, k + 1);
                        if(typeof(hint_dictionary[hint]) + '' === "undefined")
                        {
                            hint_dictionary[hint] = [];
                        }
                        hint_dictionary[hint].push
                        (
                            {
                                "name": contact.name,
                                "identifier": contact.identifier
                            }
                        );
                    }
                });

                var app_area = $("#app_area");
                var inbox_spacer = $("<div></div>").addClass("col-xs-0").addClass("col-sm-0").addClass("col-md-1").addClass("col-lg-1");
                var inbox_row = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-10").addClass("col-lg-10").css("margin-bottom", "1em").addClass("inboxrow");
                var compose_row = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").addClass("compose_row");
                var inner_compose_row = $("<div></div>");
                var recipients_div = $("<div></div>").addClass("recipients_div");
                var remove_recipients_div = $("<div></div>").addClass("remove_recipients");

                recipients_div.appendTo(inner_compose_row);
                remove_recipients_div.appendTo(inner_compose_row);

                var to_box = $("<p></p>").text("Enter someone's name...").attr("contenteditable", "true").addClass("to_box");

                to_box
                .focus(function()
                {
                    if($(this).text() === "Enter someone's name...")
                    {
                        $(this).text("");
                    }
                })
                .blur(function()
                {
                    if($.trim($(this).text()) === "")
                    {
                        $(this).text("Enter someone's name...");
                    }
                })
                .on("keyup", function()
                {
                    if($.trim($(this).text()).length > 0)
                    {
                        hint_at_users($(this), hint_dictionary);
                    }
                }).appendTo(inner_compose_row);

                inner_compose_row.appendTo(compose_row);

                var hinted_users_div = $("<div></div>").addClass("hinted_users");
                $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove").on("click", function()
                {
                    $(".hinted_users").css("display", "none");
                    $(".hinted_user").remove();
                    $(".to_box").text("").trigger("keyup");
                }).appendTo(hinted_users_div);

                hinted_users_div.appendTo(inner_compose_row);
                $("<textarea></textarea>").attr("placeholder", "Your message...").appendTo(inner_compose_row);

                $("<button></button>")
                .addClass("btn")
                .addClass("btn-primary")
                .text(" Attach file")
                .prepend
                (
                    $("<span></span>")
                    .addClass("glyphicon")
                    .addClass("glyphicon-paperclip")
                )
                .click(function()
                {
                    var idx = $(".msg_file").size() + '';
                    $("<input />")
                    .attr("type", "file")
                    .addClass("msg_file")
                    .attr("id", "msg_file_" + idx)
                    .css("display", "none")
                    .on("change", function()
                    {
                        var val = $(this).val();
                        while(val.indexOf("/") > -1)
                        {
                            val = val.replace("/", "\\");
                        }
                        paths = val.split("\\");

                        var filename = "File #" + ((parseInt(idx) + 1) + '');
                        try
                        {
                            filename = paths[paths.length - 1];
                        }
                        catch(eeeeeeee)
                        {
                        }

                        $("<p></p>")
                        .text(" " + filename)
                        .prepend
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-paperclip")
                        )
                        .appendTo(".msg_file_list");
                    }).appendTo($("body"));
                    $("#msg_file_" + idx).trigger("click");
                }).appendTo(inner_compose_row);

                $("<button></button>")
                .addClass("btn")
                .addClass("btn-success")
                .text(" Send")
                .prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-send"))
                .click(function()
                {
                    sendNPMessage(undefined, thread_data);
                }).appendTo(inner_compose_row);

                $("<button></button>")
                .addClass("btn")
                .addClass("btn-danger")
                .html("&larr; Back")
                .click(function()
                {
                    $(".recipients_div").empty();
                    $(".msg_file_list").empty();
                    $(".remove_recipients").empty();
                    $(".msg_file").remove();
                    $(".compose_row").find(".btn-success").text(" Send").prepend($("<span></span>").addClass("glyphicon").addClass("glyphicon-send"));
                    $(".compose_row").animate({"height": "0px"}, 300, function()
                    {
                        $(".inbox_inner_row").removeAttr("style");
                    });
                }).appendTo(inner_compose_row);

                $("<div></div>").addClass("msg_file_list").appendTo(inner_compose_row)

                var inbox_spacer2 = inbox_spacer.clone();

                var title = $("<h2></h2>");
                title.addClass("clist_title").text("Inbox").prepend($("<span></span>").html("&nbsp;").addClass("glyphicon glyphicon-envelope"))
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-danger").addClass("btn-messaging-back").text("Back")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });                        
                    })
                )
                .appendTo(inbox_row);
                $("<hr/>").appendTo(inbox_row);

                var inner_row = $("<div></div>").addClass("row").addClass("inbox_inner_row");

                $("<span></span>").addClass("glyphicon").addClass("glyphicon-pencil").attr("title", "Compose New Message").click(function()
                {
                    composeMessage();
                }).appendTo(inbox_row);
                compose_row.appendTo(inbox_row);

                $.each(thread_data, function(i, thread)
                {
                    thread.messages.reverse()
                    var thread_div = $("<div></div>").addClass("thread").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12");
                    var inner_thread_div = $("<div></div>").addClass("row").addClass("inbox_thread_item");
                    inner_thread_div.attr("id", "thread_" + thread.identifier);
                    inner_thread_div.click(function()
                    {
                        loadConversationInline(thread, thread_data, contacts);
                    });
                    var first_message = thread.messages[0];
                    var words = first_message.content.split(" ");
                    synopsis = "";
                    try
                    {
                        for(var k = 0; (k < 10 && k < words.length); k++)
                        {
                            synopsis += words[k] + " ";
                        }
                    }
                    catch(e)
                    {
                    }

                    var user_pic_div = $("<div></div>").addClass("col-xs-2").addClass("col-sm-2").addClass("col-md-1").addClass("col-lg-1");
                    if(window.user_identifier === first_message.sender_identifier)
                    {
                        user_pic_div.attr("title", "You");
                    }
                    else
                    {
                        user_pic_div.attr("title", ident_name_map[first_message.sender_identifier]);
                    }
                    $("<img />").addClass("img").addClass("img-responsive").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + first_message.sender_identifier + ".jpg").addClass("inbox_profile_thumb").appendTo(user_pic_div);

                    var msg_div = $("<div></div>").addClass("col-xs-6").addClass("col-sm-6").addClass("col-md-7").addClass("col-lg-7").addClass("thread_synopsis");
                    msg_div.text($.trim(synopsis + "..."));

                    var date_div = $("<div></div>").addClass("col-xs-2").addClass("col-sm-2").addClass("xol-md-2").addClass("col-lg-2").addClass("thread_date");


                    var dayte = new Date(1970, 0, 1);
                    dayte = moment(dayte);
                    dayte.utc();
                    dayte.add(first_message.send_time, "milliseconds");
                    dayte.local();
                    var dayte2 = new Date();
                    var mins = dayte2.getTimezoneOffset();
                    dayte.subtract(mins, "minutes");

                    date_div.append
                    (
                        $("<p></p>").addClass("thread_date").text(dayte.format("MMM DD, hA"))
                    );

                    var icons_div = $("<div></div>").addClass("row").addClass("msg_icons");
                    var exclam_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-6").addClass("col-lg-6");
                    var attach_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-6").addClass("col-lg-6");

                    var exclam = $("<span></span>").addClass("glyphicon").addClass("glyphicon-exclamation-sign").attr("title", "Message is unread");
                    if(first_message.read_by_recipient || first_message.recipient_identifier !== window.user_identifier)
                    {
                        exclam.css("visibility", "hidden");
                    }
                    else
                    {
                        inner_thread_div.addClass("unread_thread_item");
                    }
                    exclam.appendTo(exclam_div);

                    var attach = $("<span></span>").addClass("glyphicon").addClass("glyphicon-paperclip").attr("title", "Most recent message includes attachments");
                    if(first_message.blob_count === 0)
                    {
                        attach.css("visibility", "hidden");
                    }
                    attach.appendTo(attach_div);

                    exclam_div.appendTo(icons_div);
                    attach_div.appendTo(icons_div);

                    $.each([user_pic_div, msg_div, date_div, icons_div], function(k, div)
                    {
                        div.appendTo(inner_thread_div);
                    });
                    inner_thread_div.appendTo(thread_div);

                    thread_div.appendTo(inner_row);
                });
                inner_row.appendTo(inbox_row);
                inbox_spacer.appendTo(app_area);
                inbox_row.appendTo(app_area);
                inbox_spacer2.appendTo(app_area);
            }
            function loadConversationInline(thread, thread_data, contacts)
            {
                $(".msg_row").remove();
                $(".msg_file").remove();

                identifier_name_map = {};
                $.each(contacts, function(i, contact)
                {
                    identifier_name_map[contact.identifier] = contact.name;
                });

                var first_message = thread.messages[0];
                if(!first_message.read_by_recipient && first_message.recipient_identifier === window.user_identifier)
                {
                    $.post("./data", {"fn": "read_message", "identifier": first_message.identifier, "thread_identifier": thread.identifier}).done(function(resp)
                    {
                        thread.messages[0].read_by_recipient = true;
                        $("#thread_" + thread.identifier).removeClass("unread_thread_item");
                        loadConversationInline(thread, thread_data, contacts);
                    });
                    return;
                }

                var messages_row = $("<div></div>").addClass("msg_row");
                var reply_to_identifier = "-1"
                if(window.user_identifier === thread.original_sender_identifier)
                {
                    reply_to_identifier = thread.original_recipient_identifier;
                }
                else
                {
                    reply_to_identifier = thread.original_sender_identifier;
                }
                messages_row.addClass("reply_to_" + reply_to_identifier);

                var inner_messages_row = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12");
                $.each(JSON.parse(JSON.stringify(thread.messages)).reverse(), function(i, message)
                {
                    var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");

                    var msg_pic_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1").addClass("msg_pic_div");
                    if(message.sender_identifier === window.user_identifier)
                    {
                        msg_pic_div.attr("title", "You");
                    }
                    else
                    {
                        msg_pic_div.attr("title", identifier_name_map[message.sender_identifier]);
                    }
                    msg_pic_div.append
                    (
                        $("<img />")
                        .addClass("img")
                        .addClass("img-responsive")
                        .attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + message.sender_identifier + ".jpg")
                    );

                    var dayte = new Date(1970, 0, 1);
                    dayte = moment(dayte);
                    dayte.utc();
                    dayte.add(message.send_time, "milliseconds");
                    dayte.local();
                    var dayte2 = new Date();
                    var mins = dayte2.getTimezoneOffset();
                    dayte.subtract(mins, "minutes");
                    var content_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-md-10").addClass("msg_content");
                    content_div.append
                    (
                        $("<pre></pre>").html(identifier_name_map[message.sender_identifier] + " &#8658; " + dayte.format("MMM DD, hA") + ":   &#8665;\n\n" + message.content)
                    );
                    if(message.blob_count > 0)
                    {
                        $("<hr />").appendTo(content_div);
                        $("<p></p>").text("Attachments:").appendTo(content_div);
                        for(var k = 0; k < message.blob_count; k++)
                        {
                            var file_name = message.blob_names[k];
                            var file_parts = file_name.split(".");
                            var extension = file_parts[file_parts.length - 1];

                            $("<p></p>").addClass("msg_attachment")
                            .append
                            (
                                $("<a></a>")
                                .attr("download", message.blob_names[k])
                                .attr("target", "_blank")
                                .text(" " + file_name)
                                .attr("href", "//storage.googleapis.com/" + window.app_bucket + "/MessageBlobs/" + message.identifier + "_" + (k + '') + "." + extension)
                            )
                            .prepend
                            (
                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-paperclip")
                            )
                            .appendTo(content_div);
                        }
                        $("<hr />").appendTo(content_div);
                    }

                    if(i === thread.messages.length - 1)
                    {
                        $("<textarea></textarea>").addClass("inline_content_box").attr("placeholder", "Your reply...").appendTo(content_div);

                        $("<button></button>")
                        .addClass("btn")
                        .addClass("btn-primary")
                        .text(" Attach file")
                        .prepend
                        (
                            $("<span></span>")
                            .addClass("glyphicon")
                            .addClass("glyphicon-paperclip")
                        )
                        .click(function()
                        {
                            var idx = $(".msg_file").size() + '';

                            $("<input />")
                            .attr("type", "file")
                            .addClass("msg_file")
                            .attr("id", "msg_file_" + idx)
                            .css("display", "none")
                            .on("change", function()
                            {
                                var val = $(this).val();
                                while(val.indexOf("/") > -1)
                                {
                                    val = val.replace("/", "\\");
                                }
                                paths = val.split("\\");

                                var filename = "File #" + ((parseInt(idx) + 1) + '');
                                try
                                {
                                    filename = paths[paths.length - 1];
                                }
                                catch(eeeeeeee)
                                {
                                }

                                $("<p></p>")
                                .text(" " + filename)
                                .prepend
                                (
                                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-paperclip")
                                )
                                .appendTo(".inline_msg_file_list");
                            }).appendTo($("body"));

                            $("#msg_file_" + idx).trigger("click");
                        }).appendTo(content_div);

                        $("<button></button>")
                        .addClass("btn")
                        .addClass("btn-success")
                        .text(" Reply")
                        .prepend
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-share-alt")
                        )
                        .click(function()
                        {
                            sendNPMessage(thread.identifier, thread_data);
                        }).appendTo(content_div);

                        $("<button></button>")
                        .addClass("btn")
                        .addClass("btn-danger")
                        .html("&larr; Back")
                        .click(function()
                        {
                            $(".msg_row").remove();
                            $(".msg_file").remove();
                        }).appendTo(content_div);

                        $("<div></div>").addClass("inline_msg_file_list").appendTo(content_div);
                    }

                    var inner_inner = $("<div></div>").addClass("row");
                    if(window.user_identifier === message.original_sender_identifier)
                    {
                        msg_pic_div.appendTo(inner_inner);
                        content_div.appendTo(inner_inner);
                        spacer.appendTo(inner_inner);
                    }
                    else
                    {
                        spacer.appendTo(inner_inner);
                        msg_pic_div.appendTo(inner_inner);
                        content_div.appendTo(inner_inner);
                    }
                    inner_inner.appendTo(inner_messages_row);
                });
                inner_messages_row.appendTo(messages_row);
                messages_row.insertAfter($("#thread_" + thread.identifier));
            }
            function sendNPMessage(identifier, thread_data)
            {
                if
                (
                    (
                        $(".compose_row").find("textarea").size() > 0               &&
                        $.trim($(".compose_row").find("textarea").val()).length < 1 &&
                        $(".msg_content").size() === 0
                    )

                    ||

                    (
                        $(".msg_content").find("textarea").size() > 0            &&
                        $.trim($(".msg_content").find("textarea").val()).length < 1
                    )

                )
                {
                    window.alert("The message cannot be empty!");
                    return;
                }

                var new_thread = false;
                if(typeof(identifier) + '' === "undefined")
                {
                    identifier = "-1"
                    new_thread = true;
                }

                var new_message = (identifier === "-1")

                var pre_completion_fn = function()
                {
                    if(new_message)
                    {
                        $(".compose_row").find(".btn-success").text("Sending...");
                    }
                    else
                    {
                        $(".msg_content").find(".btn-success").text("Sending...");
                    }
                };

                var post_completion_fn = function(resp)
                {
                    if(new_message)
                    {
                        $("#inbox").trigger("click");
                    }
                    else
                    {
                        var cont = true;
                        var thing_to_step_through = thread_data;
                        if(typeof(thread_data["threads"]) + '' !== "undefined")
                        {
                            thing_to_step_through = thread_data.threads;
                        }
                        $.each(thing_to_step_through, function(i, thread)
                        {
                            if(!cont)
                            {
                                return;
                            }
                            if(thread.identifier === identifier)
                            {
                                thread.messages.unshift(resp.threads[0].messages[resp.threads[0].messages.length - 1]);
                                cont = false;
                            }
                        });
                        $(".msg_content").find(".btn-danger").trigger("click");
                        $("#thread_" + identifier).trigger("click");
                    }
                };

                var textarea_parent = $(".compose_row");
                var textarea_parent_class = "compose_row";
                var recipients = [];
                if(new_thread)
                {
                    $(".recipients_div").find("img").each(function(i, e)
                    {
                        recipients.push
                        (
                            $(e).attr("id").replace("recipient_of_", "")
                        );
                    });
                }
                else
                {
                    textarea_parent = $(".msg_row");
                    textarea_parent_class = "msg_row";
                    recipients.push($.trim($(".msg_row").attr("class").replace("msg_row", "").replace("reply_to_", "")));
                }

                if(recipients.length + $(".msg_content").size() === 0)
                {
                    window.alert("You must choose at least one recipient");
                    return;
                }

                if($(".msg_file").size() === 0)
                {
                    pre_completion_fn();
                    $.post("./data", {"fn": "send_message", "identifier": identifier, "has_files": "0", "file_count": "0", "txt": $.trim(textarea_parent.find("textarea").eq(0).val()), "recipients": JSON.stringify(recipients)}).done(function(resp)
                    {
                        post_completion_fn(resp);
                    });
                }
                else
                {
                    var formData = new FormData();

                    formData.append("fn", "send_message");
                    formData.append("identifier", identifier);
                    formData.append("has_files", "1");
                    formData.append("txt", $.trim(textarea_parent.find("textarea").eq(0).val()));
                    formData.append("recipients", JSON.stringify(recipients));
                    formData.append("file_count", ($(".msg_file").size() + ''));

                    $(".msg_file").each(function(i, e)
                    {
                        formData.append($(e).attr("id"), $(e)[0].files[0]);
                    });

                    var xhr = new XMLHttpRequest();
                    (xhr.upload || xhr).addEventListener("progress", function(e)
                    {
                        var done = e.position || e.loaded
                        var total = e.totalSize || e.total;
                        var completion_percentage = (Math.round(done/total*100) + '') + "%";
                        $("." + textarea_parent_class + " .glyphicon-success").html("&nbsp;&nbsp;&nbsp;&nbsp;" + completion_percentage);

                    });
                    xhr.addEventListener("load", function(e)
                    {
                        post_completion_fn($.parseJSON(e.target.responseText));
                    });
                    xhr.open("POST", "./data");
                    xhr.send(formData);
                }
            }
            function sortLeaderBoard()
            {
                $(".lb_tally_total").remove();
            	var size = 0;
            	$("span.pl_cnt").each(function(i, e)
            	{
            		size += parseInt($(e).text());
            	});
            	size = parseInt(size);
            	size += '';
            	$("<span></span>").addClass("lb_tally_total").text("Tally Total: " + size).insertAfter($(".lb_dds"));
                if($(".pl_cnt").size() < 4)
                {
                    return;
                }

                var done = true;
                var items = $("span.pl_cnt");
                for(var i = 0; i < items.size(); i++)
                {
                    var item_a = $("span.pl_cnt").eq(i);
                    var item_b = null;
                    if($(".pl_cnt").eq(i + 1).size() > 0)
                    {
                        item_b = $("span.pl_cnt").eq(i + 1);
                    }
                    if(item_b !== null)
                    {
                        try
                        {
                            if(parseInt(item_b.text()) > parseInt(item_a.text()))
                            {
                                item_b.parent().parent().insertBefore(item_a.parent().parent());
                                done = false;
                            }
                        }
                        catch(e6)
                        {
                        }
                    }
                }
                if(!done)
                {
                    sortLeaderBoard();
                }
            }
            function showLeaderBoard(achievement_metric, time_metric, format, lb_data, office_filter, team_or_rep_view, child_offices)
            {
                hideIconGrid();
                if(typeof(team_or_rep_view) + '' === "undefined")
                {
                    team_or_rep_view = "reps";
                }
            	if(typeof(office_filter) + '' === "undefined")
            	{
            		office_filter = "-1";
            	}
                if(typeof(achievement_metric) + '' === "undefined")
                {
                    achievement_metric = "leads_acquired";
                }
                if(typeof(time_metric) + '' === "undefined")
                {
                    time_metric = "daily";
                }
                if(typeof(format) + '' === "undefined")
                {
                    format = "plain_list";
                }
                if($(".lb_loading_txt").size() === 0)
                {
                    $("<h2></h2>").addClass("lb_loading_txt").text("Loading...").appendTo($("#app_area"));

                }
                if(typeof(lb_data) + '' === "undefined")
                {
                    $.post("./data", {"fn": "get_leaderboard_data", "achievement_metric": achievement_metric, "time_metric": time_metric, "office": office_filter}).done(function(resp)
                    {
                        showLeaderBoard(achievement_metric, time_metric, format, resp, office_filter, team_or_rep_view, child_offices);
                    });
                    return;
                }
                if(typeof(office_filter) + '' === "undefined")
                {
                	office_filter = "-1";
                }
                if(typeof(child_offices) + '' === "undefined")
                {
                	$.post("./data", {"fn": "enumerate_child_only_offices"}).done(function(resp)
                	{
                		showLeaderBoard(achievement_metric, time_metric, format, lb_data, office_filter, team_or_rep_view, resp.offices);
                	});
                	return;
                }
                $(".lb_loading_txt").remove();

                var app_area = $("#app_area");

                $("<h3></h3>").text(" Leaderboard").prepend
                (
                    $("<span></span>").addClass("lb_trophy").html("&#127942;")
                ).appendTo(app_area);

                $("<hr />").appendTo(app_area);

                metric_map =
                {
                    "leads_acquired": "ABs",/*,
                    "packets_submitted": "CDs"*/
                    "app_stat_clockins": "NP Grid - Clock-Ins",
                    "panels_sold": "Panels Sold"
                };

                time_map =
                {
                    "daily": "Today",
                    "weekly": "This Week",
                    "monthly": "This Month",
                    "quarterly": "This Quarter",
                    "yearly": "This Year",
                    "yesterday": "Yesterday",
                    "last_week": "Last Week",
                    "last_month": "Last Month",
                    "last_quarter": "Last Quarter"/*,
                    "last_year": "Last Year",
                    "all_time": "All Time"*/
                };
                
                var offices_map = {"-1": "All Offices"};
                $.each(child_offices, function(i, child_office)
                {
                	offices_map[child_office.identifier] = child_office.name;
                });

                var dd_div = $("<div></div>").addClass("lb_dds");

                var achievement_dd = $("<div></div>").addClass("dropdown").attr("id", "dropdownAchievement");

                $("<button></button>")
                .attr("type", "button")
                .addClass("btn")
                .addClass("btn-default")
                .addClass("dropdown-toggle")
                .attr("data-toggle", "dropdown")
                .attr("aria-expanded", "true")
                .text(metric_map[achievement_metric] + " ")
                .append
                (
                    $("<span></span>").addClass("caret")
                ).appendTo(achievement_dd);

                var achievement_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labeled-by", "dropdownAchievement");
                $.each(Object.keys(metric_map), function(i, metric)
                {
                    var li = $("<li></li>").attr("role", "presentation").addClass("achievement_opt");
                    li.attr("id", "achievement_option_value_of_" + metric);
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                    a.text(metric_map[metric]);
                    a.appendTo(li);
                    li.appendTo(achievement_ul);
                });

                achievement_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        clearApp(function()
                        {
                            showLeaderBoard($(e).attr("id").replace("achievement_option_value_of_", ""), time_metric, format, undefined, office_filter, team_or_rep_view, child_offices);
                        });
                    });
                });

                achievement_ul.appendTo(achievement_dd);
                achievement_dd.appendTo(dd_div);

                var time_dd = $("<div></div>").addClass("dropdown").attr("id", "dropdownTime");

                $("<button></button>").text(time_map[time_metric] + " ")
                .attr("type", "button")
                .addClass("btn")
                .addClass("btn-default")
                .addClass("dropdown-toggle")
                .attr("data-toggle", "dropdown")
                .attr("aria-expanded", "true")
                .append
                (
                   $("<span></span>").addClass("caret")
                ).appendTo(time_dd);

                var time_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labeled-by", "dropdownTime");
                $.each(Object.keys(time_map), function(i, time)
                {
                    var li = $("<li></li>").attr("role", "presentation").addClass("time_opt");
                    li.attr("id", "time_option_value_of_" + time);
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                    a.text(time_map[time]);
                    a.appendTo(li);
                    li.appendTo(time_ul);
                });

                time_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        clearApp(function()
                        {
                            showLeaderBoard(achievement_metric, $(e).attr("id").replace("time_option_value_of_", ""), format, undefined, office_filter, team_or_rep_view, child_offices);
                        });
                    });
                });

                time_ul.appendTo(time_dd);
                time_dd.appendTo(dd_div);

                var formats_map =
                {
                    "plain_list": "Plain List",
                    "pie_chart": "Pie Chart",
                    "bar_chart": "Bar Chart"
                };

                var format_dd = $("<div></div>").addClass("dropdown").attr("id", "dropdownFormat");

                $("<button></button>").text(formats_map[format] + " ")
                .attr("type", "button")
                .addClass("btn")
                .addClass("btn-default")
                .addClass("dropdown-toggle")
                .attr("data-toggle", "dropdown")
                .attr("aria-expanded", "true")
                .append
                (
                    $("<span></span>").addClass("caret")
                ).appendTo(format_dd);

                var format_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labeled-by", "dropdownFormat");
                $.each(Object.keys(formats_map), function(i, format)
                {
                    var li = $("<li></li>").attr("role", "presentation").addClass("format_opt");
                    li.attr("id", "format_option_value_of_" + format);
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                    a.text(formats_map[format]);
                    a.appendTo(li);

                    if(format === "pie_chart" || format === "bar_chart")
                    {
                        li.css("display", "none");
                    }
                    li.appendTo(format_ul);
                });

                format_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        clearApp(function()
                        {
                            showLeaderBoard(achievement_metric, time_metric, $(e).attr("id").replace("format_option_value_of_", ""), undefined, office_filter, team_or_rep_view, child_offices);
                        });
                    });
                });

                format_ul.appendTo(format_dd);
                format_dd.appendTo(dd_div);
                
                var office_dd = $("<div></div>").addClass("dropdown").attr("id", "dropdownOfficeSelection");
                
                $("<button></button>").text(offices_map[office_filter])
                .attr("type", "button")
                .addClass("btn")
                .addClass("btn-default")
                .addClass("dropdown-toggle")
                .attr("data-toggle", "dropdown")
                .attr("aria-expanded", "true")
                .append
                (
                    $("<span></span>").addClass("caret")
                ).appendTo(office_dd);
                
                var office_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labeled-by", "dropdownOfficeSelection");
                $.each(Object.keys(offices_map), function(i, office)
                {
                    var li = $("<li></li>").attr("role", "presentation").addClass("office_opt");
                    li.attr("id", "office_option_value_of_" + office);
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                    a.text(offices_map[office]);
                    a.appendTo(li);
                    li.appendTo(office_ul);
                });

                office_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        clearApp(function()
                        {
                            showLeaderBoard(achievement_metric, time_metric, format, undefined, $(e).attr("id").replace("office_option_value_of_", ""), team_or_rep_view, child_offices);
                        });
                    });
                });

                office_ul.appendTo(office_dd);
                //office_dd.appendTo(dd_div);


                var team_or_rep_map = 
                {
                    "reps": "Reps",
                    "teams": "Teams"
                };
                var team_or_rep_dd = $("<div></div>").addClass("dropdown").attr("id", "dropdownTeamOrRepSelection");
                
                $("<button></button>").text(team_or_rep_map[team_or_rep_view])
                .attr("type", "button")
                .addClass("btn")
                .addClass("btn-default")
                .addClass("dropdown-toggle")
                .attr("data-toggle", "dropdown")
                .attr("aria-expanded", "true")
                .append
                (
                    $("<span></span>").addClass("caret")
                ).appendTo(team_or_rep_dd);

                var team_or_rep_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").attr("aria-labeled-by", "dropdownOfficeSelection");                

                $.each(Object.keys(team_or_rep_map), function(i, view_option)
                {
                    var li = $("<li></li>").attr("role", "presentation").addClass("team_or_rep_view_opt");
                    li.attr("id", "team_or_rep_view_value_of_" + view_option);
                    var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                    a.text(team_or_rep_map[view_option]);
                    a.appendTo(li);
                    li.appendTo(team_or_rep_ul);
                });

                team_or_rep_ul.find("li").each(function(i, e)
                {
                    $(e).click(function()
                    {
                        clearApp(function()
                        {
                            showLeaderBoard(achievement_metric, time_metric, format, undefined, office_filter, $(e).attr("id").replace("team_or_rep_view_value_of_", ""), child_offices);
                        });
                    });
                });

                team_or_rep_ul.appendTo(team_or_rep_dd);
                team_or_rep_dd.appendTo(dd_div);


                $("<span></span>").text("").addClass("interval_span").appendTo(dd_div);

                var lb_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").addClass("lb_main_div");


                var highlight = function(hex, channel_idx)
                {
                    hex = hex.replace("#", "");
                    var channels =
                    [
                        (hex[0] + hex[1]).toUpperCase(),
                        (hex[2] + hex[3]).toUpperCase(),
                        (hex[4] + hex[5]).toUpperCase()
                    ];

                    var dec = parseInt(channels[channel_idx], 16);
                    dec += 10;
                    if(dec > 255)
                    {
                        dec = 255;
                    }

                    return "#" + channels.join("");
                };

                var render_fns =
                {
                    "plain_list": function(data)
                    {
                        $(".no_usr_lb_msg").remove();
                        lb_div.addClass("lb_plain_list");
                        // determine the highest number of digits
                        digit_cnt = 1;

                        if(team_or_rep_view === "reps")
                        {
                            $.each(data.data, function(i, amount)
                            {
                                var d_cnt = (amount + '').length;
                                if(d_cnt.length > digit_cnt)
                                {
                                    digit_cnt = d_cnt.length;
                                }
                            });
                        }
                        else
                        {
                            $.each(Object.keys(data.office_tallies), function(i, o_identifier)
                            {
                                if(o_identifier.length === 128)
                                {
                                    var d_cnt = (data.office_tallies[o_identifier] + '').length;
                                    if(d_cnt.length > digit_cnt)
                                    {
                                        digit_cnt = d_cnt.length;
                                    }
                                }                                
                            });
                        }
                        

                        var show_nobody_msg = true;

                        if(team_or_rep_view === "reps")
                        {
                            $.each(Object.keys(data.data), function(i, rep_id)
                            {
                                if((data.data[rep_id] * 1) < 1)
                                {
                                    return;
                                }
                                show_nobody_msg = false;

                                var inner_row = $("<div></div>").addClass("row").addClass("lb_user_data_" + data.rep_id_to_identifier[rep_id]).addClass("rendered_lb_plain_list");

                                var user_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12");
                                user_div.append
                                (
                                    $("<img />").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + data.rep_id_to_identifier[rep_id] + ".jpg").addClass("lb_thumb_img").addClass("pl_cnt")
                                );
                                var cnt = data.data[rep_id] + '';
                                while(cnt.length < digit_cnt)
                                {
                                    cnt = "0" + cnt;
                                }
                                $("<span></span>").css("font-family", "'Monospace', Monospace, Arial, Helvetica, sans-serif").text(cnt).addClass("pl_cnt").appendTo(user_div);

                                $("<span></span>").addClass("pl_name").text(data.rep_id_to_name[rep_id]).appendTo(user_div);

                                if($.trim(user_div.find(".pl_name").text()).length > 0)
                                {
                                    user_div.appendTo(inner_row);
                                    inner_row.appendTo(lb_div);
                                    show_nobody_msg = false;
                                }
                            });
                            if(show_nobody_msg)
                            {
                                $("<h3></h3>").addClass("no_usr_lb_msg").text("No user has met the metric for this interval").appendTo(lb_div);
                            }
                        }
                        else
                        {
                            var office_identifier_name_map = {};
                            $.each(child_offices, function(i, office)
                            {
                                office_identifier_name_map[office.identifier] = office.name;
                            });

                            $.each(Object.keys(data.office_tallies), function(i, e)
                            {
                                if(e.length < 128)
                                {
                                    return;
                                }
                                if((data.office_tallies[e] * 1) < 1)
                                {
                                    return;
                                }
                                show_nobody_msg = false;

                                var inner_row = $("<div></div>").addClass("row").addClass("lb_user_data_" + e).addClass("rendered_lb_plain_list");
                                var user_div = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12");
                                user_div.append
                                (
                                    $("<i></i>").addClass("lb_thumb_img").addClass("pl_cnt")
                                );
                                var cnt = data.office_tallies[e] + '';
                                while(cnt.length < digit_cnt)
                                {
                                    cnt = "0" + cnt;
                                }
                                $("<span></span>").css("font-family", "'Monospace', Monospace, Arial, Helvetica, sans-serif").text(cnt).addClass("pl_cnt").appendTo(user_div);
                                $("<span></span>").addClass("pl_name").text(office_identifier_name_map[e]).appendTo(user_div);

                                if($.trim(user_div.find(".pl_name").text()).length > 0)
                                {
                                    user_div.appendTo(inner_row);
                                    inner_row.appendTo(lb_div);
                                    show_nobody_msg = false;
                                }
                            });
                            if(show_nobody_msg)
                            {
                                $("<h3></h3>").addClass("no_usr_lb_msg").text("No team has met the metric for this interval").appendTo(lb_div);
                            }                            
                        }                        
                    },
                    "pie_chart": function(data)
                    {
                        var oranges = randomColor({"hue": "orange", "count": data.users.length});
                        var blues = randomColor({"hue": "blue", "count": data.users.length});

                        var cnt = 0;
                        $.each(data.users, function(i, user)
                        {
                            cnt += user.count;
                            var arr = oranges;
                            if(i % 2 === 1)
                            {
                                arr = blues;
                            }

                            user["color"] = arr[i];
                        });
                        if(cnt === 0)
                        {
                            $("<h2></h2>").text("No data to show").appendTo(lb_div);
                            return;
                        }

                        var pie_data = [];

                        $.each(data.users, function(i, user)
                        {
                            var channel_idx = 0;
                            channel_idx += 2 * ((i % 2 === 1) * 1);
                            pie_data.push
                            (
                                {
                                    "value": user.count,
                                    "color": user.color,
                                    "highlight": highlight(user.color, channel_idx),
                                    "label": user.name
                                }
                            );
                        });


                        tmp_row = $("<div></div>").addClass("row").addClass("lb_tmp_row");
                        tmp_row.append
                        (
                            $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").text(" ")

                        ).appendTo(app_area);
                        setTimeout(function()
                        {
                            var w = $(".lb_tmp_row").width();
                            w = w + '';
                            w = w.replace("px", "");
                            w = parseInt(w);
                            w = w + '';
                            w = w + 'px';
                            $(".lb_tmp_row").remove();

                            $("<canvas></canvas").attr("id", "tmp_lb_canvas").attr("width", w).attr("height", "400px").appendTo(app_area);

                            var ctx = $("#tmp_lb_canvas")[0].getContext("2d");
                            var pie = new Chart(ctx).Pie(pie_data);

                            $("#tmp_lb_canvas").appendTo(lb_div);
                        }, 200);
                    },
                    "bar_chart": function(data)
                    {
                        data.users.reverse();

                        var bar_data = {};
                        bar_data["labels"] = [];
                        bar_data["datasets"] = [];

                        var data_set = [];
                        $.each(data.users, function(i, user)
                        {
                            if(user.count > 0)
                            {
                                data_set.push(user.count);
                            }
                        });

                        $.each(data.users, function(i, user)
                        {
                            if(user.count > 0)
                            {
                                bar_data["labels"].push(user.name);
                            }
                        });
                        bar_data["datasets"].push
                        (
                            {
                                "label": "Metric Data",
                                "fillColor": "rgba(31,111,189,1.0)",
                                "strokeColor": "rgba(18,88,156,1.0)",
                                "highlightFill": "rgba(54,146,234,1.0)",
                                "highlightStroke": "rgba(3,129,210,1.0)",
                                "data": data_set
                            }
                        );

                        tmp_row = $("<div></div>").addClass("row").addClass("lb_tmp_row");
                        tmp_row.append
                        (
                            $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").text(" ")

                        ).appendTo(app_area);
                        setTimeout(function()
                        {
                            var w = $(".lb_tmp_row").width();
                            w = w + '';
                            w = w.replace("px", "");
                            w = parseInt(w);
                            w = w + '';
                            w = w + 'px';
                            $(".lb_tmp_row").remove();

                            $("<canvas></canvas").attr("id", "tmp_lb_canvas").attr("width", w).attr("height", "300px").appendTo(app_area);

                            var ctx = $("#tmp_lb_canvas")[0].getContext("2d");
                            var bar = new Chart(ctx).Bar(bar_data);

                            $("#tmp_lb_canvas").appendTo(lb_div);
                        }, 200);




                    }
                };

                render_fns[format](lb_data);

                dd_div.appendTo(app_area);
                lb_div.appendTo(app_area);
                if(time_metric === "all_time")
                {
                    $(".interval_span").text("---");
                }
                else
                {
                    $(".interval_span").text(moment(lb_data.start_dt, "YYYY-MM-DD").format("MM/DD/YYYY") + " --- " + moment(lb_data.end_dt, "YYYY-MM-DD").format("MM/DD/YYYY"));
                }

                $("<button></button>").attr("id", "lb_back").html("&larr; Back").addClass("btn-danger").addClass("btn").attr("type", "button").click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                }).appendTo(app_area);
                sortLeaderBoard();
            }
            function bubbleSortArrayOfObjectsByKey(objs, key)
            {
                for(var i = 0; i < objs.length; i++)
                {
                    var a = objs[i];

                    var b = null;
                    if(i !== objs.length - 1)
                    {
                        b = objs[i + 1];
                    }

                    if(b !== null)
                    {
                        var item_a = a[key];
                        var item_b = b[key];

                        if(item_b < item_a)
                        {
                            cpy = [];
                            // make the copy
                            for(var k = 0; k < i; k++)
                            {
                                cpy.push(objs[k]);
                            }

                            cpy.push(b);
                            cpy.push(a);

                            for(var k = i + 2; k < objs.length; k++)
                            {
                                cpy.push(objs[k]);
                            }

                            objs = cpy;
                            i = -1;
                        }
                    }
                }

                return objs;
            }
            function avCheck()
            {
                var identifiers = "[]";
                var saved_identifiers = localStorage.getItem("av_identifiers")
                if(saved_identifiers !== null)
                {
                    identifiers = saved_identifiers
                }
                $.post("/data", {"fn": "av_check", "identifiers": identifiers}).done(function(r)
                {
                    localStorage.setItem("av_identifiers", JSON.stringify(r.identifiers));
                    if(r.new)
                    {
                        BootstrapDialog.show
                        (
                            {
                                "title": "New Training Media Available",
                                "message": "New Audio and/or Video media is available in training resources",
                                "buttons":
                                [
                                    {
                                        "label": "OK",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            d.close();
                                        }
                                    },
                                    {
                                        "label": "Take me there!",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            d.close();
                                            $("#training_resources").trigger("click");
                                        }
                                    }
                                ]
                            }
                        );
                    }
                });
            }
            $(document).ready(function()
            {
                $("#same_day_a").click(function()
                {
                    var that = $(this);
                    var text = that.text().toLowerCase();
                    if(text.indexOf("not accepting") > -1)
                    {
                        var html = $("<div></div>");
                        $("<p></p>").text("Specify the latest SP2 time you can accepts for same-day ABs:").appendTo(html);
                        var time_sel = $("<select></select>").attr("id", "same_day_time_sel");
                        time_sel.css("border", "0px solid #000").css("background", "#000000")
                        for(var i = 7; i < 23; i++)
                        {
                            var am_pm = "AM";
                            if (i >= 12)
                            {
                                am_pm = "PM";
                            }
                            var hour = i;
                            if(hour > 12)
                            {
                                hour -= 12;
                            }

                            var hour_str = hour + '';
                            if(hour_str.length === 1)
                            {
                                hour_str = "0" + hour_str;
                            }

                            for(var k = 0; k < 60; k += 10)
                            {
                                var opt = $("<option></option>");
                                var min_str = k + '';
                                if(min_str.length === 1)
                                {
                                    min_str = "0" + min_str;
                                }
                                var value = i + '';
                                value += ":";
                                value += k;
                                opt.attr("value", value).text(hour_str + ":" + min_str + " " + am_pm);
                                opt.appendTo(time_sel);
                            }

                        }
                        time_sel.appendTo(html);

                        BootstrapDialog.show
                        (
                            {
                                "title": "Specify Same-Day Availability",
                                "message": html.html(),
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(d)
                                        {
                                            d.close();
                                        }
                                    },
                                    {
                                        "label": "Confirm Availability",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            var mom = moment();
                                            var kv_key = "accepts_leads_" + moment().format("YYYY-MM-DD") + "_" + window.user_identifier;
                                            var val = $("#same_day_time_sel").val();
                                            var idx = $("#same_day_time_sel")[0].selectedIndex;
                                            var value_text = $("#same_day_time_sel").find("option").eq(idx)[0].innerText;

                                            if(val.indexOf(":") > -1)
                                            {
                                                var kv_key2 = window.user_identifier + "_same_day_assignment_" + moment().format("YYYY-MM-DD");
                                                $.ajax
                                                (
                                                    {
                                                        "url": '/kv/' + kv_key2,
                                                        type: 'DELETE',
                                                        success: function(result)
                                                        {

                                                        }
                                                });
                                                $.post("/kv/" + kv_key, {"value": val, "ttl": 60 * 60 * 24 * 3}).done(function()
                                                {
                                                    that.removeClass("not_accepting");
                                                    that.addClass("accepting");
                                                    that.text("Accepting same-days until " + value_text);
                                                    d.close();
                                                });
                                            }                                             
                                        }
                                    }
                                ]
                            }
                        );
                    }
                    else
                    {
                        var html = $("<div>...</div>");
                        BootstrapDialog.show
                        (
                            {
                                "title": "What's up",
                                "message": html.html(),
                                "buttons":
                                [
                                    {
                                        "label": "I clicked this by accident",
                                        "cssClass": "btn-danger",
                                        "action": function(d)
                                        {
                                            d.close();
                                        }
                                    },
                                    {
                                        "label": "Remove my availability",
                                        "cssClass": "btn-danger",
                                        "action": function(d)
                                        {
                                            var mom = moment();
                                            var kv_key = "accepts_leads_" + moment().format("YYYY-MM-DD") + "_" + window.user_identifier;
                                            $.ajax
                                            (
                                                {
                                                    "url": '/kv/' + kv_key,
                                                    type: 'DELETE',
                                                    success: function(result)
                                                    {
                                                        that.removeClass("accepting");
                                                        that.addClass("not_accepting");
                                                        that.text("Not accepting same-days")
                                                        d.close();
                                                    }
                                            });
                                        }
                                    }
                                ]
                            }
                        );
                    }
                });

                var survey_check_fn = function()
                {
                    var user_type = "{{ user_type }}";
                    if(user_type === "sales_manager" || user_type === "energy_expert" || user_type === "solar_pro_manager")
                    {
                        $.post("/data", {"fn": "survey_response_check", "identifier": window.user_identifier}).done(function(r)
                        {
                            if(!r.found)
                            {
                                window.location.href = "/tell_us/" + window.user_identifier;
                            }
                        });
                    }
                }
                setInterval(function()
                {
                    survey_check_fn();
                }, 1000 * 60 * 10);
                survey_check_fn();


                if(window.location.protocol.toLowerCase().indexOf("https") === -1)
                {
                    $("body").html("");
                    var url = window.location.href.toLowerCase();
                    url = url.replace("http://", "https://");
                    window.location.href = url;
                    return;
                }

                buildIcons();
                if(window.location.href.indexOf("?autoload=") > -1 || window.location.href.indexOf("&autoload=") > -1)
                {
                    var url_subbed = window.location.href.substring(window.location.href.indexOf("autoload="));
                    var replaced = url_subbed.replace("autoload=", "");
                    var split = replaced.split("&");
                    var item = split[0];
                    var decoded = decodeURIComponent(item);
                    $("#" + item).trigger("click");
                }
                doCustomerHoldsTally();
                doPerfectPacketTally();
                doNotesTally();
                doUnbookedSurveysTally();
                doSaveMeTally();
                doRequiredActionsTally();
                avCheck();
                sp2Annoy();

                checkSP2trigger();
                $(window).resize(function()
                {
                    setTimeout(function()
                    {
                        resize_fn();
                    }, 150);
                });
                $(window).on("orientationchange",function()
                {
                    setTimeout(function()
                    {
                        landscapeCheck();
                    }, 1000);
                });
                setTimeout(function()
                {
                    landscapeCheck();
                }, 750);

                var autoclicked = false;
                if(localStorage.getItem("button_to_click") !== null)
                {
                    $("#" + localStorage.getItem("button_to_click")).click();
                    localStorage.removeItem("button_to_click");
                    autoclicked = true;
                }

                if(!autoclicked)
                {
                    var c_val = $.cookie("button_to_click");
                    if((typeof(c_val) + '').toLowerCase() === "string")
                    {
                        $("#" + c_val).click();
                        $.removeCookie("button_to_click");
                    }
                }
                if(localStorage.getItem("assumed_user_hint_to_show"))
                {
                    BootstrapDialog.alert
                    (
                        {
                            "title": "Howdy!",
                            "message": "Well hello there, \"" + localStorage.getItem("assumed_user_hint_to_show") + "\"&nbsp;&nbsp;&nbsp;;)"
                        }
                    );
                    localStorage.removeItem("assumed_user_hint_to_show");
                }

                $.post("./data", {"fn": "get_unread_threads_for_user"}).done(function(resp)
                {
                    if(resp.senders.length < 1)
                    {
                        return;
                    }

                    var html = $("<div></div>");
                    var word = "person";
                    if(resp.senders.length > 1)
                    {
                        word = word.replace("rson", "ople");
                    }
                    html.append
                    (
                        $("<p></p>").text((resp.senders.length + '') + " " + word + " is waiting to hear back from you...")
                    );
                    html.append
                    (
                        $("<hr />")
                    );

                    var users_div = $("<div></div>").addClass("row");
                    $.each(resp.senders, function(i, sender)
                    {
                        var img = $("<img />").addClass("img").addClass("img-responsive");
                        img.attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + sender + ".jpg");
                        img.css("max-width", "100%");

                        var p = $("<p></p>").text(resp.sender_name_dict[sender]);

                        var user_div = $("<div></div>").addClass("col-xs-3").addClass("col-sm-3").addClass("col-md-3").addClass("col-lg-3");
                        img.appendTo(user_div);
                        p.appendTo(user_div);
                        user_div.appendTo(users_div);

                    });

                    html.append(users_div);

                    BootstrapDialog.show
                    (
                        {
                            "title": "New messages are waiting!",
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "Show me",
                                    "action": function(dialog)
                                    {
                                        $("#inbox").trigger("click");
                                        dialog.close();
                                    }
                                }
                            ]
                        }
                    );

                });
                if({{ show_lurker_message}} === 1)
                {
                    BootstrapDialog.show
                    (
                        {
                            "title": "Lurker?",
                            "message": "Lurking?<br /><br />It's easier to make a name for yourself when we can put a face to you. You can upload a photo by clicking the 'My Settings' icon and clicking the profile picture...",
                            "buttons":
                            [
                                {
                                    "label": "Take me there",
                                    "cssClass": "btn-primary",
                                    "action": function(d)
                                    {
                                        $("#user_settings").trigger("click");
                                        d.close();
                                    }
                                }
                            ]
                        }
                    )
                }
                loadFeaturedLBData();
            });
            window.user_identifier = "{{ user_identifier }}";

            function showContests()
            {
                hideIconGrid();
                $.post("./data", {"fn": "list_contests"}).done(function(resp)
                {
                    var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("contest_main_div");
                    $("<h2></h2>").html("<i class='fa fa-diamond'></i> Competitions:").appendTo(main_div);
                    $("<br />").appendTo(main_div);
                    $("<br />").appendTo(main_div);


                    if(resp.contests.length === 0)
                    {
                        $("<h4></h4>").text(" (There are currently no competitions) ").appendTo(main_div);
                    }
                    else
                    {
                        $.each(resp.contests, function(i, contest)
                        {
                            var contest_item = $("<div></div>").attr("id", "contest_" + contest.identifier).addClass("contest_div");
                            $("<div></div>").addClass("contest_info_btn_row")
                            .append
                            (
                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").click(function()
                                {
                                    showContestInfo(contest);
                                })
                            ).appendTo(contest_item);

                            var st = moment(contest.start_time, "YYYY-MM-DD hh:mm:ss");
                            var et = moment(contest.end_time, "YYYY-MM-DD hh:mm:ss");

                            $("<p></p>").text(contest.name).addClass("contest_name").appendTo(contest_item);
                            $("<hr />").appendTo(contest_item);
                            $("<p></p>")
                            .addClass("contest_time")
                            .html(st.format("YYYY-MM-DD").replace("am", "A.M.").replace("pm", "P.M.") + "&nbsp;&nbsp;&nbsp; - &nbsp;&nbsp;&nbsp;" + et.format("YYYY-MM-DD").replace("am", "A.M.").replace("pm", "P.M."))
                            .appendTo(contest_item);

                            contest_item.appendTo(main_div);
                        });
                    }

                    var app_area = $("#app_area");
                    spacer.appendTo(app_area);

                    $("<button></button>").html("&larr; Back").addClass("btn").addClass("btn-danger").click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    }).appendTo(main_div);
                    main_div.appendTo(app_area);
                    spacer.clone().appendTo(app_area);
                });
            }

            function showContestInfo(contest)
            {
                var description_p = $("<p></p>").addClass("contest_description");

                if($.parseJSON(contest.description).provided === false)
                {
                    description_p.text("(No description or competition rules were provided)");
                }
                else
                {
                    var descrip = $.parseJSON(contest.description).text;
                    var description_lines = descrip.split("\n");
                    var description_html = description_lines.join("<br />");

                    description_p.html(description_html);
                }

                description_p.appendTo($("#contest_" + contest.identifier));
            }
            function showDataLoggerMap()
            {
                hideIconGrid();
                var app_area = $("#app_area");
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").css("font-size", "2em")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                }).appendTo(main_div);
                $("<br />").appendTo(main_div);
                $("<div></div>").attr("id", "data_logger_map_div").appendTo(main_div);

                var load_data = function(items, map)
                {
                    $.each(items, function(i, item)
                    {
                        var url_suffix = "blue-dot.png";
                        if(item.old)
                        {
                            url_suffix = "red-dot.png";
                        }
                        var marker = new google.maps.Marker
                        (
                            {
                                "map": map,
                                "position": item["location"],
                                "icon":
                                {
                                    "url": "https://maps.google.com/mapfiles/ms/icons/" + url_suffix
                                }
                            }
                        );
                        
                        var info_window = new google.maps.InfoWindow
                        (
                            {
                                "content": "<div class='dl_info_window'>" + item.name + "<br />" + item.address.split("\n").join("<br />") + "<br />" + moment(item.sp2, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm:ss a") + "</div>"
                            }
                        );

                        google.maps.event.addListener(marker, 'click', function() 
                        {
                            info_window.open(map, marker);
                        });

                        
                    });
                };

                $.post("/data", {"fn": "get_rep_data_logger_info", "identifier": window.user_identifier}).done(function(r)
                {
                    $.each([spacer, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                    var map = new google.maps.Map(document.getElementById("data_logger_map_div"),
                    {
                        "zoom": 4,
                        "center": {"lat": 33.9979486, "lng": -117.3327293}
                    });

                    var callback_count = 0;
                    var callbacks_required = r.length;
                    $.each(r, function(i, obj)
                    {
                        var addy = obj.address;
                        while(addy.indexOf("\n") > -1)
                        {
                            addy = addy.replace("\n", " ");
                        }

                        $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyC1JStq4qg-S61Y1bAXLzAWlq3ToUIscZk&address=" + encodeURIComponent(addy)).done(function(r2)
                        {
                            var lat = r2.results[0].geometry.location.lat;
                            var long = r2.results[0].geometry.location.lng;
                            obj["location"] = {"lat": lat, "lng": long};
                            callback_count++;
                        });
                    });

                    window.temp_check_interval = setInterval(function()
                    {
                        if(callback_count === callbacks_required)
                        {
                            window.clearInterval(window.temp_check_interval);
                            load_data(r, map);
                        }
                    }, 1000);
                    window.temp_intervals.push(temp_check_interval);
                });
                
            }
            function showDetailsForSP2CustomerInfo(appointment, icon)
            {
                $.post("/data", {"fn": "get_sp2_details_for_customer", "identifier": appointment.identifier}).done(function(r)
                {
                    appointment.proposal = r.proposal
                    appointment.credit_notes = r.notes;

                    var sys_size = "{Missing}";
                    var h = appointment.hour + '';
                    if(h.length === 1)
                    {
                        h = "0" + h;
                    }
                    var min = appointment.minute + '';
                    if(min.length === 1)
                    {
                        min = "0" + min;
                    }

                    var d = appointment.day + '';
                    if(d.length === 1)
                    {
                        d = "0" + d;
                    }
                    var m = appointment.month + '';
                    if(m.length === 1)
                    {
                        m = "0" + m;
                    }
                    var y = appointment.year + '';
                    var sp2_dt = [y, m, d].join("-") + " " + [h, min, "00"].join(":") + " " + appointment.ampm;
                    if(appointment.proposal !== null)
                    {
                        var data = $.parseJSON(appointment.proposal.info);
                        if(typeof(data["system_size"]) + '' !== "undefined")
                        {
                            sys_size = data.system_size;
                        }
                    }

                    $.getJSON("/kv/later_notes_" + appointment.identifier).done(function(obj)
                    {
                        let pulled_notes = "";
                        if(obj.value !== undefined)
                        {
                            pulled_notes = obj.value;

                            var html = $("<html></html>");
                            html.append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("Customer Address:")
                                )
                            )
                            .append
                            (
                                $("<p></p>").html(appointment.address + "<br />" + appointment.city + ", " + appointment.state)
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("Customer Phone:")
                                )
                            )
                            .append
                            (
                                $("<p></p>").text(appointment.phone_number)
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("Email Address:")
                                )
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<a></a>").text(appointment.email).attr("href", "mailto:" + appointment.email)
                                )
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("System Size:")
                                )
                            )
                            .append
                            (
                                $("<p></p>").text(sys_size)
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("SP2 Appointment Date-Time:")
                                )
                            )
                            .append
                            (
                                $("<p></p>").text(sp2_dt)
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("Notes from Admin")
                                )
                            )
                            .append
                            (
                                $("<p></p>").html(appointment.credit_notes.split("\n").join("<br />"))
                            )
                            .append
                            (
                                $("<p></p>")
                                .append
                                (
                                    $("<b></b>").text("Store Notes for Later:")
                                )
                            )
                            .append
                            (
                                $("<textarea></textarea>").attr("value", pulled_notes).addClass("later_notes").attr("id", "blur_me")                                
                            );

                            if(r.is_lead)
                            {
                                $("<hr />").appendTo(html);
                                $("<p></p>").text("Solar Pro: " + r.solar_pro.name).appendTo(html);
                                $("<a></a>").attr("href", "tel:" + r.solar_pro.phone).text(r.solar_pro.phone_formatted).appendTo(html);
                                var ab_call_p = $("<p></p>");
                                if(r.solar_pro.ab_call === null)
                                {
                                    ab_call_p.text("AB call not available.")   
                                }
                                else
                                {
                                    ab_call_p
                                    .append
                                    (
                                        $("<a></a>").attr("target", "_blank").text("Link to AB Call").attr("href", r.solar_pro.ab_call)
                                    );
                                }
                                ab_call_p.appendTo(html);
                            }

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Details for " + appointment.name,
                                    "message": html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Reschedule SP2",
                                            "cssClass": "btn-primary",
                                            "action": function(dialog)
                                            {
                                                dialog.close();
                                                setTimeout(function()
                                                {
                                                    $("#reschedule_" + appointment.identifier).find("a").first().trigger("click");
                                                }, 400);
                                            }
                                        },
                                        {
                                            "label": "OK",
                                            "cssClass": "btn-success",
                                            "action": function(dialog)
                                            {
                                                dialog.close()
                                            }
                                        }
                                    ],
                                    "onshown": ((d) =>
                                    {
                                        icon.css("display", "inline-block");
                                        $("#blur_me").blur(function()
                                        {
                                            let that = $(this);
                                            $.post("/kv/later_notes_" + appointment.identifier, {"value": that.val()}).done(function()
                                            {
                                                d.close();
                                            });
                                        })
                                        .val(pulled_notes)
                                    })
                                }
                            );
                        }
                    });                    
                });
            }
            window.temp_proposal_rep_intervals = [];
            function prepareCustomerForProposal(customer, panels, panel_points)
            {
                var bad = false;
                if(customer.total_dollars < 1)
                {
                    bad = true;
                }
                if(customer.total_kwhs < 1)
                {
                   bad = true;
                }
                if(customer.usage_months < 1)
                {
                    bad = true;
                }
                if(customer.highest_amount < 1)
                {
                    bad = true;
                }
                if(customer.proposal === null)
                {
                    bad = true;
                }
                var hide_system_size = false;
                if(!bad)
                {
                    var inpho = $.parseJSON(customer.proposal.info)
                    if(typeof(inpho["system_size"]) + '' === "undefined")
                    {
                        bad = true;
                    }
                    if(!bad)
                    {
                        if(typeof(inpho["cad_photo"]) + '' === "undefined")
                        {
                            bad = true;
                        }
                    }
                    if(!bad)
                    {
                        if(typeof(inpho["offset"]) + '' === "undefined")
                        {
                            bad = true;
                        }
                    }
                    
                }
                if(bad)
                {
                    window.alert("The customer's usage and/or proposal data is missing.");
                    return;
                }

                if(typeof(inpho["display_status"]) + '' !== "undefined")
                {
                    if(inpho["display_status"] === "Yes")
                    {
                        hide_system_size = true;
                    }
                }
                $(".proposal_form_row").remove();
                $.each(window.temp_proposal_rep_intervals, function(i, interval)
                {
                    window.clearInterval(interval);
                });
                var interval_fns = [];
                var field_info =
                {

                    "usage_months":
                    {
                        "type": "multiple_choice",
                        "secondary_type": "dropdown",
                        "choices":
                        [
                            {
                                "value": "1",
                                "value_friendly": "01",
                            },
                            {
                                "value": "2",
                                "value_friendly": "02"
                            },
                            {
                                "value": "3",
                                "value_friendly": "03",
                            },
                            {
                                "value": "4",
                                "value_friendly": "04"
                            },
                            {
                                "value": "5",
                                "value_friendly": "05"
                            },
                            {
                                "value": "6",
                                "value_friendly": "06"
                            },
                            {
                                "value": "7",
                                "value_friendly": "07"
                            },
                            {
                                "value": "8",
                                "value_friendly": "08"
                            },
                            {
                                "value": "9",
                                "value_friendly": "09"
                            },
                            {
                                "value": "10",
                                "value_friendly": "10"
                            },
                            {
                                "value": "11",
                                "value_friendly": "11"
                            },
                            {
                                "value": "12",
                                "value_friendly": "12"
                            }
                        ],
                        "title": "Usage Months Available"
                    },
                    "total_kwhs":
                    {
                        "type": "real_number",
                        "secondary_type": "none",
                        "title": "Total KwH",
                        "input_filter": function(el)
                        {
                            var new_txt = "";
                            var txt = $.trim(el.val());
                            var allowed_chars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
                            $.each(txt.split(""), function(i, char)
                            {
                                if(allowed_chars.indexOf(char) > -1)
                                {
                                    if(new_txt.indexOf(".") === -1 && char === ".")
                                    {
                                        new_txt += char;
                                    }
                                    else
                                    {
                                        if(char !== ".")
                                        {
                                            new_txt += char;
                                        }
                                    }
                                }
                            });
                            el.val(new_txt);
                        }
                    },
                    "total_dollars":
                    {
                        "type": "real_number",
                        "secondary_type": "currency",
                        "title": "Total Dollars",
                        "input_filter": function(el)
                        {
                            var new_txt = "";
                            var txt = $.trim(el.val());
                            var allowed_chars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
                            $.each(txt.split(""), function(i, char)
                            {
                                if(allowed_chars.indexOf(char) > -1)
                                {
                                    if(new_txt.indexOf(".") === -1 && char === ".")
                                    {
                                        new_txt += char;
                                    }
                                    else
                                    {
                                        if(char !== ".")
                                        {
                                            new_txt += char;
                                        }
                                    }
                                }
                            });
                            el.val(new_txt);
                        }
                    },
                    "highest_amount":
                    {
                        "type": "real_number",
                        "secondary_type": "currency",
                        "title": "Highest Montly Bill",
                        "input_filter": function(el)
                        {
                            var new_txt = "";
                            var txt = $.trim(el.val());
                            var allowed_chars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
                            $.each(txt.split(""), function(i, char)
                            {
                                if(allowed_chars.indexOf(char) > -1)
                                {
                                    if(new_txt.indexOf(".") === -1 && char === ".")
                                    {
                                        new_txt += char;
                                    }
                                    else
                                    {
                                        if(char !== ".")
                                        {
                                            new_txt += char;
                                        }
                                    }
                                }
                            });
                            el.val(new_txt);
                        }
                    },
                    "offset":
                    {
                        "type": "multiple_choice",
                        "secondary_type": "dropdown",
                        "choices":
                        [
                            "UT-70",
                            "UT-90",
                            "CA-TOU",
                            "Partial"
                        ],
                        "title": "Offset",
                        "dependent_question":
                        {
                            "key": "utility_bill_after_solar",
                            "type": "real_number",
                            "secondary_type": "currency",
                            "title": "Utility Bill After Solar",
                            "input_filter": function(el)
                            {
                                var new_txt = "";
                                var txt = $.trim(el.val());
                                var allowed_chars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
                                $.each(txt.split(""), function(i, char)
                                {
                                    if(allowed_chars.indexOf(char) > -1)
                                    {
                                        if(new_txt.indexOf(".") === -1 && char === ".")
                                        {
                                            new_txt += char;
                                        }
                                        else
                                        {
                                            if(char !== ".")
                                            {
                                                new_txt += char;
                                            }
                                        }
                                    }
                                });
                                el.val(new_txt);
                            }
                        },
                        "dependent_value": "Partial"

                    },
                    "system_size":
                    {
                        "type": "real_number",
                        "secondary_type": "none",
                        "title": "System Size",
                        "input_filter": function(el)
                        {
                            var new_txt = "";
                            var txt = $.trim(el.val());
                            var allowed_chars = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "."];
                            $.each(txt.split(""), function(i, char)
                            {
                                if(allowed_chars.indexOf(char) > -1)
                                {
                                    if(new_txt.indexOf(".") === -1 && char === ".")
                                    {
                                        new_txt += char;
                                    }
                                    else
                                    {
                                        if(char !== ".")
                                        {
                                            new_txt += char;
                                        }
                                    }
                                }
                            });
                            el.val(new_txt);
                        }
                    },
                    "cad_photo":
                    {
                        "type": "file",
                        "secondary_type": "none",
                        "title": "CAD Photo"
                    },
                    "term":
                    {
                        "type": "multiple_choice",
                        "secondary_type": "dropdown",
                        "choices":
                        [
                            {
                                "value": "12",
                                "value_friendly": "12-Year"
                            },
                            {
                                "value": "20",
                                "value_friendly": "20-Year"
                            }
                        ],
                        "title": "Term",
                        "entity_dependency": function(customer)
                        {
                            return customer.state.toUpperCase() === "UT";
                        }
                    }
                };

                var row = $("<div></div>").addClass("proposal_form_row");

                if(typeof(inpho["trees_need_cut"]) + '' !== "undefined")
                {
                    if(inpho["trees_need_cut"] === "Yes")
                    {
                        $("<p></p>").addClass("trees_need_cut_warning").text("TREES NEED CUT FOR THIS PROPOSAL").appendTo(row);
                        $("<p></p>").addClass("trees_need_cut_details").text(inpho["tree_cut_details"]).appendTo(row);
                    }
                }
                if(customer.income_verification_required)
                {
                    $("<p></p>").addClass("income_verification_warning").text("INCOME VERIFICATION REQUIRED FOR CUSTOMER. COLLECT BEFORE WELCOME CALL.").appendTo(row);
                }
                if(customer.usage_type === "estimated")
                {
                    $("<p></p>").addClass("income_verification_warning").text("USAGE OBTAINED IS AN ESTIMATE.  PLEASE CONFIRM ACTUAL USAGE BEFORE SIGNING THE CUSTOMER UP.").appendTo(row);
                }
                $("<p></p>").addClass("residual_bill_warning").text("Please be aware that all customers will have an electric bill after they go solar. This bill will include any taxes, fees, and non-bipassable charges. This bill is not included in the section below that says bill after solar.").appendTo(row);
                var replaced = customer.notes;
                while(replaced.indexOf("\r") > -1)
                {
                    replaced = replaced.replace("\r", "");
                }
                var replaced_values = replaced.split("\n");
                var html_joined = replaced_values.join("<br />");
                $("<p></p>").addClass("notes_from_solar_pro")
                .html("<b>Notes from Solar Pro:<br />" + html_joined)
                .appendTo(row);

                var n_p = $("<p></p>").addClass("notes_from_solar_pro").html("Notes from Proposal Designer: <span class='notes_from_prop_designer_span'> (Loading...)</span>");
                $.post("/data", {"fn": "proposal_designer_notes", "identifier": customer.identifier}).done(function(notes_resp)
                {
                    n_p.find(".notes_from_prop_designer_span").remove();
                    $("<span></span>").html("<br />" + notes_resp.notes.split("\n").join("<br />")).appendTo(n_p);
                });

                n_p.appendTo(row);

                $.post("./data", {"fn": "crunch_numbers_v2", "identifier": customer.identifier}).done(function(resp)
                {
                    var tbl = $("<table></table>");
                    var tbody = $("<tbody></tbody>");

                    var ss = $.parseJSON(customer.proposal.info).system_size;

                    
                    if(typeof($.parseJSON(customer.proposal.info)["new_panel_qty"]) + '' !== "undefined")
                    {
                        if($.parseJSON(customer.proposal.info)["panel_type"].indexOf("[[[") > -1)
                        {
                            var watts = $.parseJSON(customer.proposal.info)["panel_type"];
                            watts = watts.substring(watts.indexOf("[[["));
                            watts = watts.replace("[[[", "");
                            watts = watts.replace("]]]", "");

                            watts = parseFloat(watts);

                            var n = watts * parseFloat($.parseJSON(customer.proposal.info)["new_panel_qty"]);
                            n /= 1000;
                            ss = n;
                        }
                    }                    
                    var ss_css = "";
                    if(hide_system_size)
                    {
                        ss_css = "display: none;"   
                    }

                    $("<tr></tr>").attr("style", ss_css)
                    .append
                    (
                        $("<td></td>").text("System Size")
                    )
                    .append
                    (
                        $("<td></td>").text((ss + '') + ' KW')
                    )
                    .appendTo(tbody);

                    $("<tr></tr>")
                    .append
                    (
                        $("<td></td>").text("Offset")
                    )
                    .append
                    (
                        $("<td></td>")
                        .append
                        (
                            $("<a></a>").text("Click to Reveal").attr("href", "javascript:void(0);").addClass("calced_details_show")
                        )
                    )                    
                    .appendTo(tbody);

                    $("<tr></tr>")
                    .append
                    (
                        $("<td></td>").text("Total KWHs")
                    )
                    .append
                    (
                        $("<td></td>").text(customer.total_kwhs + '')
                    )
                    .appendTo(tbody);

                    tbody.append
                    (
                        $("<tr></tr>")
                        .append
                        (
                            $("<td></td>").text("Utility Bill After Solar")
                        )
                        .append
                        (
                            $("<td></td>")
                            .append
                            (
                                $("<a></a>").text("Click to Reveal").attr("href", "javascript:void(0);").addClass("calced_details_show")
                            )
                        )
                    );

                    $.each(resp.items, function(i, item)
                    {
                        var tr = $("<tr></tr>");
                        var formula_txt_str = item["formula"];
                        if(formula_txt_str === "State Tax Credit")
                        {
                            formula_txt_str = resp.state_tax_formula_label;
                        }
                        $("<td></td>").text(formula_txt_str).appendTo(tr);
                        $("<td></td>").text(item["number"]).appendTo(tr);

                        if(formula_txt_str === "Points Used")
                        {
                            tr.insertAfter(tbody.find("tr").first());
                        }
                        else
                        {
                            tr.appendTo(tbody);
                        }                        
                    });

                    tbody.find(".calced_details_show").each(function(i, e)
                    {                        
                        $(e).click(function()
                        {
                            var tbod = $(this).closest("tbody");
                            tbod.css("display", "none");

                            var new_tbody = $("<tbody></tbody>").addClass("calced_details_tbod");
                            $("<tr></tr>")
                            .append
                            (
                                $("<th></th>").text("Panel Qty")
                            )
                            .append
                            (
                                $("<th></th>").text("Offset")
                            )
                            .append
                            (
                                $("<th></th>").text("Y1 Production")
                            )
                            .append
                            (
                                $("<th></th>").text("Residual Bill")
                            )
                            .appendTo(new_tbody);
                            $("<tr></tr>")
                            .append
                            (
                                $("<td></td>").attr("colspan", "4")
                                .append
                                (
                                    $("<span></span>").addClass("special_message_calced_details").text("THESE ARE ESTIMATIONS ONLY")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("label").addClass("label-primary").html("&larr; Back")
                                    .click(function()
                                    {
                                        new_tbody.remove();
                                        tbod.css("display", "table-row-group");
                                    })
                                )
                            )
                            .appendTo(new_tbody);

                            var prop = $.parseJSON(customer.proposal.info);

                            var trs = [];

                            var per_kwh_price = parseFloat(customer.total_dollars) / parseFloat(customer.total_kwhs);

                            var qty_to_use = prop.panel_qty;
                            if(Object.keys(prop).indexOf("new_panel_qty") > -1)
                            {
                                qty_to_use = prop.new_panel_qty;
                            }
                            for(var iii = parseInt(qty_to_use); iii > 9; iii--)
                            {
                                var tee_r = $("<tr></tr>");
                                $("<td></td>").text((iii + '')).appendTo(tee_r);
                                
                                if(iii === parseInt(qty_to_use))
                                {
                                    $("<td></td>").text(prop.offset).appendTo(tee_r);
                                    $("<td></td>").text($.trim((prop.year_one_production + '').replace("kw", ""))).appendTo(tee_r);
                                    if((typeof(prop["utility_bill_after_solar"]) + '').toLowerCase() === "undefined")
                                    {
                                        $("<td><td>").addClass("confused").text("$0.00").appendTo(tee_r);
                                    }
                                    else
                                    {
                                        var residual = prop.utility_bill_after_solar + '';
                                        residual = $.trim(residual.replace("$", ""));
                                        residual = parseFloat(residual);
                                        residual = currencyFormat(residual);
                                        $("<td></td>").text(residual).appendTo(tee_r);
                                    }                                    
                                }
                                else
                                {
                                    var tkwhs_ = parseFloat(customer.total_kwhs);
                                    var y1prod_ = parseFloat($.trim((prop.year_one_production + '').replace("kw", "")));
                                    var this_ratio_ = parseFloat(iii) / parseFloat(new_tbody.find("tr").eq(2).find("td").first().text());
                                    this_ratio_ *= parseFloat(new_tbody.find("tr").eq(2).find("td").eq(1).text().replace("%", "")) * 0.01;

                                    var orig_prod = y1prod_;
                                    var this_prod = this_ratio_ * orig_prod;
                                    var new_percentage = (parseInt(this_ratio_ * parseFloat(100)) + '');
                                    if(this_prod >= tkwhs_)
                                    {
                                        $("<td></td>").text("100%").appendTo(tee_r);
                                    }
                                    else
                                    {
                                        $("<td></td>").text((new_percentage + '') + "%").appendTo(tee_r);
                                    }

                                    var or_percentage = parseInt(new_tbody.find("tr").eq(2).find("td").eq(1).text().replace("%", ""));
                                    var or_offset = parseFloat((prop.year_one_production + '').replace("kw", ""));

                                    var new_prod = (or_offset * new_percentage) / or_percentage


                                    var old_cost = new_tbody.find("tr").eq(2).find("td").eq(3).text();
                                    while(old_cost.indexOf(",") > -1)
                                    {
                                        old_cost = old_cost.replace(",", "");
                                    }
                                    while(old_cost.indexOf("$") > -1)
                                    {
                                        old_cost = old_cost.replace("$", "");
                                    }
                                    old_cost = parseFloat(old_cost);
                                    new_cost = (old_cost * or_percentage) / parseInt(new_percentage);
                                    new_cost = parseFloat(new_cost);

                                    $("<td></td>").text(parseInt(new_prod) + '').appendTo(tee_r);                                    
                                    $("<td></td>").text(currencyFormat(new_cost)).appendTo(tee_r);

                                    /*var percentage_a = parseFloat(iii) / parseFloat(new_tbody.find("tr").eq(2).find("td").first().text());
                                    percentage_a *= parseFloat(100);
                                    if(percentage_a > parseFloat(100))
                                    {
                                        percentage_a = parseFloat(100);
                                    }
                                    var percentage_a = parseFloat(iii) / parseFloat(new_tbody.find("tr").eq(2).find("td").first().text());
                                    percentage_a *= parseFloat($.trim((prop.year_one_production + '').replace("kw", "")));
                                    percentage_a /= parseFloat(customer.total_kwhs);
                                    var actual_percentage_a = percentage_a;                                    
                                    percentage_a *= parseFloat(100);
                                    if(percentage_a > parseFloat(100))
                                    {
                                        percentage_a = parseFloat(100);
                                    }
                                    $("<td></td>").text((parseInt(percentage_a) + '') + "%").appendTo(tee_r);
                                    var orig_prod = parseFloat(new_tbody.find("tr").eq(2).find("td").eq(2).text());
                                    var this_prod = orig_prod * actual_percentage_a;
                                    $("<td></td>").text(parseInt(this_prod) + '').appendTo(tee_r);

                                    var costt = parseFloat(0);                                
                                    if(parseFloat(this_prod) < parseFloat(customer.total_kwhs))
                                    {
                                        var diff = parseFloat(customer.total_kwhs) - parseFloat(this_prod);
                                        costt = diff * per_kwh_price;
                                        costt /= parseFloat(12);
                                    }
                                    $("<td></td>").text(currencyFormat(costt)).appendTo(tee_r);*/
                                }
                                tee_r.find(".confused").each(function(iiii, eeee)
                                {
                                    if(iiii > 0)
                                    {
                                        $(eeee).remove();
                                    }
                                });
                                tee_r.appendTo(new_tbody);                               
                            }
                            new_tbody.insertAfter(tbod);
                        });
                    });
                    tbody.appendTo(tbl);

                    if(customer.requires_proposal)
                    {
                        tbody.find("tr").each(function(iiiii, eeeee)
                        {
                            $(eeeee).find("td").eq(1).text("SEE PROPOSAL");
                        });
                    }

                    tbl.appendTo(row);
                    $("<h2></h2>").css("display", "none").addClass("thomas_warning").text("Dropping Pay on Self-Gen reduces commissions by $120/KW for every $50/KW reduced").appendTo(row);

                    var fund_dropdown = $("<div></div>").addClass("dropdown");
                    fund_dropdown.append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text("Update the Fund").addClass("proposal_fund_btn")
                    );

                    var fund_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                    $.each(resp.funds, function(i, fund)
                    {
                        if(fund.value === customer.fund)
                        {
                            fund_dropdown.find("button").first().text(fund.value_friendly);
                        }
                        $("<li></li>").attr("id", "fund_value_of_" + fund.value).attr("role", "presentation")
                        .append
                        (
                            $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text(fund.value_friendly)
                        )
                        .click(function()
                        {
                            customer.fund = fund.value;
                            $(".proposal_fund_btn").text($(this).text());
                            $(".proposal_fund_btn").animate({opacity: 0.2}, 250, function()
                            {
                                $.post("/data", {"fn": "set_fund_for_booking", "fund": fund.value, "identifier": customer.booking_identifier}).done(function(resp77)
                                {
                                    customer.funding_tier = "n/a";
                                    prepareCustomerForProposal(customer, panels, panel_points);
                                });
                            });

                        }).appendTo(fund_ul);
                    });
                    fund_ul.appendTo(fund_dropdown);
                    fund_dropdown.find("button").first().append
                    (
                        $("<span></span>").addClass("caret")
                    );

                    var tier_dropdown = $("<div></div>").addClass("dropdown");
                    tier_dropdown.append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text("Update the Tier").addClass("proposal_tier_btn")
                        .append
                        (
                            $("<span></span>").addClass("caret")
                        )
                    );

                    var tier_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");

                    $("<li></li>").attr("id", "tier_value_of_A").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("Normal Pay")
                    )
                    .appendTo(tier_ul);

                    $("<li></li>").attr("id", "tier_value_of_B").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("-$50/kw")
                    )
                    .appendTo(tier_ul);

                    $("<li></li>").attr("id", "tier_value_of_C").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("-$100/kw")
                    )
                    .appendTo(tier_ul);

                    $("<li></li>").attr("id", "tier_value_of_D").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("-$150/kw")
                    )
                    .appendTo(tier_ul);

                    $("<li></li>").attr("id", "tier_value_of_E").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("-$200/kw")
                    )
                    .appendTo(tier_ul);

                    tier_ul.find("li").each(function(i, e)
                    {
                        $(e).click(function()
                        {
                            if(window.confirm("New Power matches how much you drop the price per KW"))
                            {
                                customer.tier_option = $(e).attr("id").replace("tier_value_of_", "");
                                $(".proposal_tier_btn").text($(e).text());
                                $(".proposal_tier_btn").animate({opacity: 0.2}, 250, function()
                                {
                                    $.post("/data", {"fn": "update_rep_customer_tier", "tier": $(e).attr("id").replace("tier_value_of_", ""), "identifier": customer.identifier}).done(function(resp772)
                                    {
                                        prepareCustomerForProposal(customer, panels, panel_points);
                                    });
                                });
                            }
                        });
                        if($(e).attr("id").replace("tier_value_of_", "") === customer.tier_option)
                        {
                            tier_dropdown.find(".proposal_tier_btn").text($(e).text());
                            $("<span></span>").addClass("caret").appendTo(tier_dropdown.find(".proposal_tier_btn"));
                        }
                    });

                    tier_ul.appendTo(tier_dropdown);

                    if(customer.requires_proposal)
                    {
                        tier_dropdown.css("display", "none");
                    }

                    var panel_type_dropdown = $("<div></div>").addClass("dropdown");
                    var prop_info = $.parseJSON(customer.proposal.info);

                    var p_name = prop_info.panel_type.substring(0, prop_info.panel_type.indexOf("[[["));
                    var p_points = ""
                    var p_points = panel_points[p_name] + '';

                    panel_type_dropdown.append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text(p_name + " - " + p_points + " points")
                        .append
                        (
                            $("<span></span>").addClass("caret")
                        )
                    );

                    var panel_type_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");                    
                    $.each(panels, function(iii, panel)
                    {
                        var points = panel_points[panel.substring(0, panel.indexOf("[[["))];
                        points += '';
                        var li = $("<li></li>").attr("id", "tier_value_of_A").attr("role", "presentation")
                        var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text(panel.substring(0, panel.indexOf("[[[")) + " - " + points + " points");
                        li.attr("data-panel_name", panel);
                        li.attr("data-panel_points", points + '');

                        li.click(function()
                        {
                            var that = $(this);
                            var ul = that.closest("ul");
                            var btn = that.closest(".dropdown").find("button").first();
                            btn.css("opacity", "0.1");
                            $.post("/data", {"fn": "update_panel_type", "identifier": customer.identifier, "type": that.data("panel_name")}).done(function(r)
                            {
                                var old_info_prop = $.parseJSON(customer.proposal.info);
                                old_info_prop["panel_type"] = that.data("panel_name");
                                customer.proposal.info = JSON.stringify(old_info_prop);
                                prepareCustomerForProposal(customer, panels, panel_points);
                            });
                        });
                        a.appendTo(li);
                        li.appendTo(panel_type_ul);
                    });

                    panel_type_ul.appendTo(panel_type_dropdown);

                    var panel_dropdown = $("<div></div>").addClass("dropdown");
                    $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown")
                    .text("Update Panel Option")
                    .append
                    (
                        $("<span></span>").addClass("caret")
                    )
                    .appendTo(panel_dropdown);

                    var panel_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                    $.each(panels, function(i, panel)
                    {
                        $("<li></li>").attr("role", "presentation")
                        .append
                        (
                            $("<a></a>")
                            .attr("role", "menuitem")
                            .attr("href", "javascript:void(0);")
                            .text(panel.substring(0, panel.indexOf("[[[")))
                            .click(function()
                            {
                                $(this).parent().parent().prev().css("opacity", "0.2").text("Updating...");
                                var that = $(this);
                                $.post("./data", {"fn": "update_panel_option", "identifier": customer.proposal.identifier, "panel": panel}).done(function(resp2)
                                {
                                    customer.proposal.info = resp2;                                    
                                    $("#reschedule_" + customer.identifier).find(".glyphicon-open-file").trigger("click");
                                });
                            })
                        ).appendTo(panel_ul);
                    });
                    panel_ul.find("li").each(function(i, e)
                    {
                        if($.parseJSON(customer.proposal.info).panel_type.indexOf($(e).text()) > -1)
                        {
                            panel_dropdown.find(".btn").text($(e).text());
                            $("<span></span>").addClass("caret").appendTo(panel_dropdown.find(".btn"));
                        }
                    });
                    panel_ul.appendTo(panel_dropdown);

                    var extra_dropdowns = $("<div></div>").addClass("extra_dropdowns");
                    if(fund_dropdown.find("li").size() > 0)
                    {
                        extra_dropdowns.append
                        (
                            fund_dropdown
                        );
                    }
                    var interest_rate_dropdown = $("<div></div>").addClass("dropdown");
                    $("<p></p>").text("Interest Rate:").appendTo(interest_rate_dropdown);
                    var interest_btn = $("<button></button>").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").attr("type", "button").attr("data-toggle", "dropdown").text("n/a").append($("<span></span>").addClass("caret")).addClass("interest_rate_btn");
                    interest_btn.appendTo(interest_rate_dropdown);
                    var interest_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").addClass("interest_ul");
                    /*$("<li></li>").attr("role", "presentation")
                    .append
                    (
                        $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text("n/a")
                    )
                    .appendTo(interest_ul);*/
                    var append_interest_dropdown = false;
                    $.each(resp.funds, function(iii, fund)
                    {
                        if(fund["value"] === customer.fund)
                        {
                            if(fund.tier_enabled)
                            {
                                append_interest_dropdown = true;
                                $.each(fund.tier_data, function(iiii, tier)
                                {
                                    if(tier.name === customer.funding_tier)
                                    {
                                        interest_btn.text(tier.name).append($("<span></span>").addClass("caret"));
                                    }
                                    /*var li = $("<li></li>").attr("role", "presentation").attr("data-funding_tier", tier.name);
                                    $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);").text(tier.name).appendTo(li);
                                    li.click(function()
                                    {
                                        li.parent().parent().css("opacity", "0.2");
                                        $.post("/data", {"fn": "set_funding_tier_for_booking", "identifier": customer.booking_identifier, "tier": li.data("funding_tier")}).done(function(rrrrrrrrrr)
                                        {
                                            customer.funding_tier = li.data("funding_tier");
                                            prepareCustomerForProposal(customer, panels, panel_points);
                                        });
                                    });
                                    li.appendTo(interest_ul);*/
                                });                            
                            }
                        }                                                
                    });
                    interest_btn.appendTo(interest_rate_dropdown);
                    interest_ul.appendTo(interest_rate_dropdown);                    

                    if(append_interest_dropdown && !customer.requires_proposal)
                    {
                        extra_dropdowns.append
                        (
                            interest_rate_dropdown
                        );
                    }                    
                    if(customer.state === "CA" || true)
                    {
                        extra_dropdowns.append
                        (
                            tier_dropdown
                        );
                    }
                    if(customer.state === "UT")
                    {
                        extra_dropdowns.append
                        (
                            panel_dropdown
                        );
                    }
                    extra_dropdowns.append(panel_type_dropdown);


                    if(!customer.locked)
                    {
                        extra_dropdowns.appendTo(row);
                    }                    

                    var panel_qty_dd = $("<div></div>").addClass("dropdown");
                    if(customer.requires_proposal)
                    {
                        panel_qty_dd.css("display", "none");
                    }
                    $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").text("Lower Panel Qty").attr("data-toggle", "dropdown").append($("<span></span>").addClass("caret")).appendTo(panel_qty_dd);
                    var qty_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");

                    if(typeof($.parseJSON(customer.proposal.info)["new_panel_qty"]) + '' !== "undefined")
                    {
                        panel_qty_dd.find(".btn").text($.parseJSON(customer.proposal.info)["new_panel_qty"] + " panels");
                        $("<span></span>").addClass("caret").appendTo(panel_qty_dd.find(".btn"));
                    }

                    var start = $.parseJSON(customer.proposal.info)["panel_qty"];
                    for(var i = start; i >= 11; i--)
                    {
                        var li = $("<li></li>").attr("role", "presentation")
                        .append
                        (
                            $("<a></a>").attr("href", "javascript:void(0);").attr("tabindex", "-1").text(i).attr("role", "menuitem").text(i + '')
                        );
                        li.click(function()
                        {
                            var that = $(this);
                            that.parent().prevAll(".btn").first().animate({opacity: 0.2}, 250, function()
                            {
                                $.post("./data", {"fn": "tweak_panel_qty", "qty": that.text(), "identifier": customer.proposal.identifier}).done(function(resp)
                                {
                                    var new_info = $.parseJSON(customer.proposal.info);
                                    new_info["new_panel_qty"] = that.text();
                                    customer.proposal.info = JSON.stringify(new_info);
                                    that.parent().prevAll(".btn").text(that.text());
                                    that.parent().prevAll(".btn").append($("<span></span>").addClass("caret"));
                                    that.parent().prevAll(".btn").removeAttr("style");
                                    that.closest(".proposal_form_row").prevAll(".sp2_reschedule").first().find(".glyphicon-open-file").trigger("click");
                                });
                            });
                        }).appendTo(qty_ul);
                    }
                    qty_ul.appendTo(panel_qty_dd);
                    if(!customer.locked)
                    {
                        panel_qty_dd.addClass("panel_qty_dd").appendTo(row);
                    }                    

                    var incentive_sel = $("<select></select>").addClass("incentive_sel");
                    $("<option></option>").attr("value", "n/a").text("Choose One").appendTo(incentive_sel);
                    $("<option></option>").attr("value", "Thermostat").text("Theromostat").appendTo(incentive_sel);
                    //$("<option></option>").attr("value", "Doorbell").text("Doorbell").appendTo(incentive_sel);
                    //$("<option></option>").attr("value", "LED Bulbs").text("LED Bulbs").appendTo(incentive_sel);

                    incentive_sel.val(customer.titan_incentive);

                    incentive_sel.change(function()
                    {
                        $.post("/kv/" + "titan_incentive_" + customer.identifier, {"value": incentive_sel.val(), "ttl": 60 * 60 * 24 * 30}).done(function()
                        {
                        });
                    });

                    incentive_sel.appendTo(panel_qty_dd);


                    $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-primary").addClass("prop_gen_btn").text("Generate Proposal").click(function()
                    {
                        if(customer.fund === "hero")
                        {
                            window.alert("This is a HERO customer.");
                            return;
                        }
                        $(this).css("opacity", "0.3").text("Generating...");
                        var form = $("<form></form>").attr("role", "form").attr("action", "/data?fn=generate_proposal&identifier=" + customer.identifier + "&dt=" + new Date().getTime() + '').attr("method", "POST").attr("id", "temp_proposal_form").attr("name", "temp_proposal_form");
                        form.attr("target", "_blank")
                        $("<input />").attr("type", "hidden").attr("name", "doc_option").attr("value", "proposal_v2").appendTo(form);
                        form.appendTo($("body"));
                        document.forms["temp_proposal_form"].submit();
                        setTimeout(function()
                        {
                            $("form").last().remove();
                        }, 500);

                    }).appendTo(row);

                    $("<button></button>").addClass("btn").addClass("btn-primary").text("Roof Work Quote").css("margin-left", "1em")
                    .click(function()
                    {
                        var roofing_html = $("<div></div>");
                        $("<p></p>").text("What is the square footage of the house (house only, not property)?").appendTo(roofing_html);
                        $("<input />").attr("type", "text").attr("id", "sq_footage").attr("placeholder", "5000").appendTo(roofing_html);
                        $("<br />").appendTo(roofing_html);
                        $("<br />").appendTo(roofing_html);
                        $("<p></p>").text("One-Story or Two-Story house?").appendTo(roofing_html);
                        $("<select></select>").attr("id", "roof_quote_story").css("background", "#000000")
                        .append
                        (
                            $("<option></option>").attr("value", "n/a").text("Choose One")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "one").text("One-Story")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "two").text("Two-Story")
                        )
                        .appendTo(roofing_html);

                        $("<br />").appendTo(roofing_html);
                        $("<br />").appendTo(roofing_html);
                        $("<p></p>").text("How many car garages?").appendTo(roofing_html);
                        $("<select></select>").attr("id", "garage_count").css("background", "#000000")
                        .append
                        (
                            $("<option></option>").attr("value", "0").text("None")
                        )
                        .append
                        (
                            $("<option></option>").attr("selected", "selected").attr("value", "1").text("One")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "2").text("Two")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "3").text("Three")
                        )
                        .appendTo(roofing_html);

                        BootstrapDialog.show
                        (
                            {
                                "title": "Provide parameters for this quote",
                                "message": roofing_html.html(),
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(d)
                                        {
                                            d.close();
                                        }
                                    },
                                    {
                                        "label": "Get Quote",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            var sq_parsed = parseInt($.trim($("#sq_footage").val()));
                                            if(Number.isNaN(sq_parsed))
                                            {
                                                window.alert("The square footage could not be parsed");
                                                return;
                                            }
                                            var stories = $("#roof_quote_story").val();
                                            if(stories === "n/a")
                                            {
                                                window.alert("You must specify whether this is a one-story or two-story house");
                                                return;
                                            }
                                            var garages = $("#garage_count").val();
                                            if(garages === "n/a")
                                            {
                                                window.alert("Please specify the number of garages");
                                                return;
                                            }
                                            var payload2 = {"fn": "get_roof_quote", "identifier": customer.identifier};
                                            payload2["sq_feet"] = sq_parsed + '';
                                            payload2["stories"] = stories;
                                            payload2["garages"] = garages;
                                            $.post("/data", payload2).done(function(quote)
                                            {
                                                d.close();
                                                var quote_html = $("<div></div>");

                                                $("<p></p>")
                                                .text(parseFloat(quote.squares).toFixed(2))
                                                .prepend
                                                (
                                                    $("<b></b>").text("Squares Calculated: ")
                                                )
                                                .appendTo(quote_html);

                                                $("<p></p>")
                                                .text(quote.without_discount)
                                                .prepend
                                                (
                                                    $("<b></b>").text("Sub-Total: ")
                                                )
                                                .appendTo(quote_html);

                                                $("<p></p>")
                                                .text(quote.savings)
                                                .prepend
                                                (
                                                    $("<b></b>").text("Fund Adjustment: ")
                                                )
                                                .appendTo(quote_html);

                                                $("<p></p>")
                                                .text(quote.with_discount)
                                                .prepend
                                                (
                                                    $("<b></b>").text("Grand Total: ")
                                                )
                                                .appendTo(quote_html);

                                                BootstrapDialog.show
                                                (
                                                    {
                                                        "title": "Generated Quote",
                                                        "message": quote_html.html(),
                                                        "buttons":
                                                        [
                                                            {
                                                                "label": "Cancel",
                                                                "cssClass": "btn-danger",
                                                                "action": function(d2)
                                                                {
                                                                    d2.close();
                                                                }
                                                            },
                                                            {
                                                                "label": "Add quote to deal",
                                                                "cssClass": "btn-primary",
                                                                "action": function(d2)
                                                                {
                                                                    window.CUSTOM_OPTION_HACK = true;
                                                                    window.CUSTOM_OPTION_NAME = "Roof Work";
                                                                    var amt9 = quote.with_discount;
                                                                    while(amt9.indexOf("$") > -1)
                                                                    {
                                                                        amt9 = amt9.replace("$", "");
                                                                    }
                                                                    while(amt9.indexOf(",") > -1)
                                                                    {
                                                                        amt9 = amt9.replace(",", "");
                                                                    }
                                                                    window.CUSTOM_OPTION_AMOUNT = amt9;
                                                                    d2.close();
                                                                    $("#system_options_btn_rep_portal").trigger("click");
                                                                }
                                                            }
                                                        ]
                                                    }
                                                );
                                            })
                                        }
                                    }
                                ]
                            }
                        );

                    }).appendTo(row);

                    $("<button></button>").css("display", "none").attr("type", "button").addClass("btn").addClass("btn-primary").text("Generate System Layout").addClass("docs_gen_btn").click(function()
                    {
                        var bad2 = false;
                        var inpho2 = $.parseJSON(customer.proposal.info)
                        if(typeof(inpho2["panel_type"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["panel_qty"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["inverter_type"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["inverter_qty"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["racking"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }

                        if(bad2)
                        {
                            window.alert("One or more required pieces of information are missing. Therefore, the documents cannot be generated.");
                            return;
                        }
                        $(this).css("opacity", "0.3").text("Generating...");
                        var form = $("<form></form>").attr("role", "form").attr("action", "/data?fn=generate_proposal&identifier=" + customer.identifier + "&dt=" + new Date().getTime() + '').attr("method", "POST").attr("id", "temp_proposal_form").attr("name", "temp_proposal_form");
                        form.attr("target", "_blank")
                        $("<input />").attr("type", "hidden").attr("name", "doc_option").attr("value", "system_layout").appendTo(form);
                        form.appendTo($("body"));
                        document.forms["temp_proposal_form"].submit();
                        setTimeout(function()
                        {
                            $("form").last().remove();
                        }, 500);
                    }).appendTo(row);

                    $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-primary").text("Generate Documents").addClass("docs_gen_btn_2").click(function()
                    {
                        var bad2 = false;
                        var inpho2 = $.parseJSON(customer.proposal.info)
                        if(typeof(inpho2["panel_type"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["panel_qty"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["inverter_type"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["inverter_qty"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }
                        if(typeof(inpho2["racking"]) + '' === "undefined")
                        {
                            bad2 = true;
                        }

                        if(bad2)
                        {
                            window.alert("One or more required pieces of information are missing. Therefore, the documents cannot be generated.");
                            return;
                        }

                        var html1 = $("<div></div>");
                        html1.append($("<p></p>").text("Provide additional info..."));
                        html1.append($("<br />"));
                        html1.append($("<input />").attr("type", "text").attr("placeholder", "Name of person on utility bill...").addClass("utility_bill_person"));
                        html1.append($("<br />"));
                        $("<p></p>").text("Utility Account #").appendTo(html1);
                        $("<input />").attr("type", "text").attr("placeholder", "234234...").appendTo(html1).attr("id", "gd_u_num");
                        $("<br />").appendTo(html1);
                        $("<p></p>").text("Amps (REQUIRED for Missouri customers, DO NOT LEAVE BLANK)").appendTo(html1);
                        $("<input />").attr("type", "text").attr("placeholder", "123.4").attr("id", "miss_amps").appendTo(html1);
                        $("<br />").appendTo(html1);
                        $("<p></p>").text("Volts (REQUIRED for Missouri customers, DO NOT LEAVE BLANK)").appendTo(html1);
                        $("<input />").attr("type", "text").attr("placeholder", "342.5").attr("id", "miss_volts").appendTo(html1);
                        html1.append($("<br />"));
                        html1.append($("<br />"));
                        var incentive_dd = $("<div></div>").addClass("dropdown");
                        $("<button></button>").attr("type", "button").addClass("btn").addClass("btn-default").addClass("dropdown-toggle").addClass("incentive_button").text("Select an Incentive").attr("data-toggle", "dropdown").append
                        (
                            $("<span></span>").addClass("caret")
                        ).appendTo(incentive_dd);
                        var incentive_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu").addClass("incentive_ul");

                        var incentive_options =
                        [
                            "Skydrop and LED package",
                            "Nest and LED package",
                            "None",
                            "Other"
                        ];

                        $.each(incentive_options, function(i, incentive_option)
                        {
                            var li = $("<li></li>").attr("role", "presentation");
                            var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");
                            a.text(incentive_option);
                            a.appendTo(li);
                            li.appendTo(incentive_ul);
                        });

                        incentive_ul.appendTo(incentive_dd);
                        $("<input />").attr("type", "hidden").attr("id", "incentive_option").appendTo(incentive_dd);
                        incentive_dd.appendTo(html1);
                        $("<br />").appendTo(html1);
                        $("<textarea></textarea>").attr("placeholder", "What's the incentive?").addClass("incentive_ta").css("display", "none").appendTo(html1);

                        if(customer.fund.toLowerCase().indexOf("greensky") > -1)
                        {
                            $("<br />").appendTo(html1);
                            $("<input />").attr("type", "text").addClass("shopping_acct_num").attr("placeholder", "Card Acct Number").appendTo(html1);
                            $("<br />").appendTo(html1);
                            $("<br />").appendTo(html1);
                            var sel = $("<select></select>").attr("id", "exp_month");
                            $("<option value='n/a'>Exp. Month</option>").appendTo(sel);
                            $.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], function(kkk, num)
                            {
                                var num_txt = num + '';
                                if(num_txt.length === 1)
                                {
                                    num_txt = "0" + num_txt;
                                }
                                $("<option></option>").attr("value", num + '').text(num_txt).appendTo(sel);
                            });

                            var sel2 = $("<select></select>").attr("id", "exp_year");
                            $("<option value='n/a'>Exp. Year</option>").appendTo(sel2);
                            for(var num = moment().year(); num < moment().year() + 10; num++)
                            {
                                $("<option></option>").attr("value", num + '').text(num + '').appendTo(sel2);
                            }

                            sel.appendTo(html1);
                            sel2.appendTo(html1);
                            $("<br />").appendTo(html1);
                            $("<br />").appendTo(html1);
                            $("<input />").attr("type", "text").addClass("cvv_num").attr("placeholder", "CVV #").appendTo(html1);
                        }
                        $("<br />").appendTo(html1);
                        $("<br />").appendTo(html1);
                        $("<b></b>").css("display", "block").text("Do you need to change the customer name or email?").appendTo(html1);
                        $("<select></select>").attr("id", "update_customer_details").css("display", "block")
                        .append
                        (
                            $("<option value='N/A'>Choose One</option>")
                        )
                        .append
                        (
                            $("<option value='1'>Yes</option>")
                        )
                        .append
                        (
                            $("<option value='0'>No</option>")
                        )
                        .appendTo(html1);

                        $("<br />").appendTo(html1);
                        

                        $("<div></div>").addClass("docs_update_customer_details_div").css("display", "none")
                        .append
                        (
                            $("<input />").attr("type", "text").attr("placeholder", "First Name")
                        )
                        .append
                        (
                            $("<input />").attr("type", "text").attr("placeholder", "Last Name")
                        )
                        .append
                        (
                            $("<input />").attr("type", "email").attr("placeholder", "customer@domain.com")
                        )
                        .append
                        (
                            $("<br />")
                        )
                        .appendTo(html1);

                        $("<select></select>").attr("id", "signing_mode")
                        .append
                        (
                            $("<option value='digital' selected='selected'>Digital Signing</option>")
                        )
                        //.append
                        //(
                            //$("<option value='legacy'>Print and Sign w/Pen</option>")
                        //)
                        .appendTo(html1);


                        BootstrapDialog.show
                        (
                            {
                                "title": "Not so fast",
                                "message": html1.html(),
                                "onshown": function(dialog)
                                {
                                    $("#cosign_cb")
                                    .change(function()
                                    {
                                        var that5 = $(this);
                                        if(that5[0].checked)
                                        {
                                            $("#cosigner_details").css("display", "block");
                                        }
                                        else
                                        {
                                            $("#cosigner_details").css("display", "none");
                                        }
                                    });
                                    $(".incentive_ul li").each(function(i, e)
                                    {
                                        $(e).click(function()
                                        {
                                            $(e).parent().prevAll("button").first().text($(e).text());
                                            $("<span></span>").addClass("caret").appendTo($(e).parent().prevAll("button").first());

                                            $("#incentive_option").val($(e).text());
                                            if($(e).nextAll("li").size() === 0)
                                            {
                                                $(".incentive_ta").css("display", "block");
                                            }
                                            else
                                            {
                                                $(".incentive_ta").css("display", "none");
                                            }
                                        });
                                    });

                                    $("#update_customer_details").change(function()
                                    {
                                        var v = $(this).val();
                                        if(v === "1")
                                        {
                                            $(".docs_update_customer_details_div").css("display", "block");
                                        }
                                        else
                                        {
                                            $(".docs_update_customer_details_div").css("display", "none");
                                        }
                                    });

                                    if(customer.email === "didnt_want_to_provide_email@no_domain.com")
                                    {
                                        $("#update_customer_details")[0].selectedIndex = 1;
                                        $("#update_customer_details").trigger("change");
                                        $("#update_customer_details").attr("disabled", "disabled");
                                        $(".docs_update_customer_details_div").find("input").first().val("Please Wait...");
                                        $(".docs_update_customer_details_div").find("input").eq(1).val("Please Wait...");
                                        $.post("/data", {"fn": "get_first_and_last_for_cust", "identifier": customer.identifier}).done(function(name_details)
                                        {
                                            $(".docs_update_customer_details_div").find("input").first().val(name_details.first);
                                            $(".docs_update_customer_details_div").find("input").eq(1).val(name_details.last);
                                        });
                                    }
                                },
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(dialog)
                                        {
                                            dialog.close();
                                        }
                                    },
                                    {
                                        "label": "Add Cosigner",
                                        "cssClass": "btn-success",
                                        "action": function(dialog) {
                                            let co_name = window.prompt("Please enter the cosigner's name");
                                            $.post("/kv/cosigner_name_" + customer.identifier, {"value": co_name, "ttl": (60 * 60 * 24 * 30).toString()}).done(function()
                                            {
                                                dialog.close();
                                            });
                                        }
                                    },
                                    {
                                        "label": "Remove Cosigner",
                                        "cssClass": "btn-danger",
                                        "action": function(dialog) {
                                            fetch
                                            (
                                                "/kv/cosigner_name_" + customer.identifier,
                                                {
                                                    "method": "DELETE"
                                                }
                                            )
                                            .then((resp) =>
                                            {
                                                dialog.close();
                                            })
                                        }
                                    },
                                    {
                                        "label": "Continue",
                                        "cssClass": "btn-success gendocssubbtn",
                                        "action": function(dialog)
                                        {
                                            if($.trim($(".utility_bill_person").val()).length === 0)
                                            {
                                                window.alert("You must specify the person on the utility bill");
                                                return;
                                            }
                                            if($(".incentive_button").text().toLowerCase().indexOf("select") > -1)
                                            {
                                                window.alert("You must specify the incentive");
                                                return;
                                            }

                                            if($("#incentive_option").val().toLowerCase() === "other")
                                            {
                                                if($.trim($(".incentive_ta").val()).length === 0)
                                                {
                                                    window.alert("You must describe the other incentive option");
                                                    return;
                                                }
                                            }

                                            if(customer.fund.toLowerCase().indexOf("greensky") > -1)
                                            {
                                                if($.trim($(".shopping_acct_num").val()).length < 1)
                                                {
                                                    window.alert("You must provide the Account Card #");
                                                    return;
                                                }
                                                if($.trim($(".cvv_num").val()).length === 0)
                                                {
                                                    window.alert("You must provide the CVV #");
                                                    return;
                                                }
                                                if($("#exp_month").val() === "n/a")
                                                {
                                                    window.alert("You must provide the expiration month");
                                                    return;
                                                }
                                                if($("#exp_year").val() === "n/a")
                                                {
                                                    window.alert("You must provide the expiration year");
                                                    return;
                                                }
                                            }
                                            if($("#update_customer_details").val().toLowerCase() === "n/a")
                                            {
                                                window.alert("You must specify whether you are updating the customer's name or not.");
                                                return;
                                            }

                                            $(".gendocssubbtn").css("opacity", "0.2").text("Generating Docs...");
                                            var clone = $(".incentive_button").clone();
                                            clone.find("span").remove();

                                            var incentive = clone.text();
                                            if(incentive === "Other")
                                            {
                                                incentive = $.trim($(".incentive_ta").val());
                                            }
                                            if($.trim($("#gd_u_num").val()).length === 0)
                                            {
                                                window.alert("You must provide the utility number");
                                                return;
                                            }

                                            var payload = {"fn": "docs_compile", "identifier": customer.identifier, "utility_person": $.trim($(".utility_bill_person").val()), "incentive": incentive};
                                            payload["miss_amps"] = $.trim($("#miss_amps").val());
                                            payload["miss_volts"] = $.trim($("#miss_volts").val());
                                            payload["u_num"] = $("#gd_u_num").val();
                                            if(customer.fund.toLowerCase().indexOf("greensky") > -1)
                                            {
                                                payload["is_greensky"] = "1";
                                                payload["acct_num"] = $.trim($(".shopping_acct_num").val());
                                                payload["exp_year"] = $("#exp_year").val();
                                                payload["exp_month"] = $("#exp_month").val();
                                                payload["cvv"] = $.trim($(".cvv_num").val());
                                            }
                                            payload["mode"] = $("#signing_mode").val();

                                            var post_for_docs_fn = function()
                                            {
                                                $.post("./data", payload).done(function(resp55)
                                                {
                                                    dialog.close();
                                                    BootstrapDialog.show
                                                    (
                                                        {
                                                            "title": "Keep an eye on your inbox",
                                                            "message": "Your documents are on their way via email...(please wait at least 10 minutes before retrying)"
                                                        }
                                                    );
                                                });
                                            };

                                            if($("#update_customer_details").val() === "1")
                                            {
                                                var input_idxs = ["first name", "last name", "email address"];
                                                var ret_early5 = false;
                                                $(".docs_update_customer_details_div input").each(function(mmm, nnn)
                                                {
                                                    if($.trim($(nnn).val()) === "")
                                                    {
                                                        if(!ret_early5)
                                                        {
                                                            window.alert("You must provide the customer's new " + input_idxs[mmm] + ".");
                                                            ret_early5 = true;
                                                        }
                                                    }

                                                });
                                                if(ret_early5)
                                                {
                                                    return;
                                                }

                                                var fffff = $.trim($(".docs_update_customer_details_div input").eq(0).val());
                                                var lllll = $.trim($(".docs_update_customer_details_div input").eq(1).val());
                                                var eeeee = $.trim($(".docs_update_customer_details_div input").eq(2).val());
                                                var aaaaa = customer.address;

                                                $.post("./data", {"fn": "update_customer_details", "f": fffff, "l": lllll, "e": eeeee, "a": aaaaa, "identifier": customer.identifier}).done(function(resp99cents)
                                                {
                                                    post_for_docs_fn();
                                                });
                                            }
                                            else
                                            {
                                                post_for_docs_fn();
                                            }
                                        }
                                    }
                                ]
                            }
                        );

                    }).appendTo(row);

                    $("<button></button>").addClass("btn").addClass("btn-primary").text("Tax Info").addClass("tax_info_btn")
                    .click(function()
                    {
                        var tax_btn = $(this);
                        tax_btn.css("opacity", "0.2");
                        $.post("/data", {"fn": "tax_info_for_customer", "identifier": customer.identifier}).done(function(rrrrr)
                        {                           
                            var html = $("<div></div>");
                            $("<p></p>").text("Choose a filing Status:").appendTo(html);

                            var filing_status_sel = $("<select></select>").attr("id", "filing_status_sel");
                            $("<option></option>").attr("value", "n/a").text("Choose One").appendTo(filing_status_sel);
                            $.each(window.tax_data, function(iii, t_data)
                            {
                                var opt = $("<option></option>").text(t_data.name).attr("value", t_data.name);
                                if(rrrrr.filing_status === t_data.name)
                                {
                                    opt.attr("selected", "selected");
                                }
                                opt.appendTo(filing_status_sel);
                            });

                            filing_status_sel.appendTo(html);

                            $("<p></p>").text("Choose a federal income bracket:").appendTo(html);
                            var percentage_sel = $("<select></select>").attr("id", "federal_tax_percentage_sel");
                            $("<option></option>").attr("value", "n/a").text("Choose One").appendTo(percentage_sel);
                            percentage_sel.appendTo(html);

                            $("<p></p>").text("Choose a state income bracket:").appendTo(html);
                            var percentage_sel2 = $("<select></select>").attr("id", "state_tax_percentage_sel");
                            $("<option></option>").attr("value", "n/a").text("Choose One").appendTo(percentage_sel2);
                            percentage_sel2.appendTo(html);
                            

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Tax and Income Information",
                                    "message": html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Cancel",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                d.close();
                                                tax_btn.css("opacity", "1.0");
                                            }
                                        },
                                        {
                                            "label": "Save",
                                            "cssClass": "btn-primary",
                                            "action": function(d)
                                            {
                                                if($("#filing_status_sel").val() === "n/a")
                                                {
                                                    window.alert("Please choose a filing status");
                                                    return;
                                                }
                                                if($("#federal_tax_percentage_sel").val() === "n/a")
                                                {
                                                    window.alert("Please specify the federal income bracket");
                                                    return;
                                                }
                                                if($("#state_tax_percentage_sel").val() === "n/a")
                                                {
                                                    window.alert("Please specify the state income bracket");
                                                    return;
                                                }
                                                $.post("/data", {"fn": "update_tax_info", "identifier": customer.identifier, "filing_status": $("#filing_status_sel").val(), "federal_percentage": $("#federal_tax_percentage_sel").val(), "state_percentage": $("#state_tax_percentage_sel").val()}).done(function(rrrrrr)
                                                {
                                                    d.close();
                                                    tax_btn.css("opacity", "1.0");
                                                });                                                
                                            }
                                        }
                                    ],
                                    "onshown": function(d)
                                    {
                                        window.filing_status_change_count = 0;
                                        $("#filing_status_sel").on("change", function()
                                        {
                                            var that = $(this);
                                            $("#federal_tax_percentage_sel").find("option").each(function(iii, eee)
                                            {
                                                if(iii > 0)
                                                {
                                                    $(eee).remove();
                                                }
                                            });
                                            $("#state_tax_percentage_sel").find("option").each(function(iii, eee)
                                            {
                                                if(iii > 0)
                                                {
                                                    $(eee).remove();
                                                }
                                            });
                                            window.filing_status_change_count++;

                                            $.each(window.tax_data, function(iii, t_data)
                                            {
                                                if(t_data.name === that.val())
                                                {
                                                    $.each(t_data.federal.brackets, function(iiii, bracket)
                                                    {
                                                        var txt = currencyFormat(parseFloat(bracket.floor.replace("$", "")));
                                                        txt += " - ";
                                                        txt += currencyFormat(parseFloat(bracket.ceiling.replace("$", "")));
                                                        txt += " | "
                                                        txt += bracket.percentage;
                                                        var opt = $("<option></option>").attr("value", bracket.percentage).text(txt);
                                                        if(window.filing_status_change_count === 1)
                                                        {
                                                            if(bracket.percentage === rrrrr.federal_percentage)
                                                            {
                                                                opt.attr("selected", "selected");
                                                            }
                                                        }
                                                        opt.appendTo($("#federal_tax_percentage_sel"));
                                                    });

                                                    $.each(t_data.state.brackets, function(iiii, bracket)
                                                    {
                                                        var txt = currencyFormat(parseFloat(bracket.floor.replace("$", "")));
                                                        txt += " - ";
                                                        txt += currencyFormat(parseFloat(bracket.ceiling.replace("$", "")));
                                                        txt += " | "
                                                        txt += bracket.percentage;
                                                        var opt = $("<option></option>").attr("value", bracket.percentage).text(txt);
                                                        if(window.filing_status_change_count === 1)
                                                        {
                                                            if(bracket.percentage === rrrrr.state_percentage)
                                                            {
                                                                opt.attr("selected", "selected");
                                                            }
                                                        }
                                                        opt.appendTo($("#state_tax_percentage_sel"));
                                                    });
                                                }
                                            });
                                        });

                                        $("#filing_status_sel").trigger("change");
                                    }
                                }
                            )

                        });
                    }).appendTo(row);

                    $("<button></button>").addClass("btn").addClass("btn-primary").text("Customer Support Plan").attr("id", "cs_plan")
                    .click(function()
                    {
                        let that = $(this);
                        that.css("opacity", "0.5");
                        $.getJSON("/data?fn=cs_plan_lookup&identifier=" + customer.identifier).done(function(cs_resp)
                        {
                            that.css("opacity", "1.0");

                            let html = $("<div></div>");
                            $("<b>Monthly Price:</b>").appendTo(html);
                            $("<br />").appendTo(html);
                            $("<br />").appendTo(html);
                            $("<br />").appendTo(html);

                            let sel = $("<select></select>").attr("id", "cs_price_sel");
                            $("<option></option>").attr("value", "-1").text("Unsubscribed").appendTo(sel);

                            for(var i = 5; i < 30; i += 5)
                            {
                                let opt = $("<option></option>");
                                opt.attr("value", i.toString()).text("$" + i.toString()).appendTo(sel);
                                if(i === cs_resp.price)
                                {
                                    opt.attr("selected", "selected");
                                }
                                opt.appendTo(sel);
                            }
                            sel.appendTo(html);

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Let's Sign Up",
                                    "message": html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Done",
                                            "cssClass": "btn-primary",
                                            "action": function(cs_d)
                                            {
                                                cs_d.close();
                                            }
                                        }
                                    ],
                                    "onshown": function(cs_d)
                                    {
                                        $("#cs_price_sel")
                                        .change(function()
                                        {
                                            $.post("/data", {"fn": "cs_plan_set", "identifier": customer.identifier, "price": $("#cs_price_sel").val()});
                                        });
                                    }
                                }
                            );

                        });
                    }).appendTo(row);
                    $("<button></button>").addClass("btn").addClass("btn-primary").text("Bank Details").attr("id", "bank_details")
                    .click(function()
                    {
                        let html = $("<div></div>");
                        $("<b></b>").text("Checking Account #").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<input />").attr("type", "text").attr("id", "checking_details").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<b></b>").text("Routing #").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<input />").attr("type", "text").attr("id", "routing_details").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<b></b>").text("Name of Bank").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<input />").attr("type", "text").attr("id", "bank_name_details").appendTo(html);
                        
                        BootstrapDialog.show
                        (
                            {
                                "buttons":
                                [
                                    {
                                        "label": "Cancel",
                                        "cssClass": "btn-danger",
                                        "action": function(d3)
                                        {
                                            d3.close();
                                        }
                                    },
                                    {
                                        "label": "Update",
                                        "cssClass": "btn-success",
                                        "action": function(d9)
                                        {
                                            let account_num = $("#checking_details").val().trim();
                                            let routing_num = $("#routing_details").val().trim();

                                            $.post("/data", {"fn": "update_bank", "identifier": customer.identifier, "account": account_num, "routing": routing_num, "bank_name": $("#bank_name_details").val()})
                                            d9.close();
                                
                                        }
                                    }
                                ],
                                "message": html.html(),
                                "title": "Monetary Info",
                                "onshown": function(d9)
                                {
                                    $.getJSON("/kv/" + customer.identifier + "_bank").done(function(k_r)
                                    {
                                        if(k_r.value !== null)
                                        {
                                            let deserialized_f = JSON.parse(k_r.value);
                                            $("#checking_details").val(deserialized_f.account);
                                            $("#routing_details").val(deserialized_f.routing);
                                            $("#bank_name_details").val(deserialized_f.bank_name)
                                        }
                                    })
                                }
                            }
                        );

                        //$.post("/data", {"fn": "set_bank_details", "identifier": customer.identifier})
                    })
                    .appendTo(row);


                    $("<button></button>").addClass("btn").addClass("btn-success").text("Close Deal").addClass("close_deal_btn")
                    .click(function()
                    {
                        var html = $("<div></div>");
                        //$("<div></div>").text("Have you uploaded all the documents?").appendTo(html);
                        var yes_no_dd = $("<div></div>").addClass("dropdown");
                        var y_n_btn = $("<button></button>").addClass("btn").addClass("btn-default").attr("type", "button").addClass("dropdown-toggle").attr("data-toggle", "dropdown").text("Select One").append($("<span></span>").addClass("caret"));
                        y_n_btn.appendTo(yes_no_dd);
                        var y_n_ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                        $("<li></li>").append
                        (
                            $("<a></a>").text("Yes")
                        ).click(function()
                        {
                            $(this).parent().prevAll(".btn").text($(this).text());
                            $("<span></span>").addClass("caret").appendTo($(this).parent().prevAll(".btn").first());
                            $(this).parent().parent().nextAll(".dropdown").first().css("display", "block");
                        }).appendTo(y_n_ul);
                        $("<li></li>").append
                        (
                            $("<a></a>").text("No")
                        ).click(function()
                        {
                            $.each(BootstrapDialog.dialogs, function(i, e)
                            {
                                e.close();
                            });
                        }).appendTo(y_n_ul);
                        y_n_ul.appendTo(yes_no_dd);

                        //yes_no_dd.appendTo(html);

                        //$("<br />").appendTo(html);
                        //$("<br />").appendTo(html);
                        //$("<div></div>").addClass("dropdown").css("display", "none").append
                        //(
                            //$("<input />").attr("type", "text").attr("placeholder", "https://link_to_shared_folder").addClass("shared_uplink")
                        //).appendTo(html);

                        //$("<br />").appendTo(html);
                        //$("<br />").appendTo(html);

                        $("<p></p>").text("Utility Account #").appendTo(html);
                        $("<input />").attr("type", "text").attr("id", "close_deal_utility_number").attr("placeholder", "862311532").appendTo(html);
                        $("<p></p>").text("Optional special note for admin:").appendTo(html);
                        $("<textarea></textarea>").addClass("special_note_admin").attr("placeholder", "The optional note...").appendTo(html);
                        $("<br />").appendTo(html);

                        $("<p></p>").text("Photo of Utility Bill (CLEAR").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_bill_photo").appendTo(html);
                        $("<hr />").appendTo(html);
                        //$("<p></p>").text("Electrical Panel Photo # 1 (Required").appendTo(html);
                        $("<p></p>").text("Photo # 1 (All Breakers)").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_panel_photo_1").appendTo(html);
                        //$("<p></p>").text("Electrical Panel Photo #2 (Required").appendTo(html);
                        $("<p></p>").text("Photo #2 (# On Main Breaker)").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_panel_photo_2").appendTo(html);
                        $("<p></p>").text("Photo #3 (What each breaker is for/layout)").appendTo(html);
                        //$("<p></p>").text("Electrical Panel Photo #3 (Required").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_panel_photo_3").appendTo(html);
                        //$("<p></p>").text("Electrical Panel Photo #4 (Required").appendTo(html);
                        $("<p></p>").text("Photo #4 (Stand Back 10 feet, Capture box on wall)").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_panel_photo_4").appendTo(html);
                        //$("<p></p>").text("Electrical Panel Photo #5 (Required").appendTo(html);
                        $("<p></p>").text("Photo #5 (Stand Back 20 feet, Capture where box is on the house)").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "req_panel_photo_5").appendTo(html);
                        $("<hr />").appendTo(html);
                        $("<p></p>").text("Roof Photo #1 (Optional").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "roof_panel_photo_1").appendTo(html);
                        $("<p></p>").text("Roof Photo #2 (Optional").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "roof_panel_photo_2").appendTo(html);
                        $("<p></p>").text("Roof Phot0 #3 (Optional").appendTo(html);
                        $("<input />").attr("type", "file").attr("id", "roof_panel_photo_3").appendTo(html);


                        $("<br />").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<br />").appendTo(html);
                        $("<br />").appendTo(html);



                        html.find(".dropdown").first().find("li").first().click(function()
                        {
                            $(this).parent().prevAll(".btn").first().text($(this).text());
                            $("<span></span>").addClass("caret").appendTo($(this).parent().prevAll(".btn").first());
                            $(this).parent().parent().nextAll(".dropdown").css("display", "block");
                        });

                        var pre_html = $("<div></div>");
                        var closing_checklists = {{deal_closing_checklists|safe}};
                        var checklist_total = 0;
                        $.each(Object.keys(closing_checklists), function(iiiii, kkkkk)
                        {
                            if(kkkkk === customer.fund)
                            {
                                checklist_total = closing_checklists[kkkkk].length;
                                $.each(closing_checklists[kkkkk], function(iiiiii, checklist_item)
                                {
                                    $("<p></p>").text(checklist_item)
                                    .append
                                    (
                                        $("<input />").addClass("deal_closed_checklist_item").attr("type", "checkbox")
                                    )
                                    .appendTo(pre_html);
                                });
                            }
                        });

                        BootstrapDialog.show
                        (
                            {
                                "title": "Have you completed the following?",
                                "message": pre_html,
                                "buttons":
                                [
                                    {
                                        "label": "No",
                                        "cssClass": "btn-danger",
                                        "action": function(ddd)
                                        {
                                            ddd.close();
                                        }
                                    },
                                    {
                                        "label": "All Items Checked",
                                        "cssClass": "btn-primary",
                                        "action": function(ddd)
                                        {
                                            var checklist_tally = 0;
                                            $(".deal_closed_checklist_item").each(function(iiiii, eeeee)
                                            {
                                                checklist_tally += ($(eeeee)[0].checked * 1);
                                            });
                                            if(checklist_tally !== checklist_total)
                                            {
                                                window.alert("You must first complete and check-off each item in the list above before closing the deal.");
                                                return;
                                            }
                                            else
                                            {
                                                ddd.close();

                                                BootstrapDialog.show
                                                (
                                                    {
                                                        "title": "What's with this deal?",
                                                        "message": "",
                                                        "onshown": function(dialog)
                                                        {
                                                            html.appendTo($(".bootstrap-dialog-message"));
                                                        },
                                                        "buttons":
                                                        [
                                                            {
                                                                "label": "Nevermind",
                                                                "cssClass": "btn-danger",
                                                                "action": function(dialog)
                                                                {
                                                                    dialog.close();
                                                                }
                                                            },
                                                            {
                                                                "label": "Close it!",
                                                                "cssClass": "btn-primary",
                                                                "action": function(dialog)
                                                                {
                                                                    var dialog_div = $(".bootstrap-dialog-body");
                                                                    //if($.trim(dialog_div.find(".shared_uplink").val()).indexOf("http") !== 0)
                                                                    //{
                                                                        //window.alert("The shared link must be a URL starting with 'http://' or 'https://'.");
                                                                        //return;
                                                                    //}
                                                                    if($.trim($("#close_deal_utility_number").val()) === "")
                                                                    {
                                                                        window.alert("Please specify the utility account number for this customer.");
                                                                        return;
                                                                    }                                                                    

                                                                    if($("#req_bill_photo")[0].files.length === 0)
                                                                    {
                                                                        window.alert("You must provide the bill photo");
                                                                        return;
                                                                    }
                                                                    for(var iii = 1; iii < 6; iii++)
                                                                    {
                                                                        if($("#req_panel_photo_" + (iii + ''))[0].files.length === 0)
                                                                        {
                                                                            window.alert("You must provide all electrical panel photos");
                                                                            return;
                                                                        }
                                                                    }
                                                                    $(".bootstrap-dialog-footer").remove();

                                                                    var formData = new FormData();
                                                                    formData.append("fn", "close_reps_deal_v2");
                                                                    formData.append("utility_number", $.trim($("#close_deal_utility_number").val()));
                                                                    //formData.append("link", $(".shared_uplink").val());
                                                                    formData.append("identifier", customer.identifier);
                                                                    formData.append("user_identifier", window.user_identifier)
                                                                    
                                                                    // compress the images
                                                                    $(".bootstrap-dialog-body").find("*").css("display", "none")
                                                                    .append
                                                                    (
                                                                        $("<p></p>").html("<br />Please wait while your images are being compressed.<br />")
                                                                    );
                                                                    
                                                                    

                                                                    var bill_photo = new Compressor
                                                                    (
                                                                        $("#req_bill_photo")[0].files[0],
                                                                        {
                                                                            "quality": 0.35,
                                                                            "success": function(result)
                                                                            {
                                                                                formData.append("req_bill_photo", result, 'bill.jpg');

                                                                                var compressor_data = [];
                                                                                var compressor_items = [];
                                                                                var first_callback_interval = null;
                                                                                first_callback_interval = setInterval(function()
                                                                                {
                                                                                    if(compressor_data.length === 5)
                                                                                    {
                                                                                        clearInterval(first_callback_interval);
                                                                                        for(var eye = 1; eye < 6; eye++)
                                                                                        {
                                                                                            formData.append("req_panel_photo_" + (eye + ''), compressor_data[eye - 1]);                                                                                                                                                                                         
                                                                                            
                                                                                        }
                                                                                        var r_tally = 0;
                                                                                        var compressor_data_2 = [];
                                                                                        var compressor_objects_2 = [];
                                                                                        
                                                                                        for(var eye2 = 1; eye2 < 4; eye2++)
                                                                                        {
                                                                                            r_tally += (($("#roof_panel_photo_" + (eye2 + ''))[0].files.length > 0) * 1);
                                                                                            /*if($("#roof_panel_photo_" + (iii + ''))[0].files.length > 0)
                                                                                            {
                                                                                                formData.append("roof_panel_photo_" + (iii + ''), $("#roof_panel_photo_" + (iii + ''))[0].files[0]);
                                                                                            }*/
                                                                                        }
                                                                                        formData.append("roof_photo_tallly", r_tally + '');

                                                                                        var second_callback_interval = null;
                                                                                        second_callback_interval = setInterval(function()
                                                                                        {
                                                                                            if(compressor_data_2.length === r_tally)
                                                                                            {
                                                                                                clearInterval(second_callback_interval);

                                                                                                for(var q = 0; q < r_tally; q++)
                                                                                                {
                                                                                                    formData.append("roof_panel_photo_" + ((q + 1) + ''), compressor_data_2[q], 'foo9.jpg');
                                                                                                }

                                                                                                var xhr = new XMLHttpRequest();

                                                                                                xhr.addEventListener("load", function(e)
                                                                                                {
                                                                                                    var respyah = $.parseJSON(e.target.responseText);
                                                                                                    if(respyah.success)
                                                                                                    {
                                                                                                        if($.trim($(".special_note_admin").val()).length > 0)
                                                                                                        {
                                                                                                            $.post("./data", {"fn": "add_note_for_customer", "identifier": customer.identifier, "has_file": "0", "txt": $.trim($(".special_note_admin").val()), "nkey": "panel_work"}).done(function(resp987123)
                                                                                                            {
                                                                                                                $.post("./data", {"fn": "save_closing_notes", "notes": $.trim($(".special_note_admin").val()), "identifier": customer.identifier}).done(function(kkyah)
                                                                                                                {
                                                                                                                    dialog.close();
                                                                                                                    $("body").css("opacity", "0.3");
                                                                                                                    localStorage.setItem("button_to_click", "sp_schedule_icon");
                                                                                                                    window.location.reload();
                                                                                                                });                                                            
                                                                                                            });
                                                                                                        }
                                                                                                        else
                                                                                                        {
                                                                                                            dialog.close();
                                                                                                            $("body").css("opacity", "0.3");
                                                                                                            localStorage.setItem("button_to_click", "sp_schedule_icon");
                                                                                                            window.location.reload();
                                                                                                        }
                                                                                                    }
                                                                                                    else
                                                                                                    {
                                                                                                        dialog.close();
                                                                                                        BootstrapDialog.alert("The deal could not be closed. Please wait at least 10 minutes after the customer completes the signing process before you mark the deal as closed. ");
                                                                                                    }
                                                                                                });
                                                                                                xhr.open("POST", "./data");
                                                                                                xhr.send(formData);
                                                                                            }
                                                                                        }, 1000);

                                                                                        for(var k = 1; k < 4; k++)
                                                                                        {
                                                                                            if($("#roof_panel_photo_" + (k + ''))[0].files.length > 0)
                                                                                            {
                                                                                                compressor_objects_2.push
                                                                                                (
                                                                                                    new Compressor
                                                                                                    (
                                                                                                        $("#roof_panel_photo_" + (k + ''))[0].files[0],
                                                                                                        {
                                                                                                            "quality": 0.35,
                                                                                                            "success": function(final_result)
                                                                                                            {
                                                                                                                compressor_data_2.push(final_result);              
                                                                                                            }
                                                                                                        }
                                                                                                    )
                                                                                                );
                                                                                            }
                                                                                        }                                                                                        
                                                                                        

                                                                                    }
                                                                                }, 1000);

                                                                                for(var iii = 1; iii < 6; iii++)
                                                                                {
                                                                                    compressor_items.push
                                                                                    (
                                                                                        new Compressor
                                                                                        (
                                                                                            $("#req_panel_photo_" + (iii + ''))[0].files[0],
                                                                                            {
                                                                                                "quality": 0.35,
                                                                                                "success": function(req_result)
                                                                                                {
                                                                                                    compressor_data.push(req_result);              
                                                                                                }
                                                                                            }
                                                                                        )
                                                                                    );
                                                                                    //formData.append("req_panel_photo_" + (iii + ''), $("#req_panel_photo_" + (iii + ''))[0].files[0]);
                                                                                }                                                                                
                                                                            }
                                                                        }
                                                                    );
                                                                    
                                                                }
                                                            }
                                                        ]
                                                    }
                                                );
                                            }

                                        }
                                    }
                                ]
                            }
                        );


                    
                    }).appendTo(row);

                    if(!customer.locked && customer.requires_proposal === false)
                    {
                        $("<button></button>").addClass("btn").addClass("btn-primary").text("System Options").addClass("additional_costs_button")
                        .attr("id", "system_options_btn_rep_portal")
                        .click(function(ev)
                        {
                            ev.stopPropagation();
                            if(customer.fund === "spruce_ppa")
                            {
                                BootstrapDialog.show
                                (
                                    {
                                        "title": "Unavailable",
                                        "message": "To add additional costs to a PPA, please consult with Thomas or Rob.",
                                        "buttons":
                                        [
                                            {
                                                "label": "Got it!",
                                                "cssClass": "btn-primary",
                                                "action": function(d)
                                                {
                                                    d.close();
                                                }
                                            }
                                        ]
                                    }
                                );
                                return;
                            }

                            
                            var that = $(this);
                            $.post("./data", {"fn": "read_setting", "value": "services_schedule"}).done(function(resp2)
                            {
                                var inpho3 = $.parseJSON(customer.proposal.info);
                                var services = resp2.data;
                                var services_price_map = {};
                                var services_name_map = {};
                                $.each(services, function(iii, eee)
                                {
                                    services_price_map[eee.value] = eee.price;
                                    services_name_map[eee.value] = eee.value_friendly;
                                });

                                var html = $("<div></div>");
                                var table = $("<table></table>").addClass("rep_fee_schedule");
                                var tbody = $("<tbody></tbody>");

                                $("<tr></tr>")
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Item")
                                    )
                                )
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Enabled")
                                    )
                                )
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Price")
                                    )
                                )
                                .appendTo(tbody);

                                $.each(services, function(iii, eee)
                                {
                                    if(!eee.active)
                                    {
                                        return;
                                    }
                                    var pryce = parseFloat(eee.price);
                                    var qty = 0;
                                    var value = eee.value;
                                    var value_friendly = eee.value_friendly;

                                    if(typeof(inpho3["additional_svcs"]) + '' !== "undefined")
                                    {
                                        $.each(inpho3["additional_svcs"], function(iiii, eeee)
                                        {
                                            if(eeee.value === eee.value)
                                            {
                                                qty = 1
                                            }
                                        });
                                    }

                                    var pryce_formatted = currencyFormat(pryce);
                                    if(eee.per_kw)
                                    {
                                        pryce_formatted += " per KW";
                                    }
                                    var cb = $("<input />").attr("type", "checkbox");
                                    if(qty > 0)
                                    {
                                        cb.attr("checked", "checked");
                                    }
                                    $("<tr></tr>")
                                    .append
                                    (
                                        $("<td></td>").addClass("fee_item").attr("data-name", eee.value).attr("data-price", services_price_map[eee.value]).text(services_name_map[eee.value])
                                    )
                                    .append
                                    (
                                        $("<td></td>").addClass("item_enabled").append(cb)
                                    )
                                    .append
                                    (
                                        $("<td></td>").addClass("pryce").text(pryce_formatted)
                                    )
                                    .appendTo(tbody);
                                });

                                tbody.appendTo(table);
                                table.appendTo(html);                                

                                BootstrapDialog.show
                                (
                                    {
                                        "title": "System Options",
                                        "message": html.html(),
                                        "onshow": function(dialog)
                                        {
                                            setTimeout(function()
                                            {
                                                $(".rep_fee_schedule").delegate("input", "change", function()
                                                {
                                                    $(".rep_fee_schedule").trigger("subtotalupdate");
                                                });

                                                $(".rep_fee_schedule").on("subtotalupdate", function()
                                                {
                                                    var that = $(this);
                                                    that.css("opacity", "0.5");
                                                    var st = 0;
                                                    $(this).find(".item_enabled").each(function(i, e)
                                                    {
                                                        st += $(e).find("input")[0].checked * parseFloat($(e).prev().data("price"));
                                                    });
                                                    $(".subtotal").text("$" + parseFloat(st).toFixed(2));

                                                    svc_data = [];
                                                    $(".fee_item").each(function(iiiii, eeeee)
                                                    {
                                                        svc_data.push({"value": $(eeeee).data("name"), "qty": $(eeeee).next().find("input")[0].checked * 1});
                                                    });
                                                    svc_data_cpy = [];
                                                    $.each(svc_data, function(iiiii, eeeee)
                                                    {
                                                        if(parseFloat(eeeee.qty) >= 1.0)
                                                        {
                                                            svc_data_cpy.push(eeeee);
                                                        }
                                                    });
                                                    svc_data = svc_data_cpy;
                                                    var new_info = $.parseJSON(customer.proposal.info);
                                                    new_info["additional_svcs"] = svc_data;
                                                    customer.proposal.info = JSON.stringify(new_info);

                                                    $.post("./data", {"fn": "update_additional_services", "identifier": customer.identifier, "services": JSON.stringify(svc_data)}).done(function(resp3)
                                                    {
                                                        that.css("opacity", "1.0");
                                                    });                                                
                                                });

                                                if(window.CUSTOM_OPTION_HACK === true)
                                                {
                                                    var temp_name = "temp_" + (new Date().getTime() + '');
                                                    window[temp_name] = setInterval(function()
                                                    {
                                                        
                                                        if($(".add-custom-opt").length === 1)
                                                        {
                                                            window.clearInterval(window[temp_name]);
                                                            $(".add-custom-opt").trigger("click");
                                                        }
                                                    }, 50);                                               
                                                }

                                            }, 1000);                                            
                                        },
                                        "closable": false,
                                        "buttons":
                                        [
                                            {
                                                "label": "Done",
                                                "cssClass": "btn-primary",
                                                "action": function(ddd)
                                                {
                                                    ddd.close();
                                                    prepareCustomerForProposal(customer, panels, panel_points);
                                                }
                                            },
                                            {
                                                "label": "Custom Options",
                                                "cssClass": "btn-primary add-custom-opt",
                                                "action": function(ddd)
                                                {
                                                    ddd.close();
                                                    var html2 = $("<div></div>");
                                                    var items_div = $("<div></div>").addClass("proposal_custom_options");
                                                    var new_item_tbl = $("<table></table>").addClass("custom_options_tbl").append($("<tbody></tbody>"));
                                                    $("<tr></tr>")
                                                    .append
                                                    (
                                                        $("<th></th>").text("Name")
                                                    )
                                                    .append
                                                    (
                                                        $("<th></th>").text("Cost")
                                                    )
                                                    .append
                                                    (
                                                        $("<th></th>").text("")
                                                    )
                                                    .appendTo(new_item_tbl.find("tbody").first());

                                                    $("<tr></tr>")
                                                    .append
                                                    (
                                                        $("<td></td>")
                                                        .append
                                                        (
                                                            $("<input />").attr("type", "text")
                                                        )                                                        
                                                    )
                                                    .append
                                                    (
                                                        $("<td></td>")
                                                        .append
                                                        (
                                                            $("<span></span>").addClass("custom_option_dollar").text("$")
                                                        )
                                                        .append
                                                        (
                                                            $("<input />").attr("type", "text")
                                                        )                                                        
                                                    )
                                                    .append
                                                    (
                                                        $("<td></td>")
                                                        .append
                                                        (
                                                            $("<button></button>").addClass("btn").addClass("btn-primary").text("Add it!").attr("id", "add_it_custom_btn_system_options")
                                                        )
                                                    )
                                                    .appendTo(new_item_tbl.find("tbody").first());
                                                    
                                                    var pinfo = $.parseJSON(customer.proposal.info);
                                                    
                                                    custom_services = []
                                                    if(Object.keys(pinfo).indexOf("custom_svcs") > -1)
                                                    {
                                                        custom_services = pinfo["custom_svcs"];
                                                    }

                                                    $.each(custom_services, function(iiiiii, custom_svc)
                                                    {
                                                        $("<tr></tr>")
                                                        .append
                                                        (
                                                            $("<td></td>")
                                                            .text(custom_svc.name)
                                                        )
                                                        .append
                                                        (
                                                            $("<td></td>")
                                                            .text(custom_svc.price)
                                                        )
                                                        .append
                                                        (
                                                            $("<td></td>")
                                                            .append
                                                            (
                                                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove")
                                                            )
                                                        )
                                                        .appendTo(new_item_tbl.find("tbody").first());
                                                    });

                                                    new_item_tbl.appendTo(html2);

                                                    BootstrapDialog.show
                                                    (
                                                        {
                                                            "title": "Custom Options",
                                                            "message": html2.html(),
                                                            "buttons":
                                                            [
                                                                {
                                                                    "label": "Cancel",
                                                                    "cssClass": "btn-danger",
                                                                    "action": function(dddd)
                                                                    {
                                                                        dddd.close();
                                                                        prepareCustomerForProposal(customer, panels, panel_points);
                                                                    }
                                                                },
                                                                {
                                                                    "label": "Save",
                                                                    "cssClass": "btn-primary committ-custom-btn",
                                                                    "action": function(dddd)
                                                                    {
                                                                        $(".bootstrap-dialog-footer").find(".btn-primary").text("Saving...").css("opacity", "0.5");
                                                                        var opts = [];
                                                                        $(".custom_options_tbl").find("tr").each(function(index, element)
                                                                        {
                                                                            var el = $(element);
                                                                            if(index > 1)
                                                                            {
                                                                                opts.push({"price": el.find("td").eq(1).text(), "name": el.find("td").first().text()});
                                                                            }
                                                                        });
                                                                        $.post("/data", {"fn": "save_custom_options", "identifier": customer.identifier, "options": JSON.stringify(opts)}).done(function(responssss)
                                                                        {
                                                                            pinfo["custom_svcs"] = opts
                                                                            customer.proposal.info = JSON.stringify(pinfo);
                                                                            dddd.close();
                                                                            prepareCustomerForProposal(customer, panels, panel_points);
                                                                        });                                                                        
                                                                    }
                                                                }
                                                            ],
                                                            "onshown": function(dddd)
                                                            {
                                                                
                                                                var add_btn = $(".bootstrap-dialog-body").find("td > .btn-primary").first();
                                                                add_btn.click(function()
                                                                {
                                                                    var that = $(this);
                                                                    var name = $.trim(that.closest("tr").find("input").first().val());
                                                                    var amt = parseFloat("0");
                                                                    var amt_txt = $.trim(that.closest("tr").find("input").eq(1).val());
                                                                    var allowed_chars2 = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", ".", "-"];
                                                                    var amt_txt2 = "";
                                                                    $.each(amt_txt.split(""), function(iiiiiiiiiii, dig)
                                                                    {
                                                                        if(allowed_chars2.indexOf(dig) > -1)
                                                                        {
                                                                            amt_txt2 += dig;
                                                                        }
                                                                    });
                                                                    var amt_parsed = parseFloat(amt_txt2);
                                                                    if(!Number.isNaN(amt_parsed))
                                                                    {
                                                                        amt = amt_parsed;
                                                                    }

                                                                    var cb = function()
                                                                    {
                                                                        var new_tr = $("<tr></tr>");
                                                                        new_tr.append
                                                                        (
                                                                            $("<td></td>")
                                                                            .text(name)
                                                                        );
                                                                        new_tr.append
                                                                        (
                                                                            $("<td></td>")
                                                                            .text(amt.toFixed(2))
                                                                        );
                                                                        new_tr.append
                                                                        (
                                                                            $("<td></td>")
                                                                            .append
                                                                            (
                                                                                $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove")
                                                                            )
                                                                        )
                                                                        new_tr.appendTo(that.closest("tbody"));

                                                                        that.closest("tr").find("input").first().val("");
                                                                        that.closest("tr").find("input").eq(1).val("");
                                                                    };

                                                                    if(amt < parseFloat(0))
                                                                    {
                                                                        var passcode = window.prompt("Please enter the passcode:");
                                                                        $.post("/data", {"fn": "password_check", "name": "Negative Custom Option", "password": passcode + ''}).done(function(rrrrrrrr)
                                                                        {
                                                                            if(rrrrrrrr.success)
                                                                            {
                                                                                cb();
                                                                            }
                                                                        });
                                                                    }
                                                                    else
                                                                    {
                                                                        cb();
                                                                    }
                                                                });

                                                                $(".custom_options_tbl").on("click", ".glyphicon-remove", function()
                                                                {
                                                                    var that = $(this);
                                                                    that.closest("tr").remove();
                                                                });
                                                                if(window.CUSTOM_OPTION_HACK === true)
                                                                {
                                                                    $(".custom_options_tbl").find("input").first().val(window.CUSTOM_OPTION_NAME).attr("value", window.CUSTOM_OPTION_NAME);
                                                                    $(".custom_options_tbl").find("input").last().val(window.CUSTOM_OPTION_AMOUNT).attr("value", window.CUSTOM_OPTION_AMOUNT);

                                                                    setTimeout(function()
                                                                    {
                                                                        $("#add_it_custom_btn_system_options").trigger("click");

                                                                        window.CUSTOM_OPTION_HACK = false;
                                                                        window.CUSTOM_OPTION_NAME = "";
                                                                        window.CUSTOM_OPTION_AMOUNT = "";

                                                                        setTimeout(function()
                                                                        {
                                                                            $(".committ-custom-btn").trigger("click");
                                                                        }, 100);
                                                                    }, 250);
                                                                }                                                                
                                                            }
                                                        }
                                                    );
                                                }
                                            }
                                        ],
                                        "onshown": function(ddddd5)
                                        {
                                            
                                        }                                        
                                    }
                                );

                                /*
                                that.remove();
                                var services = resp2.data;
                                var services_price_map = {};
                                var services_name_map = {};
                                $.each(services, function(iii, eee)
                                {
                                    services_price_map[eee.value] = eee.price;
                                    services_name_map[eee.value] = eee.value_friendly;
                                });
                                var inpho3 = $.parseJSON(customer.proposal.info);
                                var html = $("<div></div>");
                                var table = $("<table></table>").addClass("rep_fee_schedule");
                                var tbody = $("<tbody></tbody>");
                                $("<tr></tr>")
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Item")
                                    )
                                )
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Enabled")
                                    )
                                )
                                .append
                                (
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<b></b>").text("Price")
                                    )
                                )
                                .appendTo(tbody);

                                $.each(services, function(iii, eee)
                                {
                                    if(!eee.active)
                                    {
                                        return;
                                    }
                                    var pryce = parseFloat(eee.price);
                                    var qty = 0;
                                    var value = eee.value;
                                    var value_friendly = eee.value_friendly;

                                    if(typeof(inpho3["additional_svcs"]) + '' !== "undefined")
                                    {
                                        $.each(inpho3["additional_svcs"], function(iiii, eeee)
                                        {
                                            if(eeee.value === eee.value)
                                            {
                                                qty = 1
                                            }
                                        });
                                    }

                                    var cb = $("<input />").attr("type", "checkbox");
                                    if(qty > 0)
                                    {
                                        cb.attr("checked", "checked");
                                    }
                                    $("<tr></tr>")
                                    .append
                                    (
                                        $("<td></td>").addClass("fee_item").attr("data-name", eee.value).attr("data-price", services_price_map[eee.value]).text(services_name_map[eee.value])
                                    )
                                    .append
                                    (
                                        $("<td></td>").addClass("item_enabled").append(cb)
                                    )
                                    .append
                                    (
                                        $("<td></td>").addClass("pryce").text(parseFloat(pryce).toFixed(2))
                                    )
                                    .appendTo(tbody);
                                });
                                $("<tr></tr>")
                                .append
                                (
                                    $("<td></td>").html("&nbsp;")
                                )
                                .append
                                (
                                    $("<td></td>").html("&nbsp;")
                                )
                                .append
                                (
                                    $("<td></td>").addClass("subtotal").text("$")
                                ).appendTo(tbody);

                                tbody.appendTo(table);
                                table.appendTo(html);

                                table.delegate("input", "change", function()
                                {
                                    $(".rep_fee_schedule").trigger("subtotalupdate");
                                });

                                table.on("subtotalupdate", function()
                                {
                                    var st = 0;
                                    $(this).find(".item_enabled").each(function(i, e)
                                    {
                                        st += $(e).find("input")[0].checked * parseFloat($(e).prev().data("price"));
                                    });
                                    $(".subtotal").text("$" + parseFloat(st).toFixed(2));

                                    svc_data = [];
                                    $(".fee_item").each(function(iiiii, eeeee)
                                    {
                                        svc_data.push({"value": $(eeeee).data("name"), "qty": $(eeeee).next().find("input")[0].checked * 1});
                                    });
                                    svc_data_cpy = [];
                                    $.each(svc_data, function(iiiii, eeeee)
                                    {
                                        if(parseFloat(eeeee.qty) >= 1.0)
                                        {
                                            svc_data_cpy.push(eeeee);
                                        }
                                    });
                                    svc_data = svc_data_cpy;
                                    var new_info = $.parseJSON(customer.proposal.info);
                                    new_info["additional_svcs"] = svc_data;
                                    customer.proposal.info = JSON.stringify(new_info);

                                    $.post("./data", {"fn": "update_additional_services", "identifier": customer.identifier, "services": JSON.stringify(svc_data)}).done(function(resp3)
                                    {
                                    });
                                });

                                table.appendTo(html);
                                html.insertBefore($("#reschedule_" + customer.identifier).nextAll(".proposal_form_row").first().find(".extra_dropdowns"));
                                table.trigger("subtotalupdate");
                                $("#reschedule_" + customer.identifier).nextAll(".proposal_form_row").first().find(".rep_fee_schedule")[0].scrollIntoView();*/

                            });
                        }).appendTo(row);
                    }                    
                    $(".proposal_form_row").remove();
                    row.insertAfter($("#reschedule_" + customer.identifier).nextAll(".sp2_nayme").first());
                    row[0].scrollIntoView();
                });
                return;

                var form = $("<form></form>").addClass("form-horizontal").attr("role", "form").attr("action", "/data?fn=generate_proposal&identifier=" + customer.identifier).attr("method", "POST").attr("target", "_blank").attr("id", "temp_proposal_form").attr("name", "temp_proposal_form");
                form.submit(function()
                {
                    trySubmitProposalForm(customer);
                    return false;
                });

                for(var key in field_info)
                {
                    var item = field_info[key];
                    var div = $("<div></div>").addClass("form-group");
                    div.attr("id", "proposal_question_for_" + key);
                    div.addClass("proposal_question_type_of_" + item.type);
                    var lbl = $("<label></label>").addClass("control-label").addClass("col-sm-2").text(item.title + ":");
                    switch(item.secondary_type)
                    {
                        case "currency":
                            $("<span></span>").addClass("reconfigure_dolla").text("$").appendTo(lbl);
                            break;
                    }

                    lbl.appendTo(div);

                    var div2 = $("<div></div>").addClass("col-sm-10");
                    switch(item.type)
                    {
                        case "multiple_choice":
                            var dropdown_div = $("<div></div>").addClass("dropdown");

                            $("<button></button>")
                            .addClass("btn")
                            .addClass("btn-default")
                            .addClass("dropdown-toggle")
                            .attr("type", "button")
                            .attr("data-toggle", "dropdown")
                            .text("Select One")
                            .append
                            (
                                $("<span></span>").addClass("caret")
                            ).appendTo(dropdown_div);

                            var ul = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                            $.each(item.choices, function(i, choice)
                            {
                                var li = $("<li></li>").attr("role", "presentation");
                                var a = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");

                                var is_object = ((typeof(choice) + '').toLowerCase() === "object");
                                var val = "";
                                if(is_object)
                                {
                                    val = choice.value;
                                }
                                else
                                {
                                    val = choice;
                                }
                                if(is_object)
                                {
                                    li.attr("id", "proposal_value_of_" + val);
                                    a.text(choice.value_friendly);
                                }
                                else
                                {
                                    li.attr("id", "proposal_value_of_" + val);
                                    a.text(choice);
                                }
                                li.click(function()
                                {
                                    li.parent().nextAll("input").first().val(val);
                                    li.parent().prevAll("button").first().text(li.text());
                                    $("<span></span>").addClass("caret").appendTo(li.parent().prevAll("button").first());
                                });
                                a.appendTo(li);
                                li.appendTo(ul);
                            });
                            ul.appendTo(dropdown_div);
                            $("<input />").attr("type", "hidden").attr("value", "unanswered").attr("id", "hidden_value_for_" + key).appendTo(dropdown_div);
                            dropdown_div.appendTo(div2);
                            break;

                        case "real_number":
                            var build_input = function(item)
                            {
                                return $("<input />").attr("type", "text").attr("id", "hidden_value_for_" + key).attr("placeholder", "152.55").on("blur", function(ev)
                                       {
                                            item.input_filter($(this));
                                       })
                            };
                            build_input(item).appendTo(div2);
                            break;

                        case "file":
                            $("<input />").attr("type", "file").attr("id", "hidden_value_for_" + key).appendTo(div2);
                            break;

                        default:
                            break;
                    }
                    div.append(lbl);
                    div.append(div2);
                    if(typeof(item["entity_dependency"]) + '' !== "undefined")
                    {
                        if(!item.entity_dependency(customer))
                        {
                            div.css("display", "none");
                        }
                    }
                    div.appendTo(form);
                    if(typeof(item["dependent_question"]) + '' !== "undefined")
                    {
                        var div21 = $("<div></div>").addClass("form-group");
                        div21.css("display", "none");

                        div21.attr("id", "proposal_question_for_" + item.dependent_question.key);
                        div21.addClass("proposal_question_type_of_" + item.dependent_question.type);
                        var lbl2 = $("<label></label>").addClass("control-label").addClass("col-sm-2").text(item.dependent_question.title + ":");
                        switch(item.dependent_question.secondary_type)
                        {
                            case "currency":
                                $("<span></span>").addClass("reconfigure_dolla").text("$").appendTo(lbl2);
                                break;
                        }

                        lbl2.appendTo(div21);

                        var div22 = $("<div></div>").addClass("col-sm-10");

                        switch(item.dependent_question.type)
                        {
                            case "multiple_choice":
                                var dropdown_div2 = $("<div></div>").addClass("dropdown");

                                $("<button></button>")
                                .addClass("btn")
                                .addClass("btn-default")
                                .addClass("dropdown-toggle")
                                .attr("type", "button")
                                .attr("data-toggle", "dropdown")
                                .text("Select One")
                                .append
                                (
                                    $("<span></span>").addClass("caret")
                                ).appendTo(dropdown_div2);

                                var ul2 = $("<ul></ul>").addClass("dropdown-menu").attr("role", "menu");
                                $.each(item.dependent_question.choices, function(i, choice)
                                {
                                    var li2 = $("<li></li>").attr("role", "presentation");
                                    var a2 = $("<a></a>").attr("role", "menuitem").attr("tabindex", "-1").attr("href", "javascript:void(0);");

                                    var is_object = ((typeof(choice) + '').toLowerCase() === "object");
                                    var val = "";
                                    if(is_object)
                                    {
                                        val = choice.value;
                                    }
                                    else
                                    {
                                        val = choice;
                                    }
                                    if(is_object)
                                    {
                                        li2.attr("id", "proposal_value_of_" + val);
                                        a2.text(choice.value_friendly);
                                    }
                                    else
                                    {
                                        li2.attr("id", "proposal_value_of_" + val);
                                        a2.text(choice);
                                    }
                                    li2.click(function()
                                    {
                                        li2.parent().nextAll("input").first().val(val);
                                        li2.parent().prevAll("button").first().text(li2.text());
                                        $("<span></span>").addClass("caret").appendTo(li2.parent().prevAll("button").first());
                                    });
                                    a2.appendTo(li2);
                                    li2.appendTo(ul2);
                                });
                                ul2.appendTo(dropdown_div2);
                                $("<input />").attr("type", "hidden").attr("value", "unanswered").attr("id", "hidden_value_for_" + item.dependent_question.key).appendTo(dropdown_div2);
                                dropdown_div2.appendTo(div22);
                                break;

                            case "real_number":
                                $("<input />").attr("type", "text").attr("id", "hidden_value_for_" + key).attr("placeholder", "152.55").on("blur", function(ev)
                                {
                                    item.input_filter($(this));
                                }).appendTo(div22);
                                break;

                            case "file":
                                $("<input />").attr("type", "file").attr("id", "hidden_value_for_" + key).appendTo(div22);
                                break;

                            default:
                                break;
                        }
                        div21.append(lbl2);
                        div21.append(div22);
                        if(typeof(item["entity_dependency"]) + '' !== "undefined")
                        {
                            if(!item.entity_dependency(customer))
                            {
                                div21.css("display", "none");
                            }
                        }
                        div21.appendTo(form);
                    }
                }
                $("<center></center>")
                .append
                (
                    $("<hr />")
                )
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-success").attr("type", "submit").text("Generate Proposal")
                )
                .append
                (
                    $("<button></button>").css("display", "none").addClass("btn").addClass("btn-primary").text("Update Fields").attr("type", "button").click(function(ev)
                    {
                        ev.preventDefault();
                        tryUpdateFormFields(customer);
                    })
                )
                .appendTo(form);
                form.appendTo(row);
                row.appendTo(app_area);

                if(customer.proposal !== null)
                {
                    for(var key in field_info)
                    {
                        var item = field_info[key];
                        var found = false;

                        var parsed = $.parseJSON(customer.proposal.info);
                        for(var key2 in parsed)
                        {
                            if(key2 === key)
                            {
                                found = true;
                            }
                        }
                        if(found)
                        {
                            switch(item.type)
                            {
                                case "multiple_choice":
                                    var to_fixed = "---";
                                    if((typeof(parsed[key]) + '') === "number")
                                    {
                                        try
                                        {
                                            to_fixed = parsed[key].toFixed(2);
                                        }
                                        catch(e666)
                                        {
                                        }
                                    }
                                    $("#proposal_question_for_" + key).find("li").each(function(i, e)
                                    {
                                        if($(e).attr("id").replace("proposal_value_of_", "") === customer.proposal.info[key] || $(e).attr("id").replace("proposal_value_of_", "") === to_fixed || $(e).attr("id").replace("proposal_value_of_", "") === parsed[key] + '')
                                        {
                                            $(e).trigger("click");
                                        }
                                    });
                                    break;

                                case "real_number":
                                    try
                                    {
                                        $("#proposal_question_for_" + key).find("input").first().val(parsed[key].toFixed(2));
                                    }
                                    catch(e)
                                    {
                                        $("#proposal_question_for_" + key).find("input").first().val(parsed[key] + '');
                                    }
                                    break;

                                case "file":
                                    if((typeof(parsed[key]) + '').toLowerCase() === "object")
                                    {
                                        $("<a></a>").addClass("curr_proposal_href").text("Current File").attr("href", "//storage.googleapis.com/" + window.app_bucket + "/ProposalBlobs/" + customer.identifier + "_" + key + "." + parsed[key].extension).attr("target", "_blank").prependTo($("#proposal_question_for_" + key).find(".col-sm-10"));
                                    }
                                    break;

                                default:
                                    break;
                            }
                        }
                    }
                }
                $.each(["usage_months", "total_dollars", "highest_amount", "total_kwhs"], function(i, key)
                {
                    if(customer[key] > 0.0)
                    {
                        switch(field_info[key].type)
                        {
                            case "multiple_choice":
                                $("#proposal_question_for_" + key).find("li").each(function(i, e)
                                {
                                    if($(e).attr("id").replace("proposal_value_of_", "") === (customer[key] + ''))
                                    {
                                        $(e).trigger("click");
                                    }
                                });
                                break;

                            case "real_number":
                                $("#proposal_question_for_" + key).find("input").first().val(customer[key].toFixed(2));
                                break;

                            default:
                                break;
                        }
                    }
                });
                var add_fn = function(key2)
                {
                    interval_fns.push(function()
                    {
                        var curr_val = null;
                        switch(field_info[key2].type)
                        {
                            case "multiple_choice":
                                curr_val = $("#hidden_value_for_" + key2).val();
                                break;

                            default:
                                break;
                        }

                        if(curr_val === field_info[key2]["dependent_value"])
                        {
                            if($("#proposal_question_for_" + field_info[key2].dependent_question.key).css("display").toLowerCase() !== "block")
                            {
                                $("#proposal_question_for_" + field_info[key2].dependent_question.key).css("display", "block");
                            }
                        }
                        else
                        {
                            if($("#proposal_question_for_" + field_info[key2].dependent_question.key).css("display").toLowerCase() !== "none")
                            {
                                $("#proposal_question_for_" + field_info[key2].dependent_question.key).css("display", "none");
                            }
                        }
                    });

                };
                for(var key in field_info)
                {
                    if(typeof(field_info[key]["dependent_value"]) + '' !== "undefined")
                    {
                        add_fn(key);
                    }
                }
                $(".proposal_form_row").first().find(".btn-success")[0].scrollIntoView();
                window.temp_proposal_rep_intervals.push(setInterval(function()
                {
                    $.each(interval_fns, function(i, fn)
                    {
                        fn();
                    });
                }, 500));
            }
            function tryUpdateFormFields(customer)
            {
                $.each(window.temp_proposal_rep_intervals, function(i, interval)
                {
                    window.clearInterval(interval);
                });
                var form_data = new FormData();
                // validate that the input is good
                var missing_field = false;
                $(".proposal_form_row .form-group").each(function(i, e)
                {
                    if($(e).css("display").toLowerCase() === "none" || missing_field)
                    {
                        return;
                    }

                    switch($.trim($(e).attr("class").replace("form-group", "").replace("proposal_question_type_of_", "")))
                    {
                        case "real_number":
                            missing_field = $.trim($(e).find("input").first().val()).length === 0;
                            break;

                        case "file":
                            missing_field = $(e).text().toLowerCase().indexOf("current file") === -1 && $.trim($(e).find("input").val()).length === 0;

                        case "multiple_choice":
                            missing_field = $.trim($(e).find("input").val()).toLowerCase() === "unanswered" || $.trim($(e).find("input").val()).toLowerCase() === "n/a";
                            break;
                    }
                });
                if(missing_field)
                {
                    window.alert("One or more fields were not provided. Each field is required.");
                    return;
                }

                var data = {};

                var formData = new FormData();
                formData.append("field_app_identifier", customer.identifier);
                var has_cad_photo = (($("#hidden_value_for_cad_photo")[0].files.length > 0) * 1) + '';
                formData.append("has_cad_photo", has_cad_photo);
                formData.append("rep_qualifier", "1");
                if(customer.proposal !== null)
                {
                    formData.append("version", customer.proposal.version);
                }

                $(".proposal_form_row .form-group").each(function(i, e)
                {
                    if($(e).css("display").toLowerCase() === "none")
                    {
                        return;
                    }

                    var qui = $(e).attr("id").replace("proposal_question_for_", "");
                    var val = "";
                    switch($.trim($(e).attr("class").replace("form-group", "").replace("proposal_question_type_of_", "")))
                    {
                        case "real_number":
                            val = $.trim($(e).find("input").first().val());
                            break;

                        case "file":
                            val = null;
                            break;

                        case "multiple_choice":
                            val = $.trim($(e).find("input").val());
                            break;
                    }
                    if(val !== null)
                    {
                        data[qui] = val;
                    }
                });

                formData.append("fields", JSON.stringify(data));
                if(has_cad_photo === "1")
                {
                    formData.append("cad_photo", $("#hidden_value_for_cad_photo")[0].files[0]);
                }

                var xhr = new XMLHttpRequest();
                (xhr.upload || xhr).addEventListener("progress", function(e)
                {
                    var done = e.position || e.loaded
                    var total = e.totalSize || e.total;
                    var completion_percentage = (Math.round(done/total*100) + '') + "%";
                    $(".proposal_form_row").text("Updating...")[0].scrollIntoView();

                });

                xhr.addEventListener("load", function(e)
                {
                    $("#app_area").css("opacity", "0.2");
                    localStorage.setItem("button_to_click", "sp_schedule_icon");
                    window.location.reload();
                });

                xhr.open("POST", "./data?fn=save_proposal_info");
                xhr.send(formData);
            }
            function trySubmitProposalForm(customer)
            {
                var missing_data = false;
                if(customer.proposal === null)
                {
                    missing_data = true;
                }
                else
                {
                    var info = $.parseJSON(customer.proposal.info);
                    if(typeof(info["offset"]) + '' === "undefined")
                    {
                        missing_data = true;
                    }
                    else
                    {
                        if(typeof(info["utility_bill_after_solar"]) + '' === "undefined" && info["offset"].toLowerCase() === "partial")
                        {
                            missing_data = true;
                        }
                    }

                    if(typeof(info["system_size"]) + '' === "undefined")
                    {
                        missing_data = true;
                    }

                    if((typeof(info["cad_photo"]) + '').toLowerCase() !== "object")
                    {
                        missing_data = true;
                    }
                }
                if(customer.total_kwhs <= 0.01)
                {
                    missing_data = true;
                }
                if(customer.total_dollars <= 0.01)
                {
                    missing_data = true;
                }
                if(customer.highest_amount <= 0.01)
                {
                    missing_data = true;
                }
                if(customer.usage_months <= 0.01)
                {
                    missing_data = true;
                }

                if(missing_data)
                {
                    window.alert("One or more required fields are missing. Please Update the fields with all required information before generating the proposal.");
                    return;
                }

                $("#temp_proposal_form").attr("action", $("#temp_proposal_form").attr("action") + "&dt=" + (new Date().getTime() + ''));
                BootstrapDialog.show
                (
                    {
                        "title": "Choose a Document",
                        "message": "Make your selection<br /><br />",
                        "buttons":
                        [
                            {
                                "label": "Customer-Facing Proposal",
                                "action": function(dialog)
                                {
                                    $("<input />").attr("type", "hidden").attr("name", "doc_option").attr("value", "proposal").val("proposal").appendTo($("#temp_proposal_form"));
                                    document.forms["temp_proposal_form"].submit();
                                    dialog.close();
                                }

                            },
                            {
                                "label": "Customer's Numbers (Internal-Use Only)",
                                "action": function(dialog)
                                {
                                    $("<input />").attr("type", "hidden").attr("name", "doc_option").attr("value", "internal").val("internal").appendTo($("#temp_proposal_form"));
                                    document.forms["temp_proposal_form"].submit();
                                    dialog.close();
                                }
                            }
                        ]
                    }
                );
            }
            function loadFeaturedLBData()
            {
                var lb_area = $("#featured_lb_area");
                lb_area.empty();
                $("<img />").addClass("img").addClass("img-responsive").attr("src", "/bootstrap/images/rep_portal_spinner.gif").appendTo(lb_area);
                $.post("/data", {"fn": "get_leaderboard_data", "achievement_metric": "leads_acquired", "time_metric": "weekly", "office": "-1"}).done(function(r)
                {
                    var data = r.data;
                    $("#featured_lb_area").find("img").first().remove();
                    var table = $("<table></table>").attr("id", "featured_lb_tbl");
                    var tbody = $("<tbody></tbody>");
                    $("<tr></tr>")
                    .append
                    (
                        $("<th></th>").attr("colspan", "3").html("<center>AB Leaders</center>")
                    ).appendTo(tbody);

                    var winner_data = {};
                    winner_data.spot_1_name = "Nobody";
                    winner_data.spot_1_tally = -1;
                    winner_data.spot_1_identifier = "";
                    winner_data.spot_2_name = "Nobody";
                    winner_data.spot_2_tally = -1;
                    winner_data.spot_2_identifier = "";
                    winner_data.spot_3_name = "Nobody";
                    winner_data.spot_3_tally = -1;
                    winner_data.spot_3_identifier = "";
                    winner_data.spot_4_name = "Nobody";
                    winner_data.spot_4_tally = -1;
                    winner_data.spot_4_identifier = "";
                    winner_data.spot_5_name = "Nobody";
                    winner_data.spot_5_tally = -1;
                    winner_data.spot_5_identifier = "";

                    var winning_rep_ids = [];

                    var data_cpy = [];
                    $.each(Object.keys(data), function(i, key)
                    {
                        data_cpy.push({"rep_id": key, "tally": data[key]});
                    });
                    data_cpy = bubbleSortArrayOfObjectsByKey(data_cpy, "tally");
                    data_cpy.reverse();
                    for(var i = 0; i < 5; i++)
                    {
                        if(data_cpy.length >= i + 1)
                        {
                            var item = data_cpy[i];
                            var idx = i+1;
                            idx += '';
                            winner_data["spot_" + idx + "_name"] = r.rep_id_to_name[item.rep_id];
                            winner_data["spot_" + idx + "_tally"] = item.tally;
                            winner_data["spot_" + idx + "_identifier"] = r.rep_id_to_identifier[item.rep_id];
                        }
                    }

                    /*var sort = function()
                    {
                        var ret = false;
                        $.each(Object.keys(data), function(i, rep_id)
                        {
                            if(ret)
                            {
                                return;
                            }
                            if(data[rep_id] > winner_data.spot_1_tally && winning_rep_ids.indexOf(rep_id) === -1)
                            {                                
                                winning_rep_ids.push(rep_id);
                                winner_data.spot_1_name = r.rep_id_to_name[rep_id];
                                winner_data.spot_1_tally = data[rep_id];
                                winner_data.spot_1_identifier = r.rep_id_to_identifier[rep_id];
                                ret = true;
                            }
                            else if(data[rep_id] > winner_data.spot_2_tally && winning_rep_ids.indexOf(rep_id) === -1)
                            {
                                winning_rep_ids.push(rep_id);
                                winner_data.spot_2_name = r.rep_id_to_name[rep_id];
                                winner_data.spot_2_tally = data[rep_id];
                                winner_data.spot_2_identifier = r.rep_id_to_identifier[rep_id];
                                ret = true;
                            }
                            else if(data[rep_id] > winner_data.spot_3_tally && winning_rep_ids.indexOf(rep_id) === -1)
                            {
                                winning_rep_ids.push(rep_id);
                                winner_data.spot_3_name = r.rep_id_to_name[rep_id];
                                winner_data.spot_3_tally = data[rep_id];
                                winner_data.spot_3_identifier = r.rep_id_to_identifier[rep_id];
                                ret = true;
                            }
                            else if(data[rep_id] > winner_data.spot_4_tally && winning_rep_ids.indexOf(rep_id) === -1)
                            {
                                winning_rep_ids.push(rep_id);
                                winner_data.spot_4_name = r.rep_id_to_name[rep_id];
                                winner_data.spot_4_tally = data[rep_id];
                                winner_data.spot_4_identifier = r.rep_id_to_identifier[rep_id];
                                ret = true;
                            }
                            else if(data[rep_id] > winner_data.spot_5_tally && winning_rep_ids.indexOf(rep_id) === -1)
                            {
                                winning_rep_ids.push(rep_id);
                                winner_data.spot_5_name = r.rep_id_to_name[rep_id];
                                winner_data.spot_5_tally = data[rep_id];
                                winner_data.spot_5_identifier = r.rep_id_to_identifier[rep_id];
                                ret = true;
                            }
                        });
                        if(ret)
                        {
                            sort();
                            return;
                        }
                    };                    

                    sort();*/
                    for(var i = 1; i < 6; i++)
                    {
                        var tr = $("<tr></tr>");
                        var td1 = $("<td></td>");
                        if(winner_data["spot_" + (i + '') + "_identifier"] !== "")
                        {
                            $("<img />").addClass("img").addClass("img-responsive").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + winner_data["spot_" + (i + '') + "_identifier"] + ".jpg")
                            .appendTo(td1);
                        }
                        else
                        {
                            $("<span></span>").text("--").appendTo(td1);
                        }
                        td1.appendTo(tr);
                        
                        var td2 = $("<td></td>");
                        td2.text(winner_data["spot_" + (i + '') + "_name"]);
                        td2.appendTo(tr);

                        var td3 = $("<td></td>");
                        if(winner_data["spot_" + (i + '') + "_tally"] === -1)
                        {
                            td3.text("--");
                        }
                        else
                        {
                            td3.text(winner_data["spot_" + (i + '') + "_tally"] + '')
                        }
                        td3.appendTo(tr);

                        tr.appendTo(tbody);
                    }
                    tbody.appendTo(table);
                    table.appendTo(lb_area);

                    $("<center></center>")
                    .append
                    (
                         $("<button></button>").attr("id", "lb_featured_refresh").addClass("btn").addClass("btn-primary").text(" Refresh")
                        .prepend
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-refresh")                        
                        )
                        .click(function()
                        {
                            loadFeaturedLBData();
                        })                        
                    )
                    .appendTo(lb_area)                   
                });
            }
            function takeQuiz(q)
            {
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                var app_area = $("#app_area");

                $("<center></center>")
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-danger").attr("id", "quiz_back").text("Cancel Quiz").click(function()
                    {
                        clearApp(function()
                        {
                            showTrainingMedia(true);
                        });
                    })
                )
                .appendTo(app_area);
                $("<br />").appendTo(app_area);
                $("<br />").appendTo(app_area);
                $.post("/data", {"fn": "quiz_details", "identifier": q.identifier}).done(function(r)
                {
                    r.questions = r.questions.shuffle();
                    var cnt = 1;
                    $.each(r.questions, function(i, question)
                    {
                        var quiz_card = $("<div></div>").addClass("quiz_question_card").attr("data-identifier", question.identifier);
                        $("<p></p>").text((cnt + '') + ". - " + question.name).appendTo(quiz_card); 
                        var choices_ul = $("<ul></ul>").addClass("quiz_choices_ul");
                        $.each(question.choices, function(ii, choice)
                        {
                            var li = $("<li></li>");
                            if(ii === question.correct_index)
                            {
                                li.attr("data-correct", "1")
                            }
                            else
                            {
                                li.attr("data-correct", "0");
                            }
                            $("<span></span>").addClass("choice_text").text(choice.text).appendTo(li);
                            $("<input />").attr("type", "radio")
                            .appendTo(li);

                            li.appendTo(choices_ul);
                        });
                        choices_ul.appendTo(quiz_card);
                        var li_items = choices_ul.find("li").get();
                        choices_ul.find("li").remove();
                        li_items = li_items.shuffle();
                        $.each(li_items, function(iii, item)
                        {
                            $(item).appendTo(choices_ul);
                        });
                        choices_ul.find("li").each(function(iii, li)
                        {
                            $(li).find("input")
                            .change(function()
                            {
                                var that = $(this);
                                var this_idx = that.closest("li").prevAll("li").length;
                                that.closest("ul").find("input").each(function(iii, eee)
                                {
                                    $(eee)[0].checked = false;
                                });
                                that.closest("ul").find("input").eq(this_idx)[0].checked = true;
                                that.closest(".quiz_question_card").removeClass("missing_answer")
                            });
                            $(li).click(function()
                            {
                                var that = $(this);
                                that.find("input")[0].checked = true;
                                that.find("input").trigger("change");
                            });

                        });

                        quiz_card.appendTo(main_div);
                        cnt += 1;
                    });

                    $("<center></center>")
                    .append
                    (
                        $("<button></button>").addClass("btn").addClass("btn-primary").text("Submit Answers")
                        .click(function()
                        {
                            var that = $(this);             
                            var ret_early = false;
                            var scroll_el = $("body");               
                            $(".quiz_question_card").each(function(i, e)
                            {
                                if(ret_early)
                                {
                                    return;
                                }
                                var answer_tally = 0;
                                $(e).find("input").each(function(ii, ee)
                                {
                                    answer_tally += ($(ee)[0].checked * 1);
                                });
                                if(answer_tally === 0)
                                {
                                    ret_early = true;
                                    scroll_el = $(e);
                                }
                            });
                            if(ret_early)
                            {
                                scroll_el.addClass("missing_answer");
                                scroll_el[0].scrollIntoView();
                                return;
                            }
                            that.remove();
                            $("body").css("opacity", "0.2");

                            var possible_points = $(".quiz_question_card").length;
                            var points = 0;
                            $(".quiz_question_card").each(function(i, e)
                            {
                                $(e).find("input").each(function(ii, ee)
                                {
                                    if($(ee)[0].checked)
                                    {
                                        points += ((($(ee).closest("li").data("correct") + '') === "1") * 1);
                                    }
                                });
                            });
                            var score = ((points / possible_points) * 100).toFixed(2);
                            $.post("/data", {"fn": "complete_quiz", "identifier": q.identifier, "user": user_identifier, "score": score + "%"}).done(function(rrrr)
                            {
                                $("body").css("opacity", "1.0");
                                var html = $("<div></div>");
                                if(score >= parseFloat(90))
                                {
                                    html.append
                                    (
                                        $("<p></p>").text("Congratulations! You passed the quiz with a score of " + score + "%.")
                                    );
                                }
                                else
                                {
                                    html.append
                                    (
                                        $("<p></p>").html("Unfortunately you did not pass the quiz. A passing score is 90% or above.<br /><br />Your score: " + score + "%")
                                    );
                                }
                                BootstrapDialog.show
                                (
                                    {
                                        "title": "Quiz Results",
                                        "message": html.html(),
                                        "buttons":
                                        [
                                            {
                                                "label": "Close",
                                                "cssClass": "btn-primary",
                                                "action": function(d)
                                                {
                                                    d.close();
                                                    $("#quiz_back").trigger("click");
                                                }
                                            }
                                        ]
                                    }
                                );                                
                            });
                        })
                    )
                    .appendTo(main_div);
                    $.each([spacer, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                });
            }
            function showTrainingMedia(feature_quizzes)
            {
                hideIconGrid();
                var app_area = $("#app_area");
                var main_div = $("<div></div>").addClass("row");
                var labels_div = $("<div></div>").addClass("labels_div");
                $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "video").text("Videos").appendTo(labels_div);
                $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "audio").text("Audio").appendTo(labels_div);
                $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "doc").text("Documents").appendTo(labels_div);
                if(window.is_manager === 1)
                {
                    $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "manager").text("Sales Management").appendTo(labels_div);
                }
                $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "quiz").text("Quizzes").attr("id", "quizzes_label").appendTo(labels_div);                
                $("<span></span>").addClass("label").addClass("label-primary").attr("data-type", "power_up").text("Power Up").attr("id", "power_up_label").appendTo(labels_div);
                $("<span></span>").addClass("label").addClass("label-danger").attr("data-type", "back").text("Back").appendTo(labels_div);

                labels_div.appendTo(main_div);
                $("<br />").appendTo(main_div);                

                labels_div.find(".label").each(function(i, e)
                {
                    var lbl = $(e);
                    lbl.click(function()
                    {
                        if(lbl.data("type") === "back")
                        {
                            clearApp(function()
                            {
                                showIconGrid();
                            });
                            return;
                        }
                        $(".training_media").remove();
                        $(".power_up_div").remove();
                        if(lbl.data("type") === "quiz")
                        {
                            $("body").css("opacity", "0.2");
                            $.post("/data", {"fn": "get_training_media", "active_quizzes_only": "1"}).done(function(rr)
                            {
                                $.each(rr.quizzes, function(i, quiz)
                                {
                                    var div = $("<div></div>").addClass("training_media").addClass("training_media_quiz");
                                    $("<p></p>").text(quiz.name).appendTo(div);
                                    var status_span = $("<span></span>").addClass("label");
                                    if(rr.scores[quiz.identifier] === "-1%")
                                    {
                                        status_span.addClass("label-danger");
                                        status_span.text("Not Yet Taken")
                                    }
                                    else
                                    {
                                        score = parseFloat(rr.scores[quiz.identifier].replace("%", ""));
                                        if(score < parseFloat(90))
                                        {
                                            status_span.addClass("label-danger");
                                        }
                                        else
                                        {
                                            status_span.addClass("label-primary");
                                        }
                                        status_span.text(score.toFixed(2));
                                        status_span.text(status_span.text() + "%");
                                    }
                                    status_span.appendTo(div);
                                    div.click(function()
                                    {
                                        clearApp(function()
                                        {
                                            takeQuiz(quiz);
                                        });                                        
                                    });
                                    div.appendTo(main_div);
                                });
                                $("body").css("opacity", "1.0");                                
                            });
                        }
                        else if(lbl.data("type") === "power_up")
                        {
                            $("body").css("opacity", "0.2");
                            $.post("/data", {"fn": "get_power_ups", "user_identifier": window.user_identifier}).done(function(rr)
                            {
                                $.each(rr.power_ups, function(ii, power_up)
                                {
                                    var power_up_div = $("<div></div>").addClass("power_up_div");
                                    power_up_div.attr("data-identifier", power_up.identifier);
                                    $("<p></p>").text(power_up.name)
                                    .append
                                    (
                                        $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign")
                                        .click(function()
                                        {
                                            var html = $("<div></div>");
                                            $("<p></p>").text("Prizes for reaching " + power_up.name + ":").appendTo(html);
                                            $("<hr />").appendTo(html);
                                            var prize_ul = $("<ul></ul>").css("list-style-type", "decimal");
                                            $("<li></li>").text(currencyFormat(parseFloat(power_up.rep_payout_amount))).appendTo(prize_ul);
                                            $.each(power_up.incentives, function(iii, incentive)
                                            {
                                                $("<li></li>").text(incentive).appendTo(prize_ul);
                                            });
                                            prize_ul.appendTo(html);
                                            BootstrapDialog.show
                                            (
                                                {
                                                    "title": "Swag You Could Score",
                                                    "message": html.html(),
                                                    "buttons":
                                                    [
                                                        {
                                                            "label": "OK",
                                                            "cssClass": "btn-primary",
                                                            "action": function(d)
                                                            {
                                                                d.close();
                                                            }
                                                        }
                                                    ]                                                    
                                                }
                                            );
                                        })
                                    )
                                    .appendTo(power_up_div);
                                    var checkoff_ul = $("<ul></ul>");
                                    $.each(power_up.requirements, function(iii, requirement)
                                    {
                                        var li = $("<li></li>").attr("data-identifier", requirement.identifier);
                                        li.text(requirement.text);
                                        var cb = $("<input />").attr("type", "checkbox");
                                        if(typeof(rr.checkoff_data[power_up.identifier]) + '' !== "undefined")
                                        {
                                            var checked_reqs = rr.checkoff_data[power_up.identifier];
                                            if(checked_reqs.indexOf(requirement.identifier) > -1)
                                            {
                                                cb.attr("checked", "checked");
                                            }
                                        }
                                        cb.change(function()
                                        {
                                            cb.css("opacity", "0.2");
                                            $.post("/data", {"fn": "power_up_checkoff", "checked": ((cb[0].checked * 1) + ''), "identifier": power_up.identifier, "requirement_identifier": requirement.identifier, "user_identifier": window.user_identifier}).done(function(rrrrr)
                                            {
                                                cb.css("opacity", "1.0");
                                            });
                                        });
                                        cb.appendTo(li);
                                        li.appendTo(checkoff_ul);
                                    });
                                    checkoff_ul.appendTo(power_up_div);
                                    $("<span></span>").addClass("label").addClass("label-warning").text("Claim Prize").addClass("label-claim-prize")
                                    .click(function()
                                    {
                                        var that = $(this);
                                        var parent_div = that.closest(".power_up_div").first();
                                        var li_count = parent_div.find("li").length;
                                        var checked_count = 0;
                                        parent_div.find("li").each(function(iiii, eeee)
                                        {
                                            checked_count += $(eeee).find("input").first()[0].checked * 1;
                                        });
                                        if(li_count !== checked_count)
                                        {
                                            window.alert("You have not completed all the requirements for " + power_up.name + ".");
                                            return;
                                        }
                                        parent_div.css("opacity", "0.2");
                                        $.post("/data", {"fn": "claim_power_up_prize", "identifier": power_up.identifier, "user_identifier": window.user_identifier}).done(function(rrrrr)
                                        {
                                            parent_div.css("opacity", "1.0");
                                            if(!rrrrr.success)
                                            {
                                                window.alert(rrrrr.error_msg);
                                                return;
                                            }
                                            BootstrapDialog.show
                                            (
                                                {
                                                    "title": "Congratulations",
                                                    "message": "<p>Please call the rep help desk at <a href='tel:8009809835'>(800) 980-9835</a>, press OPTION 4 to pass off this level.</p>",
                                                    "buttons":
                                                    [
                                                        {
                                                            "label": "What will I get?",
                                                            "cssClass": "btn-primary",
                                                            "action": function(d)
                                                            {                                                                
                                                                parent_div.find(".glyphicon-info-sign").trigger("click");
                                                            }
                                                        },
                                                        {
                                                            "label": "OK",
                                                            "cssClass": "btn-primary",
                                                            "action": function(d)
                                                            {
                                                                d.close();
                                                            }
                                                        }
                                                    ]
                                                }
                                            );
                                        });

                                    }).appendTo(power_up_div);
                                    power_up_div.appendTo(main_div);
                                    $("body").css("opacity", "1.0");
                                });                                
                            });
                        }
                        else
                        {
                            $.post("/data", {"fn": "get_training_media", "type": lbl.data("type")}).done(function(r)
                            {
                                $.each(r.media, function(ii, media)
                                {
                                    var div = $("<div></div>").addClass("training_media").addClass("training_media_" + media.type);
                                    $("<p></p>").text(media.name).appendTo(div);
                                    switch(media.type)
                                    {
                                        case "manager_video":
                                            $("<iframe />").attr("width", "240").attr("height", "160").attr("src", "https://www.youtube.com/embed/" + media.extra_info.youtube_id).attr("frameborder", "0").attr("allowfullscreen", "true").attr("allowFullScreen", "true").appendTo(div);
                                            break;
                                        case "video":
                                            $("<iframe />").attr("width", "240").attr("height", "160").attr("src", "https://www.youtube.com/embed/" + media.extra_info.youtube_id).attr("frameborder", "0").attr("allowfullscreen", "true").attr("allowFullScreen", "true").appendTo(div);
                                            break;
                                        case "manager_audio":
                                            $("<audio></audio>").attr("controls", "true")
                                            .append
                                            (
                                                $("<source></source>").attr("type", "audio/mpeg").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/TrainingMedia/" + media.identifier + ".mp3")
                                            )
                                            .appendTo(div);
                                            break;
                                        case "audio":
                                            $("<audio></audio>").attr("controls", "true")
                                            .append
                                            (
                                                $("<source></source>").attr("type", "audio/mpeg").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/TrainingMedia/" + media.identifier + ".mp3")
                                            )
                                            .appendTo(div);
                                            break;
                                        case "manager_doc":
                                            $("<a></a>").attr("target", "_blank").attr("href", "//storage.googleapis.com/" + window.app_bucket + "/TrainingMedia/" + media.identifier + ".pdf")
                                            .append
                                            (
                                                $("<img />").attr("src", "/bootstrap/images/pdf_icon.png")
                                            )
                                            .appendTo(div);
                                            break;
                                        case "doc":
                                            $("<a></a>").attr("target", "_blank").attr("href", "//storage.googleapis.com/" + window.app_bucket + "/TrainingMedia/" + media.identifier + ".pdf")
                                            .append
                                            (
                                                $("<img />").attr("src", "/bootstrap/images/pdf_icon.png")
                                            )
                                            .appendTo(div);
                                            break;
                                            
                                        default:
                                            break;
                                    }
                                    div.appendTo(main_div);
                                });
                            });
                        }                        
                        
                    });                    
                });

                main_div.appendTo(app_area);
                if(feature_quizzes)
                {
                    $("#quizzes_label").trigger("click");
                }
            }
            function loadLeads(type)
            {
                if(typeof(type) + '' === "undefined")
                {
                    type = "unclaimed"
                }

                hideIconGrid();
                var app_area = $("#app_area");
                $("<h2></h2>").text("Loading...").appendTo(app_area);

                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var cloned = spacer.clone();

                $("<button></button>").addClass("btn").addClass("btn-danger").addClass("leads_back").text("Back").click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                }).appendTo(main_div);
                $("<span></span>").html("&nbsp;&nbsp;&nbsp;").appendTo(main_div);
                $("<span></span>").addClass("label").addClass("label-primary").text("Unclaimed")
                .click(function()
                {
                    clearApp(function()
                    {
                        loadLeads("unclaimed");
                    });
                })
                .appendTo(main_div);
                $("<span></span>").html("&nbsp;&nbsp;&nbsp;").appendTo(main_div);
                $("<span></span>").addClass("label").addClass("label-success").text("Active")
                .click(function()
                {
                    clearApp(function()
                    {
                        loadLeads("active");
                    });                    
                })
                .appendTo(main_div);
                $("<span></span>").html("&nbsp;&nbsp;&nbsp;").appendTo(main_div);
                $("<span></span>").addClass("label").addClass("label-warning").text("Export Leads").on("click", function()
                {
                    var that = $(this);
                    that.off("click");
                    $.post("/data2", {"fn": "rep_leads_export", "rep_id": window.rep_id, "identifier": window.user_identifier}).done(function(r)
                    {
                        BootstrapDialog.alert("Your report will be emailed to you within 10 minutes");
                    });
                }).appendTo(main_div);
                $("<br />").appendTo(main_div);
                $("<br />").appendTo(main_div);

                var options_map = 
                {
                    "default": "Active",
                    "rescheduled": "Reschedule",
                    "lead_cancelled": "Lead Cancelled",
                    "no_contact_but_further_followup": "Not able to contact but will keep following up",
                    "no_contact_no_followup": "Not able to contact and not going to follow up",
                    "going_to_keep_following_up": "Going to keep following up"
                };

                var active_tbl = $("<table></table>").addClass("active_leads_tbl");
                var tbody = $("<tbody></tbody>");
                $("<tr></tr>")
                .append
                (
                    $("<th></th>").text("Name")
                )
                .append
                (
                    $("<th></th>").text("Phone")
                )
                .append
                (
                    $("<th></th>").text("AB Call")
                )
                .append
                (
                    $("<th></th>").text("DL")
                )
                .append
                (
                    $("<th></th>").text("Solar Pro")
                )
                .append
                (
                    $("<th></th>").text("Address")
                )
                .append
                (
                    $("<th></th>").text("Email")
                )
                .append
                (
                    $("<th></th>").text("SP2")
                )
                .append
                (
                    $("<th></th>").text("Actions")
                )
                .append
                (
                    $("<th></th>").text("Notes")
                )
                .append
                (
                    $("<th></th>").text("Admin Notes/Checklist")
                )
                .appendTo(tbody);

                var save_checklist = function(lead, tr)
                {
                    var tbl = tr.closest("table");
                    if(tr.find("td").eq(2).text() === "--/--/----")
                    {
                        tr.find("td").eq(2).text(moment().format("MM/DD/YYYY"));
                    }
                    var data = {};
                    var arr = [];
                    tbl.find("tr").each(function(i, e)
                    {
                        if(i !== 0)
                        {
                            var item = {};
                            item["name"] = $(e).find("td").first().text();
                            item["checked"] = $(e).find("td").eq(1).find("input").first()[0].checked;
                            
                            var dt_to_parse = "";
                            if($(e).find("td").eq(2).find("input").size() > 0)
                            {
                                dt_to_parse = $(e).find("td").eq(2).find("input").val();
                            }
                            else
                            {
                                dt_to_parse = $(e).find("td").eq(2).text();
                            }
                            
                            item["date"] = moment(dt_to_parse, "MM/DD/YYYY").format("YYYY-MM-DD");
                            if(item["date"] === "Invalid date")
                            {
                                item["date"] = "1970-01-01";
                            }
                            arr.push(item);
                            data[item["name"]] = item;
                        }
                    });

                    tbl.css("opacity", "0.2");
                    $.post("/data", {"fn": "save_lead_checklist", "identifier": lead.field_app_identifier, "data": JSON.stringify(data)}).done(function(rr)
                    {
                        lead.admin_checklist = arr;
                        tbl.css("opacity", "1.0");
                    });
                }

                $.post("/data", {"fn": "get_leads_by_type", "type": type, "identifier": window.user_identifier}).done(function(r)
                {
                    var greens = [];
                    var yellows = [];

                    if(type === "unclaimed" && r.leads.length === 0)
                    {
                        loadLeads("active");
                        return;
                    }

                    r.leads = bubbleSortArrayOfObjectsByKey(r.leads, "sp2");

                    $.each(r.leads, function(i, lead)
                    {
                        switch(type)
                        {
                            case "unclaimed":
                                var div = $("<div></div>").addClass("unclaimed_lead_div");
                                $("<p></p>").addClass("unclaimed_lead_name").text(lead.name).appendTo(div);
                                $("<p></p>").addClass("unclaimed_lead_sp2").text(moment(lead.sp2, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm:ss a")).appendTo(div);
                                $("<p></p>").addClass("unclaimed_lead_address")
                                .append
                                (
                                    $("<span></span>").addClass("unclaimed_lead_street").text(lead.address)
                                )
                                .append
                                (
                                    $("<br />")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("unclaimed_lead_city_state").text(lead.city + ", " + lead.state)
                                )
                                .append
                                (
                                    $("<br />")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("unclaimed_lead_postal").text(lead.postal)
                                )
                                .appendTo(div);

                                $("<p></p>").addClass("unclaimed_lead_phone")
                                .append
                                (
                                    $("<a></a>").text(lead.phone).attr("href", "tel:" + lead.phone.digits())
                                )
                                .appendTo(div);

                                $("<p></p>").addClass("unclaimed_lead_email")
                                .append
                                (
                                    $("<a></a>").attr("href", "mailto:" + lead.email).text(lead.email)
                                )
                                .appendTo(div);

                                if(lead.phone_call === null)
                                {
                                    $("<p></p>").text("AB Call Not Available").appendTo(div);
                                }
                                else
                                {
                                    $("<a></a>").attr("href", lead.phone_call).text("AB Call Recording").attr("target", "_blank").appendTo(div);
                                }
                                $("<br />").appendTo(div);

                                $("<button></button").addClass("btn").addClass("btn-warning").addClass("unclaimed_lead_claim_btn").text("Claim it!")
                                .click(function()
                                {
                                    var that = $(this);
                                    that.text("Claiming...");
                                    $.post("/data", {"fn": "claim_lead", "identifier": lead.identifier}).done(function(rr)
                                    {
                                        that.closest(".unclaimed_lead_div").remove();
                                    });
                                }).appendTo(div);

                                div.appendTo(main_div);
                                break;
                            case "active":
                                var tr = $("<tr></tr>").attr("data-identifier", lead.identifier).attr("data-field_app_identifier", lead.field_app_identifier)
                                $("<td></td>").text(lead.name).appendTo(tr);
                                $("<td></td>")
                                .append
                                (
                                    $("<a></a>").attr("href", "tel:" + lead.phone.digits()).text(lead.phone)
                                )
                                .appendTo(tr);
                                
                                $("<td></td>")
                                .append
                                (
                                    $("<span></span>").addClass("label").addClass("label-primary").text("Click to Show")
                                    .click(function()
                                    {
                                        var that = $(this);
                                        $.post("/data2", {"fn": "get_phone_call_for_lead", "identifier": lead.field_app_identifier}).done(function(eee)
                                        {
                                            var parent_td = that.parent();
                                            that.remove();
                                            if(eee.phone_call === null)
                                            {
                                                parent_td.text("N/A");
                                            }
                                            else
                                            {
                                                $("<a></a>").attr("href", eee.phone_call).attr("target", "_blank").text("Link").appendTo(parent_td);
                                            }
                                        });
                                    })
                                )
                                .appendTo(tr);
                                $("<td></td>")
                                .append
                                (
                                    $("<span></span>").addClass("label").addClass("label-primary").text("DL")
                                    .click(function()
                                    {
                                        getDataLoggerInfo(lead.field_app_identifier);
                                    })
                                )
                                .appendTo(tr);
                                
                                if(lead.solar_pro_identifier !== "-1")
                                {
                                    $("<td></td>")
                                    .append
                                    (
                                        $("<img />").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + lead.solar_pro_identifier + ".jpg").css("max-width", "50px")
                                        .append
                                        (
                                            $("<br />")
                                        )
                                    )
                                    .append
                                    (
                                        $("<p></p>").text(lead.solar_pro)
                                    )
                                    .append
                                    (
                                        $("<p></p>")
                                        .append
                                        (
                                            $("<a></a>").attr("href", "tel:" + lead.solar_pro_phone.digits()).text(lead.solar_pro_phone)
                                        )
                                    )
                                    .appendTo(tr);
                                }
                                else
                                {
                                    $("<td></td>").text("n/a").appendTo(tr);
                                }                                

                                $("<td></td>").html
                                (
                                    lead.address + "<br />" + lead.city + ", " + lead.state + "<br />" + lead.postal
                                ).appendTo(tr);
                                $("<td></td>")
                                .append
                                (
                                    $("<a></a>").attr("href", "mailto:" + lead.email).text(lead.email)
                                )
                                .appendTo(tr);

                                var mom = moment(lead.sp2, "YYYY-MM-DD HH:mm:ss");
                                var dt_text = "Not Yet Scheduled";
                                if(mom.year() !== 1970)
                                {
                                    dt_text = mom.format("MM/DD/YYYY hh:mm:ss a");
                                }
                                $("<td></td>").text(dt_text).appendTo(tr);                                

                                var sel = $("<select></select>");
                                $.each(Object.keys(options_map), function(ii, key)
                                {
                                    var opt = $("<option></option>").attr("value", key).text(options_map[key]);
                                    if(opt.attr("value") === lead.status)
                                    {
                                        opt.attr("selected", "selected");
                                    }
                                    opt.appendTo(sel);
                                });
                                sel.change(function()
                                {
                                    var save = function()
                                    {
                                        sel.css("opacity", "0.1");
                                        $.post("/data", {"fn": "update_lead_status", "identifier": sel.closest("tr").data("identifier"), "status": sel.val()}).done(function(rr)
                                        {
                                            clearApp(function()
                                            {
                                                loadLeads("active");
                                            });                                            
                                        });
                                    };

                                    if(sel.val() === "rescheduled")
                                    {
                                        restoreOlderCustomer([], {"name": lead.name, "identifier": sel.closest("tr").data("field_app_identifier")}, false, save);
                                    }
                                    else
                                    {
                                        if((sel.val() === "no_contact_no_followup" || sel.val() === "lead_cancelled") && lead.deal_closed)
                                        {
                                            window.alert("You cannot choose this status for deals which have been closed.");
                                            return;
                                        }
                                        save();
                                    }
                                });
                                $("<td></td>").append(sel).appendTo(tr);
                                $("<td></td>")
                                .append
                                (
                                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").addClass("rep_lead_notes_info_sign")
                                    .click(function()
                                    {
                                        $.post("/data2", {"fn": "get_rep_notes_for_lead", "identifier": lead.field_app_identifier}).done(function(eee)
                                        {
                                            var notes = eee.notes;
                                            while(notes.indexOf("\r") > -1)
                                            {
                                                notes = notes.replace("\r", "");
                                            }

                                            BootstrapDialog.show
                                            (
                                                {
                                                    "title": "Notes for " + lead.name,
                                                    "message": $("<div></div>").append($("<textarea></textarea>").addClass("rep_lead_notes_ta")).html(),
                                                    "buttons":
                                                    [
                                                        {
                                                            "label": "Update",
                                                            "cssClass": "btn-primary",
                                                            "action": function(dia)
                                                            {
                                                                var new_notes = $.trim($(".rep_lead_notes_ta").first().val());
                                                                $(".bootstrap-dialog-footer").find(".btn-primary").text("Updating...");
                                                                $.post("/data", {"fn": "update_lead_notes", "identifier": lead.field_app_identifier, "notes": new_notes}).done(function(rr)
                                                                {
                                                                    dia.close();
                                                                    //lead.notes = new_notes;
                                                                });
                                                            }
                                                        },
                                                        {
                                                            "label": "Close",
                                                            "cssClass": "btn-danger",
                                                            "action": function(dia)
                                                            {
                                                                dia.close();
                                                            }
                                                        }
                                                    ],
                                                    "onshown": function(d)
                                                    {
                                                        $(".rep_lead_notes_ta").first().val(notes);
                                                    }
                                                }
                                            );
                                        });
                                    })
                                ).appendTo(tr);

                                $("<td></td>")
                                .append
                                (
                                    $("<span></span>").addClass("label").addClass("label-primary").addClass("admin_lead_notes_and_checklist_lbl").text("Click to Show")
                                    .click(function()
                                    {
                                        var that3 = $(this);
                                        $.post("/data2", {"fn": "get_admin_notes_and_checklist_for_lead", "identifier": lead.field_app_identifier}).done(function(eee)
                                        {   
                                            var td = that3.parent();
                                            that3.remove();
                                            var notes = eee.admin_notes;
                                            while(notes.indexOf("\r") > -1)
                                            {
                                                notes = notes.replace("\r", "");
                                            }
                                            while(notes.indexOf("\n") > -1)
                                            {
                                                notes = notes.replace("\n", "<br />");
                                            }

                                            $("<p></p>").text("Admin Notes:").appendTo(td);
                                            $("<p></p>").html(notes).appendTo(td);
                                            $("<hr />").appendTo(td);
                                            var tbl2 = $("<table></table>");
                                            tbl2.addClass("admin_lead_info_table");
                                            var tbody2 = $("<tbody></tbody>");
                                            $("<tr></tr>")
                                            .append
                                            (
                                                $("<th></th>").text("Item")
                                            )
                                            .append
                                            (
                                                $("<th></th>").text("Status")
                                            )
                                            .append
                                            (
                                                $("<th></th>").text("Date")
                                            )
                                            .appendTo(tbody2);

                                            $.each(eee.admin_checklist, function(iii, item2)
                                            {                                            
                                                var cb = $("<input />").attr("type", "checkbox").addClass("save_lead_checklist_cb");
                                                var date_mom = moment(item2.date, "YYYY-MM-DD");
                                                var date_txt = date_mom.format("MM/DD/YYYY");
                                                if(date_mom.year() === 1970)
                                                {
                                                    date_txt = "--/--/----"
                                                }
                                                if(item2.checked)
                                                {
                                                    cb.attr("checked", "checked");
                                                }
                                                $("<tr></tr>")
                                                .append
                                                (
                                                    $("<td></td>").text(item2.name)
                                                )
                                                .append
                                                (
                                                    $("<td></td>").append(cb)
                                                )
                                                .append
                                                (
                                                    $("<td></td>").text(date_txt)
                                                    .append
                                                    (
                                                        $("<span></span>").addClass("glyphicon").addClass("glyphicon-pencil").addClass("rep_checklist_date_edit_pencil")
                                                    )
                                                )
                                                .appendTo(tbody2);
                                            });
                                            tbody2.appendTo(tbl2);
                                            tbl2.appendTo(td);

                                            tbl2.find(".save_lead_checklist_cb").each(function(iiii, eeee)
                                            {
                                                $(eeee).change(function()
                                                {
                                                    var tr2 = $(this).closest("tr");
                                                    save_checklist(lead, tr2);
                                                });
                                            });
                                            tbl2.find(".rep_checklist_date_edit_pencil").click(function()
                                            {
                                                var checked_dt = moment();
                                                if($(this).closest("td").text() !== "--/--/----")
                                                {
                                                    checked_dt = moment($(this).closest("td").text(), "MM/DD/YYYY");
                                                }

                                                var td = $(this).closest("td");

                                                td.text("");

                                                $("<div></div>").addClass("input-append").addClass("date").attr("data-date", checked_dt.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                                                .append
                                                (
                                                    $("<input />").attr("type", "text").attr("value", checked_dt.format("MM/DD/YYYY")).attr("size", "16").addClass("span2")
                                                    .keyup(function(ev)
                                                    {
                                                        ev.preventDefault();
                                                    })
                                                    .keydown(function(ev)
                                                    {
                                                        ev.preventDefault();
                                                    })
                                                    .keypress(function(ev)
                                                    {
                                                        ev.preventDefault();
                                                    })
                                                )
                                                .append
                                                (
                                                    $("<span></span>").addClass("add-on").append($("<i></i>").addClass("icon-th"))
                                                )
                                                .appendTo(td);

                                                td.find(".date").first().datepicker
                                                (
                                                    {
                                                        "autoClose": true,
                                                        "format": "mm/dd/yyyy"
                                                    }
                                                );
                                                td.find(".date").first().find("input").first().on("change", function()
                                                {
                                                    save_checklist(lead, td.parent());
                                                });
                                                $(this).remove();
                                            });
                                        });
                                        
                                    })
                                )
                                .appendTo(tr)

                                var arr = greens;
                                
                                if(lead.status === "no_contact_but_further_followup" || lead.status === "going_to_keep_following_up")
                                {
                                    arr = yellows;
                                    tr.addClass("yellow");
                                }
                                else
                                {
                                    tr.addClass("green");
                                }

                                arr.push(tr);
                                break;
                            default:
                                break;
                        }    
                    });

                    if(type === "active")
                    {
                        $.each(greens, function(i, item)
                        {
                            item.appendTo(tbody);
                        });
                        $.each(yellows, function(i, item)
                        {
                            item.appendTo(tbody);
                        });
                        tbody.appendTo(active_tbl);
                        active_tbl.appendTo(main_div);
                    }                  

                    app_area.find("h2").remove();
                    $.each([spacer, main_div, cloned], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                });
            }
            function sp2Annoy(data)
            {
                // disabling completely
                return;


                if("{{ user_type }}" === "solar_pro" || "{{ user_type }}" === "solar_pro_manager")
                {
                    return;
                }
                if("{{ assumed }}" === "1")
                {
                    return;
                }
                if(typeof(data) + '' === "undefined")
                {
                    $.post("/data", {"fn": "sp2_annoy", "identifier": window.user_identifier}).done(function(r)
                    {
                        if(r.has_item)
                        {
                            sp2Annoy(r.item);
                        }
                        else
                        {
                            setTimeout(function()
                            {
                                sp2Annoy();
                            }, 1000 * 60 * 3);
                        }
                    });
                    return;
                }
                $.each(BootstrapDialog.dialogs, function(i, dialog)
                {
                    dialog.close();
                });
                var html = $("<div></div>");

                $("<p></p>").text("Did this customer (" + data.name + ") allow you to come inside their home and sit down with you").appendTo(html);
                $("<select></select>").attr("id", "sp2_annoy_sel1")
                .append
                (
                    $("<option></option>").attr("value", "n/a").text("Choose One")
                )
                .append
                (
                    $("<option></option>").attr("value", "1").text("Yes")
                )
                .append
                (
                    $("<option></option>").attr("value", "0").text("No")
                )
                .appendTo(html);

                $("<hr />").appendTo(html);
                $("<div></div>").css("display", "none").attr("id", "care_sel_sp2_annoy_div")
                .append
                (
                    $("<select></select>").attr("id", "sp2_annoy_care_sel")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose One")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "not_care").text("NOT CARE/Medical")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "care").text("CARE/Medical")
                    )
                )
                .append
                (
                    $("<hr />")
                )
                .appendTo(html);

                $("<div></div>").css("display", "none").attr("id", "usage_sel_sp2_annoy_div")
                .append
                (
                    $("<select></select>").attr("id", "sp2_usage_sel")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose One")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "real").text("Solar Pro's uage data was real")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "estimated").text("Usage data from the Solar Pro was estimated")
                    )
                )
                .append
                (
                    $("<hr />")
                )
                .appendTo(html);

                var options_map = 
                {
                    "default": "Active",
                    "rescheduled": "Reschedule",
                    "lead_cancelled": "Lead Cancelled",
                    "no_contact_but_further_followup": "Not able to contact but will keep following up",
                    "no_contact_no_followup": "Not able to contact and not going to follow up",
                    "going_to_keep_following_up": "Going to keep following up"
                };

                var no_options_div = $("<div></div>").addClass("sp2_annoy_no_options_div");
                $("<p></p>").text("Please update the status of this lead:").appendTo(no_options_div);
                var no_sel = $("<select></select>").attr("id", "sp2_annoy_sel2");
                $.each(Object.keys(options_map), function(i, key)
                {
                    $("<option></option>").text(options_map[key]).attr("value", key).appendTo(no_sel);
                });

                no_sel.appendTo(no_options_div);

                no_options_div.appendTo(html);

                if(data.is_lead)
                {
                    $("<p></p>").text("Optional Lead Notes:").appendTo(html);
                    $("<textarea></textarea>").addClass("sp2_annoy_opt_lead_notes").appendTo(html);
                }

                var show_again = true;

                BootstrapDialog.show
                (
                    {
                        "title": "What happened with " + data.name,
                        "message": html.html(),
                        "buttons":
                        [
                            {
                                "label": "Submit",
                                "cssClass": "btn-primary",
                                "action": function(d)
                                {
                                    var note_txt = "";
                                    if($(".sp2_annoy_opt_lead_notes").size() > 0)
                                    {
                                        note_txt = $.trim($(".sp2_annoy_opt_lead_notes").first().val());
                                    }

                                    var y_n_val = $(".bootstrap-dialog-body").first().find("select").first().val();
                                    if(y_n_val === "n/a")
                                    {
                                        window.alert("Please specify whether you went inside the customer's home or not.");
                                        return;
                                    }
                                    else if(y_n_val === "1")
                                    {
                                        var val = $("#sp2_annoy_care_sel").val();
                                        if(val === "n/a")
                                        {
                                            window.alert("You must specify whether this is a CARE/Medical customer");
                                            return;
                                        }

                                        var val2 = $("#sp2_usage_sel").val();
                                        if(val2 === "n/a")
                                        {
                                            window.alert("You must specify what type of usage data was obtained by the solar pro");
                                            return;
                                        }
                                        $(".bootstrap-dialog-footer").find(".btn-primary").text("Submitting...");
                                        
                                        var care_value = "0";
                                        if(val === "care")
                                        {
                                            care_value = "1";
                                        }
                                        
                                        $.post("/data", {"fn": "confirm_sp2_lead", "data": JSON.stringify(data), "identifier": window.user_identifier, "note_txt": note_txt, "care_value": care_value, "usage_type": val2}).done(function(r)
                                        {
                                            show_again = false;
                                            d.close();
                                        });
                                    }
                                    else if(y_n_val === "0")
                                    {
                                        if($("#sp2_annoy_sel2").val() === "rescheduled")
                                        {
                                            show_again = false;
                                            var save = function() {};
                                            if(data.lead_identifier !== null)
                                            {
                                                save = function()
                                                {
                                                    $.post("/data", {"fn": "update_lead_status", "user_identifier": window.user_identifier, "identifier": data.lead_identifier, "status": $("#sp2_annoy_sel2").val(), "note_txt": note_txt}).done(function(rr)
                                                    {
                                                    });
                                                };
                                            }
                                            d.close();
                                            restoreOlderCustomer([], {"name": data.name, "identifier": data.identifier}, false, save);
                                        }
                                        else
                                        {                                            
                                            var save2 = function()
                                            {
                                                if(data.lead_identifier !== null)
                                                {
                                                    $.post("/data", {"fn": "update_lead_status", "user_identifier": window.user_identifier, "identifier": data.lead_identifier, "status": $("#sp2_annoy_sel2").val(), "from_sp2_annoy": "1", "note_txt": note_txt}).done(function(rr)
                                                    {
                                                    });
                                                }
                                                else
                                                {
                                                    $.post("/data", {"fn": "complete_sp2_dialog", "identifier": data.identifier}).done(function(rr)
                                                    {
                                                    });
                                                }                                           
                                            }
                                            show_again = false;
                                            d.close();
                                            save2();
                                        }
                                    }

                                }
                            }
                        ],
                        "onhidden": function(d)
                        {
                            if(show_again)
                            {
                                sp2Annoy(data);
                            }
                            else
                            {
                                setTimeout(function()
                                {
                                    sp2Annoy();
                                }, 1000 * 60 * 3);
                            }
                        },
                        "onshown": function(d)
                        {
                            $("#sp2_annoy_sel1").change(function()
                            {
                                if($(this).val() === "1")
                                {
                                    //$(".sp2_annoy_no_options_div").css("display", "none");
                                }
                                $(".sp2_annoy_no_options_div").css("display", ["none", "block"][($(this).val() !== "1") * 1]);                                
                            });
                            window.temp_intervals.push
                            (
                                setInterval(function()
                                {
                                    var val = $("#sp2_annoy_sel1").val();
                                    if(val === "1")
                                    {
                                        $("#care_sel_sp2_annoy_div, #usage_sel_sp2_annoy_div").css("display", "block");
                                    }
                                    else
                                    {
                                        $("#care_sel_sp2_annoy_div, #usage_sel_sp2_annoy_div").css("display", "none");
                                        $("#sp2_annoy_care_sel, #sp2_usage_sel").val("n/a");
                                    }
                                }, 100)
                            );
                        }
                    }
                )
            }
            if("{{ user_type }}" === "solar_pro" || "{{ user_type }}" === "solar_pro_manager")
            {
                window.sp2Annoy = function(){};
            }
            function showMyABs()
            {
                hideIconGrid();
                var app_area = $("#app_area");
                var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1")
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10")
                var spacer_clone = spacer_div.clone();

                $("<h2></h2>").text("Loading...").appendTo(app_area);

                $.post("/data", {"fn": "get_my_abs", "identifier": window.user_identifier}).done(function(r)
                {
                    app_area.find("h2").text("My ABs:");
                    $("<hr />").appendTo(main_div);

                    $("<button></button>").addClass("btn").addClass("btn-danger").text("Back").addClass("my_abs_back_btn")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                    .appendTo(main_div);

                    var table = $("<table></table>").addClass("my_abs_tbl");
                    var tbody = $("<tbody></tbody>");

                    var options_map = 
                    {
                        "unclaimed": "Unclaimed",
                        "default": "Active",
                        "rescheduled": "Reschedule",
                        "lead_cancelled": "Lead Cancelled",
                        "no_contact_but_further_followup": "Not able to contact but will keep following up",
                        "no_contact_no_followup": "Not able to contact and not going to follow up",
                        "going_to_keep_following_up": "Going to keep following up"
                    };

                    $("<tr></tr>")
                    .append
                    (
                        $("<th></th>").text("Name")
                    )
                    .append
                    (
                        $("<th></th>").text("Address")
                    )
                    .append
                    (
                        $("<th></th>").text("Phone")
                    )
                    .append
                    (
                        $("<th></th>").text("SP2")
                    )
                    .append
                    (
                        $("<th></th>").text("Status")
                    )
                    .append
                    (
                        $("<th></th>").text("Rep")
                    )
                    .append
                    (
                        $("<th></th>").text("Notes")
                    )
                    .append
                    (
                        $("<th></th>").text("AK")
                    )
                    .append
                    (
                        $("<th></th>").text("CD")
                    )
                    .appendTo(tbody);

                    var y_n_map = ["No", "Yes"]

                    $.each(r.abs, function(i, ab)
                    {
                        var tr = $("<tr></tr>");
                        $("<td></td>")
                        .text
                        (
                            ab.name
                        ).appendTo(tr);
                        $("<td></tr>").html(ab.address.split("\n").join("<br />")).appendTo(tr);
                        $("<td></td>")
                        .append
                        (
                            $("<a></a>").attr("href", "tel:" + ab.phone.digits()).text(ab.phone)
                        )
                        .appendTo(tr);
                        $("<td></td>").text(moment(ab.sp_two, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm:ss a")).appendTo(tr);
                        $("<td></td>").text(options_map[ab.status]).appendTo(tr);
                        $("<td></td>")
                        .append
                        (
                            $("<img />").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + ab.rep_identifier + ".jpg").css("max-width", "50px")
                        )
                        .append
                        (
                            $("<br />")
                        )
                        .append
                        (
                            $("<p></p>").text(ab.rep_name)
                        )
                        .append
                        (
                            $("<a></a>").attr("href", "tel:" + ab.rep_phone.digits()).text(ab.rep_phone)
                        )
                        .appendTo(tr);
                        $("<td></td>")
                        .append
                        (
                            $("<span></span>").addClass("glyphicon").addClass("glyphicon-info-sign").addClass("my_ab_notes_info")
                            .click(function()
                            {
                                var notes = ab.notes;
                                while(notes.indexOf("\r") > -1)
                                {
                                    notes = notes.replace("\r", "");
                                }
                                while(notes.indexOf("\n") > -1)
                                {
                                    notes = notes.replace("\n", "<br />");
                                }
                                BootstrapDialog.show
                                (
                                    {
                                        "title": "Notes for " + ab.name,
                                        "message": $("<div></div>").append($("<p></p>").html(notes)).html(),
                                        "buttons":
                                        [
                                            {
                                                "label": "OK",
                                                "cssClass": "btn-primary",
                                                "action": function(dia)
                                                {
                                                    dia.close();
                                                }
                                            }
                                        ]
                                    }
                                );
                            })
                        )
                        .appendTo(tr);
                        $("<td></td>")
                        .text
                        (
                            y_n_map[ab.ak * 1]
                        )
                        .appendTo(tr);

                        $("<td></td>")
                        .text
                        (
                            y_n_map[ab.cd * 1]
                        )
                        .appendTo(tr)
                        tr.appendTo(tbody);
                    });
                    tbody.appendTo(table);
                    table.appendTo(main_div);

                    $.each([spacer_div, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                });
            }
            function loadSP2Calendar()
            {
                hideIconGrid();
                var app_area = $("#app_area");
                var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1")
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10")
                var spacer_clone = spacer_div.clone();

                $("<h2></h2>").text("Loading...").appendTo(app_area);
                //$.post("/data2", {"fn": "sp_calendar_v2", "rep_id": window.rep_id}).done(function(r)
                $.post("/data2", {"fn": "sp_calendar_v2", "identifier": window.user_identifier}).done(function(r)
                {
                    app_area.find("h2").remove();
                    $("<button></button>").addClass("btn").addClass("btn-danger").addClass("sp2_cal_back_button").html("&larr; Back")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                    .appendTo(main_div);
                    $("<br />").appendTo(main_div);
                    $("<br />").appendTo(main_div);
                    $("<button></button>").addClass("btn").addClass("btn-primary").text("Add Event")
                    .click(function()
                    {
                        var html = $("<div></div>");
                        $("<p></p>").text("Is this a recurring event?").appendTo(html);
                        $("<br />").appendTo(html);

                        BootstrapDialog.show
                        (
                            {
                                "title": "Make your selection",
                                "message": html.html(),
                                "buttons":
                                [
                                    {
                                        "label": "No",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            d.close();
                                            var html2 = $("<div></div>");
                                            $("<p></p>").text("Name this event:").appendTo(html2);
                                            $("<input />").css("width", "100%").css("text-indent", "0.5em").css("background", "rgba(255, 255, 255, 0.1)").css("border", "0px solid #000000").attr("id", "custom_event_name").appendTo(html2);
                                            $("<p></p>").appendTo(html2);
                                            $("<p></p>").text("Date:").appendTo(html2);
                                            $("<div></div>").attr("id", "custom_event_start_dt").addClass("input-append").addClass("date").attr("data-date", "12-02-2012").attr("data-date-format", "mm-dd-yyyy")
                                            .append
                                            (
                                                $("<input  />").addClass("span2").addClass("eightpoint5").attr("size", "16").attr("type", "text").attr("value", moment().format("MM/DD/YYYY"))
                                                .on("keyup", function(ev)
                                                {
                                                    ev.preventDefault();
                                                })
                                                .on("keydown", function(ev)
                                                {
                                                    ev.preventDefault();
                                                })
                                                .on("keypress", function(ev)
                                                {
                                                    ev.preventDefault();
                                                })
                                            )
                                            .append
                                            (
                                                $("<span></span>").addClass("add-on")
                                                .append
                                                (
                                                    $("<i></i>").addClass("icon-th")
                                                )
                                            )
                                            .appendTo(html2);
                                            $("<br />").appendTo(html2);
                                            $("<p></p>").text("Choose the start time").appendTo(html2);
                                            var hour_sel = $("<select></select>").css("background", "#000000")
                                            .append
                                            (
                                                $("<option></option>").attr("value", "n/a").text("Choose One")
                                            );

                                            for(var hour = 0; hour < 24; hour++)
                                            {
                                                for(var min = 0; min < 60; min+= 5)
                                                {
                                                    var opt = $("<option></option>");
                                                    opt.attr("value", (hour + '') + ":" + (min + ''));
                                                    var hour_text = parseInt(hour);
                                                    var am_pm = "AM";
                                                    if(hour >= 12)
                                                    {
                                                        am_pm = "PM"
                                                    }
                                                    if(hour > 12)
                                                    {
                                                        hour_text -= 12;
                                                    }
                                                    if(hour === 0)
                                                    {
                                                        hour_text = 12;
                                                    }
                                                    hour_text += '';
                                                    if(hour_text.length === 1)
                                                    {
                                                        hour_text = "0" + hour_text;
                                                    }
                                                    var min_text = min + '';
                                                    if(min_text.length === 1)
                                                    {
                                                        min_text = "0" + min_text;
                                                    }
                                                    opt.text(hour_text + ":" + min_text + " " + am_pm);
                                                    opt.appendTo(hour_sel);
                                                }
                                            } 
                                            hour_sel.appendTo(html2);
                                            $("<p></p>").appendTo(html2);

                                            $("<p></p>").text("Choose the end time").appendTo(html2);
                                            var min_sel = $("<select></select>").css("background", "#000000")
                                            .append
                                            (
                                                $("<option></option>").attr("value", "n/a").text("Choose One")
                                            );
                                            for(var hour = 0; hour < 24; hour++)
                                            {
                                                for(var min = 0; min < 60; min+= 5)
                                                {
                                                    var opt = $("<option></option>");
                                                    opt.attr("value", (hour + '') + ":" + (min + ''));
                                                    var hour_text = parseInt(hour);
                                                    var am_pm = "AM";
                                                    if(hour >= 12)
                                                    {
                                                        am_pm = "PM"
                                                    }
                                                    if(hour > 12)
                                                    {
                                                        hour_text -= 12;
                                                    }
                                                    if(hour === 0)
                                                    {
                                                        hour_text = 12;
                                                    }
                                                    hour_text += '';
                                                    if(hour_text.length === 1)
                                                    {
                                                        hour_text = "0" + hour_text;
                                                    }
                                                    var min_text = min + '';
                                                    if(min_text.length === 1)
                                                    {
                                                        min_text = "0" + min_text;
                                                    }
                                                    opt.text(hour_text + ":" + min_text + " " + am_pm);
                                                    opt.appendTo(min_sel);
                                                    
                                                }
                                            } 
                                            min_sel.appendTo(html2);
                                            $("<br />").appendTo(html2);


                                            BootstrapDialog.show
                                            (
                                                {
                                                    "title": "Details",
                                                    "message": html2.html(),
                                                    "buttons":
                                                    [
                                                        {
                                                            "label": "Cancel",
                                                            "cssClass": "btn-danger",
                                                            "action": function(d2)
                                                            {
                                                                d2.close();
                                                            }
                                                        },
                                                        {
                                                            "label": "Save",
                                                            "cssClass": "btn-primary",
                                                            "action": function(d2)
                                                            {
                                                                var name = $.trim($("#custom_event_name").val());
                                                                if(name.length === 0)
                                                                {
                                                                    window.alert("You must name this event.");
                                                                    return;
                                                                }
                                                                var body = $(".bootstrap-dialog-body");
                                                                var start_value = body.find("select").first().val();
                                                                if(start_value === "n/a")
                                                                {
                                                                    window.alert("You must choose a starting time");
                                                                    return;
                                                                }
                                                                var end_value = body.find("select").last().val();
                                                                if(end_value === "n/a")
                                                                {
                                                                    window.alert("You must choose an end time.");
                                                                    return;
                                                                }

                                                                var payload = {};
                                                                payload["identifier"] = window.user_identifier;

                                                                var date_values = body.find("input").last().val();
                                                                var split_date_values = date_values.split("/");

                                                                var start_hour = parseInt(start_value.split(":")[0]);
                                                                start_hour += '';
                                                                if(start_hour.length === 1)
                                                                {
                                                                    start_hour = "0" + start_hour;
                                                                }
                                                                var start_minute = parseInt(start_value.split(":")[1]);
                                                                start_minute += '';
                                                                if(start_minute.length === 1)
                                                                {
                                                                    start_minute = "0" + start_minute;
                                                                }

                                                                var end_hour = parseInt(end_value.split(":")[0]);
                                                                end_hour += '';
                                                                if(end_hour.length === 1)
                                                                {
                                                                    end_hour = "0" + end_hour;
                                                                }
                                                                var end_minute = parseInt(end_value.split(":")[1]);
                                                                end_minute += '';
                                                                if(end_minute.length === 1)
                                                                {
                                                                    end_minute = "0" + end_minute;
                                                                }

                                                                var dt = moment(split_date_values[2] + "-" + split_date_values[0] + "-" + split_date_values[1]);


                                                                payload["date"] = dt.format("YYYY-MM-DD");
                                                                payload["start_hours"] = start_hour;
                                                                payload["start_minutes"] = start_minute;
                                                                payload["end_hours"] = end_hour;
                                                                payload["end_minutes"] = end_minute;
                                                                payload["name"] = name;
                                                                payload["subtract_minute"] = "1";
                                                                payload["repeats_monday"] = "0";
                                                                payload["repeats_tuesday"] = "0";
                                                                payload["repeats_wednesday"] = "0";
                                                                payload["repeats_thursday"] = "0";
                                                                payload["repeats_friday"] = "0";
                                                                payload["repeats_saturday"] = "0";
                                                                payload["repeats_sunday"] = "0";

                                                                payload["type"] = "CreateEventForRep";
                                                                $.ajax('/AppData',
                                                                {
                                                                    type: 'post',
                                                                    data: JSON.stringify(payload),
                                                                    dataType: 'json',
                                                                    contentType: 'application/json',
                                                                    success: function(d3)
                                                                    {
                                                                        d2.close();
                                                                        clearApp(function()
                                                                        {
                                                                            loadSP2Calendar();
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    ],
                                                    "onshown": function(d2)
                                                    {
                                                        $("#custom_event_start_dt, #custom_event_start_dt input").datepicker
                                                        (
                                                            {
                                                                format: "mm/dd/yyyy",
                                                                autoClose: true,
                                                            }
                                                        );
                                                    }
                                                }
                                            );                                        

                                        }
                                    },
                                    {
                                        "label": "Yes",
                                        "cssClass": "btn-primary",
                                        "action": function(d)
                                        {
                                            d.close();

                                            var html2 = $("<div></div>");
                                            $("<p></p>").text("Name this event:").appendTo(html2);
                                            $("<input />").css("width", "100%").css("text-indent", "0.5em").css("background", "rgba(255, 255, 255, 0.1)").css("border", "0px solid #000000").attr("id", "custom_event_name").appendTo(html2);
                                            $("<p></p>").appendTo(html2);                                            
                                            $("<p></p>").text("Choose the start time").appendTo(html2);
                                            var hour_sel = $("<select></select>").css("background", "#000000")
                                            .append
                                            (
                                                $("<option></option>").attr("value", "n/a").text("Choose One")
                                            );

                                            for(var hour = 0; hour < 24; hour++)
                                            {
                                                for(var min = 0; min < 60; min+= 5)
                                                {
                                                    var opt = $("<option></option>");
                                                    opt.attr("value", (hour + '') + ":" + (min + ''));
                                                    var hour_text = parseInt(hour);
                                                    var am_pm = "AM";
                                                    if(hour >= 12)
                                                    {
                                                        am_pm = "PM"
                                                    }
                                                    if(hour > 12)
                                                    {
                                                        hour_text -= 12;
                                                    }
                                                    if(hour === 0)
                                                    {
                                                        hour_text = 12;
                                                    }
                                                    hour_text += '';
                                                    if(hour_text.length === 1)
                                                    {
                                                        hour_text = "0" + hour_text;
                                                    }
                                                    var min_text = min + '';
                                                    if(min_text.length === 1)
                                                    {
                                                        min_text = "0" + min_text;
                                                    }
                                                    opt.text(hour_text + ":" + min_text + " " + am_pm);
                                                    opt.appendTo(hour_sel);
                                                }
                                            } 
                                            hour_sel.appendTo(html2);
                                            $("<p></p>").appendTo(html2);

                                            $("<p></p>").text("Choose the end time").appendTo(html2);
                                            var min_sel = $("<select></select>").css("background", "#000000")
                                            .append
                                            (
                                                $("<option></option>").attr("value", "n/a").text("Choose One")
                                            );
                                            for(var hour = 0; hour < 24; hour++)
                                            {
                                                for(var min = 0; min < 60; min+= 5)
                                                {
                                                    var opt = $("<option></option>");
                                                    opt.attr("value", (hour + '') + ":" + (min + ''));
                                                    var hour_text = parseInt(hour);
                                                    var am_pm = "AM";
                                                    if(hour >= 12)
                                                    {
                                                        am_pm = "PM"
                                                    }
                                                    if(hour > 12)
                                                    {
                                                        hour_text -= 12;
                                                    }
                                                    if(hour === 0)
                                                    {
                                                        hour_text = 12;
                                                    }
                                                    hour_text += '';
                                                    if(hour_text.length === 1)
                                                    {
                                                        hour_text = "0" + hour_text;
                                                    }
                                                    var min_text = min + '';
                                                    if(min_text.length === 1)
                                                    {
                                                        min_text = "0" + min_text;
                                                    }
                                                    opt.text(hour_text + ":" + min_text + " " + am_pm);
                                                    opt.appendTo(min_sel);
                                                    
                                                }
                                            } 
                                            min_sel.appendTo(html2);
                                            $("<br />").appendTo(html2);
                                            $("<p></p>").appendTo(html2);

                                            var ul = $("<ul></ul>");
                                            
                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_monday").text("Monday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_tuesday").text("Tuesday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_wednesday").text("Wednesday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_thursday").text("Thursday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_friday").text("Friday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_saturday").text("Saturday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").addClass("repeated_day_custom_li").attr("id", "repeats_sunday").text("Sunday")
                                            .append
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            ul.appendTo(html2);


                                            BootstrapDialog.show
                                            (
                                                {
                                                    "title": "Details",
                                                    "message": html2.html(),
                                                    "buttons":
                                                    [
                                                        {
                                                            "label": "Cancel",
                                                            "cssClass": "btn-danger",
                                                            "action": function(d2)
                                                            {
                                                                d2.close();
                                                            }
                                                        },
                                                        {
                                                            "label": "Save",
                                                            "cssClass": "btn-primary",
                                                            "action": function(d2)
                                                            {
                                                                var name = $.trim($("#custom_event_name").val());
                                                                if(name.length === 0)
                                                                {
                                                                    window.alert("You must name this event.");
                                                                    return;
                                                                }
                                                                var body = $(".bootstrap-dialog-body");

                                                                var start_value = body.find("select").first().val();
                                                                if(start_value === "n/a")
                                                                {
                                                                    window.alert("You must choose a starting time");
                                                                    return;
                                                                }
                                                                var end_value = body.find("select").last().val();
                                                                if(end_value === "n/a")
                                                                {
                                                                    window.alert("You must choose an end time.");
                                                                    return;
                                                                }

                                                                var found_tally = 0;
                                                                body.find("li").each(function(i, e)
                                                                {
                                                                    found_tally += ($(e).find("input").first()[0].checked * 1);
                                                                });
                                                                if(found_tally === 0)
                                                                {
                                                                    window.alert("The event must have at least one repeated day applied to it.");
                                                                    return;
                                                                }

                                                                var payload = {};
                                                                payload["identifier"] = window.user_identifier;

                                                                var date_values = body.find("input").last().val();
                                                                var split_date_values = date_values.split("/");

                                                                var start_hour = parseInt(start_value.split(":")[0]);
                                                                start_hour += '';
                                                                if(start_hour.length === 1)
                                                                {
                                                                    start_hour = "0" + start_hour;
                                                                }
                                                                var start_minute = parseInt(start_value.split(":")[1]);
                                                                start_minute += '';
                                                                if(start_minute.length === 1)
                                                                {
                                                                    start_minute = "0" + start_minute;
                                                                }

                                                                var end_hour = parseInt(end_value.split(":")[0]);
                                                                end_hour += '';
                                                                if(end_hour.length === 1)
                                                                {
                                                                    end_hour = "0" + end_hour;
                                                                }
                                                                var end_minute = parseInt(end_value.split(":")[1]);
                                                                end_minute += '';
                                                                if(end_minute.length === 1)
                                                                {
                                                                    end_minute = "0" + end_minute;
                                                                }

                                                                payload["date"] = "2000-01-01";
                                                                payload["start_hours"] = start_hour;
                                                                payload["start_minutes"] = start_minute;
                                                                payload["end_hours"] = end_hour;
                                                                payload["end_minutes"] = end_minute;
                                                                payload["name"] = name;

                                                                $.each(["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"], function(i, e)
                                                                {
                                                                    payload["repeats_" + e] = ($("#repeats_" + e).find("input").first()[0].checked * 1) + '';
                                                                });

                                                                payload["subtract_minute"] = "1";
                                                                payload["type"] = "CreateEventForRep";
                                                                $.ajax('/AppData',
                                                                {
                                                                    type: 'post',
                                                                    data: JSON.stringify(payload),
                                                                    dataType: 'json',
                                                                    contentType: 'application/json',
                                                                    success: function(d3)
                                                                    {
                                                                        d2.close();
                                                                        clearApp(function()
                                                                        {
                                                                            loadSP2Calendar();
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    ]
                                                }
                                            );
                                        }
                                    }
                                ]
                            }
                        );
                    }).appendTo(main_div);
                    $("<br />").appendTo(main_div);
                    $("<br />").appendTo(main_div);
                    $("<div></div>").attr("id", "sp2_fcal").appendTo(main_div);
                    var events_data = [];
                    $.each(r.events, function(i, appointment)
                    {
                        var obj = {};
                        obj["title"] = appointment.name;
                        obj["repeated"] = false;
                        obj["start"] = appointment.start_dt.replace(" ", "T");
                        obj["end"] = appointment.end_dt.replace(" ", "T");
                        obj["allDay"] = false;
                        obj["field_app_identifier"] = appointment.field_app_identifier;
                        obj["identifier"] = appointment.identifier;
                        obj["details"] = appointment.details;
                        obj["start_dt"] = appointment.start_dt;
                        obj["end_dt"] = appointment.end_dt;
                        obj["name"] = appointment.name;
                        obj["event_key"] = appointment.event_key;
                        events_data.push(obj);
                    });

                    $.each([spacer_div, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });

                    var cal = $("#sp2_fcal").fullCalendar
                    (
                        {
                            "events": events_data,
                            "eventRender": function(ev, $event, view)
                            {
                                $event.data("identifier", ev.identifier).attr("data-identifier", ev.identifier)
                                .data("field_app_identifier", ev.field_app_identifier).attr("data-field_app_identifier", ev.field_app_identifier)
                                .data("details", ev.details).attr("data-details", ev.details)
                                .data("start_dt", ev.start_dt).attr("data-start_dt", ev.start_dt)
                                .data("end_dt", ev.end_dt).attr("data-end_dt", ev.start_dt)
                                .data("name", ev.name).attr("data-name", ev.name)
                                .data("event_key", ev.event_key).attr("data-event_key", ev.event_key)
                                .data("identifier", ev.identifier).attr("data-identifier", ev.identifier)
                                .addClass("sp2_ev_item")
                                .on("click", function()
                                {
                                    var html = $("<div></div>");
                                    $("<b></b>").text(ev.name).appendTo(html);
                                    $("<hr />").appendTo(html);
                                    var mom1 = moment(ev.start_dt, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm:ss a");
                                    var mom2 = moment(ev.end_dt, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm:ss a");
                                    $("<p></p>").css("color", "#F0F8FF").text(mom1 + " --- " + mom2).appendTo(html);
                                    var details = ev.details;                                    
                                    var values = ev.details.split("\n");
                                    $("<p></p>").html(values.join("<br />")).appendTo(html);
                                    $("<hr />").appendTo(html);
                                    $("<p></p>").attr("id", "sp_details_name").text("Solar Pro: Please Wait").appendTo(html);
                                    $("<p></p>").attr("id", "sp_details_phone").text("Solar Pro Phone: Please Wait").appendTo(html);

                                    var buttons = [];
                                    if(ev.field_app_identifier.length === 128)
                                    {
                                        var reschedule_button = 
                                        {
                                            "label": "Reschedule",
                                            "cssClass": "btn-success",
                                            "action": function(d)
                                            {
                                                restoreOlderCustomer([], {"name": ev.name.replace(" - SP2", ""), "identifier": ev.field_app_identifier}, false, function()
                                                {
                                                    clearApp(function()
                                                    {
                                                        d.close();
                                                        loadSP2Calendar();
                                                    });
                                                });
                                            }
                                        };
                                        buttons.push(reschedule_button);

                                        var cancel_lead_button = 
                                        {
                                            "label": "Cancel Customer",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                $.post("/data", {"fn": "cancel_lead_status_from_rep_portal_calendar", "identifier": ev.field_app_identifier}).done(function(rrrrrrrrrr)
                                                {
                                                    d.close();
                                                    clearApp(function()
                                                    {
                                                        loadSP2Calendar();
                                                    });
                                                });
                                            }
                                        };
                                        buttons.push(cancel_lead_button);
                                    }
                                    else
                                    {
                                        var delete_button = 
                                        {
                                            "label": "Delete Event",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                var payload = {"type": "DropCalendarEvent", "identifier": ev.identifier};

                                                $.ajax('/AppData',
                                                {
                                                    type: 'post',
                                                    data: JSON.stringify(payload),
                                                    dataType: 'json',
                                                    contentType: 'application/json',
                                                    success: function(d3)
                                                    {
                                                        d.close();
                                                        clearApp(function()
                                                        {
                                                            loadSP2Calendar();
                                                        });
                                                    }
                                                });
                                            }
                                        };
                                        buttons.push(delete_button);
                                    }

                                    BootstrapDialog.show
                                    (
                                        {
                                            "title": ev.name,
                                            "message": html.html(),
                                            "buttons": buttons,
                                            "onshown": function(d)
                                            {
                                                $.post("/data", {"fn": "get_sp_details", "identifier": ev.field_app_identifier}).done(function(sp_details)
                                                {
                                                    if(sp_details.name === "Self-Gen")
                                                    {
                                                        $("#sp_details_name, #sp_details_phone").remove();
                                                    }
                                                    $("#sp_details_name").text(sp_details.name);
                                                    $("#sp_details_phone").text("Solar Pro Phone: ");
                                                    $("<a></a>").attr("href", "tel:" + sp_details.phone).text(sp_details.phone_formatted).appendTo($("#sp_details_phone"));
                                                });
                                            }
                                        }
                                    );
                                });
                            },
                            "header":
                            {
                                "left": 'prev,today,next',
                                "center": 'title',
                                "right": 'month,agendaWeek,agendaDay'
                            },
                            "height": "auto",
                            "minTime": "07:00:00",
                            "maxTime": "22:00:00",
                            "defaultView": "agendaWeek"
                        }
                    );
                });
            }
            function BreadCrumbIframe(contacts)
            {
                hideIconGrid();            
                if(typeof(contacts) + '' === "undefined")
                {
                    $.post("./data", {"fn": "list_all_users", "kicks": "0"}).done(function(responsee)
                    {
                        contacts = responsee.contacts;
                        // build the contacts dictionary and the identifier => name map
                        var hint_dictionary = {};
                        var ident_name_map = {};

                        // do the first name hints
                        $.each(contacts, function(i, contact)
                        {
                            ident_name_map[contact.identifier] = contact.name;

                            var fname = contact.first_name.toLowerCase();
                            for(var k = 0; k < fname.length; k++)
                            {
                                var hint = fname.substring(0, k + 1);
                                if(typeof(hint_dictionary[hint]) + '' === "undefined")
                                {
                                    hint_dictionary[hint] = [];
                                }
                                hint_dictionary[hint].push
                                (
                                    {
                                        "name": contact.name,
                                        "identifier": contact.identifier,
                                        "rep_id": contact.rep_id
                                    }
                                );
                            }

                            var lname = contact.last_name.toLowerCase();
                            for(var k = 0; k < lname.length; k++)
                            {
                                var hint = lname.substring(0, k + 1);
                                if(typeof(hint_dictionary[hint]) + '' === "undefined")
                                {
                                    hint_dictionary[hint] = [];
                                }
                                hint_dictionary[hint].push
                                (
                                    {
                                        "name": contact.name,
                                        "identifier": contact.identifier,
                                        "rep_id": contact.rep_id
                                    }
                                );
                            }

                            var name = contact.name.toLowerCase();
                            for(var k = 0; k < name.length; k++)
                            {
                                var hint = name.substring(0, k + 1);
                                if(typeof(hint_dictionary[hint]) + '' === "undefined")
                                {
                                    hint_dictionary[hint] = [];
                                }
                                hint_dictionary[hint].push
                                (
                                    {
                                        "name": contact.name,
                                        "identifier": contact.identifier,
                                        "rep_id": contact.rep_id
                                    }
                                );
                            }
                        }); 
                        contacts = hint_dictionary;
                        BreadCrumbIframe(contacts);
                    });
                    return;
                }
                var app_area = $("#app_area");
                
                var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer_div.clone();
                
                $.post("/data", {"fn": "office_data_v2"}).done(function(r)
                {
                    var loadIframe = function(custom, start_dt, end_dt)
                    {
                        if(typeof(custom) + '' === "undefined")
                        {
                            custom = false;
                        }
                        if($("#breadcrumb_select_rep").val() !== "n/a")
                        {
                            $("#breadcrumb_iframe").remove();
                        
                            var url = "/breadcrumbs/identifier/" + $("#breadcrumb_select_rep").val() + "/date/" + moment($("#breadcrumb_dp").find("input").val(), "MM/DD/YYYY").format("YYYY-MM-DD") + "/hour/" + $("#breadcrumb_select_hour").val();
                            if(custom)
                            {
                                url = "/breadcrumbs/identifier/" + encodeURIComponent($("#breadcrumb_select_rep").val() + "|1") + "/date/" + encodeURIComponent(start_dt) + "/hour/" + encodeURIComponent(end_dt);
                            }

                            var iff = $("<iframe></iframe>")
                            .css("width", "300px")
                            .css("height", "300px")
                            .attr("id", "breadcrumb_iframe")
                            .attr("src", url);
                            
                            iff.appendTo(main_div);

                            $("#breadcrumbs_hours").parent().remove();
                            $("#breadcrumbs_minutes").parent().remove();

                            $("<h4></h4>").text("Hours: ")
                            .append
                            (
                                $("<span></span>").attr("id", "breadcrumbs_hours").text("Calculating...")
                            )
                            .insertBefore(main_div.find("iframe").first());

                            $("<h4></h4>").text("Minutes: ")
                            .append
                            (
                                $("<span></span>").attr("id", "breadcrumbs_minutes").text("Calculating...")
                            )
                            .insertAfter(main_div.find("#breadcrumbs_hours").first());

                            iff.load(function()
                            {
                                setTimeout(function()
                                {                                
                                    var crumbs = (iff[0].contentWindow || iff[0].contentDocument).breadcrumbs;

                                    var hours = 0;
                                    var mins = 0;
                                    if(typeof(crumbs) + '' !== "undefined")
                                    {
                                        if(crumbs.length > 1)
                                        {
                                            var date_crumbs_map = {};
                                            $.each(crumbs, function(i, crumb)
                                            {
                                                var mom = moment(crumb.dt, "YYYY-MM-DD hh:mm:ss");
                                                var formatted = mom.format("YYYY-MM-DD");
                                                if(typeof(date_crumbs_map[formatted]) + '' === "undefined")
                                                {
                                                    date_crumbs_map[formatted] = [];
                                                }
                                                date_crumbs_map[formatted].push(crumb);
                                            });

                                            var keys = Object.keys(date_crumbs_map);

                                            $.each(keys, function(i, key)
                                            {
                                                var start_idx = -1;
                                                var end_idx = -1;
                                                $.each(date_crumbs_map[key], function(ii, crumb)
                                                {                                                
                                                    if(crumb.in_bounds)
                                                    {
                                                        if(start_idx === -1)
                                                        {
                                                            start_idx = ii;
                                                        }
                                                        end_idx = ii;
                                                    }
                                                });

                                                if(start_idx > -1)
                                                {
                                                    if(end_idx > -1)
                                                    {
                                                        var end_mom = moment(date_crumbs_map[key][end_idx].dt, "YYYY-MM-DD hh:mm:ss");
                                                        var start_mom = moment(date_crumbs_map[key][start_idx].dt, "YYYY-MM-DD hh:mm:ss");

                                                        var duration = moment.duration(end_mom - start_mom);
                                                        hours += parseInt(duration.asHours());
                                                        mins += parseInt(duration.asMinutes());                                                
                                                    }
                                                }  
                                            });                                        
                                        }
                                    }
                                    mins -= (60 * hours);                                
                                    $("#breadcrumbs_hours").text(hours + '');
                                    $("#breadcrumbs_minutes").text(mins + '');
                                }, 1000);
                            });

                            
                        }                    
                    };

                    var rep_sel = $("<select></select>").attr("id", "breadcrumb_select_rep")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose a rep")
                    );

                    $.post("/data", {"fn": "list_users_in_given_office", "identifier": "{{ rep_office }}"}).done(function(rr)
                    {
                        $.each(rr, function(i, user)
                        {
                            $("<option></option>").attr("value", user.identifier).text(user.name).appendTo(rep_sel);
                        });

                        var hour_sel = $("<select></select>").attr("id", "breadcrumb_select_hour")
                        .append
                        (
                            $("<option></option>").attr("value", "24").text("All Day")

                        )
                        .append
                        (
                            $("<option></option>").attr("value", "0").text("Midnight to 1AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "1").text("1AM to 2AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "2").text("2AM to 3AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "3").text("3AM to 4AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "4").text("4AM to 5AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "5").text("5AM to 6AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "6").text("6AM to 7AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "7").text("7AM to 8AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "8").text("8AM to 9AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "9").text("9AM to 10AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "10").text("10AM to 11AM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "11").text("11AM to Noon")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "11").text("11AM to Noon")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "12").text("Noon to 1PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "13").text("1PM to 2PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "14").text("2PM to 3PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "15").text("3PM to 4PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "16").text("4PM to 5PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "17").text("5PM to 6PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "18").text("6PM to 7PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "19").text("7PM to 8PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "20").text("8PM to 9PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "21").text("9PM to 10PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "22").text("10PM to 11PM")
                        )
                        .append
                        (
                            $("<option></option>").attr("value", "23").text("11PM to Midnight")
                        );

                        rep_sel.on("change", function()
                        {
                            loadIframe();                   
                        });

                        hour_sel.on("change", function()
                        {
                            loadIframe();
                        });


                        var default_mom = moment().subtract(1, "days");
                        var dp_div = $("<div></div>").attr("id", "breadcrumb_dp").addClass("input-append").addClass("date").attr("data-date", default_mom.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                        .append
                        (
                            $("<input />").addClass("span2").addClass("eightpoint5").attr("size", "16").attr("type", "text").attr("value", default_mom.format("MM/DD/YYYY"))
                        )
                        .append
                        (
                            $("<span></span>").addClass("add-on")
                            .append
                            (
                                $("<i></i>").addClass("icon-th")
                            )
                        );

                        var custom_btn = $("<button></button>").addClass("btn").addClass("btn-primary").text("Custom Range").attr("id", "breadcrumbs_custom_range")
                        .click(function()
                        {
                            if(rep_sel.val() === "n/a")
                            {
                                window.alert("Please select a rep.");
                                return;
                            }
                            var html = $("<div></div>");                    
                            var cloned = dp_div.clone();
                            var cloned2 = dp_div.clone();
                            $("<p></p>").text("Starting Date:").appendTo(html);
                            cloned.appendTo(html);
                            $("<p></p>").text("Ending Date:").appendTo(html);
                            cloned2.appendTo(html);

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Custom Range",
                                    "message": html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Cancel",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                d.close();
                                            }
                                        },
                                        {
                                            "label": "Query",
                                            "cssClass": "btn-primary",
                                            "action": function(d)
                                            {
                                                var mom1 = moment($(".bootstrap-dialog-body").find("input").first().val(), "MM/DD/YYYY").format("YYYY-MM-DD");
                                                var mom2 = moment($(".bootstrap-dialog-body").find("input").last().val(), "MM/DD/YYYY").format("YYYY-MM-DD");

                                                d.close();
                                                loadIframe(true, mom1, mom2);
                                            }
                                        }
                                    ],
                                    "onshown": function(d)
                                    {
                                        $(".bootstrap-dialog-body").find("input").each(function(i, e)
                                        {
                                            $(e).datepicker
                                            (
                                                {
                                                    "autoClose": true,
                                                    "format": "mm/dd/yyyy"
                                                }
                                            );
                                        });
                                    }
                                }
                            );
                        });

                        /*var report_btn = $("<button></button>").attr("id", "breadcrumb_report_btn").addClass("btn").addClass("btn-primary").text("Reports");
                        report_btn.click(function()
                        {
                            var html = $("<div></div>");
                            $("<p></p>").text("Starting Date:").appendTo(html);
                            var dp_div2 = $("<div></div>").attr("id", "breadcrumb_report_start").addClass("input-append").addClass("date").attr("data-date", default_mom.format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                            .append
                            (
                                $("<input />").addClass("span2").addClass("eightpoint5").attr("size", "16").attr("type", "text").attr("value", default_mom.format("MM/DD/YYYY"))
                            )
                            .append
                            (
                                $("<span></span>").addClass("add-on")
                                .append
                                (
                                    $("<i></i>").addClass("icon-th")
                                )
                            );
                            dp_div2.appendTo(html);

                            $("<p></p>").text("Ending date:").appendTo(html);
                            var dp_div_cloned = dp_div2.clone();
                            dp_div_cloned.attr("id", "breadcrumb_report_end");
                            dp_div_cloned.appendTo(html);

                            $("<p></p>").text("Report Option").appendTo(html);
                            $("<select></select>").attr("id", "breadcrumbs_report_type_sel")                  
                            .append
                            (
                                $("<option></option>").attr("value", "everyone").text("Everyone")
                            )
                            .append
                            (
                                $("<option></option>").attr("value", "individual").text("Individual Rep")
                            )
                            .appendTo(html);

                            var option_mode = "everyone";

                            BootstrapDialog.show
                            (
                                {
                                    "title": "Please specify dates for this report",
                                    "message": html.html(),
                                    "buttons":
                                    [
                                        {
                                            "label": "Cancel",
                                            "cssClass": "btn-danger",
                                            "action": function(d)
                                            {
                                                d.close();
                                            }
                                        },
                                        {
                                            "label": "Continue",
                                            "cssClass": "btn-primary",
                                            "action": function(d)
                                            {
                                                var start_mom = moment($(".bootstrap-dialog-body").find("input").first().val(), "MM/DD/YYYY");
                                                var end_mom = moment($(".bootstrap-dialog-body").find("input").eq(1).val(), "MM/DD/YYYY");
                                                var continue_fn = function(dialog, mode, rep_identifier)
                                                {
                                                    dialog.close();
                                                    var html3 = $("<div></div>");
                                                    $("<p></p>").text("Specify the email address to which you would like the report sent.").appendTo(html3);
                                                    $("<input />").attr("type", "text").attr("placeholder", "person@example.com").attr("id", "breadcrumb_report_email_address").appendTo(html3);
                                                    BootstrapDialog.show
                                                    (
                                                        {
                                                            "title": "Please specify",
                                                            "message": html3.html(),
                                                            "buttons":
                                                            [
                                                                {
                                                                    "label": "Cancel",
                                                                    "cssClass": "btn-danger",
                                                                    "action": function(d3)
                                                                    {
                                                                        d3.close();
                                                                    }
                                                                },
                                                                {
                                                                    "label": "Generate it!",
                                                                    "cssClass": "btn-primary",
                                                                    "action": function(d3)
                                                                    {
                                                                        if($.trim($("#breadcrumb_report_email_address").val()).length === 0)
                                                                        {
                                                                            window.alert("Please specify the email address");
                                                                            return;
                                                                        }
                                                                        $(".bootstrap-dialog-footer").find(".btn-primary").text("Generating...");
                                                                        var obj = {"fn": "breadcrumbs_report_kickoff"};
                                                                        obj["start"] = start_mom.format("YYYY-MM-DD");
                                                                        obj["end"] = end_mom.format("YYYY-MM-DD");
                                                                        obj["mode"] = mode;
                                                                        obj["recipient"] = $.trim($("#breadcrumb_report_email_address").val()).toLowerCase();
                                                                        if(obj["mode"] === "individual")
                                                                        {
                                                                            obj["rep_identifier"] = rep_identifier;
                                                                        }
                                                                        $.post("/data", obj).done(function(respons)
                                                                        {
                                                                            d3.close();
                                                                            BootstrapDialog.alert("Your report should be delivered within the next ten minutes");
                                                                        });
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    );
                                                };
                                                if(option_mode === "individual")
                                                {
                                                    d.close();
                                                    var html2 = $("<div></div>");

                                                    $("<p></p>").text("Type the rep's name:").appendTo(html2);
                                                    $("<input />").attr("type", "text").addClass("wc_recipient_transaction_input_box").attr("placeholder", "Rep's name...").appendTo(html2);
                                                    var hinted_users_div = $("<div></div>").addClass("hinted_users");
                                                    $("<span></span>").addClass("glyphicon").addClass("glyphicon-remove").appendTo(hinted_users_div);

                                                    hinted_users_div.appendTo(html2);

                                                    BootstrapDialog.show
                                                    (
                                                        {
                                                            "title": "Choose a Rep",
                                                            "message": html2.html(),
                                                            "buttons":
                                                            [
                                                                {
                                                                    "label": "Cancel",
                                                                    "cssClass": "btn-danger",
                                                                    "action": function(d2)
                                                                    {
                                                                        d2.close();
                                                                    }
                                                                },
                                                                {
                                                                    "label": "Continue",
                                                                    "cssClass": "btn-primary",
                                                                    "action": function(d2)
                                                                    {
                                                                        if($(".hidden_identifier_for_transaction_match").size() === 0)
                                                                        {
                                                                            window.alert("You must first choose the rep.");
                                                                            return;
                                                                        }
                                                                        continue_fn(d2, "individual", $(".hidden_identifier_for_transaction_match").first().data("identifier"));
                                                                    }
                                                                }
                                                            ],
                                                            "onshown": function(d2)
                                                            {
                                                                $(".hinted_users").find("span").first().click(function()
                                                                {
                                                                    $(".hinted_users").css("display", "none");
                                                                    $(".hinted_user").remove();
                                                                });

                                                                var to_box = $(".bootstrap-dialog-body").find("input").eq(0);
                                                                to_box
                                                                .focus(function()
                                                                {
                                                                    if(to_box.val() === "Enter someone's name...")
                                                                    {
                                                                        to_box.val("");
                                                                    }
                                                                })
                                                                .blur(function()
                                                                {
                                                                    if($.trim(to_box.val()) === "")
                                                                    {
                                                                        to_box.val("Enter someone's name...");
                                                                    }
                                                                })
                                                                .on("keyup", function()
                                                                {
                                                                    if($.trim(to_box.val()).length > 0)
                                                                    {
                                                                        hint_at_users3(to_box, contacts, function(data)
                                                                        {
                                                                            console.log(data);
                                                                        });
                                                                    }
                                                                })
                                                            }
                                                        }
                                                    );
                                                    return;
                                                }
                                                continue_fn(d, "everyone");
                                            }
                                        }
                                    ],
                                    "onshown": function(d)
                                    {
                                        $("#breadcrumbs_report_type_sel").change(function()
                                        {
                                            option_mode = $(this).val();
                                        });
                                        $(".bootstrap-dialog-body").find("input").each(function(i, e)
                                        {
                                            $(e).datepicker
                                            (
                                                {
                                                    "autoClose": true,
                                                    "format": "mm/dd/yyyy"
                                                }
                                            );
                                        });
                                    }
                                }
                            );


                        });*/

                        $.each([rep_sel, hour_sel, dp_div, custom_btn], function(i, e)
                        {
                            e.appendTo(main_div);
                        });

                        main_div.find("#breadcrumb_dp").find("input").datepicker
                        (
                            {
                                "autoClose": true,
                                "format": "mm/dd/yyyy"
                            }
                        );

                        $.each(["keyup", "keydown", "keypress"], function(i, ev)
                        {
                            dp_div.find("input").on(ev, function(ev2)
                            {
                                ev2.preventDefault();
                            });
                        });

                        main_div.find("#breadcrumb_dp").find("input").change(function()
                        {
                            loadIframe();
                        });

                        $.each([spacer_div, main_div, spacer_clone], function(i, e)
                        {
                            e.appendTo(app_area);
                        });
                    });

                });
            }
            function gridRegionAdministration()
            {
                hideIconGrid();

                var show_name_labels = false;
                var xxx = 5;

                var centers = []
                var app_area = $("#app_area");
                $("<h2></h2>").text("Loading...").appendTo(app_area);
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                $("<button></button>").addClass("btn").addClass("btn-danger").addClass("area_management_back_btn").text("Back")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                })
                .appendTo(main_div);
                var spacer_clone = spacer.clone();

                $("<div></div>").attr("id", "grid_map").appendTo(main_div);
                $("<p></p>").attr("id", "grid_map_region_tally")
                .append
                (
                    $("<span></span>").text(" ")
                )
                .append
                (
                    $("<span></span>").text(" region(s) meet(s) this criteria.")
                )
                .appendTo(main_div);

                var ownership_span = $("<span></span>").text("Show Ownership:").attr("id", "show_ownership_span").appendTo(main_div);

                $.post("/data", {"fn": "office_data_v2"}).done(function(r)
                {
                    $.post("/data", {"fn": "get_employee_directory"}).done(function(r2)
                    {
                        $.post("/data2", {"fn": "quad_data_bulk"}).done(function(r3)
                        {
                            $.post("./data", {"fn": "list_all_users", "kicks": "1"}).done(function(r4)
                            {
                                var contact_identifier_friendly_name_map = {};
                                $.each(r4.contacts, function(i, contact)
                                {
                                    contact_identifier_friendly_name_map[contact.identifier] = contact.first_name + " " + contact.last_name[0] + ".";
                                });

                                var market_filter = function(quadrants)
                                {
                                    return quadrants;
                                };
                                var office_filter = function(quadrants)
                                {
                                    return quadrants;
                                };
                                var month_filter = function(quadrants)
                                {
                                    return quadrants;
                                };
                                var status_filter = function(quadrants)
                                {
                                    return quadrants;
                                };

                                var rep_filter = function(quadrants)
                                {
                                    return quadrants;
                                }

                                var centers = [{"lat": 33.9979486, "lng": -117.3305406}];
                                var grid_map_zoom_level = 16;
                                var quadrant_identifier_marker_map = {};
                                var quadrant_identifier_poly_map = {};

                                var main_map =  null;
                                var reloadMap = function()
                                {
                                    window.editing_boundaries = false;
                                    window.drawed_markers = [];
                                    window.drawn_polygon = null;
                                    quadrant_identifier_marker_map = {};
                                    quadrant_identifier_poly_map = {};                                

                                    var purgePin = function(identifier, idx, marker, color)
                                    {
                                        var cpy = [];
                                        $.each(quadrant_identifier_marker_map[identifier], function(i, e)
                                        {
                                            if((typeof(idx) + '').toLowerCase() === "number")
                                            {
                                                if(i !== idx)
                                                {
                                                    cpy.push(e);
                                                }
                                            }
                                            else
                                            {
                                                if(e.temp_id !== idx)
                                                {
                                                    cpy.push(e);
                                                }
                                            }                                        
                                        });
                                        quadrant_identifier_marker_map[identifier] = cpy;
                                        marker.setMap(null);
                                        updatePoly(identifier, color);                                    
                                    };

                                    var updatePoly = function(identifier, color)
                                    {
                                        var existing_poly = quadrant_identifier_poly_map[identifier];
                                        existing_poly.setMap(null);

                                        var coords = [];
                                        $.each(quadrant_identifier_marker_map[identifier], function(i, e)
                                        {
                                            var lat = e.getPosition().lat();
                                            var lng = e.getPosition().lng();
                                            coords.push({"lat": lat, "lng": lng});
                                        });
                                        coords.push(coords[0]);


                                        var new_poly = new google.maps.Polygon
                                        (
                                            {
                                                "paths": coords,
                                                "strokeColor": color,
                                                "strokeOpacity": 0.8, 
                                                "strokeWeight": 2,
                                                "fillColor": color,
                                                "fillOpacity": 0.5
                                            }
                                        );
                                        new_poly.setMap(main_map);
                                        quadrant_identifier_poly_map[identifier] = new_poly;
                                    };
                                    $("body").off("click", ".info_window_notes_a");
                                    $("body").on("click", ".info_window_notes_a", function(ev)
                                    {
                                        var that = $(this);
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");
                                        var notes_txt = "";
                                        $.getJSON("/kv/quadrant_notes_" + quadrant_identifier).done(function(r9)
                                        {
                                            if(r9.success)
                                            {
                                                notes_txt = r9.value;
                                            }
                                            var ta = $("<textarea></textarea>").addClass("region_notes_ta");
                                            ta.insertAfter(that);
                                            that.remove();
                                            ta.val(notes_txt);
                                            ta.off("blur");
                                            ta.css("background", "#000000");
                                            ta.css("padding", "0.5em");
                                            /*ta.on("blur", function()
                                            {
                                                var that2 = $(this);
                                                that2.css("opacity", "0.1");
                                                var notes = $.trim(that2.val());
                                                $.post("/data2", {"fn": "store_notes_on_region", "identifier": quadrant_identifier, "notes": notes}).done(function()
                                                {
                                                    that2.css("opacity", "1.0");
                                                });
                                            });*/
                                        });                                                                                
                                    });
                                    /*
                                    $("body").off("click", ".info_window_activate_deactivate");
                                    $("body").on("click", ".info_window_activate_deactivate", function(ev)
                                    {
                                        var that = $(this);
                                        var status = "active";
                                        if(that.text() === "Deactivate")
                                        {
                                            status = "deactive";
                                        }
                                        that.css("opacity", "0.5").text("Working...");
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");

                                        var payload = {"type": "QuadrantUpdate", "quad_id": quadrant_identifier, "quad_status": status};

                                        $.ajax('/AppData',
                                        {
                                            type: 'post',
                                            data: JSON.stringify(payload),
                                            dataType: 'json',
                                            contentType: 'application/json',
                                            success: function(d3)
                                            {
                                                var new_status = true;
                                                if(status === "active")
                                                {
                                                    that.text("Deactivate");
                                                }
                                                else
                                                {
                                                    new_status = false;
                                                    that.text("Reactivate");
                                                }
                                                that.css("opacity", "1.0");
                                                $.each(r3.quads, function(i, quadrant)
                                                {
                                                    if(quadrant.identifier === quadrant_identifier)
                                                    {
                                                        quadrant.active = new_status;
                                                    }
                                                });
                                                centers.push(main_map.center);
                                                grid_map_zoom_level = main_map.getZoom();
                                                reloadMap();
                                            }
                                        });

                                    });*/
                                    $("body").off("click", ".info_window_pins_changed");
                                    $("body").on("click", ".info_window_pins_changed", function()
                                    {
                                        var that = $(this);
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");
                                        that.text("Calculating...");
                                        $.post("/data2", {"fn": "percentage_of_pins_changed", "identifier": quadrant_identifier}).done(function(d3)
                                        {
                                            that.text((d3.changed_tally + '') + " of " + (d3.tally + '') + " (" + d3.percentage + "%) of pins have been changed.");
                                        });
                                    });
                                    
                                    /*$("body").off("click", ".info_window_region_delete");
                                    $("body").on("click", ".info_window_region_delete", function()
                                    {
                                        var that = $(this);
                                        if(window.confirm("Are you sure you would like to delete this region?"))
                                        {
                                            that.text("Working...").css("opacity", "0.5");
                                            var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");
                                            var payload = {"type": "DropQuadrant", "identifier": quadrant_identifier};
                                            $.ajax('/AppData',
                                            {
                                                type: 'post',
                                                data: JSON.stringify(payload),
                                                dataType: 'json',
                                                contentType: 'application/json',
                                                success: function(d3)
                                                {
                                                    var cpy = [];
                                                    $.each(r3.quads, function(i, quadrant)
                                                    {
                                                        if(quadrant.identifier !== quadrant_identifier)
                                                        {
                                                            cpy.push(quadrant);
                                                        }
                                                    });
                                                    centers.push(main_map.center);
                                                    grid_map_zoom_level = main_map.getZoom();
                                                    r3.quads = cpy;
                                                    reloadMap();
                                                }
                                            });
                                        }
                                    });*/
                                   
                                    /*$("body").off("click", ".info_window_region_reassign");
                                    $("body").on("click", ".info_window_region_reassign", function()
                                    {
                                        centers.push(main_map.center);
                                        grid_map_zoom_level = main_map.getZoom();
                                        var that = $(this);
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");
                                        selectUser(r4.contacts, function(d, identifier)
                                        {
                                            $.post("/data2", {"fn": "sales_rep_or_solar_pro_check", "identifier": identifier}).done(function(r10)
                                            {
                                                if(r10.success)
                                                {
                                                    var payload = {"type": "ReassignQuadrant", "identifier": quadrant_identifier, "rep_identifier": identifier, "admin_identifier": window.user_identifier};
                                                    $.ajax('/AppData',
                                                    {
                                                        type: 'post',
                                                        data: JSON.stringify(payload),
                                                        dataType: 'json',
                                                        contentType: 'application/json',
                                                        success: function(d3)
                                                        {
                                                            d.close();
                                                            $.each(r3.quads, function(i, quadrant)
                                                            {
                                                                if(quadrant.identifier === quadrant_identifier)
                                                                {
                                                                    quadrant.rep_identifier = identifier;
                                                                    $.each(r4.contacts, function(ii, contact)
                                                                    {
                                                                        if(contact.identifier === identifier)
                                                                        {
                                                                            $(".info_window_rep_name_td").text(contact.first_name + " " + contact.last_name);
                                                                            $(".info_window_rep_image_td").find("img").first().attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + contact.identifier + ".jpg");
                                                                        }
                                                                    });
                                                                }
                                                            });
                                                        }
                                                    });
                                                }
                                                else
                                                {
                                                    window.alert("The user chosen is neither a sales rep nor a solar pro.");
                                                    return;
                                                }
                                            });
                                        }, "Reassigning this region", "Reassign Region", "Choose a rep or solar pro", "Reassigning...");
                                        
                                    });*/
                                    
                                    /*$("body").off("click", ".info_window_edit_boundaries_a");
                                    $("body").on("click", ".info_window_edit_boundaries_a", function()
                                    {
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");
                                        window.editing_boundaries = true;
                                        window.editing_quadrant_identifier = quadrant_identifier;
                                        centers.push(main_map.center);
                                        grid_map_zoom_level = main_map.getZoom();
                                        var that = $(this);                                    
                                        window.last_info_window_opened.close();

                                        $.each(Object.keys(quadrant_identifier_marker_map), function(i, key)
                                        {
                                            $.each(quadrant_identifier_marker_map[key], function(ii, marker)
                                            {
                                                marker.setVisible(false);
                                            });
                                        });

                                        $.each(quadrant_identifier_marker_map[quadrant_identifier], function(i, e)
                                        {
                                            e.setVisible(true);
                                        });
                                    });*/
                                    
                                    $("body").off("click", ".info_window_history_a");
                                    $("body").on("click", ".info_window_history_a", function()
                                    {
                                        var that = $(this);
                                        that.text("Working...").css("opacity", "1.0");
                                        var quadrant_identifier = $(".current_quadrant_identifier").first().data("identifier");

                                        $.post("/data2", {"fn": "transaction_history_for_quadrant", "identifier": quadrant_identifier}).done(function(d3)
                                        {
                                            that.remove();
                                            $(".info_window_transaction_tbl").css("display", "table");
                                            var tbody = $(".info_window_transaction_tbl").first().find("tbody").first();
                                            d3.items.reverse();
                                            $.each(d3.items, function(iiiii, item)
                                            {
                                                $("<tr></tr>")
                                                .append
                                                (
                                                    $("<td></td>").text(item.msg)
                                                )
                                                .append
                                                (
                                                    $("<td></td>").text(moment(item.dt, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYY hh:mm:ss a"))
                                                )
                                                .appendTo(tbody);
                                            });
                                        });
                                    });
                                    window.last_info_window_opened = null;
                                    var quadrants = $.parseJSON(JSON.stringify(r3.quads));
                                    quadrants = market_filter(quadrants);
                                    quadrants = office_filter(quadrants);
                                    quadrants = month_filter(quadrants);
                                    quadrants = status_filter(quadrants);
                                    quadrants = rep_filter(quadrants);

                                    $("#grid_map_region_tally").find("span").first().text(quadrants.length + '');

                                    $.each(quadrants, function(i, quadrant)
                                    {
                                        if((typeof(quadrant.all_points) + '').toLowerCase() === "string")
                                        {
                                            quadrant.all_points = $.parseJSON(quadrant.all_points);
                                        }
                                    });

                                    $("#grid_map").remove();
                                    $("<div></div>").attr("id", "grid_map").appendTo(main_div);
                                    
                                    main_map = new google.maps.Map(document.getElementById('grid_map'), 
                                    {
                                        zoom: grid_map_zoom_level,
                                        center: centers[centers.length - 1]
                                    });

                                    

                                    $.each(quadrants, function(i, quadrant)
                                    {
                                        var color = "#0000FF";
                                        if(quadrant.active === false)
                                        {
                                            color = "#FF0000";
                                        }
                                        quadrant_identifier_marker_map[quadrant.identifier] = [];
                                        var coords = [];
                                                                        
                                        $.each(quadrant.all_points, function(ii, point)
                                        {
                                            var la = parseFloat(point.split(",")[0]);
                                            var ln = parseFloat(point.split(",")[1]);
                                            coords.push({"lat": la, "lng": ln});
                                            
                                            var marker = new google.maps.Marker
                                            (
                                                {
                                                    position: {"lat": la, "lng": ln},
                                                    map: main_map,
                                                    title: "",
                                                    draggable: true
                                                }
                                            );
                                            marker.setVisible(false);
                                            quadrant_identifier_marker_map[quadrant.identifier].push(marker);
                                            google.maps.event.addListener(marker, 'dragend', function() 
                                            {
                                                $("#boundaries_save_btn").attr("data-identifier", quadrant.identifier).data("identifier", quadrant.identifier);
                                                $("#boundaries_cancel_btn, #boundaries_save_btn").css("display", "inline-block");
                                                updatePoly(quadrant.identifier, color);
                                            });
                                            google.maps.event.addListener(marker, 'dblclick', function()
                                            {
                                                $("#boundaries_save_btn").attr("data-identifier", quadrant.identifier).data("identifier", quadrant.identifier);
                                                $("#boundaries_cancel_btn, #boundaries_save_btn").css("display", "inline-block");
                                                purgePin(quadrant.identifier, ii, marker, color);
                                            });
                                        });
                                        coords.push(coords[0]);

                                        var poly = new google.maps.Polygon
                                        (
                                            {
                                                paths: coords,
                                                strokeColor: color,
                                                strokeOpacity: 0.8,
                                                strokeWeight: 2,
                                                fillColor: color,
                                                fillOpacity: 0.5
                                            }
                                        );
                                        poly.setMap(main_map);
                                        quadrant_identifier_poly_map[quadrant.identifier] = poly;

                                    var bounds = new google.maps.LatLngBounds();
                                    $.each(coords, function(iii, coord)
                                    {
                                        bounds.extend(coord);
                                    });
                                    if(show_name_labels)
                                    {
                                        var center_lat = bounds.getCenter().lat();
                                        var center_lng = bounds.getCenter().lng();
                                        var center_coord = {"lat": function() { return center_lat;}, "lng": function(){ return center_lng;}};

                                        var font_size_arr = ["0px", "1px", "2px", "3px", "4px", "5px", "6px", "7px", "8px", "9px", "10px", "11px", "12px", "13px", "14px", "15px", "16px", "17px", "18px", "19px", "20px", "21px", "22px", "23px"];
                                        //font_size_arr.reverse();

                                        var labelOptions =
                                        {
                                            "content": "<span style='z-index: 9999;'>" + contact_identifier_friendly_name_map[quadrant.rep_identifier] + "</span>",
                                            "boxStyle":
                                            {
                                                "textAlign": "center",
                                                "fontSize": font_size_arr[grid_map_zoom_level],
                                                "width": "30px",
                                                "zIndex": 10000,
                                                "fontColor": "#000000",
                                            },
                                            "disableAutoPan": true,
                                            "pixelOffset": new google.maps.Size(5, 0),
                                            "position": center_coord,
                                            "closeBoxURL": "",
                                            "isHidden": false,
                                            "pane": "mapPane",
                                            "enableEventPropagation": true
                                        };

                                        var polygonLabel = new InfoBox(labelOptions);
                                        polygonLabel.open(main_map);
                                    }

                                        var html_content = $("<div></div>");
                                        var main_div = $("<div></div>");
                                        main_div.addClass("current_quadrant_identifier").attr("data-identifier", quadrant.identifier);

                                        var tbl = $("<table></table>").addClass("region_info_tbl");
                                        var tbody = $("<tbody></tbody>");
                                        var first_tr = $("<tr></tr>");
                                        
                                        first_tr.append
                                        (
                                            $("<td></td>").text("Manager")
                                        );

                                        $.each(r4.contacts, function(iii, contact)
                                        {
                                            if(contact.identifier === quadrant.manager_identifier)
                                            {
                                                $("<td></td>").text(contact.first_name + " " + contact.last_name).appendTo(first_tr);
                                                $("<td></td>")
                                                .append
                                                (
                                                    $("<img />").addClass("img").addClass("img-responsive").css("max-width", "40px").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + contact.identifier + ".jpg")
                                                )
                                                .appendTo(first_tr);
                                            }
                                        });

                                        first_tr.appendTo(tbody);

                                        var second_tr = $("<tr></tr>");
                                        second_tr.append
                                        (
                                            $("<td></td>").text("Rep/Solar Pro")
                                        );

                                        $.each(r4.contacts, function(iii, contact)
                                        {
                                            if(contact.identifier === quadrant.rep_identifier)
                                            {
                                                $("<td></td>").addClass("info_window_rep_name_td").text(contact.first_name + " " + contact.last_name).appendTo(second_tr);
                                                $("<td></td>").addClass("info_window_rep_image_td")
                                                .append
                                                (
                                                    $("<img />").addClass("img").addClass("img-responsive").css("max-width", "40px").attr("src", "https://storage.googleapis.com/" + window.app_bucket + "/Images/ProfilePictures/Thumb/" + contact.identifier + ".jpg")
                                                )
                                                .appendTo(second_tr);
                                            }
                                        });

                                        second_tr.appendTo(tbody);
                                        tbody.appendTo(tbl);
                                        tbl.appendTo(main_div);
                                        $("<br />").appendTo(main_div);

                                        var anchor_text = "Reactivate";
                                        if(quadrant.active)
                                        {
                                            anchor_text = "Deactivate";
                                        }
                                        
                                        $("<a></a>").text(anchor_text).addClass("info_window_activate_deactivate").attr("href", "javascript:void(0);").appendTo(main_div);
                                        $("<span></span>").addClass("label").addClass("label-danger").addClass("info_window_region_delete").text("DELETE").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<a></a>").text("Pin Info").addClass("info_window_pins_changed").attr("href", "javascript:void(0);").appendTo(main_div);
                                        $("<span></span>").addClass("label").addClass("label-primary").addClass("info_window_region_reassign").text("Reassign").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<a></a>").text("Edit Boundaries").addClass("info_window_edit_boundaries_a").attr("href", "javascript:void(0);").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<a></a>").text("Notes").addClass("info_window_notes_a").attr("href", "javascript:void(0);").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        $("<a></a>").text("History").addClass("info_window_history_a").attr("href", "javascript:void(0);").appendTo(main_div);
                                        $("<br />").appendTo(main_div);
                                        var transaction_tbl = $("<table></table>").addClass("info_window_transaction_tbl").css("display", "none");
                                        var transaction_tbody = $("<tbody></tbody>");
                                        $("<tr></tr>")
                                        .append
                                        (
                                            $("<th></th>").text("Activity")
                                        )
                                        .append
                                        (
                                            $("<th></th>").text("Time")
                                        )
                                        .appendTo(transaction_tbody);
                                        transaction_tbody.appendTo(transaction_tbl);
                                        transaction_tbl.appendTo(main_div);

                                        main_div.appendTo(html_content);

                                        var info_window = new google.maps.InfoWindow
                                        (
                                            {
                                                content: html_content.html()
                                            }
                                        );

                                        google.maps.event.addListener(poly, 'click', function (event)
                                        {
                                            if(window.last_info_window_opened !== null)
                                            {
                                                window.last_info_window_opened.close();
                                            }
                                            info_window.open(main_map, quadrant_identifier_marker_map[quadrant.identifier][0]);
                                            window.last_info_window_opened = info_window;
                                            centers.push(main_map.center);
                                            grid_map_zoom_level = main_map.getZoom();
                                        });
                                    });

                                    
                                    
                                    var longpress = false;
                                    var last_dt = null;
                                    var panning = false;
                                    var drawn_polygon = null;

                                    google.maps.event.addListener(main_map, "zoom_changed", function(event)
                                    {
                                        if(show_name_labels)
                                        {
                                            console.log(main_map.getZoom());
                                            centers.push(main_map.center);
                                            grid_map_zoom_level = main_map.getZoom();
                                            reloadMap();
                                        }                                    
                                    });

                                    /*google.maps.event.addListener(main_map, 'mousedown', function(event)
                                    {
                                        last_dt = new Date().getTime();
                                        
                                    });
                                    google.maps.event.addListener(main_map, 'mouseup', function(event)
                                    {
                                        var this_dt = new Date().getTime();
                                        if(this_dt - last_dt >= 1000)
                                        {
                                            if(!panning)
                                            {
                                                if(window.editing_boundaries === false)
                                                {
                                                    main_map.setMapTypeId('hybrid');
                                                    var drawn_marker = new google.maps.Marker
                                                    (
                                                        {
                                                            position: event.latLng,
                                                            map: main_map,
                                                            title: ""
                                                        }
                                                    );
                                                    window.drawed_markers.push(drawn_marker);

                                                    var coords = [];
                                                    $.each(window.drawed_markers, function(i, marker)
                                                    {
                                                        coords.push(marker.position);
                                                    });
                                                    if(window.drawn_polygon !== null)
                                                    {
                                                        window.drawn_polygon.setMap(null);
                                                    }

                                                    var poly_color = "#00FF00";
                                                    window.drawn_polygon = new google.maps.Polygon
                                                    (
                                                        {
                                                            paths: coords,
                                                            strokeColor: poly_color,
                                                            strokeOpacity: 0.8,
                                                            strokeWeight: 2,
                                                            fillColor: poly_color,
                                                            fillOpacity: 0.5
                                                        }
                                                    );
                                                    window.drawn_polygon.setMap(main_map);
                                                }
                                                else
                                                {
                                                    $("#boundaries_save_btn").attr("data-identifier", window.editing_quadrant_identifier).data("identifier", window.editing_quadrant_identifier);
                                                    $("#boundaries_cancel_btn, #boundaries_save_btn").css("display", "inline-block");
                                                    var marker = new google.maps.Marker
                                                    (
                                                        {
                                                            position: event.latLng,
                                                            map: main_map,
                                                            title: "",
                                                            draggable: true
                                                        }
                                                    );
                                                    marker.temp_id = new Date().getTime() + '';

                                                    var existing_color = "#0000FF";
                                                    $.each(r3.quads, function(ii, kwad)
                                                    {
                                                        if(kwad.active === false)
                                                        {
                                                            existing_color = "#FF0000";
                                                        }
                                                    });
                                                    google.maps.event.addListener(marker, 'dragend', function() 
                                                    {
                                                        $("#boundaries_save_btn").attr("data-identifier", window.editing_quadrant_identifier).data("identifier", window.editing_quadrant_identifier);
                                                        $("#boundaries_cancel_btn, #boundaries_save_btn").css("display", "inline-block");
                                                        updatePoly(window.editing_quadrant_identifier, existing_color);
                                                    });
                                                    google.maps.event.addListener(marker, 'dblclick', function()
                                                    {
                                                        $("#boundaries_save_btn").attr("data-identifier", window.editing_quadrant_identifier).data("identifier", window.editing_quadrant_identifier);
                                                        $("#boundaries_cancel_btn, #boundaries_save_btn").css("display", "inline-block");
                                                        purgePin(window.editing_quadrant_identifier, marker.temp_id, marker, poly_color);
                                                    });
                                                    quadrant_identifier_marker_map[window.editing_quadrant_identifier].push(marker);
                                                    updatePoly(window.editing_quadrant_identifier, existing_color);
                                                }                                            
                                            }
                                        }
                                        
                                    });
                                    google.maps.event.addListener(main_map, "dragstart", function(event)
                                    {
                                        panning = true;
                                    });
                                    google.maps.event.addListener(main_map, "dragend", function(event)
                                    {
                                        panning = false;
                                    });*/

                                };                        
                                var market_identifier_offices_map = {};
                                $.each(r.offices, function(i, office)
                                {
                                    market_identifier_offices_map[office.identifier] = [];
                                    $.each(office.offices, function(ii, office2)
                                    {
                                        if(office2.active)
                                        {
                                            market_identifier_offices_map[office.identifier].push(office2);
                                        }
                                    });
                                });
                                var market_identifier_offices_map2 = {};
                                $.each(r.offices, function(i, office)
                                {
                                    market_identifier_offices_map2[office.identifier] = [];
                                    $.each(office.offices, function(ii, office2)
                                    {
                                        if(office2.active)
                                        {
                                            market_identifier_offices_map2[office.identifier].push(office2.identifier);
                                        }
                                    });
                                });
                                var office_identifier_market_map = {};
                                $.each(r.offices, function(i, office)
                                {
                                    $.each(office.offices, function(i, office2)
                                    {
                                        office_identifier_market_map[office2.identifier] = office.identifier;
                                    });
                                });

                                var market_sel = $("<select></select>").addClass("grid_region_market_sel");
                                $("<option></option>").attr("value", "n/a").text("Filter by Market").appendTo(market_sel);
                                $.each(r.offices, function(i, e)
                                {
                                    if(e.active)
                                    {
                                        $("<option></option>").attr("value", e.identifier).text(e.name).appendTo(market_sel);
                                    }
                                });
                                var office_sel = $("<select></select>").addClass("grid_region_office_sel");
                                $("<option></option>").attr("value", "n/a").text("Filter by Office").appendTo(office_sel);

                                var rep_sel = $("<select></select>").addClass("grid_region_rep_sel");
                                $("<option></option>").attr("value", "n/a").text("Filter by Rep").appendTo(rep_sel);

                                $.each(r2.users, function(i, user)
                                {
                                    if(user.user_type !== "super")
                                    {
                                        $("<option></option>").attr("value", user.identifier).text(user.first_name + " " + user.last_name).appendTo(rep_sel);
                                    }
                                });
                                
                                var month_sel = $("<select></select>").addClass("grid_region_time_sel");
                                $("<option></option>").attr("value", "n/a").text("Filter by Time Assigned").appendTo(month_sel);
                                var mom = moment();
                                var month_year_list = [];
                                for(var i = 0; i < 730; i++)
                                {
                                    var year = mom.year();
                                    var month = mom.month();
                                    month++;

                                    var year_str = year + '';
                                    var month_str = month + '';
                                    if(month_str.length === 1)
                                    {
                                        month_str = "0" + month_str;
                                    }

                                    var str = month_str + "/" + year_str;
                                    if(month_year_list.indexOf(str) === -1)
                                    {
                                        month_year_list.push(str);
                                    }
                                    mom = mom.subtract(1, "days");
                                }

                                var status_sel = $("<select></select>").addClass("grid_region_status_sel");
                                $("<option></option>").attr("value", "n/a").text("Filter by Status").appendTo(status_sel);
                                $("<option></option>").attr("value", "1").text("Active").appendTo(status_sel);
                                $("<option></option>").attr("value", "0").text("Inactive").appendTo(status_sel);

                                $.each(month_year_list, function(i, str)
                                {
                                    $("<option></option>").attr("value", str).text(str).appendTo(month_sel);
                                });

                                market_sel.change(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();                                
                                    if(market_sel.val() === "n/a")
                                    {
                                        market_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        };
                                        office_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        }
                                    }
                                    else
                                    {
                                        var market_identifier = market_sel.val();
                                        market_filter = function(quadrants)
                                        {
                                            var ret_quads = [];                            
                                            for(var n = 0; n < quadrants.length; n++)
                                            {
                                                var this_market = office_identifier_market_map[quadrants[n].office_identifier];
                                                if(this_market === market_identifier)
                                                {
                                                    ret_quads.push(quadrants[n]);
                                                }
                                            }
                                            return ret_quads;
                                        };
                                                                                                            
                                    }                                
                                    office_sel.find("option").each(function(i, e)
                                    {
                                        if(i > 0)
                                        {
                                            $(e).remove();
                                        }
                                    });                                
                                    if(market_identifier !== "n/a" && market_identifier !== null && market_identifier !== undefined)
                                    {
                                        $.each(market_identifier_offices_map[market_identifier], function(i, office)
                                        {
                                            $("<option></option>").attr("value", office.identifier).text(office.name).appendTo(office_sel);
                                        });
                                    }
                                    office_sel.trigger("change");                                
                                    reloadMap();
                                });

                                office_sel.change(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    if(office_sel.val() === "n/a")
                                    {
                                        office_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        };                                
                                    }
                                    else
                                    {
                                        office_filter = function(quadrants)
                                        {
                                            var ret_quads = [];
                                            for(var n = 0; n < quadrants.length; n++)
                                            {
                                                if(quadrants[n].office_identifier === office_sel.val())
                                                {
                                                    ret_quads.push(quadrants[n]);
                                                }
                                            }
                                            return ret_quads;
                                        };                                    
                                    }
                                    reloadMap();
                                });
                                
                                rep_sel.change(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();

                                    if(rep_sel.val() === "n/a")
                                    {
                                        rep_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        }
                                    }
                                    else
                                    {
                                        rep_filter = function(quadrants)
                                        {
                                            var ret_quads = [];
                                            for(var n = 0; n < quadrants.length; n++)
                                            {
                                                if(quadrants[n].rep_identifier === rep_sel.val())
                                                {
                                                    ret_quads.push(quadrants[n]);
                                                }    
                                            }
                                            return ret_quads;
                                        }
                                    }
                                    reloadMap();
                                });

                                month_sel.change(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    if(month_sel.val() === "n/a")
                                    {
                                        month_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        };
                                    }
                                    else
                                    {
                                        month_filter = function(quadrants)
                                        {
                                            var ret_quads = [];
                                            for(var n = 0; n < quadrants.length; n++)
                                            {
                                                var mom = moment(quadrants[n].time_assigned, "YYYY-MM-DD");
                                                var year = mom.year();
                                                var month = mom.month();
                                                month++;
                                                var year_str = year + '';
                                                var month_str = month + '';
                                                if(month_str.length === 1)
                                                {
                                                    month_str = "0" + month_str;
                                                }

                                                var str = month_str + "/" + year_str;
                                                if(str === month_sel.val())
                                                {
                                                    ret_quads.push(quadrants[n]);
                                                }
                                            }   
                                            return ret_quads;
                                        }
                                    }
                                    reloadMap();
                                });

                                status_sel.change(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    if(status_sel.val() === "n/a")
                                    {
                                        status_filter = function(quadrants)
                                        {
                                            return quadrants;
                                        }
                                    }
                                    else
                                    {
                                        status_filter = function(quadrants)
                                        {
                                            var ret_quads = [];
                                            for(var n = 0; n < quadrants.length; n++)
                                            {
                                                var active = quadrants[n].active;
                                                var integer_coerced = active * 1;
                                                var str_coerced = integer_coerced + '';

                                                if(str_coerced === status_sel.val())
                                                {
                                                    ret_quads.push(quadrants[n]);
                                                }
                                            }
                                            return ret_quads;
                                        }
                                    }
                                    reloadMap();
                                });

                                var reset_btn = $("<button></button>").addClass("btn").addClass("btn-primary").attr("id", "region_draw_reset_btn").text("Reset").css("display", "none");
                                reset_btn.click(function()
                                {
                                    $.each(window.drawed_markers, function(i, marker)
                                    {
                                        marker.setMap(null);
                                    });
                                    window.drawed_markers = [];
                                    if(window.drawn_polygon !== null)
                                    {
                                        window.drawn_polygon.setMap(null);
                                    }
                                    main_map.setMapTypeId('roadmap');
                                });
                                
                                var save_btn = $("<button></button>").addClass("btn").addClass("btn-success").attr("id", "region_draw_save_btn").text("Save").css("display", "none");
                                save_btn.click(function()
                                {
                                    selectUser(r4.contacts, function(d, identifier)
                                    {
                                        $.post("/data2", {"fn": "sales_rep_or_solar_pro_check", "identifier": identifier}).done(function(r5)
                                        {
                                            if(r5.success)
                                            {
                                                d.close();
                                                selectUser(r4.contacts, function(d2, identifier2)
                                                {
                                                    $.post("/data2", {"fn": "manager_check", "identifier": identifier2}).done(function(r6)
                                                    {
                                                        if(r6.success)
                                                        {
                                                            $.post("/data2", {"fn": "office_for_rep", "identifier": identifier2}).done(function(r7)
                                                            {
                                                                var office_identifier = r7.identifier;

                                                                var min_lat = 500.0;
                                                                var max_lat = -500.0;

                                                                var min_long = 500.0;
                                                                var max_long = -500.0;


                                                                var all_points = [];

                                                                $.each(window.drawed_markers, function(i, marker)
                                                                {
                                                                    var pos = marker.getPosition();
                                                                    if(pos.lat() < min_lat)
                                                                    {
                                                                        min_lat = pos.lat();
                                                                    }
                                                                    if(pos.lat() > max_lat)
                                                                    {
                                                                        max_lat = pos.lat();
                                                                    }
                                                                    if(pos.lng() < min_long)
                                                                    {
                                                                        min_long = pos.lng();
                                                                    }
                                                                    if(pos.lng() > max_long)
                                                                    {
                                                                        max_long = pos.lng();
                                                                    }
                                                                    all_points.push((pos.lat() + '') + "," + (pos.lng() + ''));
                                                                });

                                                                $(".bootstrap-dialog-footer").find(".btn-primary").remove();
                                                                $(".bootstrap-dialog-body").text("Please Wait...");

                                                                var payload = {"type": "RepQuadrantSave"};
                                                                payload["rep_identifier"] = identifier;
                                                                payload["manager_identifier"] = identifier2;
                                                                payload["admin_identifier"] = window.user_identifier;
                                                                payload["office_identifier"] = office_identifier;
                                                                payload["upper_left_lat"] = max_lat + '';
                                                                payload["upper_left_long"] = min_long + '';
                                                                payload["upper_right_lat"] = max_lat + '';
                                                                payload["upper_right_long"] = max_long + '';
                                                                payload["bottom_left_lat"] = min_lat + '';
                                                                payload["bottom_left_long"] = min_long + '';
                                                                payload["bottom_right_lat"] = max_lat + '';
                                                                payload["bottom_right_long"] = max_long + '';
                                                                payload["all_points"] = JSON.stringify(all_points);
                                                                $.ajax('/AppData',
                                                                {
                                                                    type: 'post',
                                                                    data: JSON.stringify(payload),
                                                                    dataType: 'json',
                                                                    contentType: 'application/json',
                                                                    success: function(d5)
                                                                    {
                                                                        centers.push(main_map.center);
                                                                        grid_map_zoom_level = main_map.getZoom();
                                                                        
                                                                        var new_identifier = d5.identifier;
                                                                        
                                                                        var quad = {"identifier": new_identifier};
                                                                        quad["active"] = true;
                                                                        quad["all_points"] = all_points;
                                                                        quad["rep_identifier"] = payload["rep_identifier"];
                                                                        quad["manager_identifier"] = payload["manager_identifier"];
                                                                        quad["office_identifier"] = payload["office_identifier"];
                                                                        quad["time_assigned"] = moment().format("YYYY-MM-DD")
                                                                        r3.quads.push(quad);
                                                                        $("#region_draw_reset_btn").trigger("click");
                                                                        d2.close();
                                                                        reloadMap();
                                                                    }
                                                                });
                                                            });
                                                        }
                                                        else
                                                        {
                                                            window.alert("That user is not a manger.");
                                                            return;
                                                        }
                                                    });

                                                }, "Choose a manager...", "Assign", "Choose a manager responsible for this region.", "Assigning");
                                            }
                                            else
                                            {
                                                window.alert("This is user neither a rep nor a solar pro.");
                                                return;
                                            }
                                        });
                                    }, "Choose a Rep or Solar Pro", "Assign", "Choose a Rep or Solar Pro for this region...", "Assigning");
                                });                            

                                var boundaries_save_btn = $("<button></button>").addClass("btn").addClass("btn-primary").attr("id", "boundaries_save_btn").text("Update Boundaries");
                                boundaries_save_btn.click(function()
                                {
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    
                                    var that = $(this);
                                    var identifier = that.data("identifier");

                                    var all_points = [];
                                    var min_lat = 500.0;
                                    var max_lat = -500.0;

                                    var min_long = 500.0;
                                    var max_long = -500.0;
                                    if(quadrant_identifier_marker_map[identifier].length < 4)
                                    {
                                        window.alert("At least four points are required");
                                        return;
                                    }
                                    $.each(quadrant_identifier_marker_map[identifier], function(i, e)
                                    {
                                        var lat = e.getPosition().lat();
                                        var lng = e.getPosition().lng();
                                        all_points.push((lat + '') + "," + (lng + ''));

                                        var pos = e.getPosition();
                                        if(pos.lat() < min_lat)
                                        {
                                            min_lat = pos.lat();
                                        }
                                        if(pos.lat() > max_lat)
                                        {
                                            max_lat = pos.lat();
                                        }
                                        if(pos.lng() < min_long)
                                        {
                                            min_long = pos.lng();
                                        }
                                        if(pos.lng() > max_long)
                                        {
                                            max_long = pos.lng();
                                        }
                                    });
                                    $.each(r3.quads, function(i, quadrant)
                                    {
                                        if(quadrant.identifier === identifier)
                                        {
                                            quadrant.all_points = all_points;
                                        }
                                    });
                                    var payload = {"type": "QuadrantBoundsUpdate"};
                                    payload["identifier"] = identifier;
                                    payload["upper_left_lat"] = max_lat + '';
                                    payload["upper_left_long"] = min_long + '';
                                    payload["upper_right_lat"] = max_lat + '';
                                    payload["upper_right_long"] = max_long + '';
                                    payload["bottom_left_lat"] = min_lat + '';
                                    payload["bottom_left_long"] = min_long + '';
                                    payload["bottom_right_lat"] = max_lat + '';
                                    payload["bottom_right_long"] = max_long + '';
                                    payload["all_points"] = JSON.stringify(all_points);

                                    $.ajax('/AppData',
                                    {
                                        type: 'post',
                                        data: JSON.stringify(payload),
                                        dataType: 'json',
                                        contentType: 'application/json',
                                        success: function(d5)
                                        {
                                            window.editing_boundaries = false;
                                            $("#boundaries_save_btn, #boundaries_cancel_btn").css("display", "none");
                                            reloadMap();
                                        }
                                    });                                
                                });
                                var boundaries_cancel_btn = $("<button></button>").addClass("btn").addClass("btn-danger").attr("id", "boundaries_cancel_btn").text("Cancel");
                                boundaries_cancel_btn.click(function()
                                {
                                    window.editing_boundaries = false;
                                    $("#boundaries_save_btn, #boundaries_cancel_btn").css("display", "none");
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    reloadMap();
                                });

                                var show_ownership_cb = $("<input />").attr("type", "checkbox").change(function()
                                {
                                    show_name_labels = $(this)[0].checked;
                                    centers.push(main_map.center);
                                    grid_map_zoom_level = main_map.getZoom();
                                    reloadMap();
                                });

                                $.each([ownership_span, show_ownership_cb, market_sel, office_sel, rep_sel, month_sel, status_sel, reset_btn, save_btn, $("<br />"), boundaries_save_btn, boundaries_cancel_btn], function(i, e)
                                {
                                    e.appendTo(main_div);
                                });

                                $.each([spacer, main_div, spacer_clone], function(i, e)
                                {
                                    e.appendTo(app_area);
                                });
                                app_area.find("h2").remove();
                                reloadMap();
                                
                                window.temp_intervals.push(setInterval(function()
                                {
                                    var reset_display = reset_btn.css("display").toLowerCase();
                                    if(window.drawed_markers.length > 0)
                                    {
                                        if(reset_display !== "inline-block")
                                        {
                                            reset_btn.css("display", "inline-block");
                                        }                                    
                                    }
                                    else
                                    {
                                        if(reset_display !== "none")
                                        {
                                            reset_btn.css("display", "none");
                                        }
                                    }

                                    var save_display = save_btn.css("display").toLowerCase();
                                    if(window.drawed_markers.length >= 4)
                                    {
                                        if(save_display !== "inline-block")
                                        {
                                            save_btn.css("display", "inline-block");
                                        }
                                    }
                                    else
                                    {
                                        if(save_display !== "none")
                                        {
                                            save_btn.css("display", "none");
                                        }
                                    }
                                }, 250));                    
                            });                        
                            
                        });
                    });
                });        
            }
            function solarReaderChartGen(identifier, name, popup_shown, stay_deployed)
            {
                var show_popup = (typeof(popup_shown) + '' === "undefined") || popup_shown === false;
                

                //disabling completely
                show_popup = false;
                
                if(show_popup)
                {
                    var html = $("<div></div>");
                    $("<p></p>").text("Please provide an update for " + name).appendTo(html);
                    $("<select></select>").attr("id", "chart_gen_ak_status_sel")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose One")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "ak").text("AK")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "reschedule").text("Reschedule")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "cancel").text("Cancel")
                    )
                    .appendTo(html);

                    $("<br />").appendTo(html);
                    $("<br />").appendTo(html);

                    $("<select></select>").attr("id", "chart_gen_care_sel").css("display", "none")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose One")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "not_care").text("Not CARE/Medical")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "care").text("CARE/Medical")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "not_sure").text("Not Sure")
                    )
                    .appendTo(html);

                    $("<br />").appendTo(html);
                    $("<br />").appendTo(html);
                    $("<select></select>").attr("id", "chart_gen_usage_sel").css("display", "none")
                    .append
                    (
                        $("<option></option>").attr("value", "n/a").text("Choose One")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "estimated").text("Solar Pro's usage data was estimated")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "real").text("The Solar Pro provided real usage data")
                    )
                    .append
                    (
                        $("<option></option>").attr("value", "not_sure").text("I'm not sure yet")
                    )
                    .appendTo(html);
                    $("<textarea></textarea>").css("min-height", "5em").attr("id", "chart_gen_ak_status_notes").attr("placeholder", "Please add notes about your interaction with this customer...").appendTo(html);
                    BootstrapDialog.show
                    (
                        {
                            "title": name,
                            "message": html.html(),
                            "buttons":
                            [
                                {
                                    "label": "Continue",
                                    "cssClass": "btn-primary",
                                    "action": function(d)
                                    {
                                        var val = $("#chart_gen_ak_status_sel").val();
                                        if(val === "ak")
                                        {
                                            if($("#chart_gen_care_sel").val() === "n/a")
                                            {
                                                window.alert("You must specify a CARE status");
                                                return;
                                            }
                                            if($("#chart_gen_usage_sel").val() === "n/a")
                                            {
                                                window.alert("You must specify the type of usage obtained by the solar pro");
                                                return;
                                            }
                                            if($("#chart_gen_care_sel").val() === "not_sure")
                                            {
                                                d.close();
                                                solarReaderChartGen(identifier, name, true, false);
                                                return;
                                            }
                                            if($("#chart_gen_usage_sel").val() === "not_sure")
                                            {
                                                d.close();
                                                solarReaderChartGen(identifier, name, true, false);
                                                return;
                                            }
                                            var payload = {};
                                            payload["fn"] = "confirm_sp2_lead";
                                            payload["data"] = JSON.stringify({"identifier": identifier});
                                            payload["identifier"] = window.user_identifier;
                                            payload["note_txt"] = "";
                                            payload["care_value"] = (($("#chart_gen_care_sel").val() === "care") * 1) + '';
                                            payload["usage_type"] = $("#chart_gen_usage_sel").val();
                                            $.post("/data", payload).done(function(r)
                                            {
                                                d.close();
                                                solarReaderChartGen(identifier, name, true, false);
                                            });
                                        }
                                        if(val === "cancel")
                                        {
                                            var notes = $.trim($("#chart_gen_ak_status_notes").val());
                                            $.post("/data", {"fn": "complete_sp2_dialog", "identifier": identifier, "notes": notes, "user_identifier": window.user_identifier}).done(function()
                                            {
                                                d.close();
                                                solarReaderChartGen(identifier, name, true, false);
                                            });
                                        }
                                        if(val === "reschedule")
                                        {
                                            var notes = $.trim($("#chart_gen_ak_status_notes").val());
                                            $.post("/data", {"fn": "save_rep_lead_notes", "notes": notes, "identifier": identifier, "user_identifier": window.user_identifier}).done(function()
                                            {
                                                d.close();
                                                restoreOlderCustomer([], {"name": name, "identifier": identifier}, false, function()
                                                {
                                                    solarReaderChartGen(identifier, name, true, true);
                                                });
                                            });
                                        }
                                        
                                    }
                                }
                            ],
                            "onshown": function(d)
                            {
                                window.temp_intervals.push
                                (
                                    setInterval(function()
                                    {
                                        var val = $("#chart_gen_ak_status_sel").val();
                                        if(val === "cancel" || val === "reschedule")
                                        {
                                            $("#chart_gen_ak_status_notes").css("display", "block");
                                        }
                                        else
                                        {
                                            $("#chart_gen_ak_status_notes").css("display", "none");
                                        }
                                        if(val === "ak")
                                        {
                                            $("#chart_gen_care_sel, #chart_gen_usage_sel").css("display", "inline-block");                                            
                                            
                                        }
                                        else
                                        {
                                            $("#chart_gen_care_sel, #chart_gen_usage_sel").css("display", "none");
                                            $("#chart_gen_care_sel, #chart_gen_usage_sel").val("n/a");
                                        }
                                    }, 250)
                                );
                            }
                        }
                    );
                    return;
                }
                hideIconGrid();
                var app_area = $("#app_area");
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").addClass("solar_reader_chart_back_btn").css("font-size", "2em")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                })
                .appendTo(main_div);
                $("<h2></h2>").text("Upload Your CSV File").appendTo(main_div);
                $("<hr />").appendTo(main_div);
                $("<form></form>").attr("enctype", "multipart/form-data").attr("target", "_blank").attr("method", "POST").attr("action", "/reader_chart_gen").addClass("chart_gen_form")                
                .append
                (
                    $("<br />")
                )
                .append
                (
                    $("<input />").attr("type", "hidden").attr("name", "identifier").attr("value", identifier)
                )
                .append
                (
                    $("<input />").attr("type", "hidden").attr("name", "rep_identifier").attr("value", window.user_identifier)
                )
                .append
                (
                    $("<input />").attr("type", "file").attr("name", "csv")
                )
                .append
                (
                    $("<input />").attr("type", "submit").attr("value", "Generate Chart").addClass('submit_btn_99')
                )
                .on("submit", function()
                {
                    if($(".chart_gen_form").first().find("input").first()[0].files.length !== 1)
                    {
                        window.alert("You must upload a CSV file before generating the chart.");
                        return false;
                    }
                })
                .appendTo(main_div);

                if(stay_deployed)
                {
                    $("<input />").attr("type", "hidden").attr("value", "1").attr("name", "stay_deployed").appendTo(main_div.find("form").first());
                }

                $.each([spacer, main_div, spacer_clone], function(i, e)
                {
                    e.appendTo(app_area);
                });
            }
            function myDeals()
            {
                var app_area = $("#app_area");
                hideIconGrid();
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                $("<h2></h2>").text("My Deals").appendTo(main_div);

                $("<button></button>").addClass("btn").addClass("btn-danger").addClass("upcoming_installs_back_btn").html("&larr; Back")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                })
                .appendTo(main_div);

                $("<br />").appendTo(main_div);

                var load_data = function(data)
                {
                    if(data.length === 0)
                    {
                        data.push({"name": "No Customers Found", "date": "1970-01-01"})
                    }
                    $(".upcoming_installs_table").remove();

                    var table = $("<table></table>").addClass("upcoming_installs_table");
                    var tbody = $("<tbody></tbody>");
                    var tr1 = $("<tr></tr>");
                    tr1.append
                    (
                        $("<th></th>").text("Name")
                    )
                    if(data[0].date !== null)
                    {
                        tr1.append
                        (
                            $("<th></th>").text("Date")
                        )
                    }
                    tr1.appendTo(tbody);

                    $.each(data, function(i, item)
                    {
                        var tr = $("<tr></tr>");
                        $("<td></td>").text(item.name).appendTo(tr);
                        if(item.date !== null)
                        {
                            var date_text = "TBD";
                            if(item.date.indexOf("1970") === -1)
                            {
                                var mom = moment(item.date, "YYYY-MM-DD");
                                date_text = mom.format("MM/DD/YYYY");
                            }
                            $("<td></td>").text(date_text).appendTo(tr);
                        }                        

                        tr.appendTo(tbody);
                    });
                    tbody.appendTo(table);
                    table.appendTo(main_div);                    
                };

                $("<button></button>").addClass("btn").addClass("btn-primary").addClass("upcoming_installs_btn").text("Upcoming Installs")
                .click(function()
                {
                    $("<h2></h2>").text("Loading...").insertAfter(main_div.find("button").last());
                    $.post("/data", {"fn": "solar_pro_install_schedule", "identifier": window.user_identifier}).done(function(r)
                    {
                        main_div.find("h2").remove();
                        load_data(r);
                    });
                })
                .appendTo(main_div);

                $("<button></button>").addClass("btn").addClass("btn-primary").addClass("upcoming_installs_btn").text("Recent Installs")
                .click(function()
                {
                    $("<h2></h2>").text("Loading...").insertAfter(main_div.find("button").last());
                    $.post("/data", {"fn": "recent_installs", "identifier": window.user_identifier}).done(function(r)
                    {
                        main_div.find("h2").remove();
                        load_data(r);
                    });
                })
                .appendTo(main_div);

                $("<button></button>").addClass("btn").addClass("btn-primary").addClass("upcoming_installs_btn").text("Cancels")
                .click(function()
                {
                    $("<h2></h2>").text("Loading...").insertAfter(main_div.find("button").last());
                    $.post("/data", {"fn": "my_deal_cancels", "identifier": window.user_identifier}).done(function(r)
                    {
                        main_div.find("h2").remove();
                        load_data(r);
                    });
                })
                .appendTo(main_div);

                

                $.each([spacer, main_div, spacer_clone], function(i, e)
                {
                    e.appendTo(app_area);
                });
            }
            function runWay()
            {
                hideIconGrid();
                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").css("font-size", "2em")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                }).appendTo(main_div);
                $("<br />").appendTo(main_div);
                $("<br />").appendTo(main_div);

                var app_area = $("#app_area");

                var append_to_dom = function()
                {
                    $.each([spacer, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });
                };

                $.getJSON("/kv/runway_level_one_approval_" + window.user_identifier).done(function(r)
                {
                    var show_level_1 = false;
                    var show_level_2 = false;
                    var show_level_3 = false;

                    show_level_1 = (r.value === null);
                    $.getJSON("/kv/runway_level_two_approval_" + window.user_identifier).done(function(r2)
                    {
                        show_level_2 = (r2.value === null);
                        $.getJSON("/kv/runway_level_three_approval_" + window.user_identifier).done(function(r3)
                        {
                            show_level_3 = (r3.value === null);
                            $.getJSON("/kv/runway_level_two_data_" + window.user_identifier).done(function(r4)
                            {
                                var level_two_data = {}
                                if(r4.value !== null)
                                {
                                    level_two_data = $.parseJSON(r4.value);
                                }

                                $.getJSON("/kv/runway_level_three_data_" + window.user_identifier).done(function(r5)
                                {
                                    var level_three_data = {};
                                    if(r5.value !== null)
                                    {
                                        level_three_data = $.parseJSON(r5.value);
                                    }
                                    

                                    var icons_div = $("<div></div>");                                    

                                    var show_icons_div = function()
                                    {
                                        icons_div.css("display", "block");
                                    };

                                    var hide_icons_div = function()
                                    {
                                        icons_div.css("display", "none");
                                    };
                                    if(show_level_1)
                                    {
                                        $("<span></span>").addClass("btn").addClass("btn-primary").css("font-size", "2em").css("margin-right", "1em").css("margin-bottom", "1em").text("Level 1 - $180")
                                        .click(function()
                                        {
                                            hide_icons_div();

                                            $("<span></span>").addClass("label").addClass("label-primary").text("Level 1 - $180").css("font-size", "2em").appendTo(main_div);
                                            $("<hr />").appendTo(main_div);
                                            var ul = $("<ul></ul>").addClass("runway_level_1_ul");
                                            
                                            $("<li></li>").text("I have completed all HR paperwork")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            ) 
                                            .appendTo(ul);

                                            $("<li></li>").text("I have completed the online training")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            $("<li></li>").text("I have shadowed my manager for 4 hours")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            )
                                            .appendTo(ul);

                                            ul.appendTo(main_div);

                                            $("<hr />").appendTo(main_div);

                                            var tbl = $("<table></table>").addClass("runway_level_1_tbl");
                                            var tbody = $("<tbody></tbody>");

                                            $.each(["What date did you shadow?", "What time did you stop knocking?", "What time did you knock the first door?", "Did you get inside any homes?", "Did you book any appointments?", "What did the SPM do well?", "What did you learn from shadowing?", "What day will you start knocking on your own?"], function(i, e)
                                            {
                                                var tr = $("<tr></tr>");
                                                $("<td></td>").text(e).appendTo(tr);

                                                var ta = $("<textarea></textarea>");
                                                ta.css("background", "rgba(0, 0, 0, 0.3)");
                                                ta.css("min-height", "2em").css("padding", "0.5em").css("border", "0px solid #000");
                                                if(e === "What did the SPM do well?" || e === "What did you learn from shadowing?")
                                                {
                                                    ta.css("min-height", "5em")
                                                }
                                                $("<td></td>").append(ta).appendTo(tr);
                                                tr.appendTo(tbody);

                                            });
                                            tbody.appendTo(tbl);
                                            tbl.appendTo(main_div);

                                            $("<br />").appendTo(main_div);
                                            $("<br />").appendTo(main_div);
                                            $("<button></button>").addClass("btn").addClass("btn-success").text("Submit")
                                            .click(function()
                                            {
                                                var target_count = $(".runway_level_1_ul").first().find("li").length;

                                                var tally = 0;
                                                $(".runway_level_1_ul").find("input").each(function(i, e)
                                                {
                                                    tally += ($(e)[0].checked * 1);
                                                });
                                                if(tally !== target_count)
                                                {
                                                    window.alert("You must have each checkoff item completed.");
                                                    return;
                                                }

                                                target_count = $(".runway_level_1_tbl").first().find("textarea").length;

                                                tally = 0;
                                                $(".runway_level_1_tbl").first().find("textarea").each(function(i, e)
                                                {
                                                    tally += ($.trim($(e).val()).length > 0);
                                                });
                                                if(tally !== target_count)
                                                {
                                                    window.alert("You must answer all questions");
                                                    return;
                                                }

                                                var payload = {};
                                                payload["identifier"] = window.user_identifier;
                                                payload["level"] = "level_one"
                                                payload["fn"] = "runway_save"

                                                var data = {};
                                                data.checkoff_items = [];
                                                $(".runway_level_1_ul").find("li").each(function(i, e)
                                                {
                                                    data.checkoff_items.push($(e).text());
                                                });
                                                data.questionnaire_items = [];
                                                $(".runway_level_1_tbl").find("tr").each(function(i, e)
                                                {
                                                    var obj = {"question": $(e).find("td").first().text()};
                                                    obj["answer"] = $.trim($(e).find("textarea").first().val());
                                                    data.questionnaire_items.push(obj);
                                                });

                                                payload["data"] = JSON.stringify(data);
                                                $.post("/data", payload).done(function(r)
                                                {
                                                    clearApp(function()
                                                    {
                                                        showIconGrid();
                                                        BootstrapDialog.alert("Your submission will soon be reviewed and approved or denied by an admin. Be sure to check your email regularly.");
                                                    });

                                                });


                                            }).appendTo(main_div);
                                                                                            
                                        }).appendTo(icons_div);
                                    }
                                    if(show_level_2)
                                    {
                                        $("<span></span>").addClass("btn").addClass("btn-primary").css("font-size", "2em").css("margin-right", "1em").css("margin-bottom", "1em").text("Level 2 - $500")
                                        .click(function()
                                        {
                                            $("<h2></h2>").addClass("l2_loading").text("Loading...").appendTo(main_div);
                                            $.post("/data", {"fn": "level_two_lookup", "identifier": window.user_identifier}).done(function(l2_data)
                                            {
                                                main_div.find(".l2_loading").remove();

                                                hide_icons_div();
                                                $("<hr />").appendTo(main_div);

                                                var tbl = $("<table></table>").addClass("runway_level_1_tbl");
                                                var tbody = $("<tbody></tbody>");

                                                $("<tr></tr>")
                                                .append
                                                (
                                                    $("<th></th>").text("-----")
                                                )
                                                .append
                                                (
                                                    $("<th></th>").text("Selfie")
                                                )
                                                .append
                                                (
                                                    $("<th></th>").text("HKs")
                                                )
                                                .append
                                                (
                                                    $("<th></th>").text("ABs")
                                                )
                                                .append
                                                (
                                                    $("<th></th>").text("Date")
                                                )
                                                .appendTo(tbody);

                                                for(var i = 0; i < 10; i++)
                                                {
                                                    var tr = $("<tr></tr>");
                                                    var day_str = (i + 1) + '';
                                                    $("<td></td>").text("Day #" + day_str).appendTo(tr);
                                                    $("<td></td>")
                                                    .append
                                                    (
                                                        $("<span></span>").addClass("selfie_upload_span").css("display", "none")
                                                    )
                                                    .append
                                                    (
                                                        $("<input />").attr("type", "file").addClass("selfie_td_level_two")
                                                        .change(function()
                                                        {
                                                            var that3 = $(this);
                                                            var index = that3.closest("tr").prevAll("tr").length - 1;

                                                            var formData = new FormData();
                                                            formData.append("fn", "l2_up_selfie");
                                                            formData.append("identifier", window.user_identifier);
                                                            formData.append("img", that3[0].files[0]);
                                                            formData.append("idx", (index + ''));                                                            

                                                            var xhr = new XMLHttpRequest();
                                                            (xhr.upload || xhr).addEventListener("progress", function(e)
                                                            {
                                                                var done = e.position || e.loaded
                                                                var total = e.totalSize || e.total;
                                                                var completion_percentage = (Math.round(done/total*100) + '') + "%";
                                                                $(".selfie_upload_span").eq(index).text("Uploading (" + completion_percentage + ")");

                                                            });
                                                            xhr.addEventListener("load", function(e)
                                                            {
                                                                $(".selfie_upload_span").eq(index).remove();
                                                                $(".selfie_td_level_two").eq(index)
                                                                .replaceWith
                                                                (
                                                                    $("<span></span>").addClass("selfie_timestamp_leve_two_span").text(moment().format("MM/DD/YYYY hh:mm A"))
                                                                );
                                                                tbl.find("tr").eq(index + 1).find("td").last().text(moment().format("MM/DD/YYYY"));
                                                            });
                                                            xhr.open("POST", "./data");
                                                            xhr.send(formData);
                                                        })
                                                    )
                                                    .appendTo(tr);

                                                    $("<td></td>")
                                                    .append
                                                    (
                                                        $("<input />").attr("type", "text").addClass("level_two_hks_tally").attr("value", l2_data[i].hks !== null ? l2_data[i].hks : "")
                                                        .change(function()
                                                        {
                                                            var that3 = $(this);
                                                            var that_parsed = parseInt(that3.val());
                                                            if(Number.isNaN(that_parsed))
                                                            {
                                                                return;
                                                            }

                                                            var html = $("<div></div>");
                                                            $("<p></p>").text("By checking this box and typing my name, I certify that I knocked doors for at least 4 hours on this day and am submitting it as one of my 10 days.").appendTo(html);
                                                            $("<input />").attr("type", "checkbox").attr("id", "must_be_checked").appendTo(html);
                                                            $("<p></p>").text("Your Full Name:").appendTo(html);
                                                            $("<input />").attr("type", "text").attr("id", "full_name_input").css("width", "15em").appendTo(html);

                                                            BootstrapDialog.show
                                                            (
                                                                {
                                                                    "title": "Confirmation",
                                                                    "message": html.html(),
                                                                    "buttons":
                                                                    [
                                                                        {
                                                                            "label": "Cancel",
                                                                            "cssClass": "btn-danger",
                                                                            "action": function(d)
                                                                            {
                                                                                d.close();
                                                                                that3.val("");
                                                                            }
                                                                        },
                                                                        {
                                                                            "label": "Confirm",
                                                                            "cssClass": "btn-primary",
                                                                            "action": function(d)
                                                                            {
                                                                                if(!$("#must_be_checked")[0].checked)
                                                                                {
                                                                                    window.alert("You did not check the box");
                                                                                    return;
                                                                                }
                                                                                var trimmed2 = $.trim($("#full_name_input").val());
                                                                                if(trimmed2.length === 0)
                                                                                {
                                                                                    window.alert("You did not type your name");
                                                                                    return;
                                                                                }
                                                                                d.close();
                                                                                that3.css("opacity", "0.1");
                                                                                var tally = that3.val()
                                                                                var index = that3.closest("tr").prevAll("tr").length - 1;
                                                                                $.post("/data", {"fn": "set_hks_for_level_two", "idx": index + '', "tally": parseInt(tally), "identifier": window.user_identifier}).done(function()
                                                                                {
                                                                                    that3.css("opacity", "1.0");
                                                                                });
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            );
                                                        })
                                                    )
                                                    .appendTo(tr);

                                                    $("<td></td>")
                                                    .append
                                                    (
                                                        $("<input />").attr("type", "text").attr("value", l2_data[i].abs !== null ? l2_data[i].abs : "")
                                                        .change(function()
                                                        {
                                                            var that3 = $(this);
                                                            var that_parsed = parseInt(that3.val());
                                                            if(Number.isNaN(that_parsed))
                                                            {
                                                                return;
                                                            }
                                                            
                                                            that3.css("opacity", "0.1");
                                                            var tally = that3.val()
                                                            var index = that3.closest("tr").prevAll("tr").length - 1;
                                                            $.post("/data", {"fn": "set_abs_for_level_two", "idx": index + '', "tally": parseInt(tally), "identifier": window.user_identifier}).done(function()
                                                            {
                                                                that3.css("opacity", "1.0");
                                                            });
                                                        })
                                                    )
                                                    .appendTo(tr);

                                                    $("<td></td>").text(l2_data[i].selfie_timestamp === null ? "-----" : moment(l2_data[i].selfie_timestamp, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY")).appendTo(tr);
                                                    if(l2_data[i].selfie_exists)
                                                    {
                                                        tr.find(".selfie_td_level_two")
                                                        .replaceWith
                                                        (
                                                            $("<span></span>").addClass("selfie_timestamp_leve_two_span").text(moment(l2_data[i].selfie_timestamp, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY hh:mm A"))
                                                        );
                                                    }
                                                    tr.appendTo(tbody);
                                                }                                            
                                                tbody.appendTo(tbl);
                                                tbl.appendTo(main_div);

                                                $("<br />").appendTo(main_div);
                                                $("<br />").appendTo(main_div);

                                                $("<button></button>").css("font-size", "3em").text("Submit").addClass("btn").addClass("btn-primary")
                                                .click(function()
                                                {
                                                    BootstrapDialog.alert("Your submission will soon be reviewed and approved or denied by an admin. Be sure to check your email regularly.");
                                                })
                                                .appendTo(main_div);
                                            });                                            
                                        })
                                        .appendTo(icons_div);
                                    }
                                    if(show_level_3)
                                    {
                                        $("<span></span>").addClass("btn").addClass("btn-primary").css("font-size", "2em").css("margin-right", "1em").css("margin-bottom", "1em").text("Level 3 - $1000")
                                        .click(function()
                                        {
                                            hide_icons_div();

                                            $("<span></span>").addClass("label").addClass("label-primary").text("Level 3 - $1000").css("font-size", "2em").appendTo(main_div);
                                            $("<hr />").appendTo(main_div);
                                            var ul = $("<ul></ul>").addClass("runway_level_1_ul");
                                            
                                            $("<li></li>").text("During my third full week of work (M-F, partial weeks do not count) I had 20 HKs recorded in Grid")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            ) 
                                            .appendTo(ul);

                                            $("<li></li>").text("During my third full week of work I rode with the group car")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            ) 
                                            .appendTo(ul);

                                            $("<li></li>").text("During my fourth full week of work (M-F, partial weeks do not count) I had 20 HKs recorded in Grid")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            ) 
                                            .appendTo(ul);

                                            $("<li></li>").text("During my fourth full week of work I rode with the group car")
                                            .prepend
                                            (
                                                $("<input />").attr("type", "checkbox")
                                            ) 
                                            .appendTo(ul);

                                            ul.appendTo(main_div);

                                            $("<hr />").appendTo(main_div);

                                            var level_three_object_keys = Object.keys(level_three_data);

                                            $("<p></p>").text("Specify your work dates and hours below").appendTo(main_div);
                                            $("<p></p>").html("&nbsp;").appendTo(main_div);
                                            $("<span></span>").addClass("label").addClass("label-warning").text("Add Workday")
                                            .click(function()
                                            {
                                                var html = $("<div></div>");
                                                $("<p></p>").text("Hours Worked").appendTo(html);
                                                $("<input />").attr("type", "text").attr("id", "hours_worked_input").appendTo(html);
                                                $("<br />").appendTo(html);
                                                $("<p></p>").text("Date:").appendTo(html);

                                                $("<div></div>").addClass("input-append").addClass("date").attr("data-date", moment().format("MM/DD/YYYY")).attr("data-date-format", "mm/dd/yyyy")
                                                .append
                                                (
                                                    $("<input />").attr("size", "16").attr("type", "text").attr("value", moment().format("MM/DD/YYYY"))
                                                )
                                                .append
                                                (
                                                    $("<span></span>").addClass("add-on")
                                                    .append
                                                    (
                                                        $("<i></i>").addClass("icon-th")
                                                    )
                                                )
                                                .appendTo(html);

                                                BootstrapDialog.show
                                                (
                                                    {
                                                        "title": "Specify Details...",
                                                        "message": html.html(),
                                                        "buttons":
                                                        [
                                                            {
                                                                "label": "Cancel",
                                                                "cssClass": "btn-danger",
                                                                "action": function(d)
                                                                {
                                                                    d.close();
                                                                }
                                                            },
                                                            {
                                                                "label": "Save",
                                                                "cssClass": "btn-primary",
                                                                "action": function(d)
                                                                {
                                                                    var level_three_object_keys = Object.keys(level_three_data);
                                                                    if(level_three_object_keys.indexOf("days_worked") === -1)
                                                                    {
                                                                        level_three_data["days_worked"] = [];
                                                                    }
                                                                    var obj = {}
                                                                    obj["day"] = $(".bootstrap-dialog-body").find("input").last().val();
                                                                    obj["hours"] = $(".bootstrap-dialog-body").find("input").first().val();
                                                                    level_three_data["days_worked"].push(obj);
                                                                    var ttl = 60 * 60 * 24 * 90;
                                                                    ttl += '';
                                                                    $.post("/kv/runway_level_three_data_" + window.user_identifier, {"value": JSON.stringify(level_three_data), "ttl": ttl}).done(function(r9)
                                                                    {
                                                                        var tr = $("<tr></tr>");
                                                                        $("<td></td>").text(obj.day).appendTo(tr);
                                                                        $("<td></td>").text(obj.hours).appendTo(tr);
                                                                        tr.appendTo($(".runway_level_1_tbl").find("tbody").first());
                                                                        d.close();
                                                                    });
                                                                }
                                                            }
                                                        ],
                                                        "onshown": function(d)
                                                        {
                                                            $(".date").datepicker
                                                            (
                                                                {
                                                                    "autoClose": true,
                                                                    "format": "mm/dd/yyyy"
                                                                }
                                                            );
                                                        }
                                                    }
                                                )
                                            })
                                            .appendTo(main_div);
                                            $("<p></p>").html("&nbsp;").appendTo(main_div);
                                            var tbl = $("<table></table>").addClass("runway_level_1_tbl");
                                            var tbody = $("<tbody></tbody>");

                                            if(level_three_object_keys.indexOf("days_worked") > -1)
                                            {
                                                $.each(level_three_data["days_worked"], function(i, day_worked)
                                                {
                                                     var tr = $("<tr></tr>");
                                                     $("<td></td>").text(day_worked.day).appendTo(tr);
                                                     $("<td></td>").text(day_worked.hours + '').appendTo(tr);
                                                     tr.appendTo(tbody);

                                                });
                                            }

                                            
                                            tbody.appendTo(tbl);
                                            tbl.appendTo(main_div);
                                            $("<br />").appendTo(main_div);
                                            $("<br />").appendTo(main_div);

                                            $("<p></p>").text("Upload a photo of the runway document signed by your manager").appendTo(main_div);
                                            var a = $("<a></a>").attr("href", "https://storage.googleapis.com/" + window.app_bucket + "/Images/RunwayDocs/LevelThree/" + window.user_identifier + ".jpg").text("Document of Photo").addClass("doc_uploaded");
                                            if(level_three_object_keys.indexOf("photo") > -1)
                                            {
                                                a.appendTo(main_div);
                                            }
                                            else
                                            {
                                                $("<span></span>").addClass("label").addClass("label-primary").text("Upload")
                                                .click(function()
                                                {
                                                    var that = $(this);
                                                    var id = "temp_" + new Date().getTime();
                                                    var file_input = $("<input />").attr("type", "file");
                                                    file_input.attr("id", id);
                                                    file_input.appendTo(main_div);
                                                    file_input.css("display", "none");
                                                    file_input.change(function()
                                                    {
                                                        that.text("Uploading...");

                                                        var formData = new FormData();

                                                        formData.append("fn", "upload_runway_doc");
                                                        formData.append("level", "LevelThree");
                                                        formData.append("img", file_input[0].files[0]);
                                                        formData.append("identifier", window.user_identifier);

                                                        var xhr = new XMLHttpRequest();
                                                        (xhr.upload || xhr).addEventListener("progress", function(e)
                                                        {
                                                            var done = e.position || e.loaded
                                                            var total = e.totalSize || e.total;
                                                            var completion_percentage = (Math.round(done/total*100) + '') + "%";
                                                            that.text("Uploading...(" + completion_percentage + ")");

                                                        });
                                                        xhr.addEventListener("load", function(e)
                                                        {
                                                            var ttl = 60 * 60 * 24 * 90;
                                                            ttl += '';
                                                            level_three_data["photo"] = "1";
                                                            $.post("/kv/runway_level_three_data_" + window.user_identifier, {"value": JSON.stringify(level_three_data), "ttl": ttl}).done(function(r9)
                                                            {
                                                                that.replaceWith(a);
                                                                file_input.remove();
                                                            });
                                                        });
                                                        xhr.open("POST", "./data");
                                                        xhr.send(formData);
                                                    });
                                                    file_input.trigger("click");
                                                }).appendTo(main_div);
                                            }
                                            $("<br />").appendTo(main_div);
                                            $("<br />").appendTo(main_div);
                                            $("<button></button>").addClass("btn").addClass("btn-success").text("Submit")
                                            .click(function()
                                            {
                                                var target_count = $(".runway_level_1_ul").find("input").length;
                                                var tally = 0;
                                                $(".runway_level_1_ul").find("input").each(function(i, e)
                                                {
                                                    tally += ($(e)[0].checked * 1);
                                                });
                                                if(tally !== target_count)
                                                {
                                                    window.alert("You must have each checkoff item completed.");
                                                    return;
                                                }

                                                var keys = Object.keys(level_three_data);
                                                if(keys.indexOf("days_worked") === -1)
                                                {
                                                    window.alert("You have not specified your days worked with hours and dates");
                                                    return;
                                                }
                                                if(keys.indexOf("photo") === -1)
                                                {
                                                    window.alert("You have not uploaded the document signed by your manager");
                                                    return;
                                                }
                                                if(level_three_data.days_worked.length < 10)
                                                {
                                                    window.alert("You must specify your dates worked with hour and date (10 days)");
                                                    return;
                                                }

                                                var payload = {};
                                                payload["identifier"] = window.user_identifier;
                                                payload["level"] = "level_three"
                                                payload["fn"] = "runway_save"

                                                payload["data"] = JSON.stringify(level_three_data);
                                                $.post("/data", payload).done(function()
                                                {
                                                    clearApp(function()
                                                    {
                                                        showIconGrid();
                                                        BootstrapDialog.alert("Your submission will soon be reviewed and approved or denied by an admin. Be sure to check your email regularly.");
                                                    });
                                                });

                                            })
                                            .appendTo(main_div);

                                        }).appendTo(icons_div);
                                    }
                                    append_to_dom();
                                    icons_div.appendTo(app_area);
                                });
                            });
                            
                        });
                    });
                });                                
            }
            function carveOutRep()
            {
                hideIconGrid();

                var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");                
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                var spacer_clone = spacer.clone();

                $("<h2></h2>").text("Carve Out")
                .append
                (
                    $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").attr("id", "carve_out_back").css("float", "right")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                )
                .appendTo(main_div);
                $("<hr />").appendTo(main_div);

                var carve_out_div = $("<div></div>").css("background", "#FFFFFF");
                carve_out_div.css("padding", "1em");
                carve_out_div.css("min-height", "20em");
                $("<p></p>").attr("id", "carve_out_num").text("{{ carve_out_number }}").appendTo(carve_out_div);
                $("<center></center>")
                .append
                (
                    $("<span></span>").attr("id", "carve_out_whoah_nelly").css("opacity", "0.0").text("Whoah Nelly!")                
                )
                .appendTo(carve_out_div);

                carve_out_div.appendTo(main_div);

                $.each([spacer, main_div, spacer_clone], function(i, e)
                {
                    e.appendTo($("#app_area"));
                });
                carve_out_div[0].scrollIntoView();

                $('#carve_out_num').counterUp
                (
                    {
                        "delay": 10,
                        "time": 3000
                    }
                );
                setTimeout(function()
                {
                    var interval_ref = 
                    setInterval(function()
                    {
                        var target_text = "{{ carve_out_number }}";
                        var current_text = $("#carve_out_num").text();
                        if(current_text === target_text)
                        {
                            var parsed = parseFloat(target_text);
                            var currency_formatted = currencyFormat(parsed);
                            currency_formatted = currency_formatted.replace("$", "");
                            currency_formatted = currency_formatted.split(".")[0];
                            $("#carve_out_num").text(currency_formatted);

                            window.clearInterval(interval_ref);
                            $("#carve_out_whoah_nelly").animate({"opacity": 1.0}, 2000, function()
                            {
                                
                            });
                        }
                    }, 250);
                    window.temp_intervals.push(interval_ref);                    
                }, 500);
            }
            function showMyAreas()
            {
                hideIconGrid();
                var app_area = $("#app_area");
                $("<h2></h2>").text("Loading...").appendTo(app_area);
                $.post("/data", {"fn": "rep_quad_query_rep_portal", "identifier": window.user_identifier}).done(function(r)
                {
                    $("<button></button>").addClass("btn").addClass("btn-danger").html("&larr; Back").attr("id", "my_area_back")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                    .prependTo(app_area);
                    var quads = r.quads;
                    $("<div></div>").attr("id", "my_area_map").appendTo(app_area);

                    main_map = new google.maps.Map(document.getElementById('my_area_map'), 
                    {
                        zoom: 16,
                        center: {"lat": 33.9979486, "lng": -117.3327293}
                    });
                    var seventy_five_percent = parseFloat($(window).height()) * 0.75;
                    seventy_five_percent = parseInt(seventy_five_percent);
                    seventy_five_percent += '';
                    seventy_five_percent += 'px';

                    $("#my_area_map").css("height", seventy_five_percent);

                    $.each(quads, function(i, quad)
                    {
                        var coords = [];
                        var json_data = $.parseJSON(quad.all_points);
                        $.each(json_data, function(ii, position)
                        {
                            var lat = parseFloat(position.split(",")[0]);
                            var lng = parseFloat(position.split(",")[1]);
                            coords.push({"lat": lat, "lng": lng});
                        });
                        var first_lat = parseFloat(json_data[0].split(",")[0]);
                        var first_lng = parseFloat(json_data[0].split(",")[1]);
                        coords.push({"lat": first_lat, "lng": first_lng});                        

                        var new_poly = new google.maps.Polygon
                        (
                            {
                                "paths": coords,
                                "strokeColor": "#0000FF",
                                "strokeOpacity": 0.8, 
                                "strokeWeight": 2,
                                "fillColor": "#0000FF",
                                "fillOpacity": 0.5
                            }
                        );
                        new_poly.setMap(main_map);

                        google.maps.event.addListener(new_poly, 'click', function (event)
                        {
                            var info_window = new google.maps.InfoWindow
                            (
                                {
                                    "content": "<p class='my_area_map_i_dub' id='pin_change_" + quad.identifier + "'>Please Wait</p>"
                                }
                            );
                            var marker = new google.maps.Marker
                            (
                                {
                                    "position": coords[0],
                                    "map": main_map,
                                    "title": "",
                                    "draggable": false,
                                     "icon": "https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|000000"
                                }
                            );
                            marker.setVisible(false);

                            info_window.open(main_map, marker);
                            setTimeout(function()
                            {
                                $(".gm-style-iw-a").first().parent().css("visibility", "visible");
                            }, 250);                            
                            $.post("/data2", {"fn": "percentage_of_pins_changed", "identifier": quad.identifier}).done(function(details)
                            {
                                var str = details.changed_tally + " of " + details.tally + " pins (" + (details.percentage + '') + "%) have been changed";
                                $("#pin_change_" + quad.identifier).text(str);
                                setTimeout(function()
                                {
                                    $(".gm-style-iw-a").first().parent().css("visibility", "visible");
                                }, 250);                                                                
                            });                            
                        });

                        app_area.find("h2").remove();

                    });                    
                });   
            }
            function nirnbergerSpecial()
            {
                var app_area = $("#app_area");
                hideIconGrid();
                $("<h2></h2>").text("Loading...").appendTo(app_area);

                $.post("/data", {"fn": "pull_active_areas_for_nirnberger_rep", "identifier": window.user_identifier}).done(function(r)
                {
                    app_area.find("h2").remove();                    
                    var quads = r.quads;
                    console.log(quads);

                    var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var spacer_clone = spacer_div.clone();
                    var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");

                    window.COLE_APP_DIV = main_div;
                    
                    $("<h2></h2>").text("Nirnberger Special").appendTo(main_div);
                    $("<hr />").appendTo(main_div);
                    
                    $("<div></div>").attr("id", "nirnberger_map").appendTo(main_div);

                    $.each([spacer_div, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });

                    window.nirnberger_map = new google.maps.Map(document.getElementById('nirnberger_map'), 
                    {
                        zoom: 16,
                        center: {"lat": 33.9979486, "lng": -117.3305406}
                    });

                    var polys = [];

                    window.quad_identifier_completed_dict = {};
                    window.pin_identifier_marker_dict = {};
                    window.pin_identifier_address_dict = {}

                    $.each(quads, function(i, quad)
                    {
                        quad_identifier_completed_dict[quad.identifier] = [];

                        var coords = [];
                        var points = $.parseJSON(quad.points);

                        quad.markers = [];
                        
                        $.each(points, function(ii, point_str)
                        {
                            var lat = parseFloat(point_str.split(",")[0]);
                            var lng = parseFloat(point_str.split(",")[1]);
                            coords.push({"lat": lat, "lng": lng});
                        });
                        coords.push(coords[0]);

                        var new_poly = new google.maps.Polygon
                        (
                            {
                                "paths": coords,
                                "strokeColor": "#0000FF",
                                "strokeOpacity": 0.8, 
                                "strokeWeight": 2,
                                "fillColor": "#0000FF",
                                "fillOpacity": 0.1
                            }
                        );
                        polys.push({"identifier": quad.identifier, "poly": new_poly});
                        new_poly.setMap(nirnberger_map);
                        
                        google.maps.event.addListener(new_poly, 'click', function (event)
                        {
                            var opts = {"fillOpacity": 0.1};
                            $.each(polys, function(ii, poly_item)
                            {
                                if(poly_item.identifier !== quad.identifier)
                                {
                                    poly_item.poly.setOptions(opts);
                                }
                                else
                                {
                                    poly_item.poly.setOptions({"fillOpacity": 0.5});

                                    // fetch the pins
                                    $.post("/data", {"fn": "pull_pins_for_nirnberger_quad", "identifier": quad.identifier}).done(function(pin_response)
                                    {
                                        var pins = pin_response.pins;
                                        
                                        $.each(pins, function(iii, pin2)
                                        {
                                            var completed = false
                                            if(quad.completed.indexOf(pin2.identifier) > -1)
                                            {
                                                completed = true;
                                            }
                                            if(completed)
                                            {
                                                quad_identifier_completed_dict[quad.identifier].push(pin2.identifier);
                                            }                                            
                                        });
                                        
                                        $.each(pins, function(iiiii, pin)
                                        {
                                            var new_icon_url = "https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|B4CBF0";
                                            if(quad_identifier_completed_dict[quad.identifier].indexOf(pin.identifier) > -1)
                                            {
                                                new_icon_url = "https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|000000";
                                            }
                                            var marker = new google.maps.Marker
                                            (
                                                {
                                                    position: {"lat": pin.latitude, "lng": pin.longitude},
                                                    map: nirnberger_map,
                                                    title: "",
                                                    draggable: false,
                                                    /*icon: "https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|0000FF"*/
                                                    /*icon: "https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|B4CBF0"*/
                                                    icon: new_icon_url
                                                }
                                            );
                                            pin_identifier_marker_dict[pin.identifier] = marker;
                                            google.maps.event.addListener(marker, 'click', function (event2)
                                            {
                                                nirnberger_map.setCenter(marker.getPosition());
                                                nirnberger_map.setZoom(28);
                                                /*$.each(quad.markers, function(index, duped_marker)
                                                {
                                                    duped_marker.setIcon("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|B4CBF0");
                                                });*/
                                                /*$.each(quad.markers, function(index, duped_marker)
                                                {
                                                    duped_marker.setIcon("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|B4CBF0");
                                                });
                                                $.each(quad.markers, function(iiiii, m)
                                                {
                                                    marker.setIcon("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|000000");
                                                });*/
                                                /*if(quad_identifier_completed_dict[quad.identifier].indexOf(pin.identifier) === -1)
                                                {
                                                    marker.setIcon("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|0000FF");
                                                } */                                               

                                                var html_content = $("<div></div>");
                                                $("<p></p>").attr("id", "address_for_" + pin.identifier).addClass("nirnberger_addy").text("Please wait...").appendTo(html_content);

                                                $("<a></a>").attr("id", "cole_results_a_for_" + pin.identifier).addClass("cole_dive_in_a").css("visibility", "hidden").text("Dive In!").attr("href", "").appendTo(html_content);
                                                $("<br />").appendTo(html_content);
                                                $("<div></div>").addClass("cole_street_view_div").attr("id", "street_view_for_" + pin.identifier).appendTo(html_content);

                                                var info_window = new google.maps.InfoWindow
                                                (
                                                    {
                                                        content: html_content.html()
                                                    }
                                                );
                                                info_window.open(nirnberger_map, marker);

                                                // pull the address
                                                $.getJSON("https://maps.googleapis.com/maps/api/geocode/json?latlng=" + pin.latitude + encodeURIComponent(",") + pin.longitude + "&key=AIzaSyCdL0GwXm8y8BsO247nCIxjNtcc87uDBrQ").done(function(address_data)
                                                {
                                                    if(address_data.results.length > 0)
                                                    {
                                                        var addy = "";
                                                        var first_result = address_data.results[0];
                                                        var street_number = "";
                                                        var cole_address = "";

                                                        var city = "";
                                                        var state = "";
                                                        var postal = "";

                                                        for (var num = 0; num < first_result.address_components.length; num++)
                                                        {
                                                            for (var k = 0; k < first_result.address_components[num].types.length; k++)
                                                            {
                                                                try
                                                                {
                                                                    if (first_result.address_components[num].types[k] == "street_number")
                                                                    {
                                                                        addy += " " + first_result.address_components[num].long_name + " ";
                                                                        street_number = first_result.address_components[num].long_name;
                                                                        cole_address += street_number;
                                                                    }
                                                                    else if (first_result.address_components[num].types[k] == "route")
                                                                    {
                                                                        addy += " " + first_result.address_components[num].short_name + " ";
                                                                        cole_address += " ";
                                                                        cole_address += first_result.address_components[num].short_name;
                                                                    }
                                                                    else if (first_result.address_components[num].types[k] == "locality")
                                                                    {
                                                                        addy += " " + first_result.address_components[num].long_name + " ";
                                                                        city = first_results
                                                                    }
                                                                    else if (first_result.address_components[num].types[k] == "postal_code")
                                                                    {
                                                                        addy += " " + first_result.address_components[num].long_name + " ";
                                                                        postal = first_result.address_components[num].long_name;
                                                                    }
                                                                    else if (first_result.address_components[num].types[k] == "administrative_area_level_1")
                                                                    {
                                                                        addy += " " + first_result.address_components[num].short_name + " ";
                                                                        state = first_result.address_components[num].short_name;
                                                                    }   
                                                                }
                                                                catch(e926)
                                                                {
                                                                    //addy = "Could not resolve address";
                                                                }

                                                            }
                                                        }
                                                        var js_string = "javascript:coleDetails('" + pin.identifier + "','" + quad.identifier + "','" + cole_address + "','" + postal + "','" + state + "','" + street_number + "');";
                                                        $("#address_for_" + pin.identifier).text(addy);
                                                        window.pin_identifier_address_dict[pin.identifier] = addy;
                                                        $("#cole_results_a_for_" + pin.identifier).attr("href", js_string).css("visibility", "visible");

                                                        var panorama = new google.maps.StreetViewPanorama
                                                        (
                                                            document.getElementById('street_view_for_' + pin.identifier),
                                                            {
                                                                "position": {lat: pin.latitude, lng: pin.longitude},
                                                                "pov": {heading: 165, pitch: 0},
                                                                "zoom": 1
                                                            }
                                                        );
                                                    }
                                                });

                                            });                                         
                                            quad.markers.push(marker);
                                            marker.setMap(nirnberger_map)
                                        });
                                    });
                                }
                            });                                
                            $.each(quads, function(ii, dupe)
                            {
                                $.each(dupe.markers, function(iii, marker)
                                {
                                    marker.setMap(null);
                                });
                                dupe.markers = [];
                            });
                        });
                        
                        if(i === 0)
                        {
                           nirnberger_map.setCenter(coords[0]);
                        }
                    });
                });
            }
            function coleDetails(identifier, quad_identifier, cole_address, postal, state, street_num)
            {
                $.post("/data", {"fn": "record_dive_in", "identifier": window.user_identifier});
                $(".cole_details").remove();
                var width = $(window).width();
                var height = $(window).height();
                var five_percent_height = height * 0.05;
                var five_percent_width = width * 0.05;

                var cole_root = $("<div></div>").addClass("cole_details");

                $("<center></center>").addClass("cole_details_wait").text("Please Wait").appendTo(cole_root);
                var completed = (quad_identifier_completed_dict[quad_identifier].indexOf(identifier) > -1);
                var cole_p = $("<p></p>");
            
                cole_p.text
                (
                    "Click to Mark Completed"
                )
                .prepend
                (
                    $("<input />").attr("type", "checkbox").change(function()
                    {
                        var that = $(this);
                        if(completed)
                        {
                            return;
                        }
                        else
                        {
                            if(that[0].checked)
                            {
                                that.css("opacity", "0.1");
                                $.post("/data", {"fn": "complete_nirnberger_special_pin", "quad_identifier": quad_identifier, "pin_identifier": identifier}).done(function()
                                {
                                    var marker = pin_identifier_marker_dict[identifier];
                                    marker.setIcon("https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|000000");
                                    quad_identifier_completed_dict[quad_identifier].push(identifier)
                                    that.css("opacity", "1.0");
                                    cole_root.remove();
                                });
                            }
                        }
                    })
                );
                $("<p></p>").addClass("cole_details_address").css("font-weight", "bold").text(window.pin_identifier_address_dict[identifier])
                .appendTo(cole_root);

                if(!completed)
                {
                    cole_p.appendTo(cole_root);
                }

                cole_root.appendTo(window.COLE_APP_DIV);
                cole_root[0].scrollIntoView();
                $(window).scrollTop(0);

                var payload = {"type": "ColeQuery", "address": cole_address, "postal": postal, "state": state, "debugging": "1"};
                $.ajax
                (
                    {
                        type: "POST",
                        url: "/AppData",
                        data: JSON.stringify(payload),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function(data)
                        {

                            console.log(data);
                            $(".cole_details_wait").text("Click to Close")
                            .click(function()
                            {
                                nirnberger_map.setZoom(16);
                                cole_root.remove();
                                $("#nirnberger_map")[0].scrollIntoView();
                            });
                            $("<div></div>").attr("id", "cole_hr").appendTo(cole_root);

                            var entries = [];
                            $.each(data, function(i, item)
                            {
                                var house_num = item.HouseNumber + '';
                                if(house_num === street_num + '')
                                {
                                    $.each(["CellPhones", "PhoneNumbers"], function(n, key)
                                    {
                                        $.each(item[key], function(ii, num)
                                        {
                                            if(num.DoNotCall === "N")
                                            {
                                                var entry = {};
                                                entry.score = parseInt(item.Score);
                                                entry.name = item.FirstName + " " + item.LastName;
                                                entry.phone = num.PhoneNumber;

                                                entries.push(entry);
                                            }
                                        });
                                    });                                    
                                }                                
                            });
                            entries = bubbleSortArrayOfObjectsByKey(entries, "score");
                            entries.reverse();
                            if(entries.length === 0)
                            {
                                $("<p></p>").addClass("cole_no_results").text("No results").appendTo(cole_root);
                            }
                            else
                            {
                                var tbl = $("<table></table>");                                
                                var tbody = $("<tbody></tbody>");

                                $("<tr></tr>")
                                .append
                                (
                                    $("<th></th>").text("Score")
                                )
                                .append
                                (
                                    $("<th></th>").text("Name")
                                )
                                .append
                                (
                                    $("<th></th>").text("Phone")
                                )
                                .appendTo(tbody);

                                $.each(entries, function(i, entry)
                                {
                                    var phone_digits = entry.phone.digits();
                                    if(phone_digits !== null)
                                    {   
                                        var formatted = "(";
                                        formatted += (phone_digits[0] + phone_digits[1] + phone_digits[2]);
                                        formatted += ") ";
                                        formatted += (phone_digits[3] + phone_digits[4] + phone_digits[5]);
                                        formatted += "-";
                                        formatted += (phone_digits[6] + phone_digits[7] + phone_digits[8] + phone_digits[9]);
                                    }

                                    $("<tr></tr>")
                                    .append
                                    (
                                        $("<td></td>").text(entry.score + '')
                                    )
                                    .append
                                    (
                                        $("<td></td>").text(entry.name)
                                    )
                                    .append
                                    (
                                        $("<td></td>")
                                        .append
                                        (
                                            $("<a></a>").attr("href", "tel:" + phone_digits).text(formatted)
                                        )                                        
                                    )
                                    .appendTo(tbody);
                                });
                                tbody.appendTo(tbl);
                                tbl.appendTo(cole_root);
                                tbl.find("tr").first()[0].scrollIntoView();
                            }
                        }                    
                    }
                );
            }
            function roofWorkNeeded()
            {
                var app_area = $("#app_area");
                hideIconGrid();                
                window.second_time_called = false;
                $.post("/data", {"fn": "get_roof_work_for_rep", "identifier": window.user_identifier}).done(function(r)
                {
                    var spacer = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1");
                    var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10");
                    var spacer_clone = spacer.clone();
                    
                    $("<button></button>").addClass("btn").addClass("btn-danger").css("font-size", "2em").css("margin-bottom", "2em").html("&larr; Back")
                    .click(function()
                    {
                        clearApp(function()
                        {
                            showIconGrid();
                        });
                    })
                    .appendTo(main_div);
                    
                    var root_div = $("<div></div>").addClass("roof_work_needed_div");
                    $.each(r.items, function(i, item)
                    {
                        var cust_div = $("<div></div>").addClass("before_details_roof_work");
                        cust_div.attr("data-identifier", item.identifier).attr("data-field_app_identifier", item.field_app_identifier);
                        $("<span></span>").addClass("before_details_roof_work_cust_name").text(item.name).appendTo(cust_div);
                        cust_div.click(function()
                        {
                            $(".roof_work_sub_root").remove();
                            var that = $(this);
                            var orig_txt = that.find(".before_details_roof_work_cust_name").text();
                            that.find(".before_details_roof_work_cust_name").text("Loading...");
                            that.css("opacity", "0.5");
                            $.post("/data", {"fn": "pull_roof_work_specific_details", "identifier": item.identifier, "field_app_identifier": item.field_app_identifier}).done(function(r2)
                            {
                                that.css("opacity", "1.0");
                                that.find(".before_details_roof_work_cust_name").text(orig_txt);
                                var type_mapping = {"comp_inset": "Comp Inset (clay tile removal, etc.)", "shingle_roof": "Shingle Roof", "tile_under": "Tile Underlayment", "torch": "Flat Roof Torch Down"};

                                var sub_root = $("<div></div>").addClass("roof_work_sub_root");

                                var get_total_roof_cost = function()
                                {
                                    var option_mapping = {};
                                    if(Object.keys(r2.data).indexOf("full_reroof_cost") > -1)
                                    {
                                        option_mapping["full_reroof"] = r2.data.full_reroof_cost;
                                    }
                                    if(Object.keys(r2.data).indexOf("solar_area_only_cost") > -1)
                                    {
                                        option_mapping["solar_area_only"] = r2.data.solar_area_only_cost;
                                    }

                                    var roof_cost = option_mapping[$("#rep_option_one_sel").val()];
                                    var dealer_percentage = "0";
                                    $.each(r.funds, function(ii, fund)
                                    {
                                        if(fund.value === r2.fund)
                                        {
                                            dealer_percentage = (fund.dealer_fee_percentage + '');
                                        }
                                    });

                                    dealer_percentage = dealer_percentage.replace("%", "");
                                    dealer_percentage = parseFloat(dealer_percentage);
                                    dealer_percentage /= parseFloat(100);

                                    var ret = roof_cost / (1.0 - dealer_percentage);

                                    return ret;


                                };

                                sub_root.on("update_system_cost", function()
                                {
                                    
                                    window.SECONDARY_LOAN_ADJUSTED_AMOUNT_FINANCED = 0;
                                    var cost = get_total_roof_cost();
                                    $("#roof_work_cost_update").text(currencyFormat(cost));
                                    $(".steps_and_links_first_group").css("display", "none");
                                    $("#number_9_warning_roof_work").css("display", "none");
                                    $("#number_4_warning_roof_work").css("display", "none");                                                                        

                                    // warnings...

                                    var total_system_cost = parseFloat(r2.total_system_cost);
                                    var sum = total_system_cost + cost;
                                    var tweaked_cost = parseFloat(sum);

                                    
                                    
                                    var per_kw = sum / parseFloat(r2.system_size);                                    


                                    per_kw /= parseFloat(1000);
                                    window.per_kw_roof_work = per_kw;

                                    var is_lp = false;
                                    $.each(r.funds, function(iii, fund)
                                    {
                                        if(fund.value === r2.fund)
                                        {
                                            is_lp = fund.lp;
                                        }
                                    });
                                    window.is_lp_roof_work = is_lp

                                    var tweak_eleven_one = false;

                                    if(per_kw > parseFloat(7) && is_lp)
                                    {
                                        
                                        $("#number_4_warning_roof_work").css("display", "block");
                                        $("#roof_work_secondary_fund_group").css("display", "block");
                                        if($("#rep_option_2_fund_sel").val() === "n/a")
                                        {
                                            $("#roof_work_cost_update").text("Please choose a fund...");
                                            $("#number_7_roof_work").text("Please choose a fund...");
                                            $("#roof_work_total_tax_credit").text("Please choose a fund...");                                            
                                            return;
                                        }
                                        
                                        var current_per_kw = sum / parseFloat(r2.system_size);
                                        current_per_kw /= parseFloat(1000);

                                        var option_mapping2 = {};
                                        if(Object.keys(r2.data).indexOf("full_reroof_cost") > -1)
                                        {
                                            option_mapping2["full_reroof"] = r2.data.full_reroof_cost;
                                        }
                                        if(Object.keys(r2.data).indexOf("solar_area_only_cost") > -1)
                                        {
                                            option_mapping2["solar_area_only"] = r2.data.solar_area_only_cost;
                                        }

                                        var base_roof_cost = parseFloat(option_mapping2[$("#rep_option_one_sel").val()]);
                                        var first_round_financed = parseFloat(base_roof_cost);

                                        while(current_per_kw >= parseFloat(7))
                                        {
                                            first_round_financed -= 0.01;
                                            
                                            var new_sum = total_system_cost + first_round_financed;
                                            current_per_kw = new_sum / parseFloat(r2.system_size);
                                            current_per_kw /= parseFloat(1000);
                                        }                                        
                                        first_round_financed -= 0.01;
                                        var rounded = first_round_financed.toFixed(2);
                                        window.SECONDARY_LOAN_ADJUSTED_AMOUNT_FINANCED = parseFloat(rounded);
                                        var second_rounded = parseFloat(rounded);
                                        var third_rounded = parseFloat(rounded);
                                        var fourth_rounded = parseFloat(rounded);
                                        
                                        var first_fund_dealer_fee = 0.0;
                                        $.each(r.funds, function(ii, fund)
                                        {
                                            if(fund.value === r2.fund)
                                            {
                                                first_fund_dealer_fee = parseFloat(fund.dealer_fee_percentage.replace("%", ""));
                                                first_fund_dealer_fee /= parseFloat(100);
                                                var percentage = parseFloat(fund.dealer_fee_percentage.replace("%", ""));
                                                percentage /= 100;
                                                rounded *= (1.0 - percentage);
                                            }
                                            if(fund.value === $("#rep_option_2_fund_sel").val())
                                            {
                                                var diff = base_roof_cost - rounded;
                                                var dealer_percentage_fee = parseFloat(fund.dealer_fee_percentage.replace("%", ""));
                                                dealer_percentage_fee /= 100;
                                                //var roof_amt_lost_to_dealer_fees = (first_round_financed * first_fund_dealer_fee).toFixed(2);
                                                var roof_amt_lost_to_dealer_fees = (second_rounded * first_fund_dealer_fee).toFixed(2);
                                                roof_amt_lost_to_dealer_fees = parseFloat(roof_amt_lost_to_dealer_fees);
                                                roof_amt_lost_to_dealer_fees = roof_amt_lost_to_dealer_fees.toFixed(2);
                                                roof_amt_lost_to_dealer_fees = parseFloat(roof_amt_lost_to_dealer_fees);

                                                var remaining_to_collect = diff / (1.0 - dealer_percentage_fee);

                                                var dealer_fee_percentage2 = parseFloat(fund.dealer_fee_percentage.replace("%", ""));
                                                dealer_fee_percentage2 /= 100;
                                                var final_amt_to_show = second_rounded + (remaining_to_collect);
                                                $("#roof_work_cost_update").text(currencyFormat(final_amt_to_show));                                                
                                            }
                                        });
                                    }
                                    else
                                    {
                                        $("#number_4_warning_roof_work").css("display", "none");
                                        $("#roof_work_secondary_fund_group").css("display", "none");
                                        tweak_eleven_one = true;
                                    }
                                    var seven_num = parseFloat(r2.total_system_cost);
                                    var total_roof_work_cost_two = $("#roof_work_cost_update").text();
                                    while(total_roof_work_cost_two.indexOf("$") > -1)
                                    {
                                        total_roof_work_cost_two = total_roof_work_cost_two.replace("$", "");
                                    }
                                    while(total_roof_work_cost_two.indexOf(",") > -1)
                                    {
                                        total_roof_work_cost_two = total_roof_work_cost_two.replace(",", "");
                                    }
                                    total_roof_work_cost_two = parseFloat(total_roof_work_cost_two);
                                    var amt1 = total_roof_work_cost_two + seven_num;
                                    $("#number_7_roof_work").text(currencyFormat(amt1));
                                    var tax_amt_2 = 0.26 * amt1;
                                    $("#roof_work_total_tax_credit").text(currencyFormat(tax_amt_2));

                                    if(tax_amt_2 < window.SECONDARY_LOAN_ADJUSTED_AMOUNT_FINANCED)
                                    {
                                        $("#number_9_warning_roof_work").css("display", "block");
                                    }

                                    $("#number_eleven_number_one").text("Please choose a fund");
                                    $("#number_eleven_number_two").text("Please choose a fund");
                                    $("#number_eleven_number_three").text("Please choose a fund");
                                    $("#number_eleven_number_four").text("Please choose a fund");
                                    $("#number_tweleve_number_one").text("Please choose a fund");
                                    $("#number_tweleve_eighteen, #number_twelve_twenty_twenty_four, #number_twelve_special").text("Please choose a fund").css("display", "none");
                                    
                                    $.each(r.funds, function(ii, fund)
                                    {
                                        if(fund.value === $("#rep_option_2_fund_sel").val())
                                        {
                                            var num_el_amt = null;
                                            var a = third_rounded;
                                            var b = amt1;
                                            //$("#number_eleven_number_one").text(tweaked_cost);
                                            //$("#number_eleven_number_one").text(currencyFormat(b - a));
                                            var grab_me = null;
                                            if(tweak_eleven_one)
                                            {
                                                num_el_amt = seven_num + get_total_roof_cost();
                                                $("#number_eleven_number_one").text(currencyFormat(seven_num + get_total_roof_cost()));
                                                grab_me = seven_num + get_total_roof_cost();
                                                
                                                //$("#number_eleven_number_one").text(currencyFormat(b - a));
                                                //$("#number_eleven_number_one").text(tweaked_cost);
                                            }
                                            else
                                            {
                                                // foo
                                                num_el_amt = r2.system_size * 7000;
                                                grab_me = r2.system_size * 7000;
                                                $("#number_eleven_number_one").text(currencyFormat(r2.system_size * 7000));
                                            }
                                            window.num_el_amt66 = num_el_amt;

                                            $("#number_eleven_number_one").css("display", "block");




                                            var amt5 = b - a;
                                            amt5 *= fund.promo_factor;

                                            var num_two_amt = null;
                                            $.each(r.funds, function(ignore, f)
                                            {
                                                if(f.value === r2.fund)
                                                {
                                                    num_two_amt = num_el_amt * f.promo_factor;
                                                }                                                
                                            });
                                            $("#number_eleven_number_two").text(currencyFormat(num_two_amt)).css("display", "block");                                            

                                            var aa = third_rounded;
                                            var bb = tax_amt_2;

                                            var diff1 = third_rounded - bb;
                                            var eleven_amt = diff1;
                                            if(diff1 <= parseFloat(0))
                                            {
                                                eleven_amt = eleven_amt * parseFloat(-1);
                                                eleven_amt = (b - a) - eleven_amt;
                                                eleven_amt *= fund.after_promo_factor;
                                            }
                                            else
                                            {
                                                eleven_amt *= fund.after_promo_factor;
                                            }
                                            $.each(r.funds, function(foo, bar)
                                            {
                                                if(bar.value === r2.fund)
                                                {
                                                    var num_11_num_1_amt = $("#number_eleven_number_one").text();
                                                    while(num_11_num_1_amt.indexOf("$") > -1)
                                                    {
                                                        num_11_num_1_amt = num_11_num_1_amt.replace("$", "");
                                                    }
                                                    while(num_11_num_1_amt.indexOf(",") > -1)
                                                    {
                                                        num_11_num_1_amt = num_11_num_1_amt.replace(",", "");
                                                    }
                                                    num_11_num_1_amt = parseFloat(num_11_num_1_amt);
                                                    var num_4_amt = num_11_num_1_amt * parseFloat(bar.after_promo_factor);
                                                    $("#number_eleven_number_four").text(currencyFormat(num_4_amt));
                                                }
                                            });                                            
                                            //$("#number_eleven_number_three").text(currencyFormat(eleven_amt)).css("display", "block");                                                                                        
                                            //$("#number_tweleve_number_one").text(currencyFormat(fourth_rounded));                                            
                                            var new_amt22 = total_roof_work_cost_two - fourth_rounded;
                                            $("#number_tweleve_number_one").text(currencyFormat(new_amt22));
                                            window.new_amt22 = new_amt22;
                                            
                                            /*if(fund.value.indexOf("2018") > -1 || fund.value.indexOf("2024") > -1)
                                            {
                                                $("#number_twelve_number_two").text(currecyFormat(fourth_rounded * fund.after_promo_factor));
                                            }*/

                                            var amt445 = $("#number_eleven_number_one").text();
                                            while(amt445.indexOf("$") > -1)
                                            {
                                                amt445 = amt445.replace("$", "");
                                            }
                                            while(amt445.indexOf(",") > -1)
                                            {
                                                amt445 = amt445.replace(",", "");
                                            }
                                            amt445 = parseFloat(amt445);
                                            var amt4452 = parseFloat(amt445);

                                            var amt445_final = (new_amt22 - bb);
                                            if(amt445_final < 0)
                                            {
                                                amt445_final *= -1;
                                                amt445_final = grab_me - amt445_final;
                                                $.each(r.funds, function(nah, this_is_lame)
                                                {
                                                    if(this_is_lame.value === r2.fund)
                                                    {
                                                        amt445_final *= this_is_lame.after_promo_factor;
                                                    }
                                                });
                                            }
                                            else
                                            {
                                                $.each(r.funds, function(nah, this_is_lame)
                                                {
                                                    if(this_is_lame.value === r2.fund)
                                                    {
                                                        amt445_final = (grab_me * this_is_lame.after_promo_factor);
                                                    }
                                                });
                                            }

                                            $("#number_eleven_number_three").text(currencyFormat(amt445_final));

                                            if(fund.value.indexOf("2018") > -1)
                                            {
                                                $("#number_tweleve_eighteen").text("No payments but the full total cost must be paid off before the end of 18 months").css("display", "block");
                                            }
                                            if(fund.value.indexOf("2024") > -1)
                                            {
                                                $("#number_twelve_twenty_twenty_four").text("No payments but the full total cost must be paid off before the end of 24 months").css("display", "block");
                                            }
                                            if(fund.value.indexOf("4071") > -1)
                                            {
                                                var last_amt2 = new_amt22 * fund.after_promo_factor;
                                                $("#number_twelve_special").text(currencyFormat(last_amt2)).css("display", "block");
                                            }
                                        }
                                    });

                                });                                

                                $("<p></p>").addClass("roof_item_details_info")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Roof Type:")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text(type_mapping[r2.data.roof_type])
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "reason_needed_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Reason Needed:")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").html(r2.data.description.split("\n").join("<br />"))
                                )
                                .appendTo(sub_root);

                                var show_full_reroof = false;

                                if(r2.data.roof_type !== "comp_inset")
                                {
                                    var p_to_append = $("<p></p>").addClass("roof_item_details_info");
                                    p_to_append.append
                                    (
                                        $("<span></span>").addClass("roof_item_details_label").text("Select Full Reroof or Solar Area Only")
                                    );

                                    var first_opt = $("<option></option>").attr("value", "solar_area_only").text("Solar Area Only");
                                    var second_opt = $("<option></option>").attr("value", "full_reroof").text("Full Reroof");

                                    if(r2.data.rep_selection_one === "full_reroof")
                                    {
                                        second_opt.attr("selected", "selected");
                                        show_full_reroof = true;
                                    }
                                    $("<span></span>").addClass("roof_item_details_value")
                                    .append
                                    (
                                        $("<select></select>").attr("id", "rep_option_one_sel")
                                        .append
                                        (
                                            first_opt
                                        )
                                        .append
                                        (
                                            second_opt
                                        )
                                        .change(function(ev)
                                        {
                                            var value = $(this).val();
                                            if(value === "solar_area_only")
                                            {
                                                $("#full_reroof_photo").css("display", "none");
                                                $("#solar_only_photo").css("display", "block");
                                            }
                                            else
                                            {
                                                $("#full_reroof_photo").css("display", "block");
                                                $("#solar_only_photo").css("display", "none");
                                            }                                            
                                            ev.stopPropagation();
                                            var that2 = $(this);
                                            that2.css("opacity", "0.1");
                                            $.post("/data", {"fn": "set_value_for_roof_work_choice_1", "identifier": item.identifier, "value": that2.val()})
                                            .done(function()
                                            {
                                                r2.data.rep_selection_one = that2.val();
                                                that2.css("opacity", "1.0");
                                                cust_div.trigger("click");
                                                //sub_root.trigger("update_system_cost");
                                            });
                                        })
                                        .click(function(ev)
                                        {
                                            ev.stopPropagation();
                                        })
                                    )
                                    .appendTo(sub_root);                                    
                                }

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "number_4_warning_roof_work").css("display", "none")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("WARNING: Cost of roof work will exceed Loanpal $7 per watt price cap. You must select an additional financing product to pay for the rest of the roof work.")
                                )
                                .appendTo(sub_root);

                                var secondary_fund_sel = $("<select></select>").attr("id", "rep_option_2_fund_sel");
                                
                                secondary_fund_sel
                                .append
                                (
                                    $("<option></option>").attr("value", "n/a").text("Choose One")
                                );
                                
                                $.each(r.funds, function(iii, fund)
                                {
                                    if(fund.supplementary === true)
                                    {
                                        $("<option></option>").attr("value", fund.value).text(fund.value_friendly).appendTo(secondary_fund_sel)
                                    }                                    
                                });

                                secondary_fund_sel
                                .change(function(ev)
                                {      
                                    var that2 = $(this);     
                                    that2.css("opacity", "0.1");                                 
                                    $.post("/data", {"fn": "set_secondary_fund_for_roof_work_item", "identifier": item.field_app_identifier, "value": that2.val()})
                                    .done(function()
                                    {
                                        r2.secondary_fund = that2.val();
                                        that2.css("opacity", "1.0");
                                        //sub_root.trigger("update_system_cost");
                                        cust_div.trigger("click");
                                    });
                                })
                                .click(function(ev)
                                {
                                    ev.stopPropagation();
                                });


                                $("<p></p>").addClass("roof_item_details_info").attr("id", "roof_work_secondary_fund_group").css("display", "none")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Secondary Fund Selection")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value")                                    
                                    .append
                                    (
                                        secondary_fund_sel
                                    )
                                    .append
                                    (
                                        $("<ul></ul>")
                                        .append
                                        (
                                            $("<li></li>").text("Service Finance 2018: 18 months no interest and no payments. Pay it off in full within 18 months.")
                                        )
                                        .append
                                        (
                                            $("<li></li>").text("Service Finance 2024: 24 months no interest and no payments. Pay it off in full within 24 months.")
                                        )
                                        .append
                                        (
                                            $("<li></li>").text("Service Finance 4071: 20 years with 5.99% APR.")
                                        )
                                    )                                  
                                )
                                .appendTo(sub_root);

                                $("<div></div>").addClass("roof_work_divider").appendTo(sub_root);

                                sub_root.find("#rep_option_2_fund_sel").find("option").each(function(ii, ee)
                                {
                                    if($(ee).attr("value") === r2.secondary_fund)
                                    {
                                        $(ee).attr("selected", "selected");
                                    }
                                });                                

                                $("<p></p>").addClass("roof_item_details_info")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Total Roof Cost")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Calculating...").attr("id", "roof_work_cost_update")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "total_amount_financed_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Total Amount Financed")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Calculating...").attr("id", "number_7_roof_work")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "roof_final_yeah_amt")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Total Potential Tax Credit (Please Have Customer Consult with an Accountant, 26% of total amount financed)")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Calculating...").attr("id", "roof_work_total_tax_credit")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "number_9_warning_roof_work").css("display", "none")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("WARNING: The Total Potential Tax Credit Is LESS THAN the amount financed by the Secondary Financing Product. Please make sure the customer understands the payment terms.")
                                )
                                .appendTo(sub_root);

                                var f_name = "ERROR";
                                $.each(r.funds, function(ii, fund2)
                                {
                                    if(fund2.value === r2.fund)
                                    {
                                        f_name = fund2.value_friendly;
                                    }
                                })

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "first_fund_root_yeah")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Fund")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text(f_name)
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "roof_work_sys_cost_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("System Cost")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text(currencyFormat(parseFloat(r2.total_system_cost)))
                                )
                                .appendTo(sub_root);

                                $.each(r.funds, function(iii, fund)
                                {
                                    if(fund.value === r2.fund)
                                    {
                                        if(fund.lp)
                                        {
                                            $("<p></p>").addClass("roof_item_details_info").attr("id", "first_fund_18_months_root")
                                            .append
                                            (
                                                $("<span></span>").addClass("roof_item_details_label").text("1st 18 Months Payment")
                                            )
                                            .append
                                            (
                                                $("<span></span>").addClass("roof_item_details_value").text(currencyFormat(r2.formula_1))
                                            )
                                            .appendTo(sub_root);

                                            $("<p></p>").addClass("roof_item_details_info").attr("id", "first_fund_without_tax_credit_eighteen_months")
                                            .append
                                            (
                                                $("<span></span>").addClass("roof_item_details_label").text("After 18 months without tax credit")
                                            )
                                            .append
                                            (
                                                $("<span></span>").addClass("roof_item_details_value").text(currencyFormat(parseFloat(r2.formula_2)))
                                            )
                                            .appendTo(sub_root);
                                            
                                        }
                                    }
                                });

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "total_cost_system_and_roof_roof")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Total Cost (System & Roof)")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a Fund").attr("id", "number_eleven_number_one")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "second_fund_first_18_months_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("1st 18 months payment")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a fund").attr("id", "number_eleven_number_two")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "rolled_info_roof_work_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").html("After 18 months payment with full tax credit rolled into <span id='change_fund_two_name_here'></span> and the remaining amount rolled into <span id='change_fund_one_name_here'></span>")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a fund").attr("id", "number_eleven_number_three")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "after_18_second_fund_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("After 18 months payment without tax credit")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a fund").attr("id", "number_eleven_number_four")
                                )
                                .appendTo(sub_root);


                                $("<p></p>").addClass("roof_item_details_info").attr("id", "total_cost_rest_roof_work_root_two")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Total Cost (Rest of Roof Work)")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a fund").attr("id", "number_tweleve_number_one")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "no_payments_root")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Payment:")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("No payments but the full total cost must be paid off before the end of 18 months").attr("id", "number_tweleve_eighteen").css("display", "none")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("No payments but the full total cost must be paid off before the end of 24 months").attr("id", "number_twelve_twenty_twenty_four").css("display", "none")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text("Please choose a funding source").attr("id", "number_twelve_special").css("display", "none")
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "full_reroof_photo").css("display", "none")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Full Reroof Photo")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value")
                                    .append
                                    (
                                        $("<img />").addClass("img").addClass("img-responsive").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/RoofWorkDetails/" + item.field_app_identifier + "/reroof_photo.jpg")
                                    )
                                    
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Excluded Areas")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").html(r2.data.exclusions.split("\n").join("<br />"))
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "solar_only_photo").css("display", "none")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Solar Only Photo")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value")
                                    .append
                                    (
                                        $("<img />").addClass("img").addClass("img-responsive").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/RoofWorkDetails/" + item.field_app_identifier + "/solar_area_photo.jpg")
                                    )
                                )
                                .appendTo(sub_root);

                                $("<p></p>").addClass("roof_item_details_info").attr("id", "roof_work_dual_photo")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Evidence Photos")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value")
                                    .append
                                    (
                                        $("<img />").addClass("img").addClass("img-responsive").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/RoofWorkDetails/" + item.field_app_identifier + "/proof_photo_1.jpg")
                                    )
                                    .append
                                    (
                                        $("<img />").addClass("img").addClass("img-responsive").attr("src", "//storage.googleapis.com/" + window.app_bucket + "/Images/RoofWorkDetails/" + item.field_app_identifier + "/proof_photo_2.jpg")
                                    )
                                )
                                .appendTo(sub_root);

                                setTimeout(function()
                                {
                                    if(window.per_kw_roof_work > parseFloat(7) && window.is_lp_roof_work)
                                    {
                                        
                                        var second_fund_name = "";
                                        $.each(r.funds, function(nn, fff)
                                        {
                                            if(fff.value === $("#rep_option_2_fund_sel").val())
                                            {
                                                second_fund_name = fff.value_friendly;
                                            }
                                        });
                                        var first_fund_nayme = "";
                                        $.each(r.funds, function(nn, fff)
                                        {
                                            if(fff.value === r2.fund)
                                            {
                                                first_fund_nayme = fff.value_friendly;
                                            }
                                        });


                                        $("<div></div>").addClass("steps_and_links")
                                        .append
                                        (
                                            $("<b></b>").text("Qualify the customer for " + second_fund_name + "  and have them sign financing docs")
                                        )
                                        .append
                                        (
                                            $("<ol></ol>").addClass("steps_and_links_first_group")
                                            .append
                                            (
                                                $("<li></li>").html("Go to the following link <a target='blank' href='https://www.svcfin.com/'>https://www.svcfin.com/</a>")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Click Apply Now ")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Enter our dealer number: 500127658") 
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Select Solar Equipment")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Select Residential")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Input your information")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Change the Improvement to Roofing")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Input the amount: " + currencyFormat(window.new_amt22))
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Leave the down payment as Zero")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Select the state")
                                            )
                                            .append
                                            (
                                                $("<li></li>").text("Change the program to " + second_fund_name)
                                            )
                                        )
                                        .append
                                        (
                                            $("<p></p>").addClass("always_show_num_two_amt").text("The " + first_fund_nayme + " amount will need to increase from " + currencyFormat(parseFloat(r2.total_system_cost)) + " to " + currencyFormat(window.num_el_amt66) + " and the customer will need to re-sign financing docs with " + first_fund_nayme + ". If you cannot change this amount yourself, please text Thomas the amount of " + currencyFormat(window.num_el_amt66) + ", the customer name, and that you need it changed.")
                                        )
                                        .append
                                        (
                                            $("<p></p>").addClass("always_show_num_three").text("The customer will need to sign an updated New Power docs packet showing a roof addendum and possibly an increased system cost.  Click the generate docs link here to get that link.")
                                        )
                                        .appendTo(sub_root);   

                                        setTimeout(function()
                                        {
                                            $(".steps_and_links_first_group").css("display", "block");
                                            var first_num_11_amt_financed = $("#number_tweleve_number_one").text();
                                            while(first_num_11_amt_financed.indexOf("$") > -1)
                                            {
                                                first_num_11_amt_financed = first_num_11_amt_financed.replace("$", "");
                                            }
                                            while(first_num_11_amt_financed.indexOf(",") > -1)
                                            {
                                                first_num_11_amt_financed = first_num_11_amt_financed.replace(",", "");
                                            }
                                            first_num_11_amt_financed = parseFloat(first_num_11_amt_financed);

                                            var second_num_11 = $("#roof_work_total_tax_credit").text();
                                            while(second_num_11.indexOf("$") > -1)
                                            {
                                                second_num_11 = second_num_11.replace("$", "");
                                            }
                                            while(second_num_11.indexOf(",") > -1)
                                            {
                                                second_num_11 = second_num_11.replace(",", "");
                                            }
                                            second_num_11 = parseFloat(second_num_11);

                                            if(first_num_11_amt_financed > second_num_11)
                                            {
                                                $("#number_4_warning_roof_work").css("display", "block");
                                            }
                                            else
                                            {
                                                $("#number_4_warning_roof_work").css("display", "none");
                                            }

                                        }, 500);
                                    }
                                }, 1000);

                                                                
                                sub_root.appendTo(cust_div);
                                sub_root.click(function(ev)
                                {
                                    ev.stopPropagation();
                                });

                                if(show_full_reroof === false)
                                {
                                    $("#full_reroof_photo").css("display", "none");
                                    $("#solar_only_photo").css("display", "block");
                                }
                                else
                                {
                                    $("#full_reroof_photo").css("display", "block");
                                    $("#solar_only_photo").css("display", "none");
                                }
                                sub_root.trigger("update_system_cost");
                                sub_root.find("#roof_work_cost_update").parent().insertBefore(sub_root.find("#number_4_warning_roof_work"));
                                sub_root.find("#roof_work_dual_photo").insertAfter(sub_root.find("#reason_needed_root"));
                                sub_root.find("#rep_option_one_sel").insertAfter(sub_root.find("#roof_work_dual_photo"));
                                sub_root.find("#solar_only_photo").insertAfter(sub_root.find("#rep_option_one_sel"));
                                sub_root.find("#full_reroof_photo").insertAfter(sub_root.find("#solar_only_photo"));

                                $("<div></div>").addClass("roof_work_header").text("Roof Work Details").prependTo(sub_root);

                                var first_group_root = $("<div></div>").addClass("roof_work_sub_sub_group");
                                sub_root.find(".roof_work_divider").first().prevAll().each(function(yo, ddd)
                                {
                                    $(ddd).prependTo(first_group_root);
                                });
                                first_group_root.prependTo(sub_root);
                                $("#full_reroof_photo").next().remove();
                                $("<div></div>").addClass("roof_work_divider").appendTo(first_group_root);

                                var first_fund_nayme = "";
                                $.each(r.funds, function(nn, fff)
                                {
                                    if(fff.value === r2.fund)
                                    {
                                        first_fund_nayme = fff.value_friendly;
                                    }
                                });

                                //sub_root.find("#first_fund_18_months_root").insertAfter(sub_root.find("#roof_work_sys_cost_root"));
                                //sub_root.find("#first_fund_without_tax_credit_eighteen_months").insertAfter(sub_root.find("#first_fund_18_months_root"));

                                var second_group_root = $("<div></div>").addClass("roof_work_sub_sub_group");
                                $("<div></div>").addClass("roof_work_header").text("Old Payment Terms with just " + first_fund_nayme).appendTo(second_group_root);                               

                                var field_ids = ["roof_work_sys_cost_root", "first_fund_18_months_root", "first_fund_without_tax_credit_eighteen_months"];

                                $.each(field_ids, function(nah, id2)
                                {
                                    sub_root.find("#" + id2).appendTo(second_group_root);
                                });
                                $("<div></div>").addClass("roof_work_divider").appendTo(second_group_root);
                                second_group_root.insertAfter(first_group_root);

                                sub_root.find("#change_fund_one_name_here").text(first_fund_nayme);

                                var third_group_round_one_ids = ["total_amount_financed_root", "roof_final_yeah_amt", "first_fund_root_yeah"]

                                var third_group_root = $("<div></div>").addClass("roof_work_sub_sub_group");


                                var s_fund_name = "";
                                $.each(r.funds, function(nn, fff)
                                {
                                    if(fff.value === $("#rep_option_2_fund_sel").val())
                                    {
                                        s_fund_name = fff.value_friendly;
                                    }
                                });

                                var phirst_fund_name = "";
                                $.each(r.funds, function(nn, fff)
                                {
                                    if(fff.value === r2.fund)
                                    {
                                        phirst_fund_name = fff.value_friendly;
                                    }
                                });


                                $("#change_fund_two_name_here").text(s_fund_name);                                

                                $("<div></div>").addClass("roof_work_header").text("New Payment Terms with " + phirst_fund_name + " and " + s_fund_name).appendTo(third_group_root);
                                $.each(third_group_round_one_ids, function(nah, id2)
                                {
                                    sub_root.find("#" + id2).appendTo(third_group_root);
                                });

                                var first_sub_ol = $("<ol></ol>");

                                $("<li></li>")
                                .append
                                (
                                    sub_root.find("#total_cost_system_and_roof_roof")
                                )
                                .appendTo(first_sub_ol);
                                
                                $("<li></li>")
                                .append
                                (
                                    sub_root.find("#second_fund_first_18_months_root")
                                )
                                .appendTo(first_sub_ol);

                                $("<li></li>")
                                .append
                                (
                                    sub_root.find("#rolled_info_roof_work_root")
                                )
                                .appendTo(first_sub_ol);

                                $("<li></li>")
                                .append
                                (
                                    sub_root.find("#after_18_second_fund_root")
                                )
                                .appendTo(first_sub_ol);

                                first_sub_ol.appendTo(third_group_root);

                                $("<p></p>").addClass("roof_item_details_info")
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_label").text("Roofing Fund")
                                )
                                .append
                                (
                                    $("<span></span>").addClass("roof_item_details_value").text(s_fund_name)
                                )
                                .appendTo(third_group_root);

                                var second_ol = $("<ol></ol>");

                                $("<li></li>")
                                .append
                                (
                                    sub_root.find("#total_cost_rest_roof_work_root_two")
                                )
                                .appendTo(second_ol);

                                $("<li></li>").append
                                (
                                    sub_root.find("#no_payments_root")
                                )
                                .appendTo(second_ol);

                                second_ol.appendTo(third_group_root);

                                $("<div></div>").addClass("roof_work_divider").appendTo(third_group_root);
                                third_group_root.insertAfter(second_group_root);

                                var fourth_group_root = $("<div></div>").addClass("roof_work_sub_sub_group");

                                var header = $("<div></div>").addClass("roof_work_header").text("Steps and Links");
                                header.appendTo(fourth_group_root);

                                fourth_group_root.appendTo(sub_root);

                                setTimeout(function()
                                {
                                    $("<div></div>").addClass("roof_work_divider").appendTo($(".steps_and_links"));
                                    $(".steps_and_links").appendTo(fourth_group_root);
                                }, 1000);

                                

                                var fifth_group_root = $("<div></div>").addClass("roof_work_sub_sub_group");
                                $("<div></div>").addClass("roof_work_header").text("Go").appendTo(fifth_group_root);

                                $("<center></center>")
                                .append
                                (
                                    $("<button></button>").attr("id", "roof_work_go_btn").text("Confirm Numbers and Generate Docs")
                                    .on("click", function()
                                    {
                                        var continue_generating = false;
                                        continue_generating = true;

                                        var that3 = $(this);
                                        var payload = {};
                                        payload["fn"] = "confirm_supplement_details";
                                        payload["identifier"] = item.field_app_identifier;

                                        var fund_one_cost = $.trim($("#number_eleven_number_one").text());
                                        while(fund_one_cost.indexOf("$") > -1)
                                        {
                                            fund_one_cost = fund_one_cost.replace("$", "");
                                        }
                                        while(fund_one_cost.indexOf(",") > -1)
                                        {
                                            fund_one_cost = fund_one_cost.replace(",", "");
                                        }
                                        payload["fund_one_cost"] = fund_one_cost;

                                        var fund_two_cost = $.trim($("#number_tweleve_number_one").text());
                                        while(fund_two_cost.indexOf("$") > -1)
                                        {
                                            fund_two_cost = fund_two_cost.replace("$", "");
                                        }
                                        while(fund_two_cost.indexOf(",") > -1)
                                        {
                                            fund_two_cost = fund_two_cost.replace(",", "");
                                        }
                                        payload["fund_two_cost"] = fund_two_cost;

                                        payload["roof_scope"] = $("#rep_option_one_sel").val();
                                        

                                        var orig_txt_2 = that3.text();
                                        that3.text("Please Wait...").css("opacity", "0.5");

                                        $.post("/data", payload).done(function()
                                        {
                                            that3.css("opacity", "1.0").text(orig_txt_2);

                                            that3.text("");
                                            $("<a></a>").attr("id", "reroof_sign_link").attr("href", "/sign/" + item.field_app_identifier + "?bundle_key=roof_work").text("Signing Link").attr("target", "_blank")
                                            .click(function(ev)
                                            {
                                                ev.stopPropagation();
                                            })
                                            .appendTo(that3);
                                            that3.off("click");
                                        });

                                        
                                    })
                                )
                                .appendTo(fifth_group_root)

                                fifth_group_root.insertAfter(fourth_group_root);

                            });
                        });
                        $.each(r.funds, function(nn, fff)
                        {

                        });                        
                        
                        cust_div.appendTo(root_div);                        
                    });
                    root_div.appendTo(main_div);

                    $.each([spacer, main_div, spacer_clone], function(i, e)
                    {
                        e.appendTo(app_area);
                    });                    
                    console.log(r);
                });
            }
            function titanProgress()
            {
                hideIconGrid();
                var app_area = $("#app_area");                
                var spacer_div = $("<div></div>").addClass("col-xs-1").addClass("col-sm-1").addClass("col-md-1").addClass("col-lg-1").addClass("col-xl-1");
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("col-xl-10");
                var spacer_clone = spacer_div.clone();
                $("<h2></h2>").text("Loading...").appendTo(app_area)
                $("<button></button>").addClass("titan_back").html("&larr; Back").addClass("btn").addClass("btn-danger").css("font-size", "2em")
                .click(() =>
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    });
                })
                .appendTo(app_area);
                $("<hr />").appendTo(app_area);
                $.post("/data?fn=load_pending_titan&rep_id=" + window.rep_id).done(function(resp)
                {
                    app_area.find("h2").text("Titan Status");

                    $.each(resp.customers, function(i, customer)
                    {
                        var cust_p = $("<p></p>").addClass("titan_customer").text(customer.name);
                        if(customer.cancelled === true)
                        {
                            cust_p.addClass("titan_cancelled");
                            cust_p.text("(CANCELLED) - " + customer.name);
                        }
                        else if(customer.pto === true)
                        {
                            cust_p.addClass("titan_pto")
                        }
                        
                        cust_p.click(function()
                        {
                            var that = $(this);
                            that.css("opacity", "0.5");
                            $.post("/data", {"fn": "get_titan_status", "identifier": customer.field_app_identifier}).done(function(resp2)
                            {
                                that.css("opacity", "1.0");
                                var titan_details_div = $("<div></div>").addClass("titan_details");
                                $("<a></a>").attr("href", "javascript:void(0)").text("X").addClass("titan_close").click(function()
                                {
                                    titan_details_div.remove();
                                })
                                .appendTo(titan_details_div);

                                if(resp2.cancelled)
                                {
                                    $("<p></p>").text("Canceled: Yes").appendTo(titan_details_div);
                                }
                                else
                                {
                                    $("<p></p>").text("Canceled: No").appendTo(titan_details_div);
                                }

                                var wc_date_div = $("<p></p>").text("Permit Submitted: No");
                                if(resp2.permited_submitted || resp2.permit_submitted)   
                                {
                                    wc_date_div.text("Permit Submitted: Yes");
                                }                             
                                wc_date_div.appendTo(titan_details_div);

                                var s_needed_p = $("<p></p>").text("Survey Needed: No");
                                if(resp2.survey_needed === true)
                                {
                                    s_needed_p.text("Survey Needed: Yes");
                                    s_needed_p.appendTo(titan_details_div);

                                    var now2 = moment();                                                                
                                    var s_date_div = $("<p></p>").text("Survey Date: Not Set");
                                    var days_diff2 = Math.abs(parseInt(moment(resp2.survey_date, "YYYY-MM-DD").diff(now2, "days")));
                                    if(days_diff2 <= 200)
                                    {
                                        s_date_div.text("Survey Date: " + resp2.survey_date);
                                    }
                                    s_date_div.appendTo(titan_details_div);               
                                    var survey_time_div = $("<div></div>").text("Survey Time: Not Set");
                                    if(resp2.survey_time.indexOf("00:00:00") === -1)
                                    {
                                        survey_time_div.text("Survey Time: " + resp2.survey_time);
                                    }
                                    survey_time_div.appendTo(titan_details_div);

                                }
                                else
                                {
                                    s_needed_p.appendTo(titan_details_div);
                                }
                                $("<p></p>").text("Survey Completed: " + ["No", "Yes"][resp2.survey_completed * 1]).appendTo(titan_details_div);
                                $("<p></p>").text("Roof Work Needed: " + ["No", "Yes"][resp2.roof_work_needed * 1]).appendTo(titan_details_div);
                                if(resp2.roof_work_needed)
                                {
                                    $("<p></p>").text("Roof Work Cost: " + currencyFormat(resp2.roof_work_cost)).appendTo(titan_details_div);
                                }
                                $("<p></p>").text("MPU Needed: " + ["No", "Yes"][resp2.mpu_needed * 1]).appendTo(titan_details_div);

                                var now3 = moment();                                                                
                                var install_date_div = $("<p></p>").text("Install Date: Not Set");
                                var days_diff3 = Math.abs(parseInt(moment(resp2.install_date, "YYYY-MM-DD").diff(now3, "days")));
                                if(days_diff3 <= 200)
                                {
                                    install_date_div.text("Install Date: " + resp2.install_date);
                                }
                                install_date_div.appendTo(titan_details_div);

                                $("<p></p>").text("PTO: " + ["No", "Yes"][resp2.pto * 1]).appendTo(titan_details_div);

                                var survey_date = resp2.survey_date;

                                let notes_replaced = resp2.notes;
                                if(notes_replaced === undefined)
                                {
                                    notes_replaced = "";
                                }
                                while(notes_replaced.indexOf("\r") > -1)
                                {
                                    notes_replaced = notes_replaced.replace("\r", "");
                                }

                                $("<p></p>")
                                .html("Notes:<br /><br />" + notes_replaced.split("\n").join("<br />")).appendTo(titan_details_div);

                                $("<p></p>").text("Phone: " + resp2.phone).appendTo(titan_details_div);
                                $("<p></p>").text("Email: " + resp2.email).appendTo(titan_details_div);
                                $("<p></p>").html("Address:<br />" + resp2.address.split("\n").join("<br />")).appendTo(titan_details_div)
                                .appendTo(titan_details_div);


                                titan_details_div.appendTo(cust_p)
                            });
                        })
                        .appendTo(main_div);
                    });

                    $.each([/*spacer_div,*/ main_div/*, spacer_clone*/], function(i, div)
                    {
                        div.appendTo(app_area);
                    });
                });
            }
            function loadFollowups()
            {
                hideIconGrid();
                var main_div = $("<div></div>").addClass("col-xs-10").addClass("col-sm-10").addClass("col-md-10").addClass("col-lg-10").addClass("col-xl-10");                
                $("<button></button>").html("&larr; Back").addClass("btn").addClass("btn-danger").appendTo(main_div)
                .attr("id", "fu_go_back")
                .click(function()
                {
                    clearApp(function()
                    {
                        showIconGrid();
                    })
                });


                $("<hr />").appendTo(main_div);

                var row = $("<div></div>").addClass("row");
                var spacer = $("<div></div>").addClass("col-xs-12").addClass("col-sm-12").addClass("col-md-12").addClass("col-lg-12").addClass("col-xl-12");

                var spacer_clone = spacer.clone();

                var fu_data = localStorage.getItem("followup_data");
                if(fu_data !== null && fu_data !== undefined)
                {
                    let decoded = JSON.parse(fu_data);

                    decoded = bubbleSortArrayOfObjectsByKey(decoded, "date");

                    decoded.forEach((item) =>
                    {
                        let fu_view_item = $("<p></p>").addClass("fu_view_item");
                        
                        fu_view_item
                        .append
                        (
                            $("<span></span>").text(item.date).addClass("fu_view_date")
                        )
                        .append
                        (
                            $("<span></span>").text(item.name).addClass("fu_view_name")
                            .click(function()
                            {
                                $(".fe_details").remove();
                                var this_div = $(this);
                                this_div.css("opacity", "0.1");

                                $.post("/data", {"fn": "get_followup_details", "identifier": item.identifier})
                                .done(function(resp)
                                {
                                    $.getJSON("/kv/later_notes_" + item.identifier).done(function(obj)
                                    {
                                        let pulled_notes = "";
                                        if(obj.value !== null)
                                        {
                                            pulled_notes = obj.value;
                                        }
                                            

                                        this_div.css("opacity", "1.0");
                                        let new_div = $("<div></div>").addClass("fe_details");

                                        new_div.append
                                        (
                                            $("<p></p>")
                                            .append
                                            (
                                                $("<a></a>").attr("href", "javascript:void(0)").text("Restore").addClass("fe_restore")
                                                .click(() =>
                                                {
                                                    var fu_data2 = JSON.parse(localStorage.getItem("followup_data"));
                                                    var new_data2 = [];
                                                    fu_data2.forEach((item2) =>
                                                    {
                                                        if(item.identifier === item2.identifier)
                                                        {
                                                            var n = "n";
                                                        }
                                                        else
                                                        {
                                                            new_data2.push(item2);
                                                        }
                                                    });

                                                    localStorage.setItem("followup_data", JSON.stringify(new_data2));

                                                    let pload = {};
                                                    pload.fn = "rep_sp2_reschedule_inhouse";
                                                    pload.identifier = item.identifier;
                                                    pload.sp2_hour = "1"
                                                    pload.sp2_minute = "0"
                                                    pload.sp2_ampm = "AM";
                                                    pload.sp2_date = moment().add(-1, "days").format("MM-DD-YYYY");
                                                    $.post("/data", pload);
                                                    fu_view_item.remove();

                                                })
                                            )
                                            .append
                                            (
                                                $("<span></span>").text("X").addClass("fu_details_close")
                                                .click(() =>
                                                {
                                                    new_div.remove();
                                                })
                                            )                                            
                                        )
                                        new_div
                                        .append
                                        (
                                            $("<p></p>").text(resp.address)
                                        )
                                        .append
                                        (
                                            $("<p></p>").text(resp.city + ", " + resp.state)
                                        )
                                        .append
                                        (
                                            $("<p></p>").text(resp.postal)
                                        )
                                        .append
                                        (
                                            $("<p></p>").text(resp.phone)
                                        )
                                        .append
                                        (
                                            $("<b></b>").text("Notes")
                                        )
                                        .append
                                        (
                                            $("<br />")
                                        )
                                        .append
                                        (
                                            $("<textarea></textarea>").val(pulled_notes).addClass("pulled_notes_in_followup")
                                            .blur(function()
                                            {
                                                let that = $(this);
                                                $.post("/kv/later_notes_" + item.identifier, {"value": that.val()}).done(function()
                                                {
                                                    d.close();
                                                });
                                            })
                                        )
                                        .appendTo(new_div);

                                        new_div.appendTo(fu_view_item);                                        
                                    });                                    
                                });
                            })
                        )
                        .appendTo(main_div);
                    });
                }

                $.each([spacer, main_div, spacer_clone], function(iii, eee)
                {
                    eee.appendTo($("#app_area"));
                });
            }
        </script>
    </head>
    <body>
        <div id="landscape_reqd">
            <table align="center" style="width: 100%; height: 100%;" valign="center">
                <tbody>
                    <tr>
                        <td align="center" valign="center">
                            <h3>Landscape mode is required, please rotate the device...</h3>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                    &nbsp;
                </div>
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4" id="signout">
                    ({{ user_name }}) | <a id="href_change_pass" href="javascript:void(0);">Change Password</a> | <a href="/logout">SignOut</a>
                    <div id="lead_acceptance_div">
                        <a id="same_day_a" class="{{accepts_leads_css_class}}" style="display: {{accepts_leads_css}};" href="javascript:void(0);">{{accepts_leads_text}}</a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                    <img class="img img-responsive" src="./bootstrap/images/np_logox21.png" />
                </div>
                <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
                    <h2>New Power Company &therefore; Rep Portal</h2>
                </div>
            </div>
            <hr />
            <div class="col-xs-9 col-sm-9 col-md-9 col-lg-9">
                <div class="row" id="icon_grid">

                </div>
            </div>
            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
                <div class="row">
                    <div id="featured_lb_area" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row" id="app_area">
            </div>
        </div>
        </div>
    </body>
</html>
